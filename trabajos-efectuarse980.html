<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orden de Trabajo: FAH-980</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #e9ecef;
        }
        .paper-container {
            width: 100%;
            max-width: 8.5in; /* Tamaño carta */
            min-height: 11in;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem;
            border-radius: 0.25rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        table, th, td {
            border: 1px solid #dee2e6;
        }
        th {
            background-color: #f8f9fa;
        }
        .editable-cell { cursor: text; }
        .editable-cell:hover { background-color: #f0f8ff; }
        .editable-cell:focus {
            background-color: white;
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .editable-field {
             cursor: text;
             display: block;
             width: 100%;
             height: 100%;
             padding: 0.25rem 0.5rem;
        }
        .editable-field:focus {
            background-color: #e7f1ff;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }

        /* --- INICIO: NUEVA REGLA PARA FILA SELECCIONADA --- */
        tr.selected-row {
            background-color: #eff6ff !important; /* bg-blue-50 */
        }
        /* --- FIN: NUEVA REGLA --- */

        #signature-canvas {
            width: 400px;
            height: 200px;
            cursor: crosshair;
        }
        .signature-cell img, .footer-signature-area img {
            max-height: 40px;
            display: block;
            margin: 0 auto;
        }
        /* INICIO: NUEVA REGLA PARA MINI-FIRMA EN LISTA */
        #missing-items-list img {
            max-height: 25px;
            display: block;
            margin: 0 auto;
        }
        /* FIN: NUEVA REGLA */
        .signature-cell p, .footer-signature-area p {
            line-height: 1;
        }
        .signature-line {
            border-top: 1px solid #495057;
            margin-top: 0.5rem;
        }
        
        /* --- INICIO: NUEVO ESTILO PARA BOTONES DE TABLA --- */
        .table-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .table-action-btn.edit-btn {
            color: #2563eb; /* text-blue-600 */
        }
        .table-action-btn.edit-btn:hover {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1d4ed8; /* text-blue-700 */
        }
        .table-action-btn.delete-btn {
            color: #dc2626; /* text-red-600 */
        }
        .table-action-btn.delete-btn:hover {
            background-color: #fee2e2; /* bg-red-100 */
            color: #b91c1c; /* text-red-700 */
        }
        /* --- FIN: NUEVO ESTILO PARA BOTONES DE TABLA --- */


        @media print {
            body {
                background: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* --- INICIO: NUEVA REGLA PARA AJUSTAR EL BODY --- */
            body.printing-missing-list {
                margin: 0.5in !important; /* Añadir el margen de impresión aquí */
                padding: 0 !important;
            }
            /* --- FIN: NUEVA REGLA --- */

            .paper-container {
                box-shadow: none;
                margin: 0;
                padding: 1.5rem;
                max-width: 100%;
                border: 1px solid #dee2e6;
            }
            
            /* --- INICIO: NUEVA REGLA PARA AJUSTAR EL CONTENEDOR --- */
            body.printing-missing-list .paper-container {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
            /* --- FIN: NUEVA REGLA --- */
            
            .no-print {
                display: none !important;
            }
            .editable-cell, .editable-field {
                background-color: white !important;
                outline: none !important;
                padding: 2px 0;
                box-shadow: none;
            }
            .print-table-style {
                border: 1px solid #4a5568 !important;
                background-color: #1a202c !important; /* Tailwind blue-900 */
                color: white !important;
            }
            
            /* --- INICIO: REGLAS DE IMPRESIÓN --- */
            
            /* Ocultar todo por defecto si la clase .printing-missing-list está activa */
            /* ESTA SECCIÓN HA SIDO REESCRITA PARA CORREGIR EL ERROR DE PÁGINA EN BLANCO */
            body.printing-missing-list > *:not(.paper-container) {
                display: none !important;
            }

            /* Dentro del paper-container, ocultar todos los hijos directos */
            body.printing-missing-list .paper-container > * {
                display: none !important;
                visibility: hidden !important; /* Más fuerte */
            }
            
            /* Pero, mostrar la sección de la lista y darle estilo de impresión */
            body.printing-missing-list #missing-items-section {
                display: block !important;
                visibility: visible !important;
                box-shadow: none;
                border: none;
                margin: 0; /* Quitar el margen de aquí */
                padding: 0;
                max-width: 100%;
                width: 100%;
            }

            /* Ocultar el botón de la lista siempre que se imprima (en cualquier modo) */
            #print-list-btn {
                display: none !important;
            }
            /* --- FIN: REGLAS DE IMPRESIÓN --- */
        }
    </style>
</head>
<body>

    <div class="paper-container flex flex-col">
        <header class="mb-8">
            <div class="flex justify-between items-center border-b-2 border-gray-700 pb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">TRABAJOS A EFECTUARSE</h1>
                    <p class="text-gray-600">Mantenimiento Correctivo y Preventivo</p>
                </div>
                <div class="text-right">
                    <p class="font-bold">Aeronave: <span class="font-normal">BELL 412 / FAH-980</span></p>
                    <p class="font-bold">Fecha: <span class="font-normal" id="current-date"></span></p>
                </div>
            </div>
        </header>

        <section id="work-order-details" class="mb-8">
            <div class="text-center mb-1">
                <div class="bg-yellow-300 p-2 font-bold text-black border border-b-0 border-gray-700">
                    <p>ESCN. HELICÓPTEROS / FUERZA AÉREA HONDUREÑA</p>
                </div>
                <div class="bg-white p-2 font-bold text-black border border-gray-700">
                    <p>BASE HAM</p>
                </div>
            </div>
            
            <div class="grid grid-cols-4 border-t border-l border-gray-700 text-sm">
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">FECHA INICIO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="fecha-inicio" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">FECHA FINALIZACIÓN</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="fecha-finalizacion" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">MODELO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="modelo" class="editable-field" contenteditable="true">BELL 412</span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">ENG 1 TSN/TSO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="eng1-sn-tsn-tso" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">NÚMERO DE SERIE</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="numero-serie" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">ENG 1  CSN/CSO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="eng1-sn-csn-cso" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">MATRÍCULA</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="matricula" class="editable-field" contenteditable="true">FAH-980</span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">ENG 2  TSN/TSO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="eng2-sn-tsn-tso" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">A/C TT</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="ac-tt" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">ENG 2  CSN/CSO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="eng2-sn-csn-cso" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">TQ EVENTS</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="tq-events" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">C-BOX TSN/TSO</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="cbox-sn-tsn-tso" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">LANDINGS</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="landings" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">S/N C-BOX </div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="cbox-sn-csn-cs" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">ELABORADO POR</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="elaborado-por" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">ORDEN DE TRABAJO No.</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="orden-trabajo-no" class="editable-field" contenteditable="true"></span></div>
                <div class_A="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">N/S MOTOR #1</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="ns-motor-1" class="editable-field" contenteditable="true"></span></div>
                <div class="bg-blue-900 text-white font-semibold p-2 border-r border-b border-gray-700 print-table-style">N/S MOTOR #2</div>
                <div class="bg-white p-0 border-r border-b border-gray-700"><span id="ns-motor-2" class="editable-field" contenteditable="true"></span></div>
            </div>

            <div class="mt-6 text-right no-print">
                <button id="save-details-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    Guardar Detalles
                </button>
            </div>
        </section>

        <main class="flex-grow">
            <!-- INICIO: NUEVO CONTENEDOR PARA TÍTULO Y BOTÓN DE LOTE -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-center text-red-700">Listado de Inspecciones Vencidas</h2>
                <div id="batch-actions-container" class="hidden no-print">
                    <span id="selection-count" class="text-sm font-medium text-gray-700 mr-4">0 seleccionadas</span>
                    <button id="batch-sign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm shadow-md">
                        Firmar Seleccionadas
                    </button>
                </div>
            </div>
            <!-- FIN: NUEVO CONTENEDOR -->
            
            <div id="loading-message" class="text-center text-gray-500 my-8">Cargando lista de trabajos...</div>
            
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <!-- INICIO: NUEVO ENCABEZADO DE CHECKBOX -->
                        <th scope="col" class="px-4 py-3 w-10 text-center">
                            <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 shadow-sm focus:ring-blue-500">
                        </th>
                        <!-- FIN: NUEVO ENCABEZADO -->
                        <th scope="col" class="px-4 py-3 w-10 text-center">#</th>
                        <th scope="col" class="px-4 py-3">Descripción del Trabajo / Inspección</th>
                        <th scope="col" class="px-4 py-3 w-40">Referencia</th>
                        <th scope="col" class="px-4 py-3 w-32">Mecánico</th>
                        <th scope="col" class="px-4 py-3 w-32">ACCION TOMADA</th>
                    </tr>
                </thead>
                <tbody id="vencidas-list">
                    </tbody>
            </table>
            
            <div class="mt-8 no-print">
                <h3 class="text-lg font-semibold text-center text-gray-700">Progreso de Tareas</h3>
                <div class="w-full bg-gray-200 rounded-full h-6 mt-2 shadow-inner">
                    <div id="progress-bar" class="bg-blue-600 h-6 rounded-full text-center text-white text-sm leading-6 transition-all duration-500" style="width: 0%;">
                        <span id="progress-text">0%</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- INICIO: Tabla de Items Faltantes -->
        <section id="missing-items-section" class="mt-16 hidden">
            <!-- INICIO: CAMBIO DE LAYOUT (CSS FIX) -->
            <div class="flex justify-between items-center text-center mb-4">
                <h2 class="text-xl font-semibold text-purple-700 flex-grow">
                    Lista de Consumibles y Repuestos Faltantes
                </h2>
                <button id="print-list-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-xs no-print shadow-md ml-4 flex-shrink-0">
                    Imprimir solo esta lista
                </button>
            </div>
            <!-- FIN: CAMBIO DE LAYOUT (CSS FIX) -->
            
            <p class="text-center text-sm text-gray-500 mb-4 no-print">
                Esta tabla se actualiza automáticamente. Puede editar o borrar items (requiere clave).
            </p>
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-4 py-3">Trabajo Relacionado</th>
                        <th scope="col" class="px-4 py-3">Tipo</th>
                        <th scope="col" class="px-4 py-3">Nombre Item</th>
                        <th scope="col" class="px-4 py-3">P/N</th>
                        <th scope="col" class="px-4 py-3 w-20 text-center">Cantidad</th>
                        <!-- INICIO: NUEVA COLUMNA DE FIRMA -->
                        <th scope="col" class="px-4 py-3 w-32">Reportado Por</th>
                        <!-- FIN: NUEVA COLUMNA DE FIRMA -->
                        <!-- INICIO: NUEVA COLUMNA DE ACCIONES -->
                        <th scope="col" class="px-4 py-3 w-28 text-center no-print">Acciones</th>
                        <!-- FIN: NUEVA COLUMNA DE ACCIONES -->
                    </tr>
                </thead>
                <tbody id="missing-items-list">
                    <!-- Los items se generarán aquí -->
                </tbody>
            </table>
        </section>
        <!-- FIN: Tabla de Items Faltantes -->

        <footer class="mt-16">
            <div class="grid grid-cols-2 gap-12">
                <div class="text-center">
                    <div class="footer-signature-area cursor-pointer min-h-[70px] flex flex-col justify-end items-center" data-title="Supervisor">
                        <p class="text-gray-500 text-sm no-print">(Haga clic para firmar)</p>
                    </div>
                    <div class="signature-line"></div>
                    <p class="mt-2 font-semibold">Supervisor</p>
                    <p class="text-xs text-gray-500">(Nombre y Licencia)</p>
                </div>
                <div class="text-center">
                    <div class="footer-signature-area cursor-pointer min-h-[70px] flex flex-col justify-end items-center" data-title="Inspector">
                         <p class="text-gray-500 text-sm no-print">(Haga clic para firmar)</p>
                    </div>
                    <div class="signature-line"></div>
                    <p class="mt-2 font-semibold">Inspector</p>
                    <p class="text-xs text-gray-500">(Nombre y Licencia)</p>
                </div>
            </div>
        </footer>
        
        <div class="flex justify-center mt-12 gap-4 no-print">
            <button onclick="window.location.href=''" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                Ir al Control de Talleres
            </button>
            <button id="report-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                Generar Reporte
            </button>
            <button id="archive-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                Archivar Trabajos
            </button>
            <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                Imprimir / Guardar PDF
            </button>
        </div>
    </div>

    <!-- INICIO: Modales para Consumibles y Repuestos -->
    <div id="ask-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-900 bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm">
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 1.152-.468 2.19-1.228 2.969M12 18v.01M7.97 16l.006-.004m-.012 0l.006.004m-3.464 0l.006-.004m-.012 0l.006.004m7.442-7.42l.006-.004m-.012 0l.006.004m3.464 0l.006-.004m-.012 0l.006.004m-3.463 3.42l.006-.004m-.012 0l.006.004m-3.464 0l.006-.004m-.012 0l.006.004m7.442 0l.006-.004m-.012 0l.006.004" />
                </svg>
                <h3 id="ask-modal-title" class="mb-5 text-lg font-normal text-gray-500">¿Pregunta?</h3>
                <button id="ask-modal-yes" type="button" class="text-white bg-blue-600 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
                    Sí
                </button>
                <button id="ask-modal-no" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                    No
                </button>
            </div>
        </div>
    </div>

    <div id="item-form-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-900 bg-opacity-50 no-print overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md my-8">
            <div class="p-4 border-b">
                <h3 id="item-form-modal-title" class="text-lg font-bold text-gray-800">Añadir Item Faltante</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="item-name" class="block text-sm font-medium text-gray-700">Nombre del Item</label>
                    <input type="text" id="item-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Aceite, Tornillo, Filtro...">
                </div>
                <div>
                    <label for="item-part-number" class="block text-sm font-medium text-gray-700">Número de Parte (P/N)</label>
                    <input type="text" id="item-part-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: AN5-10A, 101-345...">
                </div>
                <div>
                    <label for="item-quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                    <input type="number" id="item-quantity" value="1" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <p id="item-form-error" class="text-red-500 text-sm h-4"></p>
            </div>
            <div class="flex justify-end gap-2 p-4 bg-gray-50">
                <button id="item-form-cancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg">Cancelar</button>
                <button id="item-form-save" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg">Guardar Item</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modales -->

    <!-- INICIO: Modales Faltantes (Firma, Clave, Confirmar) -->
    <div id="signature-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-900 bg-opacity-50 no-print overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg my-8">
            <div class="p-4 border-b">
                <h3 id="signature-modal-title" class="text-lg font-bold text-gray-800">Firma del Mecánico</h3>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="mb-4">
                    <label for="signature-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre y Licencia</label>
                    <input type="text" id="signature-name" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: K. Valladares / H-0123">
                </div>
                <div class="mt-4 border-2 border-dashed border-gray-300 rounded-lg">
                    <canvas id="signature-canvas" class="rounded-lg"></canvas>
                </div>
                <p class="text-xs text-gray-500 mt-2">Dibuje su firma en el recuadro de arriba</p>
            </div>
            <div class="flex justify-between p-4 bg-gray-50">
                <button id="signature-clear" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg">Limpiar</button>
                <div>
                    <button id="signature-cancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg mr-2">Cancelar</button>
                    <button id="signature-save" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Guardar Firma</button>
                </div>
            </div>
        </div>
    </div>

    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-900 bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <h3 id="password-modal-title" class="text-lg font-bold text-gray-800 mb-4">Clave Requerida</h3>
                <p id="password-modal-description" class="text-sm text-gray-600 mb-4">Para esta acción, ingrese la clave de supervisor.</p>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Clave</label>
                    <input type="password" id="password-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    <p id="password-error" class="text-red-500 text-xs h-4 mt-1"></p>
                </div>
            </div>
            <div class="flex justify-end gap-2 p-4 bg-gray-50">
                <button id="password-cancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg">Cancelar</button>
                <button id="password-confirm" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-900 bg-opacity-50 no-print">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm">
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 h-12 w-12 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 id="confirm-modal-title" class="mb-5 text-lg font-normal text-gray-500">¿Está seguro?</h3>
                <button id="confirm-modal-ok" type="button" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
                    Sí, estoy seguro
                </button>
                <button id="confirm-modal-cancel" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <!-- FIN: Modales Faltantes -->


    <!-- INICIO: NUEVO MODAL PARA ASIGNAR ITEMS EN LOTE -->
    <div id="assign-item-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-900 bg-opacity-50 no-print overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg my-8">
            <div class="p-4 border-b">
                <h3 id="assign-item-modal-title" class="text-lg font-bold text-gray-800">Asignar Item a Tareas</h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">Seleccione las tareas (del lote que firmó) a las que desea añadir este item:</p>
                <div id="assign-item-list" class="h-64 overflow-y-auto border rounded-md p-2 space-y-1 bg-gray-50">
                    <!-- La lista de tareas seleccionadas se generará aquí -->
                </div>
            </div>
            <div class="flex justify-end gap-2 p-4 bg-gray-50">
                <button id="assign-item-cancel" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg">Cancelar Asignación</button>
                <button id="assign-item-save" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Asignar y Continuar</button>
            </div>
        </div>
    </div>
    <!-- FIN: NUEVO MODAL -->


    <script type="module">
        import { initializeApp, setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getDatabase, 
            ref, 
            onValue, 
            set, 
            update, 
            remove, 
            get,
            push
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        // --- Configuración de Firebase Hardcodeada ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8",
            authDomain: "fah-980-ceb96.firebaseapp.com",
            databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
            projectId: "fah-980-ceb96",
            storageBucket: "fah-980-ceb96.firebasestorage.app",
            messagingSenderId: "57890484294",
            appId: "1:57890484294:web:8a27759a4da0b262e99a47",
            measurementId: "G-HSZMRM7ZCS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        setLogLevel('debug'); 

        const paperContainer = document.querySelector('.paper-container');
        const expiredListTableBody = document.getElementById('vencidas-list');
        const loadingMessage = document.getElementById('loading-message');
        const dateDisplay = document.getElementById('current-date');
        
        const signatureModal = document.getElementById('signature-modal');
        const signatureCanvas = document.getElementById('signature-canvas');
        const signatureNameInput = document.getElementById('signature-name');
        const signatureClearBtn = document.getElementById('signature-clear');
        const signatureCancelBtn = document.getElementById('signature-cancel');
        const signatureSaveBtn = document.getElementById('signature-save');
        let signaturePad;
        let activeSignatureCell = null;
        let isAuthReady = false; 

        const passwordModal = document.getElementById('password-modal');
        const passwordModalTitle = document.getElementById('password-modal-title');
        const passwordModalDescription = document.getElementById('password-modal-description');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const passwordCancelBtn = document.getElementById('password-cancel');
        const passwordConfirmBtn = document.getElementById('password-confirm');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');
        let confirmAction = () => {}; 

        // --- DOM para la tabla de items ---
        const missingItemsSection = document.getElementById('missing-items-section');
        const missingItemsList = document.getElementById('missing-items-list');

        // --- Modales para workflow de items ---
        const askModal = document.getElementById('ask-modal');
        const askModalTitle = document.getElementById('ask-modal-title');
        const askModalYesBtn = document.getElementById('ask-modal-yes');
        const askModalNoBtn = document.getElementById('ask-modal-no');

        const itemFormModal = document.getElementById('item-form-modal');
        const itemFormModalTitle = document.getElementById('item-form-modal-title');
        const itemNameInput = document.getElementById('item-name');
        const itemPartNumberInput = document.getElementById('item-part-number');
        const itemQuantityInput = document.getElementById('item-quantity');
        const itemFormError = document.getElementById('item-form-error');
        const itemFormSaveBtn = document.getElementById('item-form-save');
        const itemFormCancelBtn = document.getElementById('item-form-cancel');

        // --- INICIO: NUEVO MODAL DE ASIGNACIÓN ---
        const assignItemModal = document.getElementById('assign-item-modal');
        const assignItemModalTitle = document.getElementById('assign-item-modal-title');
        const assignItemList = document.getElementById('assign-item-list');
        const assignItemCancelBtn = document.getElementById('assign-item-cancel');
        const assignItemSaveBtn = document.getElementById('assign-item-save');
        // --- FIN: NUEVO MODAL DE ASIGNACIÓN ---


        // --- INICIO: NUEVAS VARIABLES GLOBALES DE ESTADO ---
        let activeInspectionDocId = null; // ID de la inspección que se está firmando
        let currentItemType = null; // 'consumible' o 'repuesto'
        
        // Almacena los datos de la última firma para el log de "No"
        let lastSignatureData = { name: '', dataUrl: '' }; 
        
        // Almacena el item a editar/borrar
        let itemToManage = { inspectionId: null, itemId: null, docId: null }; 
        let currentPasswordAction = ''; // 'deleteSignature', 'deleteItem', 'editItem'

        // --- INICIO: NUEVO ESTADO PARA ASIGNACIÓN EN LOTE ---
        let itemBeingAssigned = null; // Almacena {name, partNumber, quantity}
        // --- FIN: NUEVO ESTADO PARA ASIGNACIÓN EN LOTE ---

        // --- INICIO: NUEVAS VARIABLES PARA SELECCIÓN MÚLTIPLE ---
        let selectedInspections = new Set();
        let isBatchSigning = false;
        // --- FIN: NUEVAS VARIABLES PARA SELECCIÓN MÚLTIPLE ---

        // Caché de datos
        let allLoadedInspections = []; // Almacena todas las inspecciones cargadas
        let allLoadedMissingItems = []; // Almacena todos los items faltantes
        // --- FIN: NUEVAS VARIABLES GLOBALES DE ESTADO ---


        // --- INICIO: NUEVOS ELEMENTOS DOM PARA SELECCIÓN MÚLTIPLE ---
        const batchActionsContainer = document.getElementById('batch-actions-container');
        const selectionCountEl = document.getElementById('selection-count');
        const batchSignBtn = document.getElementById('batch-sign-btn');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        // --- FIN: NUEVOS ELEMENTOS DOM ---


        const DB_ROOT = "artifacts/FAH-980-DATA";
        const INSPECTIONS_PATH = `${DB_ROOT}/public_data/trabajos_vencidos`;
        const DETAILS_PATH = `${DB_ROOT}/public_data/orden_detalles`; 

        function getDetailsRef() {
            return ref(db, DETAILS_PATH);
        }
        
        function getInspectionRef(docId = null) {
            if (docId) {
                return ref(db, `${INSPECTIONS_PATH}/${docId}`);
            }
            return ref(db, INSPECTIONS_PATH);
        }
        
        // --- Botón de Imprimir Lista ---
        const printListBtn = document.getElementById('print-list-btn');
        if (printListBtn) {
            printListBtn.addEventListener('click', () => {
                document.body.classList.add('printing-missing-list');
                window.print();
            });
        }
        window.addEventListener('afterprint', () => {
            document.body.classList.remove('printing-missing-list');
        });

        const saveDetailsBtn = document.getElementById('save-details-btn');
        const detailFieldIds = [
            'fecha-inicio', 'fecha-finalizacion', 'modelo', 'eng1-sn-tsn-tso',
            'numero-serie', 'eng1-sn-csn-cso', 'matricula', 'eng2-sn-tsn-tso',
            'ac-tt', 'eng2-sn-csn-cso', 'tq-events', 'cbox-sn-tsn-tso',
            'landings', 'cbox-sn-csn-cs', 'elaborado-por', 'orden-trabajo-no',
            'ns-motor-1', 'ns-motor-2' 
        ];

        const currentDateStr = new Date().toLocaleString('es-HN');
        dateDisplay.textContent = currentDateStr;
        document.getElementById('fecha-inicio').textContent = currentDateStr;

        // --- AUTHENTICATION & DATA LOADING ---
        async function initializeAppAndData() {
            let auth;
            if (!firebaseConfig || !firebaseConfig.projectId || !firebaseConfig.databaseURL) {
                console.error("Error: Configuración de Firebase incompleta.", firebaseConfig);
                loadingMessage.textContent = "Error: Configuración de Firebase incompleta.";
                loadingMessage.classList.remove('hidden');
                return;
            }
            try {
                auth = getAuth(app); 
            } catch (authError) {
                console.error("Error fatal al inicializar 'getAuth(app)'.", authError);
                loadingMessage.textContent = "Error al conectar con los servicios de autenticación.";
                loadingMessage.classList.remove('hidden');
                return;
            }
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                isAuthReady = true;
                console.log("Autenticación exitosa. Iniciando carga de datos de RTDB.");
                loadOrderDetails();
                loadExpiredInspections();

            } catch (error) {
                console.error("Error durante el proceso de signIn:", error);
                loadingMessage.textContent = "Error al autenticarse. No se pueden cargar los datos.";
                loadingMessage.classList.remove('hidden');
            }
        }
        initializeAppAndData();

        // --- LOAD AND SAVE ORDER DETAILS ---
        function loadOrderDetails() {
            const detailsRef = getDetailsRef();
            onValue(detailsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    detailFieldIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && data[id] !== undefined) {
                            element.textContent = data[id];
                        }
                    });
                }
            }, (error) => {
                 console.error("Error al cargar detalles de la orden (RTDB):", error);
            });
        }

        saveDetailsBtn.addEventListener('click', () => {
            if (!isAuthReady) {
                console.warn("Conectando... por favor espere un momento.");
                return;
            }
            const dataToSave = {};
            detailFieldIds.forEach(id => {
                const element = document.getElementById(id);
                dataToSave[id] = element ? element.textContent.trim() : '';
            });
            
            const detailsRef = getDetailsRef();
            set(detailsRef, dataToSave)
                .then(() => {
                    saveDetailsBtn.textContent = '¡Guardado!';
                    saveDetailsBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    saveDetailsBtn.classList.add('bg-green-500');
                    setTimeout(() => {
                        saveDetailsBtn.textContent = 'Guardar Detalles';
                        saveDetailsBtn.classList.remove('bg-green-500');
                        saveDetailsBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }, 2000);
                })
                .catch((error) => {
                    console.error("Error guardando detalles (RTDB):", error);
                });
        });

        // --- LOAD EXPIRED INSPECTIONS ---
        function loadExpiredInspections() {
            const inspectionsRef = getInspectionRef();
            console.log(`[RTDB] Intentando cargar datos de la ruta: ${INSPECTIONS_PATH}`);

            onValue(inspectionsRef, (snapshot) => {
                loadingMessage.classList.add('hidden');
                
                const data = snapshot.val();
                allLoadedInspections = []; // Limpiar caché

                if (data) {
                    allLoadedInspections = Object.keys(data).map(key => ({
                        docId: key,
                        ...data[key]
                    }));
                }
                
                renderExpiredInspections(allLoadedInspections);
                renderMissingItemsTable(allLoadedInspections); 
            }, (error) => {
                console.error(`[RTDB ERROR] Fallo al leer la ruta ${INSPECTIONS_PATH}:`, error);
                loadingMessage.textContent = "Error al cargar la lista. Revise la consola (F12).";
                loadingMessage.classList.remove('hidden');
            });
        }
        
        function renderExpiredInspections(inspections) {
            expiredListTableBody.innerHTML = '';
            let signedCount = 0;
            let totalCount = 0;
            
            const inspectionsWithDocId = inspections.filter(item => item !== null);
            totalCount = inspectionsWithDocId.length;

            if (totalCount === 0) {
                expiredListTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            No hay inspecciones vencidas en este momento. ¡Buen trabajo!
                        </td>
                    </tr>
                `;
                updateProgressBar(0, 0); 
                return;
            }
            
            const groupedByTheme = inspectionsWithDocId.reduce((acc, item) => {
                const theme = item.tema || item.name || 'Inspecciones Generales'; 
                if (!acc[theme]) { acc[theme] = []; }
                acc[theme].push(item);
                return acc;
            }, {});
            
            const themeOrder = [
                'SCHEDULE INSPECTIONS', 'ENGINE 1 INSPECCIONES', 'ENGINE 2 INSPECCIONES', 'SPECIAL INSPECTIONS',
                'LUBRICACION', 'MISCELLANEOUS', 'DIRECTIVAS DE AERONAVEGABILIDAD Y BOLETINES DE SERVICIO', 'AIRWORTHINESS LIMITATIONS SCHEDULE', 'Inspecciones Generales'
            ];

            const sortedThemes = Object.keys(groupedByTheme).sort((a, b) => {
                const indexA = themeOrder.indexOf(a);
                const indexB = themeOrder.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            });


            let itemCounter = 1;

            for (const theme of sortedThemes) {
                const themeRow = document.createElement('tr');
                themeRow.className = 'bg-blue-100';
                themeRow.innerHTML = `<th colspan="5" class="px-4 py-2 text-left text-sm font-bold text-blue-800">${theme}</th>`;
                expiredListTableBody.appendChild(themeRow);

                groupedByTheme[theme].forEach((item) => {
                    if (item.signature && item.signature.signatureDataUrl) {
                        signedCount++;
                    }
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-red-50';
                    
                    const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(item.ref)}`;

                    let signatureContent = '';
                    if (item.signature && item.signature.signatureDataUrl) {
                        signatureContent = `
                            <img src="${item.signature.signatureDataUrl}" alt="Firma" />
                            <p class="text-xs mt-1 font-semibold">${item.signature.signatureName || ''}</p>
                        `;
                    }
                    
                    const accionTomadaContent = item.accionTomada || '';

                    row.innerHTML = `
                        <!-- INICIO: NUEVA CELDA DE CHECKBOX -->
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="row-checkbox rounded border-gray-300 shadow-sm focus:ring-blue-500" data-doc-id="${item.docId}">
                        </td>
                        <!-- FIN: NUEVA CELDA -->
                        <td class="px-4 py-3 text-center font-medium text-gray-900">${itemCounter++}</td>
                        <td class="px-4 py-3 font-medium text-gray-900">
                            ${item.name}
                            <p class="text-xs text-red-600 font-semibold">(Frecuencia: ${item.freqText} / Última vez: ${item.lastDone || 'N/A'})</p>
                        </td>
                        <td class="px-4 py-3">
                            <a href="${googleSearchUrl}" target="_blank" class="text-blue-600 hover:underline" title="Buscar referencia en Google">
                                ${item.ref}
                            </a>
                        </td>
                        <td class="px-4 py-3 editable-cell signature-cell text-center align-middle" data-doc-id="${item.docId}">${signatureContent}</td>
                        <td class="px-4 py-3 editable-cell accion-tomada-cell" contenteditable="true" data-doc-id="${item.docId}">${accionTomadaContent}</td>
                    `;
                    expiredListTableBody.appendChild(row);
                });
            }
            
            updateProgressBar(signedCount, totalCount);

            // --- INICIO: NUEVO ---
            // Re-vincular listeners para la selección
            setupSelectionListeners();
            // Actualizar la UI de selección (en caso de que la lista se recargue)
            updateSelectionUI();
            // --- FIN: NUEVO ---
        }

        // --- Renderizar Tabla de Items Faltantes (con botones de acción) ---
        function renderMissingItemsTable(inspections) {
            missingItemsList.innerHTML = '';
            allLoadedMissingItems = []; // Limpiar caché de items

            inspections.forEach(inspection => {
                if (inspection.itemsFaltantes) {
                    // Convertimos el objeto de RTDB a un array, guardando la clave (itemId)
                    Object.keys(inspection.itemsFaltantes).forEach(key => {
                        allLoadedMissingItems.push({
                            ...inspection.itemsFaltantes[key],
                            itemId: key, // ID del item (push key)
                            inspectionId: inspection.docId, // ID de la inspección
                            relatedJobName: inspection.name || 'Tarea desconocida' 
                        });
                    });
                }
            });

            if (allLoadedMissingItems.length === 0) {
                missingItemsSection.classList.add('hidden');
                return;
            }

            missingItemsSection.classList.remove('hidden'); 

            allLoadedMissingItems.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-purple-50';
                
                const typeLabel = item.type === 'consumible' ? 
                    '<span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 font-medium text-xs">Consumible</span>' : 
                    '<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium text-xs">Repuesto</span>';

                // --- INICIO: NUEVA LÓGICA PARA CELDA DE FIRMA ---
                let reportedByContent = '<span class="text-xs text-gray-400">N/A</span>';
                if (item.reportedBy && (item.reportedBy.name || item.reportedBy.signatureDataUrl)) {
                    if (item.reportedBy.signatureDataUrl) {
                        reportedByContent = `
                            <img src="${item.reportedBy.signatureDataUrl}" alt="Firma" />
                            <p class="text-xs mt-1 font-semibold">${item.reportedBy.name || ''}</p>
                        `;
                    } else {
                        // Fallback si solo hay nombre
                         reportedByContent = `<p class="text-xs mt-1 font-semibold">${item.reportedBy.name}</p>`;
                    }
                }
                // --- FIN: NUEVA LÓGICA PARA CELDA DE FIRMA ---

                row.innerHTML = `
                    <td class="px-4 py-3 text-gray-700">${item.relatedJobName}</td>
                    <td class="px-4 py-3">${typeLabel}</td>
                    <td class="px-4 py-3 font-medium text-gray-900">${item.name || 'N/A'}</td>
                    <td class="px-4 py-3 text-gray-600">${item.partNumber || 'N/A'}</td>
                    <td class="px-4 py-3 text-center font-medium text-gray-900">${item.quantity || '1'}</td>
                    <!-- INICIO: NUEVA CELDA -->
                    <td class="px-4 py-3 text-center align-middle">${reportedByContent}</td>
                    <!-- FIN: NUEVA CELDA -->
                    <td class="px-4 py-3 text-center no-print">
                        <button class="table-action-btn edit-btn edit-item-btn" data-item-id="${item.itemId}" data-inspection-id="${item.inspectionId}" title="Editar Item">Editar</button>
                        <button class="table-action-btn delete-btn delete-item-btn" data-item-id="${item.itemId}" data-inspection-id="${item.inspectionId}" title="Borrar Item">Borrar</button>
                    </td>
                `;
                missingItemsList.appendChild(row);
            });
        }

        function updateProgressBar(signed, total) {
            const percentage = total > 0 ? Math.round((signed / total) * 100) : 0;
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            if (progressBar && progressText) {
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}%`;
                
                if (percentage === 100) {
                    progressBar.classList.remove('bg-blue-600');
                    progressBar.classList.add('bg-green-600');
                } else {
                    progressBar.classList.remove('bg-green-600');
                    progressBar.classList.add('bg-blue-600');
                }
            }
        }

        // --- INICIO: NUEVO EVENT LISTENER PARA ABRIR MODAL DE FIRMA ---
        
        /**
         * Listener delegado para las celdas de firma en la tabla.
         * Abre el modal para firmar o el modal de clave para borrar.
         */
        expiredListTableBody.addEventListener('click', (e) => {
            const signatureCell = e.target.closest('.signature-cell');
            if (signatureCell) {
                // Prevenir que se abra si hay una firma (para borrar, se usará otro método)
                const hasSignature = signatureCell.querySelector('img');
                
                if (!hasSignature) {
                    // No hay firma, abrir modal para firmar
                    openSignatureModal(signatureCell);
                } else {
                    // Ya hay firma, abrir modal de clave para borrar
                    itemToManage = { docId: signatureCell.dataset.docId };
                    currentPasswordAction = 'deleteSignature';
                    
                    passwordModalTitle.textContent = 'Borrar Firma';
                    passwordModalDescription.textContent = 'Para borrar esta firma, ingrese la clave de supervisor.';
                    passwordConfirmBtn.textContent = 'Confirmar Borrado';
                    passwordInput.value = '';
                    passwordError.textContent = '';
                    passwordModal.classList.remove('hidden');
                    passwordInput.focus();
                }
            }
        });

        /**
         * Listeners para las firmas del footer (Supervisor / Inspector).
         */
        document.querySelectorAll('.footer-signature-area').forEach(area => {
            area.addEventListener('click', () => {
                const hasSignature = area.querySelector('img');
                if (!hasSignature) {
                    openSignatureModal(area);
                }
                // Nota: No se implementa borrado en firmas de footer,
                // ya que son solo UI y no están ligadas a un docId.
                // Se sobreescriben si se vuelve a firmar.
            });
        });
        // --- FIN: NUEVO EVENT LISTENER ---


        // --- Guardar "Acción Tomada" en Blur ---
        expiredListTableBody.addEventListener('blur', (e) => {
            if (!isAuthReady) return;
            if (e.target && e.target.classList.contains('accion-tomada-cell')) {
                const docId = e.target.dataset.docId;
                const text = e.target.textContent.trim();
                if (docId) {
                    const inspectionRef = getInspectionRef(docId);
                    update(inspectionRef, {
                        accionTomada: text
                    }).catch(error => console.error("Error guardando acción tomada (RTDB):", error));
                }
            }
        }, true);
        
        // --- Manejo de Firma (Modal) ---
        function openSignatureModal(cell) {
            activeSignatureCell = cell;
            
            const modalTitle = document.getElementById('signature-modal-title');
            const nameLabel = document.querySelector('#signature-modal label[for="signature-name"]');
            const title = cell.dataset.title;

            if (title === 'Inspector') {
                modalTitle.textContent = 'Firma del Inspector';
                nameLabel.textContent = 'Nombre del Inspector';
            } else if (title === 'Supervisor') {
                 modalTitle.textContent = 'Firma del Supervisor';
                 nameLabel.textContent = 'Nombre del Supervisor';
            } else { 
                modalTitle.textContent = 'Firma del Mecánico';
                nameLabel.textContent = 'Nombre del Mecánico';
            }

            signatureModal.classList.remove('hidden');
            signatureNameInput.value = '';
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            signatureCanvas.width = signatureCanvas.offsetWidth * ratio;
            signatureCanvas.height = signatureCanvas.offsetHeight * ratio;
            signatureCanvas.getContext("2d").scale(ratio, ratio);
            
            try {
                signaturePad = new SignaturePad(signatureCanvas, {
                    backgroundColor: 'rgb(255, 255, 255)'
                });
            } catch (padError) {
                console.error("Error al inicializar SignaturePad.", padError);
            }
        }

        // --- INICIO: Lógica de "No reportó faltantes" ---
        
        /**
         * Registra en la celda "Acción Tomada" que no se reportaron items.
         */
        function logNoItemsReported() {
            if (activeInspectionDocId && lastSignatureData.name) {
                const cell = document.querySelector(`.accion-tomada-cell[data-doc-id="${activeInspectionDocId}"]`);
                if (cell) {
                    let newText = cell.textContent.trim();
                    const logEntry = `No se reportaron faltantes. Firmado: ${lastSignatureData.name}`;
                    
                    if (!newText.includes(logEntry)) {
                        newText = newText ? `${newText}. ${logEntry}` : logEntry;
                    }
                    
                    cell.textContent = newText;
                    
                    const inspectionRef = getInspectionRef(activeInspectionDocId);
                    update(inspectionRef, {
                        accionTomada: newText
                    }).catch(error => console.error("Error guardando 'Acción Tomada' por 'No':", error));
                }
            }
        }
        
        /**
         * Cierra el modal de firma y limpia las variables temporales.
         */
        function closeSignatureModal() {
            signatureModal.classList.add('hidden');
            if(signaturePad){
                signaturePad.clear();
                signaturePad.off();
            }
            signatureNameInput.value = '';
            activeSignatureCell = null;
            // --- INICIO: MODIFICACIÓN ---
            // Limpiar solo si NO estamos en modo de firma en lote
            // (porque en lote, necesitamos los datos de la firma para el reporte de items).
            if (!isBatchSigning) {
                lastSignatureData = { name: '', dataUrl: '' }; // Limpiar datos de firma temporal
            }
            // --- FIN: MODIFICACIÓN ---
        }
        // --- FIN: Lógica de "No reportó faltantes" ---
        
        signatureCancelBtn.addEventListener('click', () => {
            isBatchSigning = false; // <-- AÑADIDO
            closeSignatureModal();
        });
        
        signatureSaveBtn.addEventListener('click', async () => { // <-- AÑADIDO 'async'
            if (!isAuthReady) {
                console.warn("Conectando... por favor espere un momento.");
                return;
            }
            const name = signatureNameInput.value.trim();
            if (signaturePad && !signaturePad.isEmpty() && name) {
                
                const dataURL = signaturePad.toDataURL('image/png');
                const signatureData = {
                    signatureDataUrl: dataURL,
                    signatureName: name
                };

                // --- INICIO: NUEVA LÓGICA DE FIRMA EN LOTE ---
                if (isBatchSigning) {
                    
                    // 1. Guardar datos de firma temporalmente (para reporte de items en lote)
                    lastSignatureData.name = name;
                    lastSignatureData.dataUrl = dataURL;
                    
                    // 2. Deshabilitar botones para evitar clics múltiples
                    signatureSaveBtn.textContent = 'Firmando...';
                    
                    const promises = [];
                    for (const docId of selectedInspections) {
                        const inspectionRef = getInspectionRef(docId);
                        promises.push(
                            update(inspectionRef, { signature: signatureData })
                        );
                    }
                    
                    try {
                        await Promise.all(promises);
                        console.log(`Firmadas ${promises.length} tareas.`);
                        
                        // --- INICIO: MODIFICACIÓN ---
                        // 3. NO limpiar la selección todavía.
                        // selectedInspections.clear(); <-- REMOVIDO
                        // updateSelectionUI(); <-- REMOVIDO
                        
                        // 4. Cerrar modal de firma e iniciar reporte de items en lote
                        closeSignatureModal(); 
                        openAskModal('consumible', '¿Faltó algún consumible para este LOTE de tareas?');
                        // --- FIN: MODIFICACIÓN ---

                    } catch (error) {
                        console.error("Error durante la firma en lote:", error);
                        // Si falla, limpiar todo
                        cleanupBatchMode();
                    } 
                    // --- INICIO: MODIFICACIÓN ---
                    // Se ha quitado el bloque 'finally' de aquí, 
                    // la limpieza se hará con cleanupBatchMode() al final del workflow de items.
                    // --- FIN: MODIFICACIÓN ---

                // --- FIN: NUEVA LÓGICA DE FIRMA EN LOTE ---

                } else if (activeSignatureCell) { 
                    // --- INICIO: LÓGICA ANTERIOR (FIRMA ÚNICA) ---
                    const docId = activeSignatureCell.dataset.docId; 

                    if (docId) {
                        update(getInspectionRef(docId), {
                            signature: signatureData
                        })
                            .then(() => {
                                // --- INICIO: Nuevo Workflow ---
                                // 1. Guardar datos de firma temporalmente
                                lastSignatureData.name = name;
                                lastSignatureData.dataUrl = dataURL;
                                activeInspectionDocId = docId; 
                                
                                // 1. Cerramos el modal de firma AHORA.
                                closeSignatureModal(); 
                                
                                // 2. Abrimos el siguiente modal.
                                openAskModal('consumible', '¿Faltó algún consumible para esta tarea?');
                            })
                            .catch(error => {
                                console.error("Error guardando firma (RTDB):", error);
                            });
                    } else { 
                        // Fallback for footer signatures (UI only)
                        activeSignatureCell.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = dataURL;
                        img.alt = 'Firma';
                        const nameElement = document.createElement('p');
                        nameElement.className = 'text-xs mt-1 font-semibold';
                        nameElement.textContent = name;
                        activeSignatureCell.appendChild(img);
                        activeSignatureCell.appendChild(nameElement);
                        closeSignatureModal();
                    }
                    // --- FIN: LÓGICA ANTERIOR (FIRMA ÚNICA) ---
                }

            } else {
                console.warn("Por favor, dibuje su firma y escriba su nombre antes de guardar.");
            }
        });

        // --- Manejo de Modales (Contraseña, Confirmar) ---
        passwordCancelBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            itemToManage = {};
            currentPasswordAction = '';
        });

        passwordConfirmBtn.addEventListener('click', () => {
            const password = passwordInput.value;
            if (password === "Kevin") { // Clave hardcodeada
                switch (currentPasswordAction) {
                    case 'deleteSignature':
                        if (itemToManage.docId) {
                            const inspectionRef = getInspectionRef(itemToManage.docId);
                            update(inspectionRef, { signature: null });
                        }
                        break;
                    
                    case 'deleteItem':
                        if (itemToManage.inspectionId && itemToManage.itemId) {
                            const itemRef = ref(db, `${INSPECTIONS_PATH}/${itemToManage.inspectionId}/itemsFaltantes/${itemToManage.itemId}`);
                            remove(itemRef);
                        }
                        break;
                        
                    case 'editItem':
                        const item = allLoadedMissingItems.find(i => i.itemId === itemToManage.itemId);
                        if (item) {
                            itemFormModalTitle.textContent = "Editar Item Faltante";
                            itemNameInput.value = item.name;
                            itemPartNumberInput.value = item.partNumber;
                            itemQuantityInput.value = item.quantity;
                            itemFormError.textContent = '';
                            
                            // Cambiar comportamiento del botón Guardar
                            itemFormSaveBtn.textContent = 'Actualizar Item';
                            itemFormSaveBtn.removeEventListener('click', handleSaveNewItem); 
                            itemFormSaveBtn.addEventListener('click', handleUpdateItem); 
                            
                            itemFormModal.classList.remove('hidden');
                        }
                        break;
                }
                passwordModal.classList.add('hidden');
                itemToManage = {};
                currentPasswordAction = '';
            } else {
                passwordError.textContent = "Clave incorrecta.";
                passwordInput.value = '';
                setTimeout(() => { passwordError.textContent = ''; }, 3000);
            }
        });

        confirmModalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmAction = () => {};
        });

        confirmModalOkBtn.addEventListener('click', () => {
            confirmAction();
            confirmModal.classList.add('hidden');
            confirmAction = () => {};
        });

        // --- Archivar Trabajos ---
        const archiveBtn = document.getElementById('archive-btn');
        archiveBtn.addEventListener('click', () => {
            if (!isAuthReady) {
                console.warn("Conectando... por favor espere un momento.");
                return;
            }

            confirmModalTitle.textContent = '¿Seguro que desea archivar? Esto limpiará la lista actual.';
            confirmAction = async () => {
                const inspectionsRef = getInspectionRef();
                const inspectionsSnapshot = await get(inspectionsRef);
                const inspectionsData = inspectionsSnapshot.val();

                if (!inspectionsData) {
                    console.warn("No hay trabajos para archivar.");
                    return;
                }
                
                const inspectionsToArchive = Object.keys(inspectionsData).map(key => ({
                    docId: key, 
                    ...inspectionsData[key]
                }));

                const detailsToArchive = {};
                detailFieldIds.forEach(id => {
                    const element = document.getElementById(id);
                    detailsToArchive[id] = element ? element.textContent.trim() : '';
                });

                if (inspectionsToArchive.length > 0) {
                    const timestamp = new Date().toISOString().replace(/[.:]/g, '-');
                    const archivePath = `${DB_ROOT}/historial_ordenes/${timestamp}`;
                    const archiveRef = ref(db, archivePath);
                    
                    const archiveData = {
                        details: detailsToArchive,
                        inspections: inspectionsToArchive,
                        archivedAt: new Date().toISOString()
                    };

                    set(archiveRef, archiveData)
                        .then(async () => {
                            await remove(inspectionsRef);
                            console.log("Trabajos archivados y lista actual limpiada con éxito.");
                        })
                        .catch((error) => {
                            console.error("Error al archivar (RTDB):", error);
                        });
                } 
            };
            confirmModal.classList.remove('hidden');
        });

        // --- Generar Reporte ---
        const reportBtn = document.getElementById('report-btn');
        reportBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                console.warn("Conectando... por favor espere un momento.");
                return;
            }
            
            // Usamos el caché global
            if (!allLoadedInspections || allLoadedInspections.length === 0) {
                console.warn("No hay inspecciones en la lista para generar un reporte.");
                return;
            }
            
            generateDiscrepancyReport(allLoadedInspections);
        });

        function generateDiscrepancyReport(inspections) {
            const matricula = document.getElementById('matricula').textContent || 'FAH-980'; 
            const fecha = new Date().toLocaleDateString('es-HN', { day: '2-digit', month: 'short', year: '2-digit' }).replace('.', '').toUpperCase();
            const inspectionsArray = inspections.filter(item => item !== null);

            let reportContent = `
                <!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Reporte - ${matricula}</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 11px; counter-reset: page-counter; }
                    .report-container { width: 100%; max-width: 8.5in; margin: auto; display: flex; flex-direction: column; min-height: 10.5in; }
                    .report-body { flex-grow: 1; }
                    .header { text-align: center; }
                    .header h1, .header h2, .header h3 { margin: 1px 0; font-weight: bold; }
                    .header h1 { font-size: 16px; } .header h2 { font-size: 14px; } .header h3 { font-size: 12px; font-weight: normal; }
                    .info-table { width: 100%; margin-top: 15px; margin-bottom: 15px; border: none; }
                    .info-table td { font-size: 12px; font-weight: bold; }
                    .notification { font-size: 12px; margin-bottom: 10px; }
                    .data-table { width: 100%; border-collapse: collapse; border: 2px solid black; }
                    .data-table th { color: white; text-align: left; padding: 6px; font-size: 14px; border: 2px solid black; }
                    .data-table td { border: 1.5px solid black; padding: 5px; vertical-align: top; }
                    .data-table .num { font-weight: bold; text-align: center; width: 45px; }
                    .discrepancy-table th { background-color: #2E75B5; }
                    .discrepancy-table td { background-color: #FFC000; }
                    .corrective-table { margin-top: 20px; }
                    .corrective-table th { background-color: #00B050; }
                    .corrective-table td { background-color: #E2EFDA; }
                    .corrective-table .mechanic-sig { text-align: center; width: 150px; }
                    .corrective-table .mechanic-sig img { max-height: 30px; display: block; margin: 0 auto 2px; }
                    .corrective-table .mechanic-sig p { font-size: 9px; margin: 0; line-height: 1; }
                    .signatures-container { margin-top: 30px; font-size: 10px; }
                    .official-signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 40px 60px; margin-top: 30px; text-align: center; }
                    .official-signatures div { padding-top: 40px; border-top: 1px solid black; }
                    @media print {
                        body { margin: 0.5in; } .no-print { display: none; }
                        .page-footer { position: fixed; bottom: 0.25in; right: 0.5in; font-size: 10px; }
                        .page-footer::after { counter-increment: page-counter; content: "Página " counter(page-counter); }
                    }
                </style></head><body>
                <div class="report-container">
                    <div class="report-body">
                        <div class="header">
                            <h1>FUERZAS ARMADAS DE HONDURAS</h1>
                            <h2>FUERZA AÉREA HONDUREÑA</h2>
                            <h3>Base Aérea "Coronel Hernán Acosta Mejía"</h3>
                            <h2>REPORTE DE TRABAJO EFECTUADO</h2>
                        </div>
                        <table class="info-table">
                            <tr><td>AVION No. Bell-412 ${matricula}</td><td style="text-align: right;">FECHA: ${fecha}</td></tr>
                        </table>
                        <p class="notification">El Taller / Sección Helicópteros notifica que el trabajo:</p>
                        <table class="data-table discrepancy-table">
                            <thead><tr><th colspan="2">Discrepancia:</th></tr></thead>
                            <tbody>
            `;
            
            const groupedByTheme = inspectionsArray.reduce((acc, item) => {
                const theme = item.tema || item.name || 'Inspecciones Generales';
                if (!acc[theme]) { acc[theme] = []; }
                acc[theme].push(item);
                return acc;
            }, {});

            const themeOrder = [
                'SCHEDULE INSPECTIONS', 'ENGINE 1 INSPECCIONES', 'ENGINE 2 INSPECCIONES', 'SPECIAL INSPECTIONS',
                'LUBRICACION', 'MISCELLANEOUS', 'DIRECTIVAS DE AERONAVEGABILIDAD Y BOLETINES DE SERVICIO', 'AIRWORTHINESS LIMITATIONS SCHEDULE', 'Inspecciones Generales'
            ];
            
            const sortedThemes = Object.keys(groupedByTheme).sort((a, b) => {
                const indexA = themeOrder.indexOf(a);
                const indexB = themeOrder.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            });

            const generateDiscrepancyTableRows = () => {
                let content = ''; let themeCounter = 1;
                for (const theme of sortedThemes) {
                    let itemCounter = 1;
                    content += `<tr><td class="num">${themeCounter}.</td><td><strong>${theme}</strong></td></tr>`;
                    groupedByTheme[theme].forEach(item => {
                        content += `<tr><td class="num">${themeCounter}.${itemCounter++}</td><td>Efectuar ${item.name} / ${item.ref}</td></tr>`;
                    });
                    themeCounter++;
                }
                return content;
            };

            reportContent += generateDiscrepancyTableRows();
            reportContent += `</tbody></table><table class="data-table corrective-table"><thead><tr><th colspan="2">Acción Correctiva:</th><th>Técnico Especialista</th></tr></thead><tbody>`;

            const generateCorrectiveTableRows = () => {
                let content = ''; let themeCounter = 1;
                for (const theme of sortedThemes) {
                    let itemCounter = 1;
                    content += `<tr><td class="num">${themeCounter}.</td><td colspan="2"><strong>${theme}</strong></td></tr>`;
                    groupedByTheme[theme].forEach(item => {
                        const signatureCell = (item.signature && item.signature.signatureDataUrl)
                            ? `<td class="mechanic-sig"><img src="${item.signature.signatureDataUrl}" alt="Firma"><p>${item.signature.signatureName || ''}</p></td>`
                            : '<td></td>';
                        content += `<tr><td class="num">${themeCounter}.${itemCounter++}</td><td>Se completó ${item.name} / ${item.ref}</td>${signatureCell}</tr>`;
                    });
                    themeCounter++;
                }
                return content;
            };
            
            reportContent += generateCorrectiveTableRows();
            reportContent += `
                                </tbody></table></div>
                        <footer class="signatures-container">
                             <div class="official-signatures">
                                  <div><p>SUPERVISOR</p></div><div><p>INSPECTOR</p></div>
                                  <div><p>JEFE TALLER / SECCION</p></div><div><p>JEFE DE LOGISTICA A-4</p></div>
                             </div>
                        </footer>
                    </div><div class="page-footer"></div>
                    <button class."no-print" onclick="window.print()" style="position: fixed; top: 10px; right: 10px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px;">Imprimir Reporte</button>
                </body></html>
            `;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.open();
            reportWindow.document.write(reportContent);
            reportWindow.document.close();
        }

        // --- Lógica para Items Faltantes (Consumibles / Repuestos) ---

        function openAskModal(type, title) {
            currentItemType = type; 
            askModalTitle.textContent = title;
            askModal.classList.remove('hidden');
        }
        function closeAskModal() {
            askModal.classList.add('hidden');
        }
        
        function openItemFormModal() {
            const title = currentItemType === 'consumible' ? 'Añadir Consumible Faltante' : 'Añadir Repuesto Faltante';
            itemFormModalTitle.textContent = title;
            
            itemNameInput.value = '';
            itemPartNumberInput.value = '';
            itemQuantityInput.value = '1';
            itemFormError.textContent = '';
            
            // Asegurar que el botón de guardar esté en modo "Crear"
            itemFormSaveBtn.textContent = 'Guardar Item';
            itemFormSaveBtn.removeEventListener('click', handleUpdateItem);
            itemFormSaveBtn.addEventListener('click', handleSaveNewItem);
            
            itemFormModal.classList.remove('hidden');
            itemNameInput.focus();
        }

        function closeItemFormModal() {
            itemFormModal.classList.add('hidden');
            // Resetear el botón de guardar a su estado original (crear)
            itemFormSaveBtn.textContent = 'Guardar Item';
            itemFormSaveBtn.removeEventListener('click', handleUpdateItem);
            itemFormSaveBtn.addEventListener('click', handleSaveNewItem);
        }

        // --- Event Listeners para Modales de Items ---
        askModalYesBtn.addEventListener('click', () => {
            closeAskModal();
            openItemFormModal(); 
        });

        askModalNoBtn.addEventListener('click', () => {
            closeAskModal();
            
            // --- INICIO: LÓGICA DE LOTE ---
            if (isBatchSigning) {
                if (currentItemType === 'consumible') {
                    openAskModal('repuesto', '¿Faltó algún repuesto para este LOTE de tareas?');
                } else {
                    // Último paso (repuestos)
                    logNoItemsReportedBatch(); // <-- Nueva función
                    cleanupBatchMode(); // <-- Nueva función
                }
            // --- FIN: LÓGICA DE LOTE ---
            
            } else { // --- LÓGICA ORIGINAL (SINGLE) ---
                if (currentItemType === 'consumible') {
                    openAskModal('repuesto', '¿Faltó algún repuesto para esta tarea?');
                } else {
                    logNoItemsReported();
                    activeInspectionDocId = null;
                    currentItemType = null;
                }
            }
        });

        itemFormCancelBtn.addEventListener('click', () => {
            closeItemFormModal();
            
            // --- INICIO: LÓGICA DE LOTE ---
            if (isBatchSigning) {
                // Si cancelamos el formulario, continuamos al siguiente paso
                continueBatchWorkflow();
            // --- FIN: LÓGICA DE LOTE ---

            } else { // --- LÓGICA ORIGINAL (SINGLE) ---
                if (currentItemType === 'consumible') {
                    openAskModal('repuesto', '¿Faltó algún repuesto para esta tarea?');
                } else {
                    logNoItemsReported(); // <-- LOG "NO" (al cancelar el último paso)
                    activeInspectionDocId = null;
                    currentItemType = null;
                }
            }
        });

        // --- INICIO: Lógica separada para Guardar/Actualizar Items ---
        
        /**
         * Manejador para CREAR un nuevo item faltante.
         */
        async function handleSaveNewItem() {
            const name = itemNameInput.value.trim();
            const partNumber = itemPartNumberInput.value.trim();
            const quantity = itemQuantityInput.value.trim();

            if (!name || !quantity) {
                itemFormError.textContent = 'El Nombre y la Cantidad son obligatorios.';
                setTimeout(() => { itemFormError.textContent = ''; }, 3000);
                return;
            }

            // --- INICIO: LÓGICA DE LOTE (MODIFICADA) ---
            if (isBatchSigning) {
                if (!currentItemType) {
                    console.error("Error: currentItemType es nulo en modo lote.");
                    return;
                }
                
                // 1. Guardar datos del item temporalmente
                itemBeingAssigned = { name, partNumber, quantity };
                
                // 2. Cerrar modal de formulario
                closeItemFormModal();
                
                // 3. Abrir nuevo modal para asignar el item
                openAssignItemModal();

                // (La lógica de 'promises' se movió a 'handleAssignItemSave')
            // --- FIN: LÓGICA DE LOTE ---
            
            } else if (activeInspectionDocId) { // --- LÓGICA ORIGINAL (SINGLE) ---
                await saveMissingItem(activeInspectionDocId, currentItemType, { name, partNumber, quantity });
                
                closeItemFormModal();

                if (currentItemType === 'consumible') {
                    openAskModal('repuesto', '¿Faltó algún repuesto para esta tarea?');
                } else {
                    activeInspectionDocId = null;
                    currentItemType = null;
                }
            } else {
                console.error("Error: No se encontró activeInspectionDocId y no está en modo lote.");
            }
        }
        
        /**
         * Manejador para ACTUALIZAR un item existente (desde el modal de clave).
         */
        async function handleUpdateItem() {
            const name = itemNameInput.value.trim();
            const partNumber = itemPartNumberInput.value.trim();
            const quantity = itemQuantityInput.value.trim();

            if (!name || !quantity) {
                itemFormError.textContent = 'El Nombre y la Cantidad son obligatorios.';
                setTimeout(() => { itemFormError.textContent = ''; }, 3000);
                return;
            }

            if (!itemToManage.inspectionId || !itemToManage.itemId) {
                console.error("Error: No se encontró itemToManage.inspectionId o itemId para actualizar.");
                closeItemFormModal();
                return;
            }

            // Referencia al item específico
            const itemRef = ref(db, `${INSPECTIONS_PATH}/${itemToManage.inspectionId}/itemsFaltantes/${itemToManage.itemId}`);
            
            try {
                // Actualizamos solo los campos del formulario
                await update(itemRef, {
                    name: name,
                    partNumber: partNumber,
                    quantity: quantity
                });
                console.log("Item actualizado con éxito.");
            } catch (error) {
                console.error("Error actualizando item (RTDB):", error);
            }
            
            closeItemFormModal();
            itemToManage = {}; // Limpiar el item en gestión
        }
        
        // Asignar el manejador de "crear" por defecto
        itemFormSaveBtn.addEventListener('click', handleSaveNewItem);


        /**
         * Guarda un nuevo item en RTDB usando push.
         */
        async function saveMissingItem(docId, type, item) {
            if (!docId) return;
            const itemsListRef = ref(db, `${INSPECTIONS_PATH}/${docId}/itemsFaltantes`);
            const newItem = {
                type: type,
                name: item.name,
                partNumber: item.partNumber,
                quantity: item.quantity,
                addedAt: new Date().toISOString(),
                // --- INICIO: NUEVOS CAMPOS ---
                reportedBy: {
                    name: lastSignatureData.name || 'N/A',
                    signatureDataUrl: lastSignatureData.dataUrl || null
                }
                // --- FIN: NUEVOS CAMPOS ---
            };
            try {
                await push(itemsListRef, newItem);
                console.log("Item faltante guardado con éxito.");
            } catch (error) {
                console.error("Error guardando item faltante (RTDB):", error);
            }
        }
        
        // --- FIN: Lógica separada Guardar/Actualizar ---


        // --- INICIO: Event Listener para botones de Editar/Borrar Item ---
        
        missingItemsList.addEventListener('click', (e) => {
            const target = e.target;
            
            // Botón BORRAR
            if (target.classList.contains('delete-item-btn')) {
                itemToManage = {
                    inspectionId: target.dataset.inspectionId,
                    itemId: target.dataset.itemId
                };
                currentPasswordAction = 'deleteItem';
                
                passwordModalTitle.textContent = 'Confirmar Borrado';
                passwordModalDescription.textContent = 'Para borrar este item, ingrese la clave de supervisor.';
                passwordConfirmBtn.textContent = 'Confirmar Borrado';
                passwordInput.value = '';
                passwordError.textContent = '';
                passwordModal.classList.remove('hidden');
                passwordInput.focus();
            }
            
            // Botón EDITAR
            if (target.classList.contains('edit-item-btn')) {
                itemToManage = {
                    inspectionId: target.dataset.inspectionId,
                    itemId: target.dataset.itemId
                };
                currentPasswordAction = 'editItem';
                
                passwordModalTitle.textContent = 'Confirmar Edición';
                passwordModalDescription.textContent = 'Para editar este item, ingrese la clave de supervisor.';
                passwordConfirmBtn.textContent = 'Confirmar';
                passwordInput.value = '';
                passwordError.textContent = '';
                passwordModal.classList.remove('hidden');
                passwordInput.focus();
            }
        });
        
        // --- FIN: Event Listener para botones de Editar/Borrar Item ---


        // --- INICIO: NUEVAS FUNCIONES DE LOTE ---
        
        /**
         * Registra "No se reportaron faltantes" en la celda "Acción Tomada"
         * para TODAS las inspecciones seleccionadas en el lote.
         */
        function logNoItemsReportedBatch() {
            if (!lastSignatureData.name) return; // No hay firma, no se puede loggear

            const logEntry = `No se reportaron faltantes. Firmado: ${lastSignatureData.name}`;
            const promises = [];

            for (const docId of selectedInspections) {
                let newText = '';
                // Intentar actualizar la UI si la celda está visible
                const cell = document.querySelector(`.accion-tomada-cell[data-doc-id="${docId}"]`);
                if (cell) {
                    newText = cell.textContent.trim();
                } else {
                    // Si no está visible, buscar en el caché
                    const inspection = allLoadedInspections.find(insp => insp.docId === docId);
                    if (inspection) {
                        newText = inspection.accionTomada || '';
                    }
                }
                
                if (!newText.includes(logEntry)) {
                    newText = newText ? `${newText}. ${logEntry}` : logEntry;
                }
                
                if (cell) {
                    cell.textContent = newText; // Actualizar UI
                }
                
                const inspectionRef = getInspectionRef(docId);
                promises.push(update(inspectionRef, { accionTomada: newText }));
            }

            Promise.all(promises)
                .then(() => console.log(`'No Faltantes' loggeado para ${promises.length} tareas.`))
                .catch(error => console.error("Error loggeando 'No Faltantes' en lote:", error));
        }

        /**
         * Limpia y resetea el estado después de completar un workflow en lote.
         */
        function cleanupBatchMode() {
            console.log("Finalizando modo de firma en lote.");
            isBatchSigning = false;
            selectedInspections.clear();
            updateSelectionUI(); // Esto des-seleccionará todo y ocultará el botón
            
            // Limpiar variables globales
            currentItemType = null;
            lastSignatureData = { name: '', dataUrl: '' }; // Ahora sí limpiamos
            itemBeingAssigned = null; // <-- NUEVO
            
            // Volver a habilitar botones del modal de firma (que ya está cerrado)
            signatureSaveBtn.disabled = false;
            signatureCancelBtn.disabled = false;
            signatureSaveBtn.textContent = 'Guardar Firma';
        }
        
        /**
         * Función helper para continuar el workflow de lote 
         * (ir a repuestos o finalizar).
         */
        function continueBatchWorkflow() {
            if (currentItemType === 'consumible') {
                openAskModal('repuesto', '¿Faltó algún repuesto para este LOTE de tareas?');
            } else {
                // Este era el último paso (repuestos)
                cleanupBatchMode();
            }
        }

        // --- FIN: NUEVAS FUNCIONES DE LOTE ---


        // --- INICIO: NUEVAS FUNCIONES PARA ASIGNAR ITEMS EN LOTE ---
        
        /**
         * Abre el modal para seleccionar a qué tareas del lote 
         * se asignará el item recién creado.
         */
        function openAssignItemModal() {
            if (!itemBeingAssigned) return;

            assignItemModalTitle.textContent = `Asignar: "${itemBeingAssigned.name}" (Cant: ${itemBeingAssigned.quantity})`;
            assignItemList.innerHTML = ''; // Limpiar lista

            let hasItems = false;
            for (const docId of selectedInspections) {
                const inspection = allLoadedInspections.find(insp => insp.docId === docId);
                if (inspection) {
                    hasItems = true;
                    const li = document.createElement('li');
                    li.className = 'flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer';
                    li.innerHTML = `
                        <input type="checkbox" data-doc-id="${docId}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3" checked>
                        <label class="text-sm font-medium text-gray-800 flex-1 cursor-pointer">${inspection.name}</label>
                    `;
                    // Permitir clic en toda la fila
                    li.addEventListener('click', (e) => {
                        const cb = li.querySelector('input');
                        if (e.target !== cb) {
                            cb.checked = !cb.checked;
                        }
                    });
                    assignItemList.appendChild(li);
                }
            }
            
            // Añadir helpers de "Seleccionar Todo / Ninguno"
            if (hasItems) {
                const helperRow = document.createElement('div');
                helperRow.className = 'flex justify-end gap-4 mt-2 pt-2 border-t';
                helperRow.innerHTML = `
                    <button id="assign-select-all" class="text-xs text-blue-600 font-medium hover:underline">Seleccionar Todos</button>
                    <button id="assign-select-none" class="text-xs text-gray-600 font-medium hover:underline">No Seleccionar Ninguno</button>
                `;
                assignItemList.prepend(helperRow);
                
                // Asignar listeners a los nuevos botones (solo una vez)
                helperRow.querySelector('#assign-select-all').addEventListener('click', () => {
                    assignItemList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                });
                helperRow.querySelector('#assign-select-none').addEventListener('click', () => {
                    assignItemList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                });
            }

            assignItemModal.classList.remove('hidden');
        }
        
        /**
         * Cierra el modal de asignación y limpia el item temporal.
         */
        function closeAssignItemModal() {
            assignItemModal.classList.add('hidden');
            itemBeingAssigned = null;
            assignItemList.innerHTML = ''; // Limpiar para la próxima vez
        }
        
        /**
         * Manejador para el botón "Asignar y Continuar" del nuevo modal.
         * Guarda el item solo en las tareas seleccionadas.
         */
        async function handleAssignItemSave() {
            if (!itemBeingAssigned || !isBatchSigning) return;

            const checkedBoxes = assignItemList.querySelectorAll('input[type="checkbox"]:checked');
            const promises = [];

            for (const cb of checkedBoxes) {
                const docId = cb.dataset.docId;
                if (docId) {
                    promises.push(saveMissingItem(docId, currentItemType, itemBeingAssigned));
                }
            }

            if (promises.length > 0) {
                try {
                    await Promise.all(promises);
                    console.log(`Item '${itemBeingAssigned.name}' asignado a ${promises.length} tareas.`);
                } catch (error) {
                    console.error("Error asignando item en lote:", error);
                }
            }

            closeAssignItemModal();
            continueBatchWorkflow(); // <-- Continuar a repuestos o finalizar
        }

        /**
         * Manejador para el botón "Cancelar" del nuevo modal.
         * Simplemente continúa al siguiente paso sin guardar el item.
         */
        function handleAssignItemCancel() {
            closeAssignItemModal();
            continueBatchWorkflow(); // <-- Continuar a repuestos o finalizar
        }
        
        // Asignar los nuevos listeners
        assignItemSaveBtn.addEventListener('click', handleAssignItemSave);
        assignItemCancelBtn.addEventListener('click', handleAssignItemCancel);
        
        // --- FIN: NUEVAS FUNCIONES PARA ASIGNAR ITEMS EN LOTE ---


        // --- INICIO: NUEVAS FUNCIONES PARA SELECCIÓN MÚLTIPLE ---

        /**
         * Vincula los event listeners para las casillas de selección.
         * Se llama cada vez que se renderiza la tabla.
         */
        function setupSelectionListeners() {
            // Eliminar listeners antiguos para evitar duplicados
            selectAllCheckbox.removeEventListener('change', handleSelectAll);
            expiredListTableBody.removeEventListener('change', handleRowCheckbox);
            batchSignBtn.removeEventListener('click', handleBatchSign);

            // Añadir nuevos listeners
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            expiredListTableBody.addEventListener('change', handleRowCheckbox);
            batchSignBtn.addEventListener('click', handleBatchSign);
        }

        /**
         * Maneja el clic en la casilla "Seleccionar Todo".
         */
        function handleSelectAll(e) {
            const isChecked = e.target.checked;
            const allCheckboxes = expiredListTableBody.querySelectorAll('.row-checkbox');
            
            allCheckboxes.forEach(cb => {
                cb.checked = isChecked;
                const docId = cb.dataset.docId;
                if (isChecked) {
                    selectedInspections.add(docId);
                } else {
                    selectedInspections.delete(docId);
                }
            });
            updateSelectionUI();
        }

        /**
         * Maneja el clic en la casilla de una fila individual.
         */
        function handleRowCheckbox(e) {
            if (!e.target.classList.contains('row-checkbox')) return;
            
            const cb = e.target;
            const docId = cb.dataset.docId;
            
            if (cb.checked) {
                selectedInspections.add(docId);
            } else {
                selectedInspections.delete(docId);
            }
            updateSelectionUI();
        }

        /**
         * Actualiza la UI (contador, botón de lote, estado de "Seleccionar Todo" y resaltado de filas).
         */
        function updateSelectionUI() {
            const allCheckboxes = expiredListTableBody.querySelectorAll('.row-checkbox');
            const totalRows = allCheckboxes.length;
            const selectedCount = selectedInspections.size;

            // Mostrar/Ocultar el contenedor de acciones en lote
            if (selectedCount > 0) {
                batchActionsContainer.classList.remove('hidden');
                selectionCountEl.textContent = `${selectedCount} seleccionada(s)`;
            } else {
                batchActionsContainer.classList.add('hidden');
            }

            // Actualizar el estado de la casilla "Seleccionar Todo"
            if (totalRows > 0) {
                 if (selectedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedCount === totalRows) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
           
            // Resaltar filas seleccionadas
            allCheckboxes.forEach(cb => {
                const row = cb.closest('tr');
                if (row) {
                    if (selectedInspections.has(cb.dataset.docId)) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                }
            });
        }
        
        /**
         * Maneja el clic en el botón "Firmar Seleccionadas".
         */
        function handleBatchSign() {
            if (selectedInspections.size === 0) return;
            isBatchSigning = true;
            
            // "Simulamos" una celda de mecánico para que el modal de firma
            // sepa qué título poner ("Firma del Mecánico").
            const mockCell = { 
                dataset: { 
                    title: 'Mecánico' 
                } 
            }; 
            openSignatureModal(mockCell);
        }
        // --- FIN: NUEVAS FUNCIONES PARA SELECCIÓN MÚLTIPLE ---

    </script>
</body>
</html>
