<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Parte Especialista (Entrada de Datos)</title>
    <!-- Tailwind CSS CDN para un estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaci√≥n de fondo sutil para un toque moderno */
        @keyframes backgroundPan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #e0f2fe, #f0f8ff, #e0f2fe); /* Degradado suave */
            background-size: 200% 200%; /* Tama√±o m√°s grande para la animaci√≥n */
            animation: backgroundPan 20s ease infinite; /* Animaci√≥n de movimiento lento */
            color: #334155;
            min-height: 100vh; /* Asegura que la animaci√≥n ocupe toda la altura */
            display: flex; /* Para centrar el contenido verticalmente si es m√°s peque√±o */
            justify-content: center;
            align-items: center;
        }

        /* Contenedor principal estilizado como una tarjeta con neumorfismo suave */
        .container {
            max-width: 980px;
            margin: 2rem auto;
            padding: 2.8rem;
            background-color: #ffffff;
            border-radius: 1.8rem;
            box-shadow: 10px 10px 30px rgba(174, 174, 192, 0.4), 
                        -10px -10px 30px rgba(255, 255, 255, 0.7);
            border: none;
            transition: transform 0.3s ease-in-out;
        }
        .container:hover {
            transform: translateY(-5px);
        }

        /* Estilos para inputs num√©ricos */
        input[type="number"] {
            border-radius: 0.8rem;
            padding: 0.9rem 1.3rem;
            border: 1px solid #e2e8f0;
            background-color: #f7fafc;
            text-align: center;
            width: 120px;
            -moz-appearance: textfield;
            transition: all 0.3s ease-in-out;
            font-weight: 500;
            color: #1f2937;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.05), inset -2px -2px 5px rgba(255, 255, 255, 0.8);
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.3), 
                        inset 2px 2px 5px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Estilos de tabla generales */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.07);
            background-color: #ffffff;
        }
        th, td {
            text-align: left;
            padding: 1.4rem 1.7rem;
            border-bottom: 1px solid #edf2f7;
        }
        th {
            background: linear-gradient(45deg, #4f46e5, #6366f1);
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }
        thead tr:first-child th:first-child { border-top-left-radius: 1.5rem; }
        thead tr:first-child th:last-child { border-top-right-radius: 1.5rem; }

        tr:last-child td {
            border-bottom: none;
        }
        tbody tr {
            transition: all 0.25s ease-in-out;
        }
        tbody tr:hover {
            background-color: #f0f4f8;
            transform: scale(1.01);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        tbody tr:nth-child(even) {
            background-color: #f7f9fb;
        }

        /* Estilos para el modal personalizado */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.4s ease-in-out;
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 3.5rem;
            border-radius: 2rem;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.35);
            max-width: 650px;
            width: 90%;
            text-align: center;
            transform: translateY(-50px) scale(0.9);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-out;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal-content h3 {
            font-size: 2.5rem;
            color: #4f46e5;
            margin-bottom: 1.8rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .modal-content textarea {
            min-height: 160px;
            resize: vertical;
            transition: all 0.3s ease-in-out;
            border-color: #e2e8f0;
            border-radius: 1rem;
            font-size: 1.05rem;
            line-height: 1.6;
            padding: 1.2rem;
            background-color: #f7fafc;
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.03);
        }
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.3);
            background-color: #ffffff;
        }
        .modal-content button {
            border-radius: 1rem;
            font-weight: 700;
            padding: 1.1rem 2.5rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 1.1rem;
        }
        .modal-content button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content button.bg-indigo-600:hover {
            background-color: #4338ca;
        }
        .modal-content button.bg-gray-300:hover {
            background-color: #9ca3af;
        }

        /* Estilos para el √°rea de notas en la tabla */
        .note-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 0.9rem 1.2rem;
            min-height: 58px;
            border: 1px solid #eef2f7;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.05), -2px -2px 8px rgba(255, 255, 255, 0.8);
        }
        .note-display:hover {
            background-color: #f8fafc;
            border-color: #e2e8f0;
            transform: translateY(-3px);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.08), -5px -5px 15px rgba(255, 255, 255, 0.6);
        }
        .note-display span {
            color: #475569;
            font-size: 1rem;
            line-height: 1.4;
        }
        .edit-pencil-icon {
            width: 22px;
            height: 22px;
            fill: #94a3b8;
            transition: fill 0.3s ease-in-out;
        }
        .note-display:hover .edit-pencil-icon {
            fill: #4f46e5;
        }

        /* Mensaje de "no hay datos" */
        #no-data-message {
            font-style: italic;
            color: #94a3b8;
            margin-top: 2rem;
            font-size: 1.2rem;
        }

    </style>
</head>
<body class="min-h-screen">
    <div class="container">
        <h1 class="text-5xl font-extrabold text-center mb-10 text-gray-800 tracking-tight">
            üõ†Ô∏è Parte <span class="text-indigo-600">Especialista</span>
        </h1>
        <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
            Utiliza esta secci√≥n para reportar la cantidad de personal y notas espec√≠ficas 
        </p>

        <!-- Secci√≥n para la Parte Especialista (donde se ingresan los datos de esta vista) -->
        <div class="p-8 bg-white rounded-xl shadow-lg border border-gray-100 mb-10">
            <h2 class="text-3xl font-bold mb-8 text-gray-700 text-center">Mi Reporte (Especialista)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-indigo-600">
                        <tr>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-center">Cantidad</th>
                            <th class="px-6 py-4">Notas</th>
                        </tr>
                    </thead>
                    <tbody id="especialista-part-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas con inputs y notas de ESTA parte se insertar√°n aqu√≠ con JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="no-data-message" class="text-center mt-8 text-xl text-gray-500 hidden">
                ¬°Ingresa cantidades para el personal Especialista!
            </p>
        </div>

        <!-- Secci√≥n para mostrar el ID de Usuario (para depuraci√≥n y pruebas de m√∫ltiples usuarios) -->
        <div class="text-center text-gray-500 text-sm mt-8">
            ID de Usuario (para depuraci√≥n): <span id="user-id-display" class="font-mono text-gray-700 break-all">Cargando...</span>
        </div>
    </div>

    <!-- Modal personalizado para edici√≥n de notas -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="font-extrabold"></h3>
            
            <textarea id="modal-input-note" placeholder="Escribe aqu√≠ tu nota..." class="w-full"></textarea>

            <div class="flex justify-center mt-6">
                <button id="modal-confirm-button" class="bg-indigo-600 text-white mr-4">Guardar Nota</button>
                <button id="modal-cancel-button" class="bg-gray-300 text-gray-800">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        // *** CONFIGURACI√ìN DE FIREBASE PROPORCIONADA POR EL USUARIO ***
        const firebaseConfig = {
            apiKey: "AIzaSyBisvGozOBQ88dfY5KPC2mYlYc-qmZfSB4",
            authDomain: "parte-dca91.firebaseapp.com",
            projectId: "parte-dca91",
            storageBucket: "parte-dca91.firebasestorage.app",
            messagingSenderId: "267969738051",
            appId: "1:267969738051:web:1cbf9f6b907fc787782bf6",
            measurementId: "G-3938E048HW"
        };
        const appId = firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ***************************************************************

        let db;
        let auth;
        let userId;

        // ID del documento espec√≠fico para esta parte (Especialista)
        const MY_PART_REPORT_ID = "especialista_report"; 

        // Definici√≥n de los estados del personal (igual que en el parte principal)
        const staffStatuses = [
            { value: "disponible", label: "Disponible" },
            { value: "estudiando en el pais", label: "Estudiando en el Pa√≠s" },
            { value: "estudiando en el extranjero", label: "Estudiando en el Extranjero" },
            { value: "vacaciones", label: "Vacaciones" },
            { value: "asignado", label: "Asignado" },
            { value: "servicio", label: "Servicio" },
            { value: "pendiente de vuelo", label: "Pendiente de Vuelo" },
            { value: "mision pais", label: "Misi√≥n Pa√≠s" },
            { value: "mision ciudad", label: "Misi√≥n Ciudad" },
            { value: "clinica", label: "Cl√≠nica" },
            { value: "hospital militar", label: "Hospital Militar" },
            { value: "libre", label: "Libre" },
            { value: "faltistas", label: "Faltistas" },
            { value: "desertor", label: "Desertor" }
        ];

        // --- Elementos del DOM ---
        const especialistaPartTableBody = document.getElementById('especialista-part-table-body');
        const noDataMessage = document.getElementById('no-data-message');
        const userIdDisplay = document.getElementById('user-id-display');

        // Modal elements
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalInputNote = document.getElementById('modal-input-note');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        // --- Funciones para la gesti√≥n de datos y UI ---

        /**
         * Guarda los conteos y notas de la parte de Especialista en Firestore (colecci√≥n p√∫blica).
         * @param {Object} countsData - Los datos espec√≠ficos de esta parte.
         */
        async function saveEspecialistaCounts(countsData) {
            if (!db || !userId) {
                console.error("Firestore o ID de usuario no est√°n inicializados.");
                return;
            }
            // Guarda los datos en la colecci√≥n p√∫blica /artifacts/{appId}/public/data/reports/{MY_PART_REPORT_ID}
            const reportRef = doc(db, `artifacts/${appId}/public/data/reports/${MY_PART_REPORT_ID}`);
            try {
                await setDoc(reportRef, countsData, { merge: true });
                console.log(`Datos de '${MY_PART_REPORT_ID}' guardados en Firestore.`);
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
            }
        }

        /**
         * Muestra el modal personalizado en modo de edici√≥n de nota.
         * @param {string} title - T√≠tulo del modal.
         * @param {Object} [initialValues={}] - Objeto con valores iniciales (e.g., { note: '...' }).
         * @returns {Promise<string|boolean>} - Promesa que resuelve con la nota editada o false si se cancela.
         */
        function showNoteModal(title, initialValues = {}) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalInputNote.value = initialValues.note || '';
                modalInputNote.classList.remove('hidden'); 
                customModalOverlay.classList.add('visible');
                modalInputNote.focus();

                const confirmHandler = () => {
                    hideCustomModal();
                    resolve(modalInputNote.value);
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    modalCancelButton.removeEventListener('click', cancelHandler);
                };

                const cancelHandler = () => {
                    hideCustomModal();
                    resolve(false);
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    modalCancelButton.removeEventListener('click', cancelHandler);
                };

                modalConfirmButton.addEventListener('click', confirmHandler);
                modalCancelButton.addEventListener('click', cancelHandler);
            });
        }

        /** Oculta el modal personalizado. */
        function hideCustomModal() {
            customModalOverlay.classList.remove('visible');
        }

        /**
         * Renderiza la tabla para la entrada de datos de la parte de Especialista.
         * @param {Object} especialistaPartData - Los datos espec√≠ficos de esta parte.
         */
        function renderEspecialistaTable(especialistaPartData) {
            especialistaPartTableBody.innerHTML = '';
            let currentPartTotal = 0; // Se mantiene para mostrar el mensaje de "no hay datos" si todo es cero

            staffStatuses.forEach(status => {
                const currentCount = especialistaPartData[status.value]?.count || 0;
                const currentNote = especialistaPartData[status.value]?.note || '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-800">${status.label}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-center">
                        <input type="number"
                               min="0"
                               data-status-value="${status.value}"
                               value="${currentCount !== 0 ? currentCount : ''}"
                               class="border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </td>
                    <td class="px-6 py-4 text-base text-gray-700">
                        <div class="note-display" data-status-note="${status.value}">
                            <span class="truncate pr-2">${currentNote || 'Agregar nota...'}</span>
                            <svg class="edit-pencil-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L18.79 7.04l-3.75-3.75L3 17.25zM20.71 5.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </div>
                    </td>
                `;
                especialistaPartTableBody.appendChild(row);

                // A√±adir listener al input de n√∫mero para actualizar el conteo
                const quantityInput = row.querySelector('input[type="number"]');
                quantityInput.addEventListener('input', (event) => {
                    const value = event.target.value;
                    const count = parseInt(value, 10);
                    const statusVal = event.target.dataset.statusValue;

                    especialistaPartData[statusVal] = especialistaPartData[statusVal] || {};
                    especialistaPartData[statusVal].count = isNaN(count) ? 0 : Math.max(0, count);
                    saveEspecialistaCounts(especialistaPartData); // Guarda los datos de esta parte
                });

                // A√±adir listener al √°rea de notas para abrir el modal de edici√≥n
                const noteDisplay = row.querySelector('.note-display');
                noteDisplay.addEventListener('click', async () => {
                    const statusVal = noteDisplay.dataset.statusNote;
                    const currentNote = especialistaPartData[statusVal]?.note || '';
                    const newNote = await showNoteModal(
                        `Notas para: ${status.label}`,
                        { note: currentNote }
                    );

                    if (newNote !== false && typeof newNote === 'string') {
                        especialistaPartData[statusVal] = especialistaPartData[statusVal] || {};
                        especialistaPartData[statusVal].note = newNote.trim();
                        saveEspecialistaCounts(especialistaPartData); // Guarda los datos de esta parte
                    }
                });
                currentPartTotal += currentCount;
            });

            if (currentPartTotal === 0 && Object.values(especialistaPartData).every(s => s.count === 0 && s.note === '')) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
            }
        }


        // --- Inicializaci√≥n de Firebase y Listener de Datos ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autenticaci√≥n con token personalizada exitosa.");
                } catch (error) {
                    console.error("Error al autenticar con token personalizada:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
                console.log("Inicio de sesi√≥n an√≥nimo exitoso.");
            }

            // Once authenticated, get the user ID and listen for changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("Usuario autenticado. UID:", userId);

                    // --- Escuchar el documento espec√≠fico de esta parte ---
                    const especialistaReportDocRef = doc(db, `artifacts/${appId}/public/data/reports/${MY_PART_REPORT_ID}`);

                    onSnapshot(especialistaReportDocRef, (docSnap) => {
                        let currentEspecialistaData = {};
                        if (docSnap.exists()) {
                            currentEspecialistaData = docSnap.data();
                        }
                        // Asegurarse de que el objeto de datos tenga la estructura completa inicializada
                        staffStatuses.forEach(status => {
                            if (typeof currentEspecialistaData[status.value] !== 'object' || currentEspecialistaData[status.value] === null) {
                                currentEspecialistaData[status.value] = { count: 0, note: '' };
                            } else {
                                if (typeof currentEspecialistaData[status.value].count === 'undefined') currentEspecialistaData[status.value].count = 0;
                                if (typeof currentEspecialistaData[status.value].note === 'undefined') currentEspecialistaData[status.value].note = '';
                            }
                        });

                        // Renderizar la tabla con los datos m√°s recientes de esta parte
                        renderEspecialistaTable(currentEspecialistaData);

                        // Si el documento de esta parte no exist√≠a, guardarlo inicializado
                        if (!docSnap.exists()) {
                            saveEspecialistaCounts(currentEspecialistaData);
                        }

                    }, (error) => {
                        console.error("Error al escuchar actualizaciones de Firestore:", error);
                    });

                } else {
                    console.log("Usuario no autenticado.");
                    userIdDisplay.textContent = "No autenticado";
                }
            });
        });
    </script>
</body>
</html>
