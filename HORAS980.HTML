<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroLog Pro - Gestión de Mantenimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .table-fixed-column {
            position: sticky;
            left: 0;
            background: white;
            z-index: 20;
            border-right: 2px solid #e2e8f0;
        }

        .input-cell {
            width: 80px;
            text-align: center;
            font-size: 0.75rem;
            padding: 4px;
            border: 1px solid #f1f5f9;
        }

        .input-cell:focus {
            background: #eef2ff;
            outline: 2px solid #6366f1;
            z-index: 30;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* Dashboard desplegable animation */
        #quick-dashboard {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        #quick-dashboard.open {
            max-height: 200px;
            opacity: 1;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sincronizando...</p>
        </div>
    </div>

    <!-- Modal de Espejo Mejorado -->
    <div id="mirror-modal" class="modal-overlay">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border border-slate-200">
            <h3 class="text-xl font-black text-slate-800 mb-2">Sincronizar Datos</h3>
            <p class="text-sm text-slate-500 mb-6">Selecciona el tipo de espejo que deseas realizar:</p>
            
            <div class="grid gap-3">
                <button onclick="executeMirror('ac_to_engines')" class="flex items-center justify-between p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-emerald-700">AC HRS → Motores 1 y 2</div>
                        <div class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">Copia AC HRS a ENGINE HRS de ambos</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>

                <div class="h-px bg-slate-100 my-1"></div>

                <button onclick="executeMirror('table')" class="flex items-center justify-between p-4 bg-slate-50 hover:bg-indigo-50 border border-slate-200 hover:border-indigo-200 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 group-hover:text-indigo-700">Motor 1 → Motor 2 (Tabla)</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Registros diarios (1 al 31)</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>

                <button onclick="executeMirror('vienen')" class="flex items-center justify-between p-4 bg-slate-50 hover:bg-indigo-50 border border-slate-200 hover:border-indigo-200 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 group-hover:text-indigo-700">Motor 1 → Motor 2 (Vienen)</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Acumulados iniciales</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>

                <button onclick="executeMirror('all')" class="flex items-center justify-between p-4 bg-indigo-600 hover:bg-indigo-700 border border-indigo-500 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-white">Copiar Todo (M1 a M2)</div>
                        <div class="text-[10px] text-indigo-200 font-bold uppercase tracking-wider">Vienen + Registros Diarios</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </button>
            </div>

            <button onclick="closeMirrorModal()" class="w-full mt-6 text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600">Cancelar</button>
        </div>
    </div>
    <!-- Modal de Acceso QR y Llenado Rápido -->
<div id="quick-fill-modal" class="modal-overlay">
    <div class="bg-white rounded-3xl p-6 max-w-md w-full shadow-2xl border border-slate-200">
        <h3 class="text-xl font-black text-slate-800 mb-2">Acceso Rápido</h3>
        <p class="text-sm text-slate-500 mb-4">Escanea tu QR para acceder y registrar auditoría</p>

    <div id="qr-reader" style="width:100%; display:flex; justify-content:center;"></div>

        <div id="quick-fill-form" class="hidden mt-4">
            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-2">Rellenar rápidamente:</p>
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="quick-ac-hrs" placeholder="AC HRS" class="input-cell">
                <input type="number" id="quick-aterrizajes" placeholder="ATERRIZAJES" class="input-cell">
                <input type="number" id="quick-rins" placeholder="RINS" class="input-cell">
                <input type="number" id="quick-eng1-hrs" placeholder="ENGINE HRS 1" class="input-cell">
                <input type="number" id="quick-eng1-starts" placeholder="ENGINE STARTS 1" class="input-cell">
                <input type="number" id="quick-flights1" placeholder="FLIGHTS 1" class="input-cell">
                <input type="number" id="quick-ciclos1" placeholder="CICLOS 1" class="input-cell">
                <input type="number" id="quick-eng2-hrs" placeholder="ENGINE HRS 2" class="input-cell">
                <input type="number" id="quick-eng2-starts" placeholder="ENGINE STARTS 2" class="input-cell">
                <input type="number" id="quick-flights2" placeholder="FLIGHTS 2" class="input-cell">
                <input type="number" id="quick-ciclos2" placeholder="CICLOS 2" class="input-cell">
            </div>

            <div class="mt-4 flex flex-col gap-2">
                <button id="btn-capture" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold">Tomar Foto y Ubicación</button>
                <button id="btn-save-quick" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold">Guardar y Registrar Auditoría</button>
            </div>
        </div>

        <button onclick="closeQuickFillModal()" class="w-full mt-4 text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600">Cancelar</button>
    </div>
</div>


    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 shadow-sm flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <button id="toggle-dashboard" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tight leading-none uppercase">AEROLOG MASTER</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">FAH-980 Selective Mirror</p>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-slate-100 p-1.5 rounded-2xl border border-slate-200">
            <select id="select-month" class="bg-transparent text-xs font-bold px-3 py-1.5 outline-none cursor-pointer text-slate-700">
                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
            <select id="select-year" class="bg-transparent text-xs font-bold px-3 py-1.5 outline-none cursor-pointer text-slate-700"></select>
        </div>

        <div class="flex gap-2 text-xs">
            <span id="sync-status" class="flex items-center gap-1 text-amber-600 font-bold bg-amber-50 px-3 py-1.5 rounded-xl border border-amber-100">
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span> Conectando...
            </span>
            <button id="btn-mirror-trigger" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-xl font-bold border border-indigo-200 hover:bg-indigo-100 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                Menú Espejo
            </button>
            <button id="btn-copy-prev" class="bg-white text-slate-700 px-4 py-2 rounded-xl font-bold border border-slate-200 hover:bg-slate-50 transition-all">Cerrar Mes Anterior</button>
            <button id="btn-export" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-slate-700 transition-all">Exportar JSON</button>
        </div>
    </nav>

    <!-- Dashboard Desplegable de Accesos Rápidos -->
    <div id="quick-dashboard" class="bg-slate-50 border-b border-slate-200 px-6">
        <div class="max-w-7xl mx-auto">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Módulos de Reporte e Inspección</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#3b4454] hover:bg-[#2d3440] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Generar Reporte del Mes</span>
                </a>
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#4e96d9] hover:bg-[#3d85c8] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Estado de Motores</span>
                </a>
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#a855f7] hover:bg-[#9333ea] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Estado de Componentes</span>
                </a>
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#14b8a6] hover:bg-[#0d9488] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Inspecciones</span>
                </a>
                <button onclick="openQuickFillModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold">Llenado Rápido con QR</button>

            </div>
        </div>
    </div>

    <div class="p-4 max-w-[100vw]">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200" id="header-row">
                            <th class="table-fixed-column px-4 py-6 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest min-w-[200px]">Nomenclatura</th>
                            <th class="px-4 py-2 text-[10px] font-black text-indigo-600 border-r border-slate-200">VIENEN</th>
                        </tr>
                    </thead>
                    <tbody id="master-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl transform translate-y-32 transition-all duration-500 flex items-center gap-3 z-[100]">
        <span id="toast-msg" class="font-bold text-sm tracking-tight"></span>
    </div>
<!-- Librería QR -->




    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let firebaseConfig = {
            apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8", 
            projectId: "fah-980-ceb96",
            authDomain: "fah-980-ceb96.firebaseapp.com",
            databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
            storageBucket: "fah-980-ceb96.appspot.com",
            messagingSenderId: "820427334707",
            appId: "1:820427334707:web:753198086036814227806d"
        };

        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) firebaseConfig = { ...firebaseConfig, ...JSON.parse(__firebase_config) }; } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fah-980-master-v1';
        const PATH_ROOT = `artifacts/${appId}/public/data/MAINTENANCE_LOGS`;

        let currentPeriod = ""; 
        let globalData = {};
        let isRendering = false;
        let unsubscribe = null;
        let currentUser = null;

        const baseMotorFields = [
            { id: 'cont_exc', label: 'CONTINGENCY EXCURSIONS', limit: 0, factor: 1 },
            { id: 'eng_hrs', label: 'ENGINE HRS', limit: 0, factor: 1 },
            { id: 'eng_starts', label: 'ENGINE STARTS', limit: 0, factor: 1 },
            { id: 'flights', label: 'FLIGHTS', limit: 0, factor: 1 },
            { id: 'hub_1', label: 'HUB COMPRESOR 1.1', limit: 110000, factor: 3 },
            { id: 'hub_2', label: 'HUB COMPRESOR 1.2', limit: 35000, factor: 1 },
            { id: 'disk_2', label: '2ND STAGE COMPRESOR DISK', limit: 29000, factor: 1 },
            { id: 'disk_3', label: '3RD STAGE COMPRESOR DISK', limit: 29000, factor: 1 },
            { id: 'impeller', label: 'IMPELLER', limit: 29000, factor: 1 },
            { id: 'ct_disk', label: 'COMPRESSOR TURBINE DISK', limit: 7200, factor: 0.9 },
            { id: 'pt_disk_1', label: 'POWER TURBINE DISK 1.1', limit: 57000, factor: 4 },
            { id: 'pt_disk_2', label: 'POWER TURBINE DISK 1.2', limit: 15000, factor: 1 },
            { id: 'ciclos', label: 'CICLOS', limit: 0, factor: 1 }
        ];

        const config = [
            { id: 'ac_hrs', label: 'AC HRS', group: 'GENERAL' },
            { id: 'aterrizajes', label: 'ATERRIZAJES', group: 'GENERAL' },
            { id: 'rins', label: 'RINS', group: 'GENERAL' },
            { type: 'separator', label: 'MOTOR #1' },
            ...baseMotorFields.map(f => ({ ...f, id: `${f.id}_1`, label: `${f.label} 1` })),
            { type: 'separator', label: 'MOTOR #2' },
            ...baseMotorFields.map(f => ({ ...f, id: `${f.id}_2`, label: `${f.label} 2` }))
        ];

        // Toggle Dashboard Logic
        document.getElementById('toggle-dashboard').addEventListener('click', () => {
            document.getElementById('quick-dashboard').classList.toggle('open');
        });

        window.closeMirrorModal = () => document.getElementById('mirror-modal').style.display = 'none';
        
        window.executeMirror = async (mode) => {
            closeMirrorModal();
            document.getElementById('loader').style.display = 'flex';
            
            const mirrorBatch = {};

            if (mode === 'ac_to_engines') {
                const acData = globalData['ac_hrs'] || {};
                const acVienen = globalData['vienen_ac_hrs'] || 0;
                
                ['eng_hrs_1', 'eng_hrs_2'].forEach(engineKey => {
                    mirrorBatch[`vienen_${engineKey}`] = acVienen;
                    mirrorBatch[engineKey] = { ...acData };
                });
                showToast("AC HRS sincronizado a Motores 1 y 2");
            } else {
                baseMotorFields.forEach(field => {
                    const m1Key = `${field.id}_1`;
                    const m2Key = `${field.id}_2`;
                    
                    if((mode === 'vienen' || mode === 'all') && globalData[`vienen_${m1Key}`] !== undefined) {
                        mirrorBatch[`vienen_${m2Key}`] = globalData[`vienen_${m1Key}`];
                    }
                    
                    if((mode === 'table' || mode === 'all') && globalData[m1Key]) {
                        mirrorBatch[m2Key] = { ...globalData[m1Key] };
                    }
                });
                showToast(`Motor 2 actualizado (${mode})`);
            }

            try {
                const dbRef = ref(db, `${PATH_ROOT}/${currentPeriod}`);
                await update(dbRef, mirrorBatch);
            } catch (e) {
                showToast("Error al sincronizar");
            } finally {
                document.getElementById('loader').style.display = 'none';
                renderMatrix();
            }
        };

        const renderMatrix = () => {
            isRendering = true;
            const body = document.getElementById('master-body');
            body.innerHTML = '';
            config.forEach(row => {
                if(row.type === 'separator') {
                    body.innerHTML += `<tr class="bg-slate-100/50 separator-row"><td colspan="45" class="px-4 py-1 text-[9px] font-black text-slate-400 text-center uppercase tracking-[0.3em]">${row.label}</td></tr>`;
                    return;
                }
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 transition-colors data-row";
                let html = `<td class="table-fixed-column px-4 py-2 text-xs font-bold text-slate-700 border-r border-slate-200">${row.label}</td>`;
                const vV = globalData[`vienen_${row.id}`] || 0;
                html += `<td class="bg-indigo-50/30 border-r border-slate-200"><input type="number" step="0.1" value="${vV}" data-type="vienen" data-id="${row.id}" class="input-cell font-bold text-indigo-700"></td>`;
                let mT = 0;
                for(let d=1; d<=31; d++) {
                    const dV = (globalData[row.id] && globalData[row.id][d]) || 0;
                    mT += parseFloat(dV);
                    html += `<td class="border-r border-slate-50"><input type="number" step="0.1" value="${dV || ''}" placeholder="-" data-type="day" data-id="${row.id}" data-day="${d}" class="input-cell text-slate-500"></td>`;
                }
                html += `<td class="bg-indigo-50 text-center font-bold text-indigo-800 text-xs border-r border-slate-200">${mT.toFixed(1)}</td>`;
                const gT = parseFloat(vV) + mT;
                html += `<td class="bg-indigo-600 text-center font-black text-white text-xs border-r border-slate-200">${gT.toFixed(1)}</td>`;
                const lV = row.limit || 0; const fV = row.factor || 1;
                const rS = lV > 0 ? (lV - (gT * fV)) : 0;
                html += `<td class="bg-yellow-50 text-center font-bold text-slate-600 text-xs border-r border-slate-200">${lV || '-'}</td>`;
                html += `<td class="bg-yellow-50 text-center font-bold text-slate-600 text-xs border-r border-slate-200">${fV || '-'}</td>`;
                html += `<td class="bg-red-50 text-center font-black ${rS < 500 && lV > 0 ? 'text-red-600 animate-pulse' : 'text-slate-800'} text-xs">${lV > 0 ? rS.toFixed(1) : '-'}</td>`;
                tr.innerHTML = html; body.appendChild(tr);
            });
            isRendering = false;
        };

        const setupUIHeader = () => {
            const hR = document.getElementById('header-row');
            for(let i=1; i<=31; i++) { hR.innerHTML += `<th class="px-2 py-2 text-[10px] font-bold border-r border-slate-100">${i}</th>`; }
            hR.innerHTML += `<th class="px-4 py-2 text-[10px] font-black text-indigo-600 border-x border-slate-200 bg-indigo-50 uppercase">Mes</th><th class="px-4 py-2 text-[10px] font-black text-white bg-indigo-600 border-r border-slate-200 uppercase">General</th><th class="px-4 py-2 text-[10px] font-black text-slate-600 bg-yellow-100 border-r border-slate-200 uppercase">Límite</th><th class="px-4 py-2 text-[10px] font-black text-slate-600 bg-yellow-100 border-r border-slate-200 uppercase">Factor</th><th class="px-4 py-2 text-[10px] font-black text-white bg-red-500 uppercase">Restante</th>`;
            const yS = document.getElementById('select-year'); const cY = new Date().getFullYear();
            for(let y = cY-2; y <= cY+5; y++) { const o = document.createElement('option'); o.value = y; o.innerText = y; if(y === cY) o.selected = true; yS.appendChild(o); }
        };

        const setupSync = (user) => {
            if (!user) return;
            if (unsubscribe) unsubscribe();
            unsubscribe = onValue(ref(db, `${PATH_ROOT}/${currentPeriod}`), (snap) => {
                globalData = snap.exists() ? snap.val() : {};
                if (!document.activeElement || document.activeElement.tagName !== 'INPUT') renderMatrix();
                document.getElementById('loader').style.display = 'none';
                updateSyncStatus(true);
            }, () => updateSyncStatus(false));
        };

        const updateSyncStatus = (connected) => {
            const s = document.getElementById('sync-status');
            s.innerHTML = connected ? '<span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Conectado' : '<span class="w-2 h-2 bg-red-500 rounded-full"></span> Error';
            s.className = `flex items-center gap-1 font-bold bg-${connected?'emerald':'red'}-50 px-3 py-1.5 rounded-xl border border-${connected?'emerald':'red'}-100 text-${connected?'emerald':'red'}-600`;
        };

        document.addEventListener('change', async (e) => {
            if (isRendering || e.target.tagName !== 'INPUT') return;
            const i = e.target; const { type, id, day } = i.dataset; const v = parseFloat(i.value) || 0;
            if (type === 'vienen') { await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), { [`vienen_${id}`]: v }); }
            else if (type === 'day') { await set(ref(db, `${PATH_ROOT}/${currentPeriod}/${id}/${day}`), v); }
            renderMatrix();
        });

        const changePeriod = () => {
            currentPeriod = `${document.getElementById('select-month').value}-${document.getElementById('select-year').value}`;
            document.getElementById('loader').style.display = 'flex';
            setupSync(currentUser);
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        };

        setupUIHeader();
        document.getElementById('select-month').addEventListener('change', changePeriod);
        document.getElementById('select-year').addEventListener('change', changePeriod);
        document.getElementById('btn-mirror-trigger').addEventListener('click', () => { document.getElementById('mirror-modal').style.display = 'flex'; });
        document.getElementById('btn-copy-prev').addEventListener('click', async () => {
            const m = parseInt(document.getElementById('select-month').value);
            const y = parseInt(document.getElementById('select-year').value);
            let pM = m-1, pY = y; if(pM<0){pM=11;pY--;}
            const pSnap = await get(ref(db, `${PATH_ROOT}/${pM}-${pY}`));
            if(!pSnap.exists()) return showToast("No hay datos previos");
            if(confirm(`¿Cerrar mes anterior y pasar totales a VIENEN?`)) {
                const pD = pSnap.val(); const b = {};
                config.forEach(r => { if(r.type!=='separator'){ const vV = pD[`vienen_${r.id}`]||0; let vM=0; if(pD[r.id]) Object.values(pD[r.id]).forEach(v=>vM+=parseFloat(v||0)); b[`vienen_${r.id}`] = vV+vM; } });
                await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), b); renderMatrix();
            }
        });

        onAuthStateChanged(auth, (u) => {
            currentUser = u;
            if (u) {
                if(currentPeriod === "") {
                    const d = new Date();
                    document.getElementById('select-month').value = d.getMonth();
                    document.getElementById('select-year').value = d.getFullYear();
                    currentPeriod = `${d.getMonth()}-${d.getFullYear()}`;
                }
                setupSync(u);
            }
        });

        const initAuth = async () => {
            try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch (e) {}
        };
        initAuth();

        // Keyboard Navigation System
        document.addEventListener('keydown', (e) => {
            const activeInput = document.activeElement;
            if (!activeInput || activeInput.tagName !== 'INPUT') return;

            const currentTd = activeInput.closest('td');
            const currentRow = activeInput.closest('tr');
            const cellIndex = currentTd.cellIndex;
            let targetInput = null;

            const findNextInputInRow = (row, startIdx, direction) => {
                let idx = startIdx + direction;
                while (idx >= 0 && idx < row.cells.length) {
                    const input = row.cells[idx].querySelector('input');
                    if (input) return input;
                    idx += direction;
                }
                return null;
            };

            const findNextInputInCol = (startRow, colIdx, direction) => {
                let row = direction === 1 ? startRow.nextElementSibling : startRow.previousElementSibling;
                while (row) {
                    if (!row.classList.contains('separator-row')) {
                        const input = row.cells[colIdx]?.querySelector('input');
                        if (input) return input;
                    }
                    row = direction === 1 ? row.nextElementSibling : row.previousElementSibling;
                }
                return null;
            };

            if (e.key === 'ArrowRight') {
                targetInput = findNextInputInRow(currentRow, cellIndex, 1);
            } else if (e.key === 'ArrowLeft') {
                targetInput = findNextInputInRow(currentRow, cellIndex, -1);
            } else if (e.key === 'ArrowDown' || e.key === 'Enter') {
                e.preventDefault();
                targetInput = findNextInputInCol(currentRow, cellIndex, 1);
            } else if (e.key === 'ArrowUp') {
                targetInput = findNextInputInCol(currentRow, cellIndex, -1);
            }

            if (targetInput) {
                targetInput.focus();
                targetInput.select();
            }
        });
        // --- Variables y auditoría ---
let quickUser = null;
let quickPhoto = null;
let quickLocation = null;
const auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');

// --- Funciones de modal ---

   window.openQuickFillModal = () => {
    document.getElementById('quick-fill-modal').style.display = 'flex';
    startQRScanner();
};
window.closeQuickFillModal = () => {
    document.getElementById('quick-fill-modal').style.display = 'none';
};

// --- QR Scanner ---
let html5QrCode = null;

function startQRScanner() {
    document.getElementById('quick-fill-form').classList.remove('hidden'); // mostrar formulario directamente
    const qrDiv = document.getElementById('qr-reader');
    qrDiv.innerHTML = ""; // limpiar si hay algo
    // Cambia la URL o el texto que quieres codificar
    new QRCode(qrDiv, {
        text: "https://sozin0512.github.io/ESTADISTICA-2/HORAS980.HTML",
        width: 180,
        height: 180,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });
}


// --- Captura de foto y ubicación ---
document.getElementById('btn-capture').addEventListener('click', async () => {
    // Foto
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const bitmap = await imageCapture.grabFrame();
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width; canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d'); ctx.drawImage(bitmap,0,0);
        quickPhoto = canvas.toDataURL('image/jpeg', 0.7);
        track.stop();
    } catch(e){ console.error(e); alert('No se pudo capturar la foto'); }

    // Ubicación
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            quickLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            showToast('Foto y ubicación capturadas');
        }, err=>{ console.error(err); alert('No se pudo obtener la ubicación'); });
    } else { alert('Geolocalización no soportada'); }
});

// --- Guardar llenado rápido y auditoría ---
document.getElementById('btn-save-quick').addEventListener('click', async () => {
    if(!quickUser){ alert('No hay usuario QR'); return; }

    // Obtener valores
    const getVal = id => parseFloat(document.getElementById(id).value)||0;
    const values = {
        ac_hrs: getVal('quick-ac-hrs'),
        aterrizajes: getVal('quick-aterrizajes'),
        rins: getVal('quick-rins'),
        eng_hrs_1: getVal('quick-eng1-hrs'),
        eng_starts_1: getVal('quick-eng1-starts'),
        flights_1: getVal('quick-flights1'),
        ciclos_1: getVal('quick-ciclos1'),
        eng_hrs_2: getVal('quick-eng2-hrs'),
        eng_starts_2: getVal('quick-eng2-starts'),
        flights_2: getVal('quick-flights2'),
        ciclos_2: getVal('quick-ciclos2')
    };

    // Guardar en Firebase
    try {
        const updates = {};
        for(const k in values){
            const v = values[k];
            const prev = globalData[`vienen_${k}`] || 0;
            updates[`vienen_${k}`] = prev + v;
        }
        await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), updates);
        renderMatrix();
    } catch(e){ console.error(e); showToast('Error al guardar'); return; }

    // Guardar auditoría
    const logEntry = {
        user: quickUser,
        date: new Date().toISOString(),
        photo: quickPhoto,
        location: quickLocation,
        changes: values
    };
    auditLog.push(logEntry);
    localStorage.setItem('auditLog', JSON.stringify(auditLog));
    showToast('Llenado rápido registrado y auditoría guardada');

    closeQuickFillModal();
});

// --- Mostrar auditoría en consola o modal opcional ---
window.showAuditLog = () => {
    console.table(auditLog);
    alert('Revisa la consola para el historial de auditoría');
};

    </script>
</body>
</html>
