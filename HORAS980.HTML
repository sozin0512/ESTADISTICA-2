<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.Z.I.N. - FAH-980</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .table-fixed-column {
            position: sticky;
            left: 0;
            background: white;
            z-index: 20;
            border-right: 2px solid #e2e8f0;
        }

        .input-cell {
            width: 80px;
            text-align: center;
            font-size: 0.75rem;
            padding: 4px;
            border: 1px solid #f1f5f9;
        }

        .input-cell:focus {
            background: #eef2ff;
            outline: 2px solid #6366f1;
            z-index: 30;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #quick-dashboard {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        #quick-dashboard.open {
            max-height: 200px;
            opacity: 1;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <!-- Pantalla de Carga -->
    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sincronizando...</p>
        </div>
    </div>

    <!-- Modales de la Interfaz -->
    <div id="qr-modal" class="modal-overlay">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl border border-slate-200 text-center">
            <h3 class="text-xl font-black text-slate-800 mb-4">Acceso R√°pido QR</h3>
            <div id="qrcode" class="flex justify-center mb-6"></div>
            <p class="text-xs text-slate-500 mb-6 font-medium">Escanea para ir directo al <b>Llenado R√°pido</b> en tu m√≥vil.</p>
            <button onclick="closeModal('qr-modal')" class="w-full bg-slate-800 text-white py-3 rounded-2xl font-bold">Cerrar</button>
        </div>
    </div>

    <div id="fill-modal" class="modal-overlay">
        <div class="bg-white rounded-3xl p-6 max-w-2xl w-full shadow-2xl border border-slate-200 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-black text-slate-800">Asistente de Llenado</h3>
                    <p class="text-[10px] text-indigo-600 font-bold uppercase">Registro con Auditor√≠a</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-400">D√çA:</span>
                    <input type="number" id="fill-day-select" min="1" max="31" class="w-16 p-2 border rounded-xl font-bold text-center text-indigo-600">
                </div>
            </div>

            <div class="mb-6 p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                <label class="block text-[10px] font-black text-indigo-400 uppercase mb-2">Responsable del Cambio (Firma Digital)</label>
                <input type="text" id="audit-user" placeholder="Ej: Sgt. Perez / Mec√°nico" class="w-full bg-white border border-indigo-200 p-3 rounded-xl font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="fill-fields-container"></div>

            <div class="mt-8 flex gap-3">
                <button onclick="closeModal('fill-modal')" class="flex-1 py-3 text-slate-400 font-bold uppercase tracking-widest text-xs">Cancelar</button>
                <button id="btn-save-fill" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-2xl font-bold shadow-lg shadow-indigo-200">Guardar y Firmar</button>
            </div>
        </div>
    </div>

   <div id="mirror-modal" class="modal-overlay">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border border-slate-200">
        <h3 class="text-xl font-black text-slate-800 mb-2">Sincronizar Datos</h3>
        <p class="text-sm text-slate-500 mb-6">Selecciona el tipo de espejo que deseas realizar:</p>
        
        <div class="grid gap-4">
            <button onclick="mirrorAcToEngines()" class="flex items-center justify-between p-4 rounded-2xl border-2 border-emerald-100 bg-emerald-50 hover:bg-emerald-100 transition-all group">
                <div class="text-left">
                    <p class="text-emerald-700 font-black text-sm uppercase">AC HRS ‚Üí Motores 1 y 2</p>
                    <p class="text-[10px] text-emerald-500 font-bold uppercase">Copia AC HRS a Engine HRS de ambos</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </button>

            <button onclick="mirrorMotor(1, 2, 'table')" class="flex items-center justify-between p-4 rounded-2xl border border-slate-200 hover:border-indigo-200 hover:bg-slate-50 transition-all">
                <div class="text-left">
                    <p class="text-slate-700 font-black text-sm uppercase">Motor 1 ‚Üí Motor 2 (Tabla)</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Registros diarios (1 al 31)</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>

            <button onclick="mirrorMotor(1, 2, 'vienen')" class="flex items-center justify-between p-4 rounded-2xl border border-slate-200 hover:border-indigo-200 hover:bg-slate-50 transition-all">
                <div class="text-left">
                    <p class="text-slate-700 font-black text-sm uppercase">Motor 1 ‚Üí Motor 2 (Vienen)</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Acumulados Iniciales</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>

            <button onclick="mirrorMotor(1, 2, 'all')" class="flex items-center justify-between p-4 rounded-2xl bg-indigo-600 hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                <div class="text-left">
                    <p class="text-white font-black text-sm uppercase">Copiar Todo (M1 a M2)</p>
                    <p class="text-[10px] text-indigo-200 font-bold uppercase">Vienen + Registros Diarios</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </button>
        </div>

        <button onclick="closeModal('mirror-modal')" class="w-full mt-6 text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600">Cancelar</button>
    </div>
</div>

    <!-- Barra de Navegaci√≥n -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 shadow-sm flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <button id="toggle-dashboard" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tight leading-none uppercase">S.O.Z.I.N.</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">FAH-980 BELL-412SP</p>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-slate-100 p-1.5 rounded-2xl border border-slate-200">
            <select id="select-month" class="bg-transparent text-xs font-bold px-3 py-1.5 outline-none cursor-pointer text-slate-700">
                <!-- Opciones de meses -->
            </select>
            <select id="select-year" class="bg-transparent text-xs font-bold px-3 py-1.5 outline-none cursor-pointer text-slate-700"></select>
        </div>

        <div class="flex gap-2 text-xs flex-wrap">
            <span id="sync-status" class="flex items-center gap-1 text-amber-600 font-bold bg-amber-50 px-3 py-1.5 rounded-xl border border-amber-100">
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span> Conectando...
            </span>
            <button onclick="openFillModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                Llenado R√°pido
            </button>
            <button id="btn-mirror-trigger" onclick="document.getElementById('mirror-modal').style.display='flex'" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-xl font-bold border border-indigo-200 hover:bg-indigo-100 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                Men√∫ Espejo
            </button>
            <button onclick="generateQr()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold border border-slate-200 hover:bg-slate-200 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                Acceso M√≥vil
            </button>
        </div>
    </nav>

    <!-- Dashboard R√°pido -->
    <div id="quick-dashboard" class="bg-slate-50 border-b border-slate-200 px-6">
        <div class="max-w-7xl mx-auto">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">M√≥dulos de Reporte e Inspecci√≥n</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-6 bg-[#3b4454] text-white rounded-xl shadow-lg">Generar Reporte</div>
                <div class="p-6 bg-[#4e96d9] text-white rounded-xl shadow-lg">Estado Motores</div>
                <div class="p-6 bg-[#a855f7] text-white rounded-xl shadow-lg">Componentes</div>
                <div class="p-6 bg-[#14b8a6] text-white rounded-xl shadow-lg">Inspecciones</div>
            </div>
        </div>
    </div>

    <!-- Contenedor Tabla Principal -->
    <div class="p-4 max-w-[100vw]">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200" id="header-row">
                            <th class="table-fixed-column px-4 py-6 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest min-w-[200px]">Nomenclatura</th>
                            <th class="px-4 py-2 text-[10px] font-black text-indigo-600 border-r border-slate-200">VIENEN</th>
                            <!-- D√≠as generados por JS -->
                        </tr>
                    </thead>
                    <tbody id="master-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Historial de Auditor√≠a -->
    <div class="p-4 max-w-[100vw] mt-8">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-sm font-black text-slate-700 uppercase tracking-widest flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Historial de Cambios (Auditor√≠a)
                </h3>
                <span class="text-[10px] font-bold text-slate-400">MOVIMIENTOS EN TIEMPO REAL</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100/50 text-[10px] font-black text-slate-500 uppercase">
                            <th class="px-4 py-3">Fecha/Hora</th>
                            <th class="px-4 py-3">Responsable</th>
                            <th class="px-4 py-3">D√≠a Mod.</th>
                            <th class="px-4 py-3">Cambios Realizados</th>
                            <th class="px-4 py-3">GPS / Mapa</th>
                        </tr>
                    </thead>
                    <tbody id="audit-log-body" class="text-xs font-medium text-slate-600"></tbody>
                </table>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                <button id="load-more-logs" class="text-[10px] font-black text-indigo-600 hover:text-indigo-800 uppercase tracking-widest transition-all">
                    Mostrar movimientos anteriores +
                </button>
            </div>
        </div>
    </div>

    <!-- Toast de Notificaci√≥n -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl transform translate-y-32 transition-all duration-500 flex items-center gap-3 z-[100]">
        <span id="toast-msg" class="font-bold text-sm tracking-tight"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, query, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuraci√≥n
        const firebaseConfig = {
            apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8", 
            projectId: "fah-980-ceb96",
            authDomain: "fah-980-ceb96.firebaseapp.com",
            databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
            appId: "1:820427334707:web:753198086036814227806d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const appId = 'fah-980-master-v1';
        
        let currentPeriod = `${new Date().getFullYear()}_${new Date().getMonth() + 1}`;
        const PATH_ROOT = `artifacts/${appId}/public/data/MAINTENANCE_LOGS`;
        const LOGS_PATH_ROOT = `artifacts/${appId}/public/data/LOGS_MOVIMIENTOS`;

        let globalData = {};
        let logsLimit = 10;

        // Estructura de Datos de Aeronave
        const baseMotorFields = [
            { id: 'cont_exc', label: 'CONTINGENCY EXCURSIONS', limit: 0, factor: 1 },
            { id: 'eng_hrs', label: 'ENGINE HRS', limit: 0, factor: 1 },
            { id: 'eng_starts', label: 'ENGINE STARTS', limit: 0, factor: 1 },
            { id: 'flights', label: 'FLIGHTS', limit: 0, factor: 1 },
            { id: 'hub_1', label: 'HUB COMPRESOR 1.1', limit: 110000, factor: 3 },
            { id: 'hub_2', label: 'HUB COMPRESOR 1.2', limit: 35000, factor: 1 },
            { id: 'disk_2', label: '2ND STAGE COMPRESOR DISK', limit: 29000, factor: 1 },
            { id: 'disk_3', label: '3RD STAGE COMPRESOR DISK', limit: 29000, factor: 1 },
            { id: 'impeller', label: 'IMPELLER', limit: 29000, factor: 1 },
            { id: 'ct_disk', label: 'COMPRESSOR TURBINE DISK', limit: 7200, factor: 0.9 },
            { id: 'pt_disk_1', label: 'POWER TURBINE DISK 1.1', limit: 57000, factor: 4 },
            { id: 'pt_disk_2', label: 'POWER TURBINE DISK 1.2', limit: 15000, factor: 1 },
            { id: 'ciclos', label: 'CICLOS', limit: 0, factor: 1 }
        ];

        const config = [
            { id: 'ac_hrs', label: 'AC HRS', group: 'GENERAL' },
            { id: 'aterrizajes', label: 'ATERRIZAJES', group: 'GENERAL' },
            { id: 'rins', label: 'RINS', group: 'GENERAL' },
            { type: 'separator', label: 'MOTOR #1' },
            ...baseMotorFields.map(f => ({ ...f, id: `${f.id}_1`, label: `${f.label} 1` })),
            { type: 'separator', label: 'MOTOR #2' },
            ...baseMotorFields.map(f => ({ ...f, id: `${f.id}_2`, label: `${f.label} 2` }))
        ];
// --- Funciones de Espejo (Mirroring) ---

window.mirrorAcToEngines = async () => {
    if (!confirm("¬øSincronizar AC HRS con Engine HRS de ambos motores?")) return;
    
    const updates = {};
    const acData = globalData['ac_hrs'] || {};
    
    // Copiamos cada d√≠a y el 'vienen'
    Object.keys(acData).forEach(key => {
        updates[`eng_hrs_1/${key}`] = acData[key];
        updates[`eng_hrs_2/${key}`] = acData[key];
    });

    try {
        await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), updates);
        showToast("‚úÖ AC HRS sincronizado a Motores");
        closeModal('mirror-modal');
    } catch (e) {
        showToast("‚ùå Error en sincronizaci√≥n");
    }
};

window.mirrorMotor = async (sourceNum, targetNum, mode) => {
    const msg = mode === 'all' ? "todo el contenido" : (mode === 'table' ? "los registros diarios" : "los acumulados (vienen)");
    if (!confirm(`¬øCopiar ${msg} del Motor ${sourceNum} al Motor ${targetNum}?`)) return;

    const updates = {};
    const motorFields = baseMotorFields.map(f => f.id); // IDs base sin el _1 o _2

    motorFields.forEach(baseId => {
        const sourceId = `${baseId}_${sourceNum}`;
        const targetId = `${baseId}_${targetNum}`;
        const sourceData = globalData[sourceId] || {};

        if (mode === 'vienen' || mode === 'all') {
            if (sourceData['vienen'] !== undefined) {
                updates[`${targetId}/vienen`] = sourceData['vienen'];
            }
        }

        if (mode === 'table' || mode === 'all') {
            for (let d = 1; d <= 31; d++) {
                if (sourceData[d] !== undefined) {
                    updates[`${targetId}/${d}`] = sourceData[d];
                }
            }
        }
    });

    try {
        await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), updates);
        showToast(`‚úÖ Motor ${sourceNum} ‚Üí ${targetNum} completado`);
        closeModal('mirror-modal');
    } catch (e) {
        console.error(e);
        showToast("‚ùå Error al copiar datos");
    }
};
        // --- Funciones de Utilidad ---
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // --- Auditor√≠a ---
        async function writeAuditLog(user, day, changes, coords = null) {
            const logRef = ref(db, `${LOGS_PATH_ROOT}/${currentPeriod}/${Date.now()}`);
            const geoLink = coords ? `https://www.google.com/maps?q=${coords.latitude},${coords.longitude}` : "GPS OFF";

            await set(logRef, {
                timestamp: new Date().toLocaleString('es-HN'),
                usuario: user.toUpperCase(),
                dia_modificado: day,
                detalles: changes,
                geo: geoLink
            });
        }

        const listenAuditLogs = () => {
            const logsRef = query(ref(db, `${LOGS_PATH_ROOT}/${currentPeriod}`), limitToLast(logsLimit));
            onValue(logsRef, (snapshot) => {
                const body = document.getElementById('audit-log-body');
                body.innerHTML = '';
                if (!snapshot.exists()) return;
                
                const logs = [];
                snapshot.forEach(child => logs.push(child.val()));
                logs.reverse().forEach(log => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-50 hover:bg-indigo-50/30 transition-all";
                    tr.innerHTML = `
                        <td class="px-4 py-3 font-bold text-slate-400 text-[10px]">${log.timestamp}</td>
                        <td class="px-4 py-3 font-black text-indigo-700 text-[11px]">${log.usuario}</td>
                        <td class="px-4 py-3 text-center font-bold text-slate-700">${log.dia_modificado}</td>
                        <td class="px-4 py-3 text-[10px] text-slate-500">${log.detalles.join(' | ')}</td>
                        <td class="px-4 py-3">
                            ${log.geo.includes('http') ? `<a href="${log.geo}" target="_blank" class="text-emerald-500 font-bold hover:underline">üìç Ver Mapa</a>` : '<span class="text-slate-300">N/A</span>'}
                        </td>
                    `;
                    body.appendChild(tr);
                });
            });
        };

        // --- L√≥gica Principal de Llenado ---
        window.openFillModal = () => {
            const container = document.getElementById('fill-fields-container');
            container.innerHTML = '';
            document.getElementById('fill-day-select').value = new Date().getDate();
            
            const fieldsToFill = [
                'ac_hrs', 'aterrizajes', 'rins', 
                'cont_exc_1', 'eng_hrs_1', 'eng_starts_1', 'flights_1', 'ciclos_1',
                'cont_exc_2', 'eng_hrs_2', 'eng_starts_2', 'flights_2', 'ciclos_2'
            ];

            fieldsToFill.forEach(id => {
                const rowConfig = config.find(c => c.id === id);
                const div = document.createElement('div');
                div.className = "bg-slate-50 p-3 rounded-2xl border border-slate-100";
                div.innerHTML = `
                    <label class="block text-[10px] font-black text-slate-400 mb-1">${rowConfig.label}</label>
                    <input type="number" step="0.1" id="fill-input-${id}" class="w-full bg-white border border-slate-200 p-2 rounded-xl font-bold text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                `;
                container.appendChild(div);
            });
            document.getElementById('fill-modal').style.display = 'flex';
        };

        document.getElementById('btn-save-fill').onclick = async () => {
            const user = document.getElementById('audit-user').value.trim();
            const day = document.getElementById('fill-day-select').value;
            if (!user) return alert("‚ö†Ô∏è Se requiere firma para validar el cambio.");
            if (!day) return;

            document.getElementById('loader').style.display = 'flex';

            const finalizeSave = async (coords = null) => {
                const batch = {};
                const summary = [];
                const fieldsToFill = ['ac_hrs', 'aterrizajes', 'rins', 'cont_exc_1', 'eng_hrs_1', 'eng_starts_1', 'flights_1', 'ciclos_1', 'cont_exc_2', 'eng_hrs_2', 'eng_starts_2', 'flights_2', 'ciclos_2'];

                fieldsToFill.forEach(fid => {
                    const val = parseFloat(document.getElementById(`fill-input-${fid}`).value) || 0;
                    if (val > 0) {
                        batch[`${fid}/${day}`] = val;
                        summary.push(`${fid.toUpperCase()}: ${val}`);
                    }
                });

                if (summary.length > 0) {
                    try {
                        await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), batch);
                        await writeAuditLog(user, day, summary, coords);
                        showToast("‚úÖ Registro guardado y firmado");
                        closeModal('fill-modal');
                    } catch (e) {
                        showToast("‚ùå Error de red al guardar");
                    }
                }
                document.getElementById('loader').style.display = 'none';
            };

            navigator.geolocation.getCurrentPosition(
                (pos) => finalizeSave(pos.coords),
                () => finalizeSave(null),
                { timeout: 4000 }
            );
        };

        // --- Renderizado de Tabla ---
        const renderTable = () => {
            const header = document.getElementById('header-row');
            const body = document.getElementById('master-body');
            
            // Limpiar d√≠as anteriores y generar 31 columnas
            while (header.children.length > 2) header.lastChild.remove();
            for (let i = 1; i <= 31; i++) {
                const th = document.createElement('th');
                th.className = "px-4 py-2 text-[10px] font-black text-slate-400 border-r border-slate-100 min-w-[80px]";
                th.innerText = i;
                header.appendChild(th);
            }

            body.innerHTML = '';
            config.forEach(row => {
                if (row.type === 'separator') {
                    const tr = document.createElement('tr');
                    tr.className = "bg-indigo-50/50";
                    tr.innerHTML = `<td colspan="33" class="px-4 py-2 text-[10px] font-black text-indigo-600 uppercase tracking-widest">${row.label}</td>`;
                    body.appendChild(tr);
                    return;
                }

                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors";
                
                // Columna Nomenclatura
                const tdNom = document.createElement('td');
                tdNom.className = "table-fixed-column px-4 py-3 text-xs font-bold text-slate-600";
                tdNom.innerText = row.label;
                tr.appendChild(tdNom);

                // Columna VIENEN (Acumulado)
                const tdVienen = document.createElement('td');
                tdVienen.className = "px-2 py-1 border-r border-slate-200";
                const inv = document.createElement('input');
                inv.type = "number";
                inv.className = "input-cell font-black text-indigo-600 bg-indigo-50/30 rounded";
                inv.value = globalData[`${row.id}/vienen`] || 0;
                inv.onchange = (e) => updateField(row.id, 'vienen', e.target.value);
                tdVienen.appendChild(inv);
                tr.appendChild(tdVienen);

                // Celdas de D√≠as
                for (let d = 1; d <= 31; d++) {
                    const tdDay = document.createElement('td');
                    tdDay.className = "px-1 py-1 border-r border-slate-50";
                    const ind = document.createElement('input');
                    ind.type = "number";
                    ind.className = "input-cell text-slate-500 focus:text-indigo-600 font-medium";
                    ind.value = globalData[`${row.id}/${d}`] || '';
                    ind.onchange = (e) => updateField(row.id, d, e.target.value);
                    tdDay.appendChild(ind);
                    tr.appendChild(tdDay);
                }
                body.appendChild(tr);
            });
        };

        const updateField = async (field, key, value) => {
            const val = parseFloat(value) || 0;
            const path = `${PATH_ROOT}/${currentPeriod}/${field}/${key}`;
            await set(ref(db, path), val);
        };

        // --- Inicializaci√≥n ---
        const init = async () => {
            await signInAnonymously(auth);
            
            // Cargar A√±os en selector
            const selectYear = document.getElementById('select-year');
            for(let y = 2024; y <= 2030; y++) {
                const opt = document.createElement('option');
                opt.value = y; opt.innerText = y;
                selectYear.appendChild(opt);
            }
            selectYear.value = new Date().getFullYear();

            // Cargar Meses
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const selectMonth = document.getElementById('select-month');
            months.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i + 1; opt.innerText = m;
                selectMonth.appendChild(opt);
            });
            selectMonth.value = new Date().getMonth() + 1;

            // Escuchar cambios de periodo
            const updatePeriod = () => {
                currentPeriod = `${selectYear.value}_${selectMonth.value}`;
                listenToData();
                listenAuditLogs();
            };
            selectYear.onchange = updatePeriod;
            selectMonth.onchange = updatePeriod;

            updatePeriod();
            document.getElementById('loader').style.display = 'none';
        };

        const listenToData = () => {
            onValue(ref(db, `${PATH_ROOT}/${currentPeriod}`), (snap) => {
                globalData = snap.val() || {};
                renderTable();
                document.getElementById('sync-status').innerHTML = `<span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Sincronizado`;
                document.getElementById('sync-status').className = "flex items-center gap-1 text-emerald-600 font-bold bg-emerald-50 px-3 py-1.5 rounded-xl border border-emerald-100";
            });
        };

        window.generateQr = () => {
            const cont = document.getElementById('qrcode');
            cont.innerHTML = '';
            new QRCode(cont, { text: window.location.href, width: 200, height: 200 });
            document.getElementById('qr-modal').style.display = 'flex';
        };

        document.getElementById('toggle-dashboard').onclick = () => {
            document.getElementById('quick-dashboard').classList.toggle('open');
        };

        document.getElementById('load-more-logs').onclick = () => {
            logsLimit += 15;
            listenAuditLogs();
            showToast("Cargando historial...");
        };

        init();
    </script>
</body>
</html>
