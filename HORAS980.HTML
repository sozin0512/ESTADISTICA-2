
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroLog Pro - Gesti√≥n de Mantenimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>


        /* Estilos para Auditor√≠a y Llenado R√°pido */
.modal-overlay { 
    position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); 
    backdrop-filter: blur(8px); display: none; align-items: center; 
    justify-content: center; z-index: 1000; padding: 20px; 
}
video#webcam { width: 100%; border-radius: 1rem; background: #000; transform: scaleX(-1); }
#photo-canvas { display: none; }
.quick-input { 
    width: 100%; padding: 12px; background: #f1f5f9; 
    border: 2px solid #e2e8f0; border-radius: 12px; font-weight: bold; 
}
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .table-fixed-column {
            position: sticky;
            left: 0;
            background: white;
            z-index: 20;
            border-right: 2px solid #e2e8f0;
        }

        .input-cell {
            width: 80px;
            text-align: center;
            font-size: 0.75rem;
            padding: 4px;
            border: 1px solid #f1f5f9;
        }

        .input-cell:focus {
            background: #eef2ff;
            outline: 2px solid #6366f1;
            z-index: 30;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* Dashboard desplegable animation */
        #quick-dashboard {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        #quick-dashboard.open {
            max-height: 200px;
            opacity: 1;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

<div id="audit-modal" class="modal-overlay">
    <div class="bg-white rounded-3xl p-6 max-w-md w-full shadow-2xl">
        <div class="text-center mb-4">
            <h3 class="text-xl font-black text-slate-800">Verificaci√≥n de Acceso</h3>
            <p class="text-sm text-slate-500">Toma una foto para activar el llenado r√°pido.</p>
        </div>
        <video id="webcam" autoplay playsinline></video>
        <canvas id="photo-canvas" width="640" height="480"></canvas>
        <div id="gps-info" class="text-[10px] text-center mt-2 font-mono text-slate-400">Obteniendo ubicaci√≥n...</div>
        <button id="btn-capture" class="w-full mt-4 bg-indigo-600 text-white py-4 rounded-2xl font-bold">CAPTURAR Y CONTINUAR</button>
    </div>
</div>

<div id="quick-fill-panel" class="modal-overlay">
    <div class="bg-white rounded-3xl p-6 max-w-lg w-full shadow-2xl">
        <h2 class="text-xl font-black mb-4">LLENADO R√ÅPIDO (MODO QR)</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="text-[10px] font-bold">AC HRS VUELO</label>
                <input type="number" id="q_ac_hrs" class="quick-input" placeholder="0.0">
            </div>
            <div>
                <label class="text-[10px] font-bold">ATERRIZAJES</label>
                <input type="number" id="q_aterrizajes" class="quick-input" placeholder="0">
            </div>
        </div>
        <div class="mt-4 p-4 bg-slate-900 rounded-2xl text-white">
            <p class="text-[10px] text-indigo-400 font-bold uppercase">Comparaci√≥n vs Forma 13</p>
            <div class="flex justify-between mt-2">
                <span>Total Anterior: <b id="q_prev_val">-</b></span>
                <span>Nuevo Total: <b id="q_new_val" class="text-indigo-400">-</b></span>
            </div>
        </div>
        <button id="btn-save-quick" class="w-full mt-6 bg-emerald-600 text-white py-4 rounded-2xl font-black">GUARDAR EN LOGS</button>
        <button onclick="location.reload()" class="w-full mt-2 text-slate-400 text-xs">Cancelar</button>
    </div>
</div>


    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sincronizando...</p>
        </div>
    </div>

    <!-- Modal de Espejo Mejorado -->
    <div id="mirror-modal" class="modal-overlay">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border border-slate-200">
            <h3 class="text-xl font-black text-slate-800 mb-2">Sincronizar Datos</h3>
            <p class="text-sm text-slate-500 mb-6">Selecciona el tipo de espejo que deseas realizar:</p>
            
            <div class="grid gap-3">
                <button onclick="executeMirror('ac_to_engines')" class="flex items-center justify-between p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-emerald-700">AC HRS ‚Üí Motores 1 y 2</div>
                        <div class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">Copia AC HRS a ENGINE HRS de ambos</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>

                <div class="h-px bg-slate-100 my-1"></div>

                <button onclick="executeMirror('table')" class="flex items-center justify-between p-4 bg-slate-50 hover:bg-indigo-50 border border-slate-200 hover:border-indigo-200 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 group-hover:text-indigo-700">Motor 1 ‚Üí Motor 2 (Tabla)</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Registros diarios (1 al 31)</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>

                <button onclick="executeMirror('vienen')" class="flex items-center justify-between p-4 bg-slate-50 hover:bg-indigo-50 border border-slate-200 hover:border-indigo-200 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-slate-700 group-hover:text-indigo-700">Motor 1 ‚Üí Motor 2 (Vienen)</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Acumulados iniciales</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>

                <button onclick="executeMirror('all')" class="flex items-center justify-between p-4 bg-indigo-600 hover:bg-indigo-700 border border-indigo-500 rounded-2xl transition-all group">
                    <div class="text-left">
                        <div class="font-bold text-white">Copiar Todo (M1 a M2)</div>
                        <div class="text-[10px] text-indigo-200 font-bold uppercase tracking-wider">Vienen + Registros Diarios</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </button>
            </div>

            <button onclick="closeMirrorModal()" class="w-full mt-6 text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600">Cancelar</button>
        </div>
    </div>

    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 shadow-sm flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <button id="toggle-dashboard" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tight leading-none uppercase">AEROLOG MASTER</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">FAH-980 Selective Mirror</p>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-slate-100 p-1.5 rounded-2xl border border-slate-200">
            <select id="select-month" class="bg-transparent text-xs font-bold px-3 py-1.5 outline-none cursor-pointer text-slate-700">
                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
            <select id="select-year" class="bg-transparent text-xs font-bold px-3 py-1.5 outline-none cursor-pointer text-slate-700"></select>
        </div>

        <div class="flex gap-2 text-xs">
            <span id="sync-status" class="flex items-center gap-1 text-amber-600 font-bold bg-amber-50 px-3 py-1.5 rounded-xl border border-amber-100">
                <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span> Conectando...
            </span>
            <button id="btn-mirror-trigger" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-xl font-bold border border-indigo-200 hover:bg-indigo-100 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                Men√∫ Espejo
            </button>
            <button id="btn-copy-prev" class="bg-white text-slate-700 px-4 py-2 rounded-xl font-bold border border-slate-200 hover:bg-slate-50 transition-all">Cerrar Mes Anterior</button>
            <button id="btn-export" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-slate-700 transition-all">Exportar JSON</button>
        </div>
    </nav>

    <!-- Dashboard Desplegable de Accesos R√°pidos -->
    <div id="quick-dashboard" class="bg-slate-50 border-b border-slate-200 px-6">
        <div class="max-w-7xl mx-auto">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">M√≥dulos de Reporte e Inspecci√≥n</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#3b4454] hover:bg-[#2d3440] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Generar Reporte del Mes</span>
                </a>
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#4e96d9] hover:bg-[#3d85c8] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Estado de Motores</span>
                </a>
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#a855f7] hover:bg-[#9333ea] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Estado de Componentes</span>
                </a>
                <a href="#" class="flex items-center justify-center text-center p-6 bg-[#14b8a6] hover:bg-[#0d9488] text-white rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    <span class="font-bold text-sm">Inspecciones</span>
                </a>
            </div>
        </div>
    </div>

    <div class="p-4 max-w-[100vw]">
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200" id="header-row">
                            <th class="table-fixed-column px-4 py-6 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest min-w-[200px]">Nomenclatura</th>
                            <th class="px-4 py-2 text-[10px] font-black text-indigo-600 border-r border-slate-200">VIENEN</th>
                        </tr>
                    </thead>
                    <tbody id="master-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl transform translate-y-32 transition-all duration-500 flex items-center gap-3 z-[100]">
        <span id="toast-msg" class="font-bold text-sm tracking-tight"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let firebaseConfig = {
            apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8", 
            projectId: "fah-980-ceb96",
            authDomain: "fah-980-ceb96.firebaseapp.com",
            databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
            storageBucket: "fah-980-ceb96.appspot.com",
            messagingSenderId: "820427334707",
            appId: "1:820427334707:web:753198086036814227806d"
        };

        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) firebaseConfig = { ...firebaseConfig, ...JSON.parse(__firebase_config) }; } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fah-980-master-v1';
        const PATH_ROOT = `artifacts/${appId}/public/data/MAINTENANCE_LOGS`;

        let currentPeriod = ""; 
        let globalData = {};
        let isRendering = false;
        let unsubscribe = null;
        let currentUser = null;

        const baseMotorFields = [
            { id: 'cont_exc', label: 'CONTINGENCY EXCURSIONS', limit: 0, factor: 1 },
            { id: 'eng_hrs', label: 'ENGINE HRS', limit: 0, factor: 1 },
            { id: 'eng_starts', label: 'ENGINE STARTS', limit: 0, factor: 1 },
            { id: 'flights', label: 'FLIGHTS', limit: 0, factor: 1 },
            { id: 'hub_1', label: 'HUB COMPRESOR 1.1', limit: 110000, factor: 3 },
            { id: 'hub_2', label: 'HUB COMPRESOR 1.2', limit: 35000, factor: 1 },
            { id: 'disk_2', label: '2ND STAGE COMPRESOR DISK', limit: 29000, factor: 1 },
            { id: 'disk_3', label: '3RD STAGE COMPRESOR DISK', limit: 29000, factor: 1 },
            { id: 'impeller', label: 'IMPELLER', limit: 29000, factor: 1 },
            { id: 'ct_disk', label: 'COMPRESSOR TURBINE DISK', limit: 7200, factor: 0.9 },
            { id: 'pt_disk_1', label: 'POWER TURBINE DISK 1.1', limit: 57000, factor: 4 },
            { id: 'pt_disk_2', label: 'POWER TURBINE DISK 1.2', limit: 15000, factor: 1 },
            { id: 'ciclos', label: 'CICLOS', limit: 0, factor: 1 }
        ];

        const config = [
            { id: 'ac_hrs', label: 'AC HRS', group: 'GENERAL' },
            { id: 'aterrizajes', label: 'ATERRIZAJES', group: 'GENERAL' },
            { id: 'rins', label: 'RINS', group: 'GENERAL' },
            { type: 'separator', label: 'MOTOR #1' },
            ...baseMotorFields.map(f => ({ ...f, id: `${f.id}_1`, label: `${f.label} 1` })),
            { type: 'separator', label: 'MOTOR #2' },
            ...baseMotorFields.map(f => ({ ...f, id: `${f.id}_2`, label: `${f.label} 2` }))
        ];

        // Toggle Dashboard Logic
        document.getElementById('toggle-dashboard').addEventListener('click', () => {
            document.getElementById('quick-dashboard').classList.toggle('open');
        });

        window.closeMirrorModal = () => document.getElementById('mirror-modal').style.display = 'none';
        
        window.executeMirror = async (mode) => {
            closeMirrorModal();
            document.getElementById('loader').style.display = 'flex';
            
            const mirrorBatch = {};

            if (mode === 'ac_to_engines') {
                const acData = globalData['ac_hrs'] || {};
                const acVienen = globalData['vienen_ac_hrs'] || 0;
                
                ['eng_hrs_1', 'eng_hrs_2'].forEach(engineKey => {
                    mirrorBatch[`vienen_${engineKey}`] = acVienen;
                    mirrorBatch[engineKey] = { ...acData };
                });
                showToast("AC HRS sincronizado a Motores 1 y 2");
            } else {
                baseMotorFields.forEach(field => {
                    const m1Key = `${field.id}_1`;
                    const m2Key = `${field.id}_2`;
                    
                    if((mode === 'vienen' || mode === 'all') && globalData[`vienen_${m1Key}`] !== undefined) {
                        mirrorBatch[`vienen_${m2Key}`] = globalData[`vienen_${m1Key}`];
                    }
                    
                    if((mode === 'table' || mode === 'all') && globalData[m1Key]) {
                        mirrorBatch[m2Key] = { ...globalData[m1Key] };
                    }
                });
                showToast(`Motor 2 actualizado (${mode})`);
            }

            try {
                const dbRef = ref(db, `${PATH_ROOT}/${currentPeriod}`);
                await update(dbRef, mirrorBatch);
            } catch (e) {
                showToast("Error al sincronizar");
            } finally {
                document.getElementById('loader').style.display = 'none';
                renderMatrix();
            }
        };

        const renderMatrix = () => {
            isRendering = true;
            const body = document.getElementById('master-body');
            body.innerHTML = '';
            config.forEach(row => {
                if(row.type === 'separator') {
                    body.innerHTML += `<tr class="bg-slate-100/50 separator-row"><td colspan="45" class="px-4 py-1 text-[9px] font-black text-slate-400 text-center uppercase tracking-[0.3em]">${row.label}</td></tr>`;
                    return;
                }
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 transition-colors data-row";
               // Dentro de renderMatrix, cambia la l√≠nea de la primera celda por esta:
let html = `
<td class="table-fixed-column px-4 py-2 text-xs font-bold text-slate-700 border-r border-slate-200">
    <div class="flex items-center justify-between group">
        ${row.label}
        <button onclick="generateQRForRow('${row.id}', '${row.label}')" class="opacity-0 group-hover:opacity-100 p-1 hover:bg-indigo-100 rounded text-indigo-600 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v-3m0 0h-1m1 0h1m0 0v1m0 4h1m-1 0h-1m0 0v-1m0 4h1m-1 0h-1m0 0v-1m-7-4h1m-1 0h-1m0 0v-1m0 4h1m-1 0h-1m0 0v-1" /></svg>
        </button>
    </div>
</td>`;
                const vV = globalData[`vienen_${row.id}`] || 0;
                html += `<td class="bg-indigo-50/30 border-r border-slate-200"><input type="number" step="0.1" value="${vV}" data-type="vienen" data-id="${row.id}" class="input-cell font-bold text-indigo-700"></td>`;
                let mT = 0;
                for(let d=1; d<=31; d++) {
                    const dV = (globalData[row.id] && globalData[row.id][d]) || 0;
                    mT += parseFloat(dV);
                    html += `<td class="border-r border-slate-50"><input type="number" step="0.1" value="${dV || ''}" placeholder="-" data-type="day" data-id="${row.id}" data-day="${d}" class="input-cell text-slate-500"></td>`;
                }
                html += `<td class="bg-indigo-50 text-center font-bold text-indigo-800 text-xs border-r border-slate-200">${mT.toFixed(1)}</td>`;
                const gT = parseFloat(vV) + mT;
                html += `<td class="bg-indigo-600 text-center font-black text-white text-xs border-r border-slate-200">${gT.toFixed(1)}</td>`;
                const lV = row.limit || 0; const fV = row.factor || 1;
                const rS = lV > 0 ? (lV - (gT * fV)) : 0;
                html += `<td class="bg-yellow-50 text-center font-bold text-slate-600 text-xs border-r border-slate-200">${lV || '-'}</td>`;
                html += `<td class="bg-yellow-50 text-center font-bold text-slate-600 text-xs border-r border-slate-200">${fV || '-'}</td>`;
                html += `<td class="bg-red-50 text-center font-black ${rS < 500 && lV > 0 ? 'text-red-600 animate-pulse' : 'text-slate-800'} text-xs">${lV > 0 ? rS.toFixed(1) : '-'}</td>`;
                tr.innerHTML = html; body.appendChild(tr);
            });
            isRendering = false;
        };

        const setupUIHeader = () => {
            const hR = document.getElementById('header-row');
            for(let i=1; i<=31; i++) { hR.innerHTML += `<th class="px-2 py-2 text-[10px] font-bold border-r border-slate-100">${i}</th>`; }
            hR.innerHTML += `<th class="px-4 py-2 text-[10px] font-black text-indigo-600 border-x border-slate-200 bg-indigo-50 uppercase">Mes</th><th class="px-4 py-2 text-[10px] font-black text-white bg-indigo-600 border-r border-slate-200 uppercase">General</th><th class="px-4 py-2 text-[10px] font-black text-slate-600 bg-yellow-100 border-r border-slate-200 uppercase">L√≠mite</th><th class="px-4 py-2 text-[10px] font-black text-slate-600 bg-yellow-100 border-r border-slate-200 uppercase">Factor</th><th class="px-4 py-2 text-[10px] font-black text-white bg-red-500 uppercase">Restante</th>`;
            const yS = document.getElementById('select-year'); const cY = new Date().getFullYear();
            for(let y = cY-2; y <= cY+5; y++) { const o = document.createElement('option'); o.value = y; o.innerText = y; if(y === cY) o.selected = true; yS.appendChild(o); }
        };

        const setupSync = (user) => {
            if (!user) return;
            if (unsubscribe) unsubscribe();
            unsubscribe = onValue(ref(db, `${PATH_ROOT}/${currentPeriod}`), (snap) => {
                globalData = snap.exists() ? snap.val() : {};
                if (!document.activeElement || document.activeElement.tagName !== 'INPUT') renderMatrix();
                document.getElementById('loader').style.display = 'none';
                updateSyncStatus(true);
            }, () => updateSyncStatus(false));
        };

        const updateSyncStatus = (connected) => {
            const s = document.getElementById('sync-status');
            s.innerHTML = connected ? '<span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Conectado' : '<span class="w-2 h-2 bg-red-500 rounded-full"></span> Error';
            s.className = `flex items-center gap-1 font-bold bg-${connected?'emerald':'red'}-50 px-3 py-1.5 rounded-xl border border-${connected?'emerald':'red'}-100 text-${connected?'emerald':'red'}-600`;
        };

        document.addEventListener('change', async (e) => {
            if (isRendering || e.target.tagName !== 'INPUT') return;
            const i = e.target; const { type, id, day } = i.dataset; const v = parseFloat(i.value) || 0;
            if (type === 'vienen') { await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), { [`vienen_${id}`]: v }); }
            else if (type === 'day') { await set(ref(db, `${PATH_ROOT}/${currentPeriod}/${id}/${day}`), v); }
            renderMatrix();
        });

        const changePeriod = () => {
            currentPeriod = `${document.getElementById('select-month').value}-${document.getElementById('select-year').value}`;
            document.getElementById('loader').style.display = 'flex';
            setupSync(currentUser);
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        };

        setupUIHeader();
        document.getElementById('select-month').addEventListener('change', changePeriod);
        document.getElementById('select-year').addEventListener('change', changePeriod);
        document.getElementById('btn-mirror-trigger').addEventListener('click', () => { document.getElementById('mirror-modal').style.display = 'flex'; });
        document.getElementById('btn-copy-prev').addEventListener('click', async () => {
            const m = parseInt(document.getElementById('select-month').value);
            const y = parseInt(document.getElementById('select-year').value);
            let pM = m-1, pY = y; if(pM<0){pM=11;pY--;}
            const pSnap = await get(ref(db, `${PATH_ROOT}/${pM}-${pY}`));
            if(!pSnap.exists()) return showToast("No hay datos previos");
            if(confirm(`¬øCerrar mes anterior y pasar totales a VIENEN?`)) {
                const pD = pSnap.val(); const b = {};
                config.forEach(r => { if(r.type!=='separator'){ const vV = pD[`vienen_${r.id}`]||0; let vM=0; if(pD[r.id]) Object.values(pD[r.id]).forEach(v=>vM+=parseFloat(v||0)); b[`vienen_${r.id}`] = vV+vM; } });
                await update(ref(db, `${PATH_ROOT}/${currentPeriod}`), b); renderMatrix();
            }
        });

        onAuthStateChanged(auth, (u) => {
            currentUser = u;
            if (u) {
                if(currentPeriod === "") {
                    const d = new Date();
                    document.getElementById('select-month').value = d.getMonth();
                    document.getElementById('select-year').value = d.getFullYear();
                    currentPeriod = `${d.getMonth()}-${d.getFullYear()}`;
                }
                setupSync(u);
            }
        });

        // --- DETECTOR DE ESCANEO QR ---
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('mode') === 'qr') {
    // Esperamos un segundo a que carguen los datos de Firebase
    setTimeout(() => {
        if (typeof initAudit === 'function') {
            initAudit(); 
        } else {
            alert("Error: La funci√≥n de auditor√≠a no se ha cargado correctamente.");
        }
    }, 2000);
}

        const initAuth = async () => {
            try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch (e) {}
        };
        initAuth();

        // Keyboard Navigation System
        document.addEventListener('keydown', (e) => {
            const activeInput = document.activeElement;
            if (!activeInput || activeInput.tagName !== 'INPUT') return;

            const currentTd = activeInput.closest('td');
            const currentRow = activeInput.closest('tr');
            const cellIndex = currentTd.cellIndex;
            let targetInput = null;

            const findNextInputInRow = (row, startIdx, direction) => {
                let idx = startIdx + direction;
                while (idx >= 0 && idx < row.cells.length) {
                    const input = row.cells[idx].querySelector('input');
                    if (input) return input;
                    idx += direction;
                }
                return null;
            };

            const findNextInputInCol = (startRow, colIdx, direction) => {
                let row = direction === 1 ? startRow.nextElementSibling : startRow.previousElementSibling;
                while (row) {
                    if (!row.classList.contains('separator-row')) {
                        const input = row.cells[colIdx]?.querySelector('input');
                        if (input) return input;
                    }
                    row = direction === 1 ? row.nextElementSibling : row.previousElementSibling;
                }
                return null;
            };

            if (e.key === 'ArrowRight') {
                targetInput = findNextInputInRow(currentRow, cellIndex, 1);
            } else if (e.key === 'ArrowLeft') {
                targetInput = findNextInputInRow(currentRow, cellIndex, -1);
            } else if (e.key === 'ArrowDown' || e.key === 'Enter') {
                e.preventDefault();
                targetInput = findNextInputInCol(currentRow, cellIndex, 1);
            } else if (e.key === 'ArrowUp') {
                targetInput = findNextInputInCol(currentRow, cellIndex, -1);
            }

            if (targetInput) {
                targetInput.focus();
                targetInput.select();
            }
        });

        // Variable global para el generador
let qrGenerator = null;

window.generateQRForRow = (id, label) => {
    const container = document.getElementById('qrcode-container');
    const details = document.getElementById('qr-details');
    container.innerHTML = ''; 

    // Creamos el link que activa el modo r√°pido
    const linkActivador = "https://sozin0512.github.io/ESTADISTICA-2/HORAS980.HTML?mode=qr";

    details.innerText = `ESCANEADO PARA: ${label}`;
    document.getElementById('qr-title').innerText = "ACCESO R√ÅPIDO";

    new QRCode(container, {
        text: linkActivador,
        width: 200,
        height: 200,
        colorDark : "#1e1b4b",
        colorLight : "#ffffff"
    });

    document.getElementById('qr-display-modal').style.display = 'flex';
};
window.closeQRModal = () => {
    document.getElementById('qr-display-modal').style.display = 'none';
};

// --- L√ìGICA DE AUDITOR√çA Y LLENADO R√ÅPIDO ---
let userCoords = null;
const PATH_AUDIT = `artifacts/${appId}/public/audit_logs`;

// 1. Detectar si entra por QR
const params = new URLSearchParams(window.location.search);
if (params.get('mode') === 'qr') {
    setTimeout(() => initAudit(), 2000); // Esperar a que carguen los datos
}

async function initAudit() {
    document.getElementById('audit-modal').style.display = 'flex';
    // Obtener GPS
    navigator.geolocation.getCurrentPosition(p => {
        userCoords = { lat: p.coords.latitude, lng: p.coords.longitude };
        document.getElementById('gps-info').innerText = `üìç ${userCoords.lat}, ${userCoords.lng}`;
    });
    // Activar C√°mara
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById('webcam').srcObject = stream;
}

document.getElementById('btn-capture').addEventListener('click', async () => {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('photo-canvas');
    canvas.getContext('2d').drawImage(video, 0, 0, 640, 480);
    const photo = canvas.toDataURL('image/jpeg', 0.5);

    // Guardar Auditor√≠a
    await set(ref(db, `${PATH_AUDIT}/${Date.now()}`), {
        ts: new Date().toLocaleString(),
        coords: userCoords,
        photo: photo,
        user: currentUser?.uid || 'anonimo'
    });

    video.srcObject.getTracks().forEach(t => t.stop());
    document.getElementById('audit-modal').style.display = 'none';
    document.getElementById('quick-fill-panel').style.display = 'flex';
    setupQuickCalculator();
});

function setupQuickCalculator() {
    const day = new Date().getDate();
    // Calcular total anterior de AC HRS
    const vienen = parseFloat(globalData['vienen_ac_hrs'] || 0);
    let mes = 0;
    if(globalData['ac_hrs']) Object.values(globalData['ac_hrs']).forEach(v => mes += parseFloat(v));
    
    document.getElementById('q_prev_val').innerText = (vienen + mes).toFixed(1);

    document.getElementById('q_ac_hrs').addEventListener('input', (e) => {
        const flight = parseFloat(e.target.value) || 0;
        document.getElementById('q_new_val').innerText = (vienen + mes + flight).toFixed(1);
    });
}

document.getElementById('btn-save-quick').addEventListener('click', async () => {
    const day = new Date().getDate();
    const ac = parseFloat(document.getElementById('q_ac_hrs').value) || 0;
    const at = parseFloat(document.getElementById('q_aterrizajes').value) || 0;

    const updates = {};
    const base = `${PATH_ROOT}/${currentPeriod}`;
    
    // Llenado masivo autom√°tico
    updates[`${base}/ac_hrs/${day}`] = ac;
    updates[`${base}/aterrizajes/${day}`] = at;
    updates[`${base}/eng_hrs_1/${day}`] = ac;
    updates[`${base}/eng_hrs_2/${day}`] = ac;
    updates[`${base}/ciclos_1/${day}`] = at;
    updates[`${base}/ciclos_2/${day}`] = at;
    updates[`${base}/flights_1/${day}`] = 1;
    updates[`${base}/flights_2/${day}`] = 1;

    await update(ref(db), updates);
    alert("Sincronizaci√≥n Exitosa");
    window.location.href = window.location.pathname; // Quitar modo QR
});

// Funci√≥n para iniciar C√°mara y GPS
// --- FUNCI√ìN √öNICA DE AUDITOR√çA Y LLENADO ---
window.initAudit = async function() {
    const modal = document.getElementById('audit-modal');
    if (!modal) {
        alert("Falta el HTML del modal de auditor√≠a");
        return;
    }
    
    modal.style.display = 'flex';
    
    // GPS
    navigator.geolocation.getCurrentPosition(
        p => { window.userCoords = { lat: p.coords.latitude, lng: p.coords.longitude }; },
        e => { console.warn("GPS no disponible"); }
    );

    // C√°mara
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('webcam');
        if (video) video.srcObject = stream;
    } catch (err) {
        console.error("Error de c√°mara:", err);
        alert("Se requiere c√°mara para el modo QR");
    }
};

// Funci√≥n para guardar los datos r√°pido (Suma autom√°tica)
document.getElementById('btn-save-quick')?.addEventListener('click', async () => {
    const day = new Date().getDate();
    const acHrs = parseFloat(document.getElementById('q_ac_hrs').value) || 0;
    const aterrizajes = parseFloat(document.getElementById('q_aterrizajes').value) || 0;

    const base = `artifacts/fah-980-master-v1/public/data/MAINTENANCE_LOGS/${currentPeriod}`;
    const updates = {};

    // AQU√ç EST√Å EL LLENADO R√ÅPIDO: Copia AC HRS a Motores y suma vuelos
    updates[`${base}/ac_hrs/${day}`] = acHrs;
    updates[`${base}/aterrizajes/${day}`] = aterrizajes;
    updates[`${base}/eng_hrs_1/${day}`] = acHrs;
    updates[`${base}/eng_hrs_2/${day}`] = acHrs;
    updates[`${base}/ciclos_1/${day}`] = aterrizajes;
    updates[`${base}/ciclos_2/${day}`] = aterrizajes;
    updates[`${base}/flights_1/${day}`] = 1; // Suma 1 vuelo autom√°ticamente
    updates[`${base}/flights_2/${day}`] = 1;

  try {
        await update(ref(db), updates);
        alert("‚úÖ Datos de vuelo sincronizados en Motores 1 y 2");
        // Regresa a la p√°gina limpia sin el ?mode=qr
        window.location.href = "https://sozin0512.github.io/ESTADISTICA-2/HORAS980.HTML";
    } catch (e) {
        alert("Error al guardar: " + e.message);
    }
});
    </script>
</body>
</html>
