<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TÍTULO ACTUALIZADO A FAH-980 -->
    <title>Datos de Vuelo FAH-980</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales del cuerpo y fondo */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, #87CEEB 0%, #ADD8E6 100%); /* Azul cielo a azul claro */
            overflow-x: hidden; /* Evita el scroll horizontal */
            position: relative; /* Para posicionar elementos absolutos */
        }

        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 1.875rem; /* 30px */
            margin-bottom: 1.25rem; /* 20px */
            color: #2c3e50;
        }

        /* Contenedor de autenticación */
        #auth-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 2.5rem; /* Más padding */
            border: 1px solid #d1d5db; /* Borde más sutil */
            border-radius: 0.75rem; /* 12px, más redondeado */
            max-width: 400px;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            background: linear-gradient(135deg, #fdfefe 0%, #ffffff 100%); /* Gradiente suave */
            box-shadow: 0 20px 30px -8px rgba(0, 0, 0, 0.25), 0 10px 10px -5px rgba(0, 0, 0, 0.1); /* Sombra pronunciada */
            animation: fadeInScale 1s ease-out forwards; /* Animación de aparición */
            position: relative;
            z-index: 10;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        #auth-container h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.75rem; /* 28px */
            margin-bottom: 1.75rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.15);
        }

        #auth-container input {
            width: calc(100% - 22px);
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #auth-container input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.25);
            outline: none;
        }

        #auth-container button {
            padding: 12px 25px;
            margin: 8px 5px;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
            text-shadow: 0 1px 2px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        #auth-container button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
            transition: all 0.4s ease;
        }
        #auth-container button:hover::before {
            left: 100%;
        }

        #auth-container button:active {
            transform: translateY(3px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        #auth-container button:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.25);
        }

        /* Colores de botones de autenticación */
        #login-btn { background: linear-gradient(to right, #22c55e, #10b981); color: white; }
        #login-btn:hover { background: linear-gradient(to right, #16a34a, #059669); }
        #signup-btn { background: linear-gradient(to right, #3b82f6, #2563eb); color: white; }
        #signup-btn:hover { background: linear-gradient(to right, #2563eb, #1d4ed8); }
        #forgot-password-btn { background: linear-gradient(to right, #f59e0b, #eab308); color: white; }
        #forgot-password-btn:hover { background: linear-gradient(to right, #d97706, #ca8a04); }
        #logout-btn { background: linear-gradient(to right, #ef4444, #dc2626); color: white; }
        #logout-btn:hover { background: linear-gradient(to right, #dc2626, #b91c1c); }
        #inspections-btn { background: linear-gradient(to right, #8b5cf6, #7c3aed); color: white; }
        #inspections-btn:hover { background: linear-gradient(to right, #7c3aed, #6d28d9); }

        #auth-status {
            color: #dc2626;
            margin-top: 1.25rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* Contenedor principal de la aplicación */
        #main-app-content {
            display: none; /* Oculto por defecto */
            width: 100%;
        }
        #main-app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        #main-app-header h2 {
            margin-bottom: 0;
        }

        /* Estilos de la tabla y elementos relacionados */
        .user-id-container {
            text-align: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: #555;
        }
        .year-container, .tab-container, .button-container {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            background-color: #ddd;
            border: 1px solid #999;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s ease;
        }
        .tab-button:hover { background-color: #d0d0d0; }
        .tab-button.active {
            background-color: #b0c4de;
            font-weight: bold;
            border-color: #90a4b0;
        }

        table {
            border-collapse: collapse;
            width: auto; /* Ajustar ancho automáticamente */
            font-size: 0.6875rem; /* 11px */
            margin: 0 auto; /* Centrar tabla */
            margin-top: 1.25rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        th, td {
            border: 1px solid #dcdcdc;
            padding: 0.375rem;
            text-align: center;
            min-width: 25px;
            white-space: nowrap;
        }
        th {
            background-color: #b0c4de;
            color: #333;
            font-weight: bold;
        }
        .nomenclatura {
            background-color: #e9e9e9;
            font-weight: bold;
            text-align: left;
            padding-left: 5px;
            min-width: 150px;
        }
        .motor-header {
            background-color: #ffc000;
            font-weight: bold;
            text-align: center;
        }

        /* Estilos para celdas editables y de solo lectura */
        td.editable-cell {
            background-color: #fefefe;
            cursor: text;
        }
        td.editable-cell:focus {
            outline: 2px solid #6cb2eb;
            background-color: #e6f7ff;
        }
        td.read-only-cell {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        /* Estilos para el efecto LED */
        .led-persistente {
            background-color: #f8f7f7 !important;
            color: #0e0f0e;
            animation: resplandor 2s infinite;
            font-weight: bold;
        }
        @keyframes resplandor {
            0% { box-shadow: 0 0 5px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 15px rgba(0,0,0,0.4); }
            100% { box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        }
        .celda-modificada {
            animation: ledFlash 1s ease-in-out;
        }
        @keyframes ledFlash {
            0% { background-color: #39ff14; }
            50% { background-color: #f8f7f7; }
            100% { background-color: #f8f7f7; }
        }

        /* Estilos para el texto de RESTANTE */
        .restante-verde { color: green; font-weight: bold; }
        .restante-amarillo { color: orange; font-weight: bold; }
        .restante-rojo { color: red; font-weight: bold; }

        /* Nuevos estilos para las etiquetas y el parpadeo */
        .label-yellow { background-color: #FFFF00; font-weight: bold; }
        .label-red { background-color: #FF0000; color: white; font-weight: bold; }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .blinking { animation: blink 1s infinite; }

        /* Contenedor para el cuadro de recordatorio global */
        .recordatorio-global-container {
            margin-top: 15px;
            width: 100%;
            border: 1px solid #000;
            background-color: #e0e0e0;
            padding: 5px;
            box-sizing: border-box;
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border-radius: 8px;
        }
        #recordatorio-textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #aaa;
            background-color: #e0e0e0;
            resize: vertical;
            font-family: Arial, sans-serif;
            font-size: 11px;
            padding: 5px;
            box-sizing: border-box;
            border-radius: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        #recordatorio-textarea::placeholder { color: #666; }

        /* Contenedor para las opciones de impresión */
        .print-options-container {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .print-options-container label {
            margin: 0 10px;
            font-weight: normal;
        }

        /* Estilos del helicóptero */
        #helicopter-svg {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: auto;
            filter: drop-shadow(3px 5px 2px rgba(0, 0, 0, 0.2));
            z-index: 20;
            animation: flyInHeli 2s ease-out forwards, hover 3s ease-in-out infinite alternate 2s;
        }
        @keyframes flyInHeli {
            from { top: -150px; opacity: 0; transform: translateX(-50%) rotate(-15deg); }
            to { top: 20px; opacity: 1; transform: translateX(-50%) rotate(0deg); }
        }
        @keyframes hover {
            0% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
            100% { transform: translateX(-50%) translateY(0px); }
        }

        /* Estilos de la careta de Anonymous */
        #anonymous-mask-img {
            position: absolute;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            width: 60px;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(3px 5px 2px rgba(0, 0, 0, 0.2));
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            animation: dropAndRiseMask 4s ease-in-out forwards 2.5s;
        }
        @keyframes dropAndRiseMask {
            0% { opacity: 0; transform: translateX(-50%) translateY(-100%); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            35% { transform: translateX(-50%) translateY(var(--mask-drop-distance)); }
            65% { transform: translateX(-50%) translateY(var(--mask-drop-distance)); }
            90% { transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-100%); }
        }

        /* Estilos del efecto de revelación (círculo blanco) */
        #reveal-circle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 100px;
            height: 100px;
            background-color: white;
            border-radius: 50%;
            opacity: 0;
            z-index: 12;
            pointer-events: none;
            animation: revealEffect 1s ease-out forwards 3.9s;
        }
        @keyframes revealEffect {
            0% { opacity: 0; transform: translateX(-50%) scale(0); }
            50% { opacity: 0.8; transform: translateX(-50%) scale(1); }
            100% { opacity: 0; transform: translateX(-50%) scale(1.5); }
        }

        /* --- INICIO: Estilos del modal de REPORTE (NUEVO) --- */
        #reportModal {
            display: none; /* Oculto por defecto */
        }
        /* --- FIN: Estilos del modal de REPORTE (NUEVO) --- */


        /* Estilos de impresión */
        @media print {
            /* --- INICIO: Lógica de impresión modificada --- */
            
            /* 1. Ocultar todo por defecto */
            body > *:not(.printable-report-area) {
                display: none;
            }

            /* 2. Reglas para cuando se imprime el REPORTE (usando el modal) */
            body.imprimiendo-reporte {
                margin: 0;
                padding: 0;
                background: none;
            }
            
            body.imprimiendo-reporte #reportModal {
                display: flex !important;
                flex-direction: column;
                position: static !important;
                background: white !important;
                inset: 0 !important;
                padding: 10mm !important;
                border: none !important;
                box-shadow: none !important;
            }

            body.imprimiendo-reporte #printableReportArea {
                display: block !important;
                overflow: visible !important;
            }
            
            /* Ocultar los botones del modal de reporte al imprimirlo */
            body.imprimiendo-reporte .report-modal-buttons {
                display: none !important;
            }

            /* Asegurar que el contenido del reporte use todo el ancho */
            body.imprimiendo-reporte #reportModalContent table {
                width: 100% !important;
                font-size: 10pt !important;
                border-collapse: collapse !important;
            }
             body.imprimiendo-reporte #reportModalContent th,
             body.imprimiendo-reporte #reportModalContent td {
                border: 1px solid #000 !important;
                padding: 4px !important;
                color: #000 !important;
             }

            
            body.imprimiendo-reporte #reportModalTitle {
                font-size: 18pt !important;
                text-align: center !important;
                margin-bottom: 20px !important;
                color: #000 !important;
            }

            /* 3. Reglas para cuando se imprime la TABLA PRINCIPAL (lógica original) */
            body:not(.imprimiendo-reporte) {
                margin: 0;
                padding: 10mm;
                font-size: 10px;
            }
            body:not(.imprimiendo-reporte) .button-container, 
            body:not(.imprimiendo-reporte) .tab-container, 
            body:not(.imprimiendo-reporte) .year-container, 
            body:not(.imprimiendo-reporte) #auth-container, 
            body:not(.imprimiendo-reporte) #helicopter-svg, 
            body:not(.imprimiendo-reporte) #anonymous-mask-img, 
            body:not(.imprimiendo-reporte) #reveal-circle,
            body:not(.imprimiendo-reporte) #main-app-header, 
            body:not(.imprimiendo-reporte) .print-options-container, 
            body:not(.imprimiendo-reporte) .user-id-container,
            body:not(.imprimiendo-reporte) #motorStatusModal,
            body:not(.imprimiendo-reporte) #reportModal, /* Ocultar el modal de reporte si no es su impresión */
            /* Ocultar todos los nuevos modales QR en la impresión de tabla */
            body:not(.imprimiendo-reporte) #flightDataModal,
            body:not(.imprimiendo-reporte) #confirmationModal,
            body:not(.imprimiendo-reporte) #customAlertModal,
            body:not(.imprimiendo-reporte) #dataConflictModal,
            body:not(.imprimiendo-reporte) #mechanicNameModal,
            body:not(.imprimiendo-reporte) #goodbyeModal { 
                display: none !important; 
            }

            body:not(.imprimiendo-reporte) .print-header { display: block !important; }
            body:not(.imprimiendo-reporte) table {
                page-break-inside: avoid;
                width: 100%; 
                border-collapse: collapse;
            }
            body:not(.imprimiendo-reporte) th, 
            body:not(.imprimiendo-reporte) td {
                page-break-inside: avoid;
                page-break-after: auto;
                border: 1px solid #000 !important;
                padding: 2px;
                font-size: 9px; 
            }
            body:not(.imprimiendo-reporte) .nomenclatura {
                text-align: left !important;
                padding-left: 2px !important;
                min-width: 120px !important; 
            }
            body:not(.imprimiendo-reporte) .restante-verde, 
            body:not(.imprimiendo-reporte) .restante-amarillo, 
            body:not(.imprimiendo-reporte) .restante-rojo,
            body:not(.imprimiendo-reporte) .label-yellow, 
            body:not(.imprimiendo-reporte) .label-red {
                -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important;
            }
            body:not(.imprimiendo-reporte) .recordatorio-global-container, 
            body:not(.imprimiendo-reporte) #recordatorio-textarea {
                display: block !important; 
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                background-color: #e0e0e0 !important;
                border: 1px solid #000 !important;
            }
            body:not(.imprimiendo-reporte) #recordatorio-textarea::placeholder {
                text-shadow: none !important; 
                color: #000 !important;
            }
            body:not(.imprimiendo-reporte) .blinking {
                animation: none !important;
                opacity: 1 !important;
            }
            /* Reglas específicas para ocultar elementos según la clase del body */
            body:not(.imprimiendo-reporte).print-no-reminders .recordatorio-global-container {
                display: none !important;
            }
            body:not(.imprimiendo-reporte).print-no-yellow-labels .recordatorio-global-container,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .label-yellow,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .restante-label,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .limite-celda,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .abbrd-celda,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .extd-celda,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .flight-count-factor-celda,
            body:not(.imprimiendo-reporte).print-no-yellow-labels .fila-restante {
                display: none !important;
            }
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            /* --- FIN: Lógica de impresión modificada --- */
        }
    </style>
</head>
<body>
    <svg id="helicopter-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
            <path d="M16 13.5C16 15.433 13.3137 17 10 17C6.68629 17 4 15.433 4 13.5C4 11.567 6.68629 10 10 10C13.3137 10 16 11.567 16 13.5Z" fill="#3498db" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 12.5C12 13.0523 11.5523 13.5 11 13.5H9C8.44772 13.5 8 13.0523 8 12.5C8 11.9477 8.44772 11.5 9 11.5H11C11.5523 11.5 12 11.9477 12 12.5Z" fill="#ecf0f1"></path>
            <path d="M16 13.5H20C20.5523 13.5 21 13.0523 21 12.5C21 11.9477 20.5523 11.5 20 11.5H16" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M5 16.5L4 18.5M15 16.5L16 18.5" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M4 18.5H16" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M10 10V4C10 3.44772 10.4477 3 11 3H13C13.5523 3 14 3.44772 14 4V10" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 2V1C12 0.447715 11.5523 0 11 0H9C8.44772 0 8 0.447715 8 1V2" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 2H18C18.5523 2 19 2.44772 19 3V5C19 5.55228 18.5523 6 18 6H12" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20 11.5V9.5C20 8.94772 20.4477 8.5 21 8.5H23C23.5523 8.5 24 8.94772 24 9.5V11.5" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20 11.5H22C22.5523 11.5 23 11.9477 23 12.5V14.5C23 15.0523 22.5523 15.5 22 15.5H20" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </g>
    </svg>

    <img id="anonymous-mask-img" src="https://wallpapercrafter.com/desktop/340779-Technology-Anonymous-Phone-Wallpaper.jpg" alt="Anonymous Mask">

    <div id="reveal-circle"></div>

    <div id="auth-container" class="rounded-lg shadow-md p-6 bg-white">
        <h3 class="text-xl font-semibold mb-4">Acceso de Usuario</h3>
        <input type="email" id="email" placeholder="Correo electrónico" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="password" id="password" placeholder="Contraseña" class="w-full p-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <div class="flex flex-col sm:flex-row justify-center gap-2">
            <button id="login-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">Iniciar Sesión</button>
            <button id="signup-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Registrarse</button>
        </div>
        <button id="forgot-password-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors mt-4">Olvidé mi contraseña</button>
        <p id="auth-status" class="text-red-600 mt-3 text-sm"></p>
    </div>

    <div id="main-app-content">
        <div id="main-app-header" class="flex justify-between items-center mb-4">
            <!-- ENCABEZADO ACTUALIZADO A FAH-980 -->
            <h2 class="flex-grow text-center sm:text-left">DATOS DE VUELO FAH-980</h2>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors">Cerrar Sesión</button>
        </div>

        <div class="user-id-container">
            ID de Usuario: <span id="user-id">Cargando...</span>
        </div>
        <div class="year-container">
            Año: <select id="select-year" class="p-2 border border-gray-300 rounded-md"></select>
        </div>
        <div class="tab-container" id="meses"></div>

        <div class="print-header" id="print-month-header"></div>

        <div id="contenedor-tablas" class="overflow-x-auto"></div>
        
        <div class="recordatorio-global-container">
            <strong>Recordatorios del Mes:</strong>
            <textarea id="recordatorio-textarea" placeholder="Escribe tus recordatorios aquí"></textarea>
        </div>

        <div class="print-options-container">
            <strong>Opciones de Impresión:</strong>
            <label><input type="radio" name="printOption" value="full" checked> Tabla Completa</label>
            <label><input type="radio" name="printOption" value="no-reminders"> Sin Recordatorios</label>
            <label><input type="radio" name="printOption" value="no-yellow-labels"> Sin Columnas Amarillas</label>
        </div>

        <div class="button-container flex justify-center gap-4 mt-4">
            <!-- *** MODIFICADO: El ID sigue siendo el mismo, pero ahora tiene una nueva función *** -->
            <button id="btnImprimir" class="px-6 py-2 bg-gray-700 text-white rounded-md shadow-md hover:bg-gray-800 transition-colors">Generar Reporte del Mes</button>
            <button id="btnMotorStatus" class="px-6 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors">Estado de Motores</button>
            <!-- ENLACE ACTUALIZADO A 980 -->
            <button id="btnComponentStatus" class="px-6 py-2 bg-purple-500 text-white rounded-md shadow-md hover:bg-purple-600 transition-colors">Estado de Componentes</button>
            <!-- ENLACE ACTUALIZADO A 980 -->
            <button id="inspections-btn" class="px-6 py-2 bg-purple-600 text-white rounded-md shadow-md hover:bg-purple-700 transition-colors">Inspecciones</button>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE REPORTE DETALLADO ==== -->
    <!-- ====================================================== -->
    <div id="reportModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <!-- Contenedor del modal -->
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-3xl w-full text-center flex flex-col max-h-[90vh]">
            
            <!-- Área de contenido imprimible -->
            <div id="printableReportArea" class="overflow-y-auto flex-grow">
                <h3 id="reportModalTitle" class="text-2xl font-bold mb-4">Reporte Detallado</h3>
                <div id="reportModalContent" class="text-left">
                    <!-- El contenido del reporte se generará aquí con JavaScript -->
                </div>
            </div>
            
            <!-- Botones (no se imprimen) -->
            <div class="report-modal-buttons flex justify-center gap-4 mt-6 flex-shrink-0">
                <button id="printReportBtn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Imprimir Reporte</button>
                <button id="closeReportBtn" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE REPORTE DETALLADO ==== -->
    <!-- ==================================================== -->


    <div id="motorStatusModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl overflow-y-auto" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Estado de Componentes de Motores</h3>
                <button id="closeMotorStatusModal" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            <div id="motorStatusContent" class="space-y-4">
            </div>
            <div class="print-options-container mt-6">
                <strong>Opciones de Impresión:</strong>
                <label><input type="radio" name="motorStatusPrintOption" value="full" checked> Completo</label>
                <label><input type="radio" name="motorStatusPrintOption" value="critical-only"> Solo Críticos</label>
            </div>
            <button id="btnPrintMotorStatus" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Imprimir Estado</button>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE INGRESO RÁPIDO (QR) ==== -->
    <!-- ====================================================== -->
    <div id="flightDataModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <!-- --- MODIFICADO: Contenedor de modal con flex-col y max-h --- -->
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center flex flex-col max-h-[90vh]">
            <!-- --- INICIO: Encabezado (no se desplaza) --- -->
            <div class="flex-shrink-0">
                <h3 class="text-2xl font-bold mb-4">Ingreso de Vuelo Rápido (FAH-980)</h3>
                <p class="text-lg mb-4">Datos para el día: <strong id="flightModalDate"></strong></p>
            </div>
            <!-- --- FIN: Encabezado --- -->

            <!-- --- MODIFICADO: Contenedor de campos (ahora se desplaza) --- -->
            <div class="space-y-4 text-left overflow-y-auto flex-grow pr-2">
                <div>
                    <label for="modalAcHrs" class="block text-sm font-medium text-gray-700">AC HRS</label>
                    <input type="number" id="modalAcHrs" placeholder="Ej: 1.5" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalAterrizajes" class="block text-sm font-medium text-gray-700">ATERRIZAJES</label>
                    <input type="number" id="modalAterrizajes" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalRins" class="block text-sm font-medium text-gray-700">RINS</label>
                    <input type="number" id="modalRins" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- ==== INICIO: CAMPOS PARA 980 (Basados en 906) ==== -->
                <div>
                    <label for="modalEngineHrs1" class="block text-sm font-medium text-gray-700">Engine Hrs 1</label>
                    <input type="number" id="modalEngineHrs1" placeholder="Ej: 1.5" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalEngineHrs2" class="block text-sm font-medium text-gray-700">Engine Hrs 2</label>
                    <input type="number" id="modalEngineHrs2" placeholder="Ej: 1.5" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalEngineStarts1" class="block text-sm font-medium text-gray-700">Ciclos Motor 1 (Starts 1)</label>
                    <input type="number" id="modalEngineStarts1" placeholder="Ej: 2" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalEngineStarts2" class="block text-sm font-medium text-gray-700">Ciclos Motor 2 (Starts 2)</label>
                    <input type="number" id="modalEngineStarts2" placeholder="Ej: 2" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalFlights1" class="block text-sm font-medium text-gray-700">Vuelos 1 (Flights 1)</label>
                    <input type="number" id="modalFlights1" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalFlights2" class="block text-sm font-medium text-gray-700">Vuelos 2 (Flights 2)</label>
                    <input type="number" id="modalFlights2" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- ==== FIN: CAMPOS PARA 980 ==== -->
            </div>
            <!-- --- FIN: Contenedor de campos --- -->

            <!-- --- INICIO: Pie de modal (botones, no se desplaza) --- -->
            <div class="flex justify-center gap-4 mt-6 flex-shrink-0">
                <button id="saveFlightDataBtn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Guardar</button>
                <button id="cancelFlightDataBtn" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
            <!-- --- FIN: Pie de modal --- -->
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE INGRESO RÁPIDO (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE CONFIRMACIÓN (QR) ==== -->
    <!-- ====================================================== -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4">Confirmar Totales</h3>
            <p class="text-lg mb-4">¿Coincide esto con tu reporte de vuelo?</p>
            
            <!-- ==== INICIO: MODAL DE CONFIRMACIÓN RECONSTRUIDO ==== -->
            <!-- Contenedor scrollable para la lista de todos los campos -->
            <div id="confirmationListContainer" class="max-h-64 overflow-y-auto space-y-3 text-left bg-gray-50 p-4 rounded-md mb-3">
                <!-- JavaScript llenará esta sección dinámicamente -->
            </div>
            <!-- ==== FIN: MODAL DE CONFIRMACIÓN RECONSTRUIDO ==== -->

            <!-- ==== INICIO: NUEVO RECORDATORIO DE CAPTURA ==== -->
            <p class="text-sm font-medium text-gray-800 mt-5 bg-yellow-100 border border-yellow-300 rounded-md p-3 shadow-sm">
                <strong>Recordatorio:</strong> ¡REVISA BIEN LOS DATOS ANTES DE CONTINUAR FIJATE BIEN EN TU REPORTE DE VUELO ATT:ESTADISTICA 
                POWERED HACKER-01!
            </p>
            <!-- ==== FIN: NUEVO RECORDATORIO DE CAPTURA ==== -->

            <div class="mt-6">
                <button id="closeConfirmationBtn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Confirmado</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE CONFIRMACIÓN (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE ALERTA PERSONALIZADA ==== -->
    <!-- ====================================================== -->
    <div id="customAlertModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4 text-red-600">Error</h3>
            <p id="customAlertMessage" class="text-lg mb-6">Este es un mensaje de error.</p>
            <button id="customAlertCloseBtn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Entendido</button>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE ALERTA PERSONALIZADA ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE CONFLICTO DE DATOS (QR) ==== -->
    <!-- ====================================================== -->
    <div id="dataConflictModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4 text-yellow-600">Datos Existentes Detectados</h3>
            <p class="text-lg mb-6">Ya tienes datos registrados para este día. ¿Qué deseas hacer?</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="overwriteDataBtn" class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors mb-2 sm:mb-0">Borrar y Reemplazar</button>
                <button id="sumDataBtn" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors mb-2 sm:mb-0">Sumar a lo Existente</button>
                <button id="cancelConflictBtn" class="w-full sm:w-auto px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE CONFLICTO DE DATOS (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE NOMBRE DE MECÁNICO (QR) ==== -->
    <!-- ====================================================== -->
    <div id="mechanicNameModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4">Registro de Mecánico</h3>
            <p class="text-lg mb-4">Por último, ¿quién está llenando el reporte?</p>
            <div class="space-y-4 text-left">
                <div>
                    <label for="modalMechanicName" class="block text-sm font-medium text-gray-700">Nombre de Mecánico a Bordo</label>
                    <input type="text" id="modalMechanicName" placeholder="Ej: Juan Pérez" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="saveMechanicNameBtn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Guardar y Salir</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE NOMBRE DE MECÁNICO (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE DESPEDIDA (QR) ==== -->
    <!-- ====================================================== -->
    <div id="goodbyeModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4 text-green-600">Registro Completo</h3>
            <p id="goodbyeMessage" class="text-lg mb-6">¡Gracias, Juan Pérez! Tu reporte ha sido guardado.</p>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE DESPEDIDA (QR) ==== -->
    <!-- ==================================================== -->


    <script type="module">
        // Importa las funciones necesarias de Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, set, onValue, get } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';

        // --- CONFIGURACIÓN DE FIREBASE ACTUALIZADA A FAH-980 ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8",
            authDomain: "fah-980-ceb96.firebaseapp.com",
            databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
            projectId: "fah-980-ceb96",
            storageBucket: "fah-980-ceb96.firebasestorage.app",
            messagingSenderId: "57890484294",
            appId: "1:57890484294:web:8a27759a4da0b262e99a47",
            measurementId: "G-HSZMRM7ZCS"
        };
        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Opcional, si no lo usas puedes quitarlo
        const database = getDatabase(app); // Obtiene la instancia de Realtime Database
        const auth = getAuth(app); // Obtiene la instancia de Autenticación

        // --- RUTA DE DATOS ACTUALIZADA A FAH-980 ---
        const sharedProjectId = "FAH-980-DATA";

        // Define __app_id con un valor por defecto si no está definida
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        console.log("App ID utilizada:", appId);

        // Variables globales
        let añoActual = new Date().getFullYear(); // Inicia con el año actual
        let mesActual = new Date().getMonth(); // Inicia con el mes actual (0-11)
        let userId = "anonimo"; // Valor por defecto, se actualizará con el UID de Firebase Auth
        let currentUserRole = null; // Rol del usuario actual
        let pendingFlightData = null; // Variable global para guardar datos de QR temporalmente

        const años = [2024, 2025, 2026, 2027, 2028];
        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // Definición de todas las filas en el ORDEN FINAL DESEADO
        const nombresFilasOrdenadas = [
            "AC HRS",
            "ATERRIZAJES",
            "RINS",
            "CONTINGENCY EXCURSIONS 1",
            "HUB COMPRESOR 1.1",
            "HUB COMPRESOR 1.2",
            "2ND STAGE COMPRESOR DISK 1",
            "3RD STAGE COMPRESOR DISK 1",
            "IMPELLER 1",
            "COMPRESSOR TURBINE DISK 1",
            "POWER TURBINE DISK 1.1",
            "POWER TURBINE DISK 1.2",
            "CONTINGENCY EXCURSIONS 2", 
            "HUB COMPRESOR 2.1",
            "HUB COMPRESOR 2.2",
            "2ND STAGE COMPRESOR DISK 2",
            "3RD STAGE COMPRESOR DISK 2",
            "IMPELLER 2",
            "COMPRESSOR TURBINE DISK 2",
            "POWER TURBINE DISK 2.1",
            "POWER TURBINE DISK 2.2",
        ];

        // Nomenclaturas EXACTAS de las filas que deben tener las 5 columnas adicionales (editable)
        const filasConColumnasAdicionalesEditables = [
            "HUB COMPRESOR 1.1", "HUB COMPRESOR 1.2",
            "2ND STAGE COMPRESOR DISK 1", "3RD STAGE COMPRESOR DISK 1", "IMPELLER 1",
            "COMPRESSOR TURBINE DISK 1",
            "POWER TURBINE DISK 1.1", "POWER TURBINE DISK 1.2",
            "HUB COMPRESOR 2.1", "HUB COMPRESOR 2.2",
            "2ND STAGE COMPRESOR DISK 2", "3RD STAGE COMPRESOR DISK 2", "IMPELLER 2",
            "COMPRESSOR TURBINE DISK 2",
            "POWER TURBINE DISK 2.1", "POWER TURBINE DISK 2.2"
        ];
        
        // Nomenclaturas EXACTAS de las filas que deben tener las 5 columnas adicionales (solo etiquetas, como CICLOS)
        const filasConColumnasAdicionalesSoloEtiquetas = [
            "CICLOS 1", "CICLOS 2"
        ];

        // Definición de límites y factores fijos
        const limitesConfig = {
            "HUB COMPRESOR": {
                "1.1": { abbreviated: 2, extended: 0, flightCount: 3.0, limitCycles: 110000 },
                "1.2": { abbreviated: 2, extended: 0, flightCount: 1.0, limitCycles: 35000 },
                "2.1": { abbreviated: 2, extended: 0, flightCount: 3.0, limitCycles: 110000 },
                "2.2": { abbreviated: 2, extended: 0, flightCount: 1.0, limitCycles: 35000 }
            },
            "2ND STAGE COMPRESOR DISK": { abbreviated: 2, extended: 0, flightCount: 1.0, limitCycles: 29000 },
            "3RD STAGE COMPRESOR DISK": { abbreviated: 2, extended: 0, flightCount: 1.0, limitCycles: 29000 },
            "IMPELLER": { abbreviated: 2, extended: 0, flightCount: 1.0, limitCycles: 29000 },
            "COMPRESSOR TURBINE DISK": { abbreviated: 4, extended: 15, flightCount: 0.9, limitCycles: 7200 },
            "POWER TURBINE DISK": {
                "1.1": { abbreviated: 10, extended: 3, flightCount: 4.0, limitCycles: 57000 },
                "1.2": { abbreviated: 10, extended: 3, flightCount: 1.0, limitCycles: 15000 },
                "2.1": { abbreviated: 10, extended: 3, flightCount: 4.0, limitCycles: 57000 },
                "2.2": { abbreviated: 10, extended: 3, flightCount: 1.0, limitCycles: 15000 }
            }
        };

        // Referencias a elementos del DOM
        const contenedorTablas = document.getElementById("contenedor-tablas");
        const contenedorMeses = document.getElementById("meses");
        const selectYear = document.getElementById("select-year");
        const printMonthHeader = document.getElementById("print-month-header");
        const recordatorioTextarea = document.getElementById("recordatorio-textarea");
        const userIdDisplay = document.getElementById("user-id");

        // Elementos de autenticación
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const authContainer = document.getElementById('auth-container');
        const mainAppContent = document.getElementById('main-app-content');
        const btnImprimir = document.getElementById('btnImprimir');

        // Elementos para el estado de motores
        const btnMotorStatus = document.getElementById('btnMotorStatus');
        const motorStatusModal = document.getElementById('motorStatusModal');
        const closeMotorStatusModal = document.getElementById('closeMotorStatusModal');
        const motorStatusContent = document.getElementById('motorStatusContent');
        const btnPrintMotorStatus = document.getElementById('btnPrintMotorStatus');
        // Botón de estado de componentes
        const btnComponentStatus = document.getElementById('btnComponentStatus');
        // Botón de inspecciones
        const btnInspections = document.getElementById('inspections-btn');

        // --- INICIO: NUEVOS ELEMENTOS DEL MODAL DE REPORTE ---
        const reportModal = document.getElementById('reportModal');
        const printReportBtn = document.getElementById('printReportBtn');
        const closeReportBtn = document.getElementById('closeReportBtn');
        // --- FIN: NUEVOS ELEMENTOS DEL MODAL DE REPORTE ---

        // --- INICIO: NUEVOS ELEMENTOS DEL MODAL QR ---
        const flightDataModal = document.getElementById('flightDataModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const flightModalDate = document.getElementById('flightModalDate');
        const saveFlightDataBtn = document.getElementById('saveFlightDataBtn');
        const cancelFlightDataBtn = document.getElementById('cancelFlightDataBtn');
        const closeConfirmationBtn = document.getElementById('closeConfirmationBtn');
        const modalAcHrs = document.getElementById('modalAcHrs');
        const modalAterrizajes = document.getElementById('modalAterrizajes');
        const modalRins = document.getElementById('modalRins');
        const modalEngineHrs1 = document.getElementById('modalEngineHrs1');
        const modalEngineHrs2 = document.getElementById('modalEngineHrs2');
        const modalEngineStarts1 = document.getElementById('modalEngineStarts1');
        const modalEngineStarts2 = document.getElementById('modalEngineStarts2');
        const modalFlights1 = document.getElementById('modalFlights1');
        const modalFlights2 = document.getElementById('modalFlights2');
        const dataConflictModal = document.getElementById('dataConflictModal');
        const mechanicNameModal = document.getElementById('mechanicNameModal');
        const modalMechanicName = document.getElementById('modalMechanicName');
        const saveMechanicNameBtn = document.getElementById('saveMechanicNameBtn');
        const goodbyeModal = document.getElementById('goodbyeModal');
        const goodbyeMessage = document.getElementById('goodbyeMessage');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');
        // --- FIN: NUEVOS ELEMENTOS DEL MODAL QR ---

        // --- INICIO: Icono de Mecánico (para Tooltip) ---
        const iconoMecanicoHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-3 w-3 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
        </svg>`;
        // --- FIN: Icono de Mecánico ---

        // Helper para extraer la nomenclatura base y la variante (ej. "HUB COMPRESOR" y "1.1")
        function parseNomenclatura(nombreCompleto) {
            let nomenclaturaBase = '';
            let varianteClave = ''; 
            const matchNumericPart = nombreCompleto.match(/(\d+(?:\.\d+)?)$/);
            if (matchNumericPart) {
                varianteClave = matchNumericPart[1];
                nomenclaturaBase = nombreCompleto.substring(0, nombreCompleto.length - varianteClave.length).trim();
            } else {
                nomenclaturaBase = nombreCompleto;
            }
            return { nomenclaturaBase, varianteClave };
        }

        /**
         * Formatea un número para mostrarlo sin decimales si es un entero,
         * o con decimales si tiene parte fraccionaria.
         * @param {number|string} value El valor a formatear.
         * @returns {string} El valor formateado como string.
         */
        function formatNumber(value) {
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '';
            }
            // Si el número es un entero (no tiene parte decimal), lo devuelve como entero.
            // De lo contrario, lo devuelve con sus decimales originales.
            if (num % 1 === 0) {
                return num.toString();
            } else {
                return num.toString();
            }
        }

        // -----------------------------------------------------------
        // Funciones de Autenticación
        // -----------------------------------------------------------

        signupBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) { authStatus.textContent = 'Por favor, introduce un correo y una contraseña.'; return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log('Usuario registrado:', user.email);
                authStatus.textContent = 'Registro exitoso. ¡Bienvenido!';
                authStatus.style.color = 'green';
                emailInput.value = '';
                passwordInput.value = '';
                await set(ref(database, `user_roles/${user.uid}`), 'viewer');
                console.log('Rol de usuario asignado como viewer.');
            } catch (error) {
                console.error('Error al registrar:', error.message);
                authStatus.textContent = `Error al registrar: ${error.message}`;
                authStatus.style.color = 'red';
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) { authStatus.textContent = 'Por favor, introduce un correo y una contraseña.'; return; }
            try {
                console.log('Intentando iniciar sesión con:', email);
                await setPersistence(auth, browserLocalPersistence);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Inicio de sesión exitoso:', userCredential.user.email);
                authStatus.textContent = 'Sesión iniciada. ¡Bienvenido!';
                authStatus.style.color = 'green';
                emailInput.value = '';
                passwordInput.value = '';
            } catch (error) {
                console.error('Error al iniciar sesión:', error.code, error.message);
                authStatus.textContent = `Error al iniciar sesión: ${error.message}`;
                authStatus.style.color = 'red';
            }
        });

        forgotPasswordBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            if (!email) { authStatus.textContent = 'Por favor, introduce tu correo electrónico para restablecer la contraseña.'; authStatus.style.color = 'red'; return; }
            try {
                console.log('Intentando enviar correo de restablecimiento a:', email);
                await sendPasswordResetEmail(auth, email);
                authStatus.textContent = 'Se ha enviado un correo de restablecimiento de contraseña a tu dirección.';
                authStatus.style.color = 'green';
            } catch (error) {
                console.error('Error al enviar correo de restablecimiento:', error.code, error.message);
                authStatus.textContent = `Error al restablecer contraseña: ${error.message}`;
                authStatus.style.color = 'red';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                console.log('Intentando cerrar sesión...');
                await signOut(auth);
                console.log('Sesión cerrada');
                authStatus.textContent = 'Sesión cerrada.';
                authStatus.style.color = 'red';
            } catch (error) {
                console.error('Error al cerrar sesión:', error.code, error.message);
                authStatus.textContent = `Error al cerrar sesión: ${error.message}`;
                authStatus.style.color = 'red';
            }
        });

        onAuthStateChanged(auth, async (user) => {
            console.log('onAuthStateChanged disparado. Usuario:', user ? user.email : 'null');
            if (user) {
                // --- INICIO DEL BLOQUE 'if (user)' ---
                try {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log('Usuario actual:', user.email, 'UID:', userId);

                    // --- INICIO: Lógica de Roles (Re-añadida) ---
                    // Esta lógica es necesaria para definir 'currentUserRole'
                    const rolePath = `user_roles/${user.uid}`;
                    console.log('Obteniendo rol de:', rolePath);
                    const snapshot = await get(ref(database, rolePath));
                    if (snapshot.exists()) {
                        currentUserRole = snapshot.val();
                    } else {
                        console.log('No se encontró rol, asignando "viewer" por defecto.');
                        currentUserRole = 'viewer';
                        await set(ref(database, `user_roles/${user.uid}`), 'viewer');
                    }
                    console.log('Rol del usuario:', currentUserRole);
                    // --- FIN: Lógica de Roles ---

                    applyRolePermissions(currentUserRole);
                    await cargarDatosDeFirebase();
                    agregarEventosDeEdicion();
                    
                } catch (error) {
                    console.error("Error en onAuthStateChanged al obtener o asignar el rol del usuario o cargar datos:", error.code, error.message);
                    authStatus.textContent = `Error crítico: ${error.message}. Por favor, recarga.`;
                    authStatus.style.color = 'red';
                    currentUserRole = 'viewer'; // Falla a un rol seguro
                    applyRolePermissions(currentUserRole);
                    // Intenta cargar los datos de todos modos, incluso si el rol falló
                    await cargarDatosDeFirebase();
                    agregarEventosDeEdicion();
                } finally { 
                    // Esto se ejecutará DESPUÉS del try O del catch
                    console.log("Bloque finally: Comprobando parámetros de URL...");
                    await checkURLParamsForQR(); // <-- La llamada al QR se queda aquí
                }
                // --- FIN DEL BLOQUE 'if (user)' ---

            } else {
                // --- INICIO DEL BLOQUE 'else' (usuario no logueado) ---
                userId = "anonimo";
                userIdDisplay.textContent = userId;
                console.log('No hay usuario logueado');
                
                authContainer.style.display = 'block';
                mainAppContent.style.display = 'none';
                authStatus.textContent = 'Por favor, inicia sesión o regístrate para acceder.';
                authStatus.style.color = 'red';
                currentUserRole = null;
                applyRolePermissions(null);
                
                // --- AÑADIDO: Comprobar QR también si está deslogueado ---
                // (Esto asegura que la URL se limpie y la app se prepare)
                await checkURLParamsForQR();
                // --- FIN DEL BLOQUE 'else' ---
            }
        });

        /**
         * Aplica los permisos de la interfaz de usuario basados en el rol del usuario.
         * @param {string|null} role - El rol del usuario ('admin', 'viewer' o null si no está autenticado).
         */
        function applyRolePermissions(role) {
            // --- MODIFICADO: Cambiamos 'isAdministrator' por 'isAuthenticated' ---
            // const isAdministrator = (role === 'admin'); 
            const isAuthenticated = (role !== null); // <-- LÍNEA MODIFICADA

            document.querySelectorAll('.tabla-vuelo tbody tr').forEach(fila => {
                fila.querySelectorAll('td').forEach((celda, indexCelda) => {
                    const isNomenclatura = celda.classList.contains('nomenclatura');
                    const isTotalCell = celda.classList.contains('fila-total') || celda.classList.contains('fila-general');
                    const isRestanteCell = celda.classList.contains('fila-restante');
                    const isMotorHeader = celda.classList.contains('motor-header');
                    const isLabelCell = celda.classList.contains('limite-label') || celda.classList.contains('abbrd-label') || 
                                        celda.classList.contains('extd-label') || celda.classList.contains('flight-count-factor-label') || 
                                        celda.classList.contains('restante-label');

                    if (isNomenclatura || isTotalCell || isRestanteCell || isMotorHeader || isLabelCell) {
                        celda.contentEditable = 'false';
                        celda.classList.add('read-only-cell');
                        celda.classList.remove('editable-cell');
                    } else {
                        // --- MODIFICADO: Usar 'isAuthenticated' ---
                        celda.contentEditable = isAuthenticated ? 'true' : 'false'; // <-- LÍNEA MODIFICADA
                        if (isAuthenticated) { // <-- LÍNEA MODIFICADA
                            celda.classList.add('editable-cell');
                            celda.classList.remove('read-only-cell');
                        } else {
                            celda.classList.add('read-only-cell');
                            celda.classList.remove('editable-cell');
                        }
                    }
                });
            });

            selectYear.disabled = !isAuthenticated; 
            document.querySelectorAll('.tab-button').forEach(btn => { btn.disabled = !isAuthenticated; });
            // --- MODIFICADO: Usar 'isAuthenticated' ---
            recordatorioTextarea.readOnly = !isAuthenticated; // <-- LÍNEA MODIFICADA
            btnImprimir.disabled = !isAuthenticated;
            btnMotorStatus.disabled = !isAuthenticated;
            btnComponentStatus.disabled = !isAuthenticated;
            btnInspections.disabled = !isAuthenticated;
            btnPrintMotorStatus.disabled = !isAuthenticated;

            if (role === 'viewer') {
                authStatus.textContent = 'Has iniciado sesión como Visualizador. Puedes ver todos los datos, pero no puedes editar.';
                authStatus.style.color = 'blue';
            } else if (role === 'admin') {
                authStatus.textContent = 'Has iniciado sesión como Administrador. Puedes editar todos los datos.';
                authStatus.style.color = 'green';
            } else {
                authStatus.textContent = 'Por favor, inicia sesión o regístrate para acceder.';
                authStatus.style.color = 'red';
            }
        }

        // -----------------------------------------------------------
        // Funciones de Base de Datos (Firebase Realtime Database)
        // -----------------------------------------------------------

        async function guardarDatosEnFirebase(año, mesIndex, datosTabla, recordatorio) {
            // --- MODIFICADO: Se elimina la comprobación de 'admin' para guardar ---
            // if (currentUserRole !== 'admin') {
            //     console.warn('Acceso denegado: Solo los administradores pueden guardar datos.');
            //     authStatus.textContent = 'Acceso denegado: Solo los administradores pueden guardar datos.';
            //     authStatus.style.color = 'orange';
            //     return;
            // }

            // --- AÑADIDO: Comprobar si está autenticado ---
            if (!auth.currentUser || userId === "anonimo") {
                console.warn('Acceso denegado: Usuario no autenticado.');
                authStatus.textContent = 'Acceso denegado: Debes iniciar sesión para guardar.';
                authStatus.style.color = 'orange';
                return;
            }

            const rutaDatosMes = `artifacts/${sharedProjectId}/public_data/datos_vuelo/${año}/${mesIndex}`;
            const rutaRecordatorio = `artifacts/${sharedProjectId}/public_data/recordatorios/${año}/${mesIndex}`;

            try {
                await set(ref(database, rutaDatosMes), datosTabla);
                await set(ref(database, rutaRecordatorio), recordatorio);
                await calcularYGuardarTotalesGenerales();

                console.log(`Datos y recordatorio guardados correctamente para ${meses[mesIndex]} de ${año}`);
                authStatus.textContent = `Datos guardados para ${meses[mesIndex]} de ${año}.`;
                authStatus.style.color = 'green';
            } catch (error) {
                console.error("Error al guardar los datos:", error.code, error.message);
                authStatus.textContent = `Error al guardar los datos: ${error.message}`;
                authStatus.style.color = 'red';
            }
        }

        async function calcularYGuardarTotalesGenerales() {
            const allYearsDataRef = ref(database, `artifacts/${sharedProjectId}/public_data/datos_vuelo`);
            let allMonthsData = {};

            try {
                const snapshot = await get(allYearsDataRef);
                if (snapshot.exists()) {
                    allMonthsData = snapshot.val();
                }

                let newCumulativeTotals = {
                    'AC HRS': 0,
                    'ATERRIZAJES': 0,
                    'RINS': 0
                };

                for (const yearKey in allMonthsData) {
                    if (Object.hasOwnProperty.call(allMonthsData, yearKey)) {
                        const yearData = allMonthsData[yearKey];
                        for (const monthKey in yearData) {
                            if (Object.hasOwnProperty.call(yearData, monthKey)) {
                                const monthData = yearData[monthKey];
                                // Nota: Para AC HRS, ATERRIZAJES y RINS, el total acumulado está en la columna 34 (GENERAL)
                                // del último mes que tiene datos. 
                                // Sin embargo, para fines de este total general, vamos a seguir sumando los TOTALES DEL MES (columna 33) 
                                // y sumarle el valor VIENEN (columna 1) para obtener el total general.
                                
                                // La lógica más simple (y menos propensa a errores) es sumar el total de la columna GENERAL (34) 
                                // de cada mes/año. Como GENERAL es acumulativo (VIENEN + MES TOTAL), esto es correcto.
                                // La columna 34 contiene el valor FINAL de la fila de la tabla.

                                const acHrsIndex = nombresFilasOrdenadas.indexOf('AC HRS');
                                const aterrizajesIndex = nombresFilasOrdenadas.indexOf('ATERRIZAJES');
                                const rinsIndex = nombresFilasOrdenadas.indexOf('RINS');

                                if (monthData && Array.isArray(monthData) && monthData[acHrsIndex] && !isNaN(parseFloat(monthData[acHrsIndex][34]))) {
                                    // Sumamos el total general guardado al final del mes para AC HRS
                                    newCumulativeTotals['AC HRS'] = parseFloat(monthData[acHrsIndex][34]) || 0; 
                                }
                                if (monthData && Array.isArray(monthData) && monthData[aterrizajesIndex] && !isNaN(parseFloat(monthData[aterrizajesIndex][34]))) {
                                    // Sumamos el total general guardado al final del mes para ATERRIZAJES
                                    newCumulativeTotals['ATERRIZAJES'] = parseFloat(monthData[aterrizajesIndex][34]) || 0; 
                                }
                                if (monthData && Array.isArray(monthData) && monthData[rinsIndex] && !isNaN(parseFloat(monthData[rinsIndex][34]))) {
                                    // Sumamos el total general guardado al final del mes para RINS
                                    newCumulativeTotals['RINS'] = parseFloat(monthData[rinsIndex][34]) || 0; 
                                }

                            }
                        }
                    }
                }
                
                const rutaTotalesGenerales = `artifacts/${sharedProjectId}/public_data/totales_generales/Overall`;
                await set(ref(database, rutaTotalesGenerales), newCumulativeTotals);
                console.log("Totales generales acumulados guardados:", newCumulativeTotals);

            } catch (error) {
                console.error("Error al calcular y guardar totales generales:", error);
            }
        }

        async function cargarDatosDeFirebase() {
            if (!userId || userId === "anonimo") {
                console.warn("No se pueden cargar datos: Usuario no autenticado.");
                return;
            }

            const rutaDatosMes = `artifacts/${sharedProjectId}/public_data/datos_vuelo/${añoActual}/${mesActual}`;
            const rutaRecordatorio = `artifacts/${sharedProjectId}/public_data/recordatorios/${añoActual}/${mesActual}`;
            const rutaMecanicos = `artifacts/${sharedProjectId}/public_data/mecanicos/${añoActual}/${mesActual}`; // <-- AÑADIDO: Ruta de mecánicos

            try {
                console.log(`Cargando datos de: ${rutaDatosMes}`);
                const datosSnapshot = await get(ref(database, rutaDatosMes));
                const datos = datosSnapshot.val();
                console.log(`Datos de tabla cargados de Firebase para ${meses[mesActual]} de ${añoActual}:`, datos);

                if (datos) {
                    cargarDatosEnTablaHTML(datos, mesActual);
                    console.log(`Datos de tabla cargados para ${meses[MesActual]} de ${añoActual}`);
                } else {
                    console.log(`No hay datos de tabla guardados para ${meses[mesActual]} de ${añoActual}. Limpiando tabla.`);
                    limpiarTablaHTML(mesActual);
                }

                console.log(`Cargando recordatorio de: ${rutaRecordatorio}`);
                const recordatorioSnapshot = await get(ref(database, rutaRecordatorio));
                const recordatorio = recordatorioSnapshot.val();
                if (recordatorio !== null) {
                    recordatorioTextarea.value = recordatorio;
                    console.log(`Recordatorio cargado para ${meses[mesActual]} de ${añoActual}`);
                } else {
                    recordatorioTextarea.value = "";
                    console.log(`No hay recordatorio guardado para ${meses[mesActual]} de ${añoActual}.`);
                }

                // --- INICIO: Cargar y aplicar tooltips de mecánicos ---
                console.log(`Cargando mecánicos de: ${rutaMecanicos}`);
                const mecanicosSnapshot = await get(ref(database, rutaMecanicos));
                const mecanicos = mecanicosSnapshot.val() || {};
                
                const tablaActiva = document.querySelector(`#contenedor-tablas > div:nth-child(${mesActual + 1}) .tabla-vuelo`);
                if (tablaActiva) {
                    const headerRow = tablaActiva.querySelector('thead tr');
                    if (headerRow) {
                        // Limpiar tooltips antiguos (días 1-31, que son th:nth-child(3) en adelante)
                        headerRow.querySelectorAll('th:nth-child(n+3)').forEach(th => {
                            const diaNum = th.textContent.trim().replace(/[^0-9]/g, ''); // Limpiar icono
                            if (diaNum) {
                                th.innerHTML = diaNum; // Restaura solo el número
                                th.title = '';
                                th.style.cursor = '';
                            }
                        });

                        // Aplicar nuevos tooltips
                        for (const dia in mecanicos) {
                            const data = mecanicos[dia]; // Puede ser string (antiguo) o array (nuevo)
                            let nombres = '';

                            if (Array.isArray(data)) {
                                nombres = data.join(', '); // Unir lista
                            } else if (typeof data === 'string') {
                                nombres = data; // Compatibilidad con datos antiguos
                            }

                            const diaIndex = parseInt(dia) + 2; // +2 porque 1=Nomenclatura, 2=Vienen, 3=Dia 1
                            const th = headerRow.querySelector(`th:nth-child(${diaIndex})`);
                            if (th && nombres) { // Asegurarse de que 'nombres' no esté vacío
                                th.title = `Reporte(s) por: ${nombres}`;
                                th.style.cursor = 'help';
                                const diaNum = th.textContent.trim(); // Guardar el número del día
                                th.innerHTML = `${diaNum} ${iconoMecanicoHTML}`; // Añadir el icono
                            }
                        }
                    }
                }
                // --- FIN: Cargar y aplicar tooltips de mecánicos ---

                actualizarTotales();
            } catch (error) {
                console.error("Error al cargar los datos de Firebase:", error); // Simplificado para mejor lectura del error
                authStatus.textContent = `Error al cargar los datos: ${error.message}`;
                authStatus.style.color = 'red';
            }
        }

        btnImprimir.addEventListener('click', () => {
            // --- MODIFICADO: Ahora llama al generador de reportes ---
            generarReporteDetallado();
        });

        // --- FUNCIONES PARA EL MODAL DE ESTADO DE MOTORES ---

        function showMotorStatusModal() {
            if (!auth.currentUser) {
                // Usar un modal personalizado en lugar de alert()
                showCustomAlert('Debes iniciar sesión para ver el estado de los motores.');
                return;
            }
            motorStatusModal.classList.remove('hidden');
            renderMotorStatus(); // Renderiza el contenido del modal cada vez que se abre
        }

        function hideMotorStatusModal() {
            motorStatusModal.classList.add('hidden');
        }

        function renderMotorStatus() {
            motorStatusContent.innerHTML = ''; // Limpiar contenido anterior

            const tablaActual = document.querySelectorAll(".tabla-vuelo")[mesActual];
            if (!tablaActual) {
                motorStatusContent.innerHTML = '<p class="text-center text-gray-600">No hay datos de tabla activos para mostrar el estado de los componentes.</p>';
                return;
            }

            const componentsToDisplay = [];

            // Recopilar datos de todos los componentes editables
            tablaActual.querySelectorAll('tbody tr').forEach(row => {
                const nomenclaturaCell = row.querySelector('.nomenclatura');
                if (nomenclaturaCell) {
                    const componentName = nomenclaturaCell.textContent.trim();
                    if (filasConColumnasAdicionalesEditables.includes(componentName)) {
                        const restanteCelda = row.querySelector('.fila-restante');
                        const limiteCelda = row.querySelector('.limite-celda');
                        const generalCelda = row.querySelector('.fila-general');

                        const remaining = parseFloat(restanteCelda?.textContent.trim()) || 0;
                        const limit = parseFloat(limiteCelda?.textContent.trim()) || 0;
                        const current = parseFloat(generalCelda?.textContent.trim()) || 0;
                        
                        let statusColorClass = 'progress-green';
                        if (remaining <= 0) {
                            statusColorClass = 'progress-red';
                        } else if (remaining < limit * 0.2) {
                            statusColorClass = 'progress-orange';
                        }

                        componentsToDisplay.push({
                            name: componentName,
                            remaining: remaining,
                            limit: limit,
                            current: current,
                            statusColorClass: statusColorClass
                        });
                    }
                }
            });

            const printOption = document.querySelector('input[name="motorStatusPrintOption"]:checked').value;

            componentsToDisplay.forEach(component => {
                if (printOption === 'critical-only' && component.statusColorClass === 'progress-green') {
                    return; // Saltar componentes no críticos si la opción es "Solo Críticos"
                }

                const componentDiv = document.createElement('div');
                componentDiv.className = 'component-status-item';

                const percentUsed = (component.current / component.limit) * 100;
                const progressBarFillWidth = Math.min(100, Math.max(0, percentUsed)); // Asegurar entre 0 y 100

                componentDiv.innerHTML = `
                    <h4>${component.name}</h4>
                    <p>Límite: ${formatNumber(component.limit)} | Actual: ${formatNumber(component.current)}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill ${component.statusColorClass}" style="width: ${progressBarFillWidth}%;"></div>
                    </div>
                    <p class="progress-text">Restantes: ${formatNumber(component.remaining)}</p>
                `;
                motorStatusContent.appendChild(componentDiv);
            });

            if (componentsToDisplay.length === 0 || (printOption === 'critical-only' && motorStatusContent.children.length === 0)) {
                 motorStatusContent.innerHTML = '<p class="text-center text-gray-600">No hay componentes para mostrar con los filtros actuales.</p>';
            }
        }

        // --- INICIO: Función Debounce (requerida por lógica 906) ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        // --- FIN: Función Debounce ---

        // --- INICIO: NUEVAS FUNCIONES PARA MODO QR (Adaptadas para 980) ---

        /**
         * Revisa si la URL contiene el parámetro 'action=addFlightData'.
         * Si es así, inicia el flujo de ingreso rápido.
         */
        async function checkURLParamsForQR() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'addFlightData') {
                
                // 1. Obtener fecha actual
                const today = new Date();
                const targetYear = today.getFullYear();
                const targetMonth = today.getMonth(); // 0-11
                const targetDay = today.getDate(); // 1-31

                // 2. Comprobar si el año está en la lista
                if (!años.includes(targetYear)) {
                    showCustomAlert(`El año ${targetYear} no está configurado en la aplicación.`);
                    return;
                }

                // 3. Forzar el cambio al mes y año actuales
                if (añoActual !== targetYear) {
                    añoActual = targetYear;
                    selectYear.value = añoActual;
                    crearTablasParaAño(añoActual); // Recrear tablas para el año correcto (bisiesto)
                }

                if (mesActual !== targetMonth) {
                    // Guardar datos del mes anterior antes de cambiar
                    await guardarDatosEnFirebase(añoActual, mesActual, obtenerDatosTabla(mesActual), recordatorioTextarea.value);
                    mesActual = targetMonth;
                }
                
                // Actualizar el UI (selector de año y pestañas de mes)
                mostrarTabla(mesActual); 

                // 4. Cargar los datos del mes actual
                await cargarDatosDeFirebase();
                agregarEventosDeEdicion();
                applyRolePermissions(currentUserRole);

                // 5. Mostrar el modal de ingreso
                flightModalDate.textContent = `${targetDay} de ${meses[targetMonth]} de ${targetYear}`;
                flightDataModal.style.display = 'flex';

                // Limpiar historial de URL para que no se active de nuevo al recargar
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        /**
         * Maneja el guardado de datos del modal de ingreso rápido (QR).
         * Detecta conflictos antes de guardar.
         */
        function handleFlightDataSave() {
            // --- MODIFICADO: Se elimina la comprobación de 'admin' ---
            // if (currentUserRole !== 'admin') {
            //     showCustomAlert('Acceso denegado: Solo los administradores pueden ingresar datos de vuelo.');
            //     return;
            // }

            // --- AÑADIDO: Comprobar si está autenticado ---
            if (!auth.currentUser || userId === "anonimo") {
                showCustomAlert('Acceso denegado: Debes iniciar sesión para ingresar datos de vuelo.');
                return;
            }

            const acHrs = modalAcHrs.value;
            const aterrizajes = modalAterrizajes.value;
            const rins = modalRins.value;
            const engineHrs1 = modalEngineHrs1.value;
            const engineHrs2 = modalEngineHrs2.value;
            const engineStarts1 = modalEngineStarts1.value;
            const engineStarts2 = modalEngineStarts2.value;
            const flights1 = modalFlights1.value;
            const flights2 = modalFlights2.value;

            // Guardar datos temporalmente
            pendingFlightData = { acHrs, aterrizajes, rins, engineHrs1, engineHrs2, engineStarts1, engineStarts2, flights1, flights2 };

            const today = new Date();
            const targetDay = today.getDate(); // 1-31
            const cellIndex = targetDay + 1; // 0: Nomenclatura, 1: Vienen, 2: Día 1 ...

            // Encuentra la tabla activa
            const activeTable = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!activeTable) {
                showCustomAlert("Error: No se encontró la tabla activa.");
                return;
            }

            // Filas que el modal QR del 906 puede llenar (son compatibles con el 980)
            const dataToCheck = [
                { nomenclatura: "AC HRS", value: acHrs },
                { nomenclatura: "ATERRIZAJES", value: aterrizajes },
                { nomenclatura: "RINS", value: rins },
                { nomenclatura: "ENGINE HRS 1", value: engineHrs1 },
                { nomenclatura: "ENGINE HRS 2", value: engineHrs2 },
                { nomenclatura: "ENGINE STARTS 1", value: engineStarts1 },
                { nomenclatura: "ENGINE STARTS 2", value: engineStarts2 },
                { nomenclatura: "FLIGHTS 1", value: flights1 },
                { nomenclatura: "FLIGHTS 2", value: flights2 }
            ];

            let hasConflict = false;
            
            dataToCheck.forEach(item => {
                const newValue = parseFloat(item.value.trim()) || 0;
                if (newValue === 0) return; // Si el nuevo valor es 0, no hay conflicto

                const row = activeTable.querySelector(`tr[data-nomenclatura="${item.nomenclatura}"]`);
                // Celdas diarias empiezan en el índice 2 (Col 0: Nom, Col 1: Vienen, Col 2: Día 1)
                const cell = row ? row.querySelectorAll('td')[cellIndex] : null; 
                
                const existingValue = parseFloat(cell?.textContent.trim()) || 0;

                if (existingValue > 0) {
                    hasConflict = true;
                }
            });

            if (hasConflict) {
                // Conflicto detectado: mostrar el modal de elección
                dataConflictModal.style.display = 'flex';
                // Ocultar el modal de ingreso
                flightDataModal.style.display = 'none';
            } else {
                // Sin conflicto: aplicar los datos directamente (modo 'overwrite')
                applyFlightData('overwrite');
            }
        }

        /**
        * Aplica los datos de vuelo (guardados en pendingFlightData) a la tabla
        * según el modo (sumar o reemplazar).
        */
        async function applyFlightData(mode = 'overwrite') {
            if (!pendingFlightData) return; // No hay nada que aplicar

            const { acHrs, aterrizajes, rins, engineHrs1, engineHrs2, engineStarts1, engineStarts2, flights1, flights2 } = pendingFlightData;

            const today = new Date();
            const targetDay = today.getDate();
            const cellIndex = targetDay + 1; // +1 porque la celda "VIENEN" está en el índice 1

            const activeTable = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!activeTable) { showCustomAlert("Error: Tabla no activa."); return; }

            const dataToUpdate = [
                { nomenclatura: "AC HRS", value: acHrs },
                { nomenclatura: "ATERRIZAJES", value: aterrizajes },
                { nomenclatura: "RINS", value: rins },
                { nomenclatura: "ENGINE HRS 1", value: engineHrs1 },
                { nomenclatura: "ENGINE HRS 2", value: engineHrs2 },
                { nomenclatura: "ENGINE STARTS 1", value: engineStarts1 },
                { nomenclatura: "ENGINE STARTS 2", value: engineStarts2 },
                { nomenclatura: "FLIGHTS 1", value: flights1 },
                { nomenclatura: "FLIGHTS 2", value: flights2 }
            ];

            // 1. Actualizar las celdas en la tabla HTML
            dataToUpdate.forEach(item => {
                const nom = item.nomenclatura;
                const newValue = parseFloat(item.value.trim()) || 0;

                if (newValue === 0 && mode === 'sum') return;

                const row = activeTable.querySelector(`tr[data-nomenclatura="${nom}"]`);
                const cell = row ? row.querySelectorAll('td')[cellIndex] : null; // Celdas de día
                
                if (cell) {
                    const existingValue = parseFloat(cell.textContent.trim()) || 0;
                    let finalValue = 0;

                    if (mode === 'sum') {
                        finalValue = existingValue + newValue;
                    } else { // 'overwrite'
                        finalValue = newValue;
                    }

                    // Formatear
                    let formattedValue;
                    // Formateo decimal solo para AC HRS y ENGINE HRS
                    if (nom.includes("AC HRS") || nom.includes("ENGINE HRS")) {
                        formattedValue = finalValue > 0 ? finalValue.toFixed(1) : '';
                    } else {
                        formattedValue = finalValue > 0 ? finalValue.toFixed(0) : '';
                    }
                    cell.textContent = formatNumber(formattedValue); // formatNumber se encarga de formatear
                    
                    if (finalValue > 0) {
                        cell.classList.add("led-persistente");
                    } else {
                        cell.classList.remove("led-persistente");
                    }
                }
            });

            // 2. Recalcular y guardar en Firebase
            actualizarTotales();
            
            const dataParaConfirmar = pendingFlightData; // Guardar antes de limpiar
            
            await guardarDatosEnFirebase(añoActual, mesActual, obtenerDatosTabla(mesActual), recordatorioTextarea.value);
            
            // 3. Ocultar modal de ingreso y el de conflicto
            flightDataModal.style.display = 'none';
            dataConflictModal.style.display = 'none';
            modalAcHrs.value = '';
            modalAterrizajes.value = '';
            modalRins.value = '';
            modalEngineHrs1.value = '';
            modalEngineHrs2.value = '';
            modalEngineStarts1.value = '';
            modalEngineStarts2.value = '';
            modalFlights1.value = '';
            modalFlights2.value = '';

            // 4. Mostrar modal de confirmación con los datos actualizados
            showConfirmationModal(activeTable, dataParaConfirmar);
            
            // 5. Limpiar los datos pendientes
            pendingFlightData = null;
        }


        /**
        * Muestra el modal de confirmación con los totales generales actualizados.
        */
        function showConfirmationModal(activeTable, qrData) {
            
            const datosDelReporte = qrData || {}; // Objeto vacío por defecto
            
            // === INICIO: LÓGICA RECONSTRUIDA PARA 9 CAMPOS ===
            
            // Definir todos los campos que queremos mostrar
            const itemsAMostrar = [
                { nom: "AC HRS", suma: parseFloat(datosDelReporte.acHrs) || 0, decimales: 1 },
                { nom: "ATERRIZAJES", suma: parseFloat(datosDelReporte.aterrizajes) || 0, decimales: 0 },
                { nom: "RINS", suma: parseFloat(datosDelReporte.rins) || 0, decimales: 0 },
                { nom: "ENGINE HRS 1", suma: parseFloat(datosDelReporte.engineHrs1) || 0, decimales: 1 },
                { nom: "ENGINE HRS 2", suma: parseFloat(datosDelReporte.engineHrs2) || 0, decimales: 1 },
                { nom: "ENGINE STARTS 1", suma: parseFloat(datosDelReporte.engineStarts1) || 0, decimales: 0 },
                { nom: "ENGINE STARTS 2", suma: parseFloat(datosDelReporte.engineStarts2) || 0, decimales: 0 },
                { nom: "FLIGHTS 1", suma: parseFloat(datosDelReporte.flights1) || 0, decimales: 0 },
                { nom: "FLIGHTS 2", suma: parseFloat(datosDelReporte.flights2) || 0, decimales: 0 }
            ];

            const listContainer = document.getElementById('confirmationListContainer');
            listContainer.innerHTML = ''; // Limpiar el contenedor

            // Recorrer cada item y construir su HTML
            itemsAMostrar.forEach(item => {
                const fila = activeTable.querySelector(`tr[data-nomenclatura="${item.nom}"]`);
                if (!fila) return; // Si no se encuentra la fila, saltar

                // Leemos el "GENERAL" (que ya fue actualizado en applyFlightData)
                const generalStr = fila.querySelector('.fila-general')?.textContent.trim() || '0';
                const generalNum = parseFloat(generalStr) || 0;
                
                // Calculamos el "VIENEN" restando la suma de hoy del total general
                const vienenNum = generalNum - item.suma;
                
                // Formatear los strings
                const vienenStr = vienenNum.toFixed(item.decimales);
                const sumaStr = `+${item.suma.toFixed(item.decimales)}`;
                const generalFinalStr = generalNum.toFixed(item.decimales);
                
                // Crear el HTML para este ítem
                const itemHTML = `
                    <div class="space-y-1${item.suma === 0 ? ' opacity-60' : ''}"> <!-- Atenuar si no se reportó nada -->
                        <h4 class="font-bold text-lg text-blue-700">${item.nom}</h4>
                        <div>
                            <span class="font-medium text-gray-700">Total Anterior (Vienen):</span>
                            <strong class="text-lg float-right text-gray-800">${formatNumber(vienenStr)}</strong>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Reporte de Hoy:</span>
                            <strong class="text-lg float-right text-gray-800">${formatNumber(sumaStr)}</strong>
                        </div>
                        <hr class="my-1">
                        <div>
                            <span class="font-bold text-gray-900">NUEVO TOTAL GENERAL:</span>
                            <strong class="text-2xl float-right text-blue-700">${formatNumber(generalFinalStr)}</strong>
                        </div>
                    </div>
                `;
                listContainer.innerHTML += itemHTML;
            });
            
            // === FIN: LÓGICA RECONSTRUIDA ===

            confirmationModal.style.display = 'flex';

            // El botón "Confirmado" ahora abre el modal de mecánico
            closeConfirmationBtn.onclick = () => { // Usamos .onclick para sobreescribir
                confirmationModal.style.display = 'none';
                mechanicNameModal.style.display = 'flex'; // Abre el siguiente modal
                modalMechanicName.focus(); // Pone el cursor en el campo de nombre
            };
        }

        /**
        * Maneja el guardado del nombre del mecánico y cierra la sesión de QR.
        */
        function handleSaveMechanicName() {
            // --- MODIFICADO: Se elimina la comprobación de 'admin' ---
            // if (currentUserRole !== 'admin') {
            //     showCustomAlert('Acceso denegado: Solo los administradores pueden registrar mecánicos.');
            //     return;
            // }

            // --- AÑADIDO: Comprobar si está autenticado ---
            if (!auth.currentUser || userId === "anonimo") {
                showCustomAlert('Acceso denegado: Debes iniciar sesión para registrar mecánicos.');
                return;
            }

            const mechanicName = modalMechanicName.value.trim();
            if (!mechanicName) {
                showCustomAlert("Por favor, ingresa un nombre.");
                return;
            }

            const today = new Date();
            const targetDay = today.getDate();

            // Ruta para guardar el nombre del mecánico (ADAPTADA PARA 980)
            const mechanicPath = `artifacts/${sharedProjectId}/public_data/mecanicos/${añoActual}/${mesActual}/${targetDay}`;

            // --- Lógica para múltiples mecánicos ---
            // 1. Leer los nombres existentes primero
            get(ref(database, mechanicPath)).then(snapshot => {
                const existingData = snapshot.val();
                const nameSet = new Set();

                if (Array.isArray(existingData)) {
                    existingData.forEach(name => nameSet.add(name));
                } else if (typeof existingData === 'string' && existingData) {
                    nameSet.add(existingData); // Compatibilidad con datos antiguos
                }
                
                nameSet.add(mechanicName); // Añadir el nuevo nombre
                const updatedNameList = Array.from(nameSet); // Lista de nombres únicos

                // 2. Guardar la nueva lista (array)
                set(ref(database, mechanicPath), updatedNameList)
                    .then(() => {
                        // 3. Ocultar modal de mecánico
                        mechanicNameModal.style.display = 'none';
                        modalMechanicName.value = ''; // Limpiar el campo

                        // 4. Mostrar modal de despedida
                        goodbyeMessage.textContent = `¡Gracias, ${mechanicName}! Tu reporte ha sido guardado.`;
                        goodbyeModal.style.display = 'flex';

                        // 5. Redirigir/Cerrar la página después de 3 segundos
                        setTimeout(() => {
                            window.location.href = 'about:blank';
                        }, 3000);
                    })
                    .catch((error) => {
                        showCustomAlert(`Error al guardar la lista de mecánicos: ${error.message}`);
                    });

            }).catch(error => {
                showCustomAlert(`Error al leer los mecánicos existentes: ${error.message}`);
            });
        }
        // ====================================================
        // ==== FIN: NUEVAS FUNCIONES PARA MODO QR ====
        // ====================================================


        // =========================================================
        // ==== INICIO: NUEVAS FUNCIONES PARA REPORTE DETALLADO ====
        // =========================================================

        /**
         * Genera un reporte detallado (Totales de Mes y General) para el mes activo
         * y lo muestra en un modal.
         */
        function generarReporteDetallado() {
            const activeTable = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!activeTable) {
                showCustomAlert("No se encontró la tabla activa para generar el reporte.");
                return;
            }

            const mesNombre = meses[mesActual];
            const año = añoActual;

            const reportContentEl = document.getElementById('reportModalContent');
            const reportTitleEl = document.getElementById('reportModalTitle');
            
            if (!reportModal || !reportContentEl || !reportTitleEl) {
                showCustomAlert("Error: No se encontraron los elementos del modal de reporte.");
                return;
            }

            // 2. Establecer el título del reporte
            reportTitleEl.textContent = `Reporte Detallado de Totales - ${mesNombre} ${año} (FAH-980)`;

            // 3. Construir el HTML del reporte
            let reportHTML = `<table class="w-full text-sm border-collapse border border-gray-400">`;
            reportHTML += `<thead class="bg-gray-100">
                                <tr class="bg-gray-200">
                                    <th class="border border-gray-400 p-2 text-left">Nomenclatura</th>
                                    <th class="border border-gray-400 p-2 text-right">Total Mes</th>
                                    <th class="border border-gray-400 p-2 text-right">Total General</th>
                                </tr>
                               </thead>
                               <tbody>`;

            // 4. Iterar a través de la lista de filas ordenadas (la de 980)
            nombresFilasOrdenadas.forEach(nom => {
                const fila = activeTable.querySelector(`tr[data-nomenclatura="${nom}"]`);
                
                // Añadir cabeceras de motor para separación visual
                if (nom === "HUB COMPRESOR 1.1") {
                    reportHTML += `<tr><td colspan="3" class="font-bold bg-gray-100 p-2 border border-gray-400">MOTOR #1</td></tr>`;
                    // Añadir filas de motor 1 que están separadas en la tabla 980
                    ['ENGINE HRS 1', 'ENGINE STARTS 1', 'FLIGHTS 1', 'CICLOS 1'].forEach(motorRowName => {
                        const motorFila = activeTable.querySelector(`tr[data-nomenclatura="${motorRowName}"]`);
                        if(motorFila) {
                            reportHTML += `<tr>
                                <td class="border border-gray-400 p-2 text-left">${motorRowName}</td>
                                <td class="border border-gray-400 p-2 text-right">${motorFila.querySelector('.fila-total')?.textContent.trim() || '0'}</td>
                                <td class="border border-gray-400 p-2 text-right">${motorFila.querySelector('.fila-general')?.textContent.trim() || '0'}</td>
                            </tr>`;
                        }
                    });
                } else if (nom === "HUB COMPRESOR 2.1") {
                    reportHTML += `<tr><td colspan="3" class="font-bold bg-gray-100 p-2 border border-gray-400">MOTOR #2</td></tr>`;
                    // Añadir filas de motor 2
                    ['ENGINE HRS 2', 'ENGINE STARTS 2', 'FLIGHTS 2', 'CICLOS 2'].forEach(motorRowName => {
                        const motorFila = activeTable.querySelector(`tr[data-nomenclatura="${motorRowName}"]`);
                         if(motorFila) {
                            reportHTML += `<tr>
                                <td class="border border-gray-400 p-2 text-left">${motorRowName}</td>
                                <td class="border border-gray-400 p-2 text-right">${motorFila.querySelector('.fila-total')?.textContent.trim() || '0'}</td>
                                <td class="border border-gray-400 p-2 text-right">${motorFila.querySelector('.fila-general')?.textContent.trim() || '0'}</td>
                            </tr>`;
                        }
                    });
                }

                if (fila) {
                    const totalMes = fila.querySelector('.fila-total')?.textContent.trim() || '0';
                    const totalGeneral = fila.querySelector('.fila-general')?.textContent.trim() || '0';

                    reportHTML += `<tr>
                                        <td class="border border-gray-400 p-2 text-left">${nom}</td>
                                        <td class="border border-gray-400 p-2 text-right">${totalMes}</td>
                                        <td class="border border-gray-400 p-2 text-right">${totalGeneral}</td>
                                    </tr>`;
                }
            });

            reportHTML += `</tbody></table>`;

            // 5. Inyectar el HTML en el modal
            reportContentEl.innerHTML = reportHTML;

            // 6. Mostrar el modal
            reportModal.style.display = 'flex';
        }

        /**
        * Activa la impresión del sistema, usando estilos CSS para imprimir solo el modal de reporte.
        */
        function imprimirReporte() {
            // Añade una clase al body para activar los estilos de impresión correctos
            document.body.classList.add('imprimiendo-reporte');
            
            window.print();
            
            // Elimina la clase después de que se abra el diálogo de impresión
            setTimeout(() => {
                 document.body.classList.remove('imprimiendo-reporte');
            }, 100); // Un pequeño retardo
        }

        // =======================================================
        // ==== FIN: NUEVAS FUNCIONES PARA REPORTE DETALLADO ====
        // =======================================================


        // --- Función de inicialización de la aplicación ---
        async function iniciar() {
            cargarAños();
            crearTablasParaAño(añoActual);
            crearBotonesMeses();

            // Event listeners para el nuevo botón de estado de motores
            btnMotorStatus.addEventListener('click', showMotorStatusModal);
            closeMotorStatusModal.addEventListener('click', hideMotorStatusModal);
            btnPrintMotorStatus.addEventListener('click', printMotorStatus);

            // Listener para las opciones de impresión del modal
            document.querySelectorAll('input[name="motorStatusPrintOption"]').forEach(radio => {
                radio.addEventListener('change', renderMotorStatus);
            });
            
            // --- INICIO: NUEVOS EVENT LISTENERS PARA MODALES QR y REPORTE ---
            
            // Botón de Imprimir/Reporte (MODIFICADO)
            btnImprimir.addEventListener('click', generarReporteDetallado);
            if(printReportBtn) {
                printReportBtn.addEventListener('click', imprimirReporte);
            }
            if(closeReportBtn) {
                closeReportBtn.addEventListener('click', () => {
                    reportModal.style.display = 'none';
                });
            }

            // Botones del modal de Alerta
            if(customAlertCloseBtn) {
                customAlertCloseBtn.addEventListener('click', () => {
                    customAlertModal.style.display = 'none';
                });
            }

            // Botones del modal de Ingreso QR
            saveFlightDataBtn.addEventListener('click', handleFlightDataSave);
            cancelFlightDataBtn.addEventListener('click', () => {
                flightDataModal.style.display = 'none';
                pendingFlightData = null; // Limpiar datos pendientes si cancela
                window.location.href = 'about:blank'; // Cierra la página
            });
            
            // Botones del modal de Conflicto de Datos
            document.getElementById('overwriteDataBtn').addEventListener('click', () => applyFlightData('overwrite'));
            document.getElementById('sumDataBtn').addEventListener('click', () => applyFlightData('sum'));
            document.getElementById('cancelConflictBtn').addEventListener('click', () => {
                dataConflictModal.style.display = 'none';
                pendingFlightData = null; // Limpiar datos pendientes
            });

            // Botón del modal de Mecánico
            saveMechanicNameBtn.addEventListener('click', handleSaveMechanicName);

            // Nota: El listener de 'closeConfirmationBtn' se asigna dinámicamente en 'showConfirmationModal'
            
            // --- FIN: NUEVOS EVENT LISTENERS ---

            // Event listener para el nuevo botón "Estado de Componentes"
            btnComponentStatus.addEventListener('click', async () => {
                if (!auth.currentUser) {
                    showCustomAlert('Debes iniciar sesión para ver el estado de los componentes.');
                    return;
                }

                // Obtener los totales generales directamente de Firebase Realtime Database
                const rutaTotalesGenerales = `artifacts/${sharedProjectId}/public_data/totales_generales/Overall`;
                try {
                    const snapshot = await get(ref(database, rutaTotalesGenerales));
                    let generalTotals = { 'AC HRS': 0, 'ATERRIZAJES': 0, 'RINS': 0 };
                    if (snapshot.exists()) {
                        generalTotals = snapshot.val();
                    }

                    const componentsData = [
                        { name: "AC HRS", current: generalTotals['AC HRS'] || 0, type: "general_total" },
                        { name: "ATERRIZAJES", current: generalTotals['ATERRIZAJES'] || 0, type: "general_total" },
                        { name: "RINS", current: generalTotals['RINS'] || 0, type: "general_total" }
                    ];
                    
                    // Guardar los datos en localStorage (aunque ahora COMPONENTES980.HTML debería leer de Firebase)
                    localStorage.setItem('componentStatusData', JSON.stringify(componentsData));
                    
                    // --- ENLACE ACTUALIZADO A COMPONENTES980.HTML ---
                    window.location.href = 'COMPONENTES980.HTML'; 

                } catch (error) {
                    console.error("Error al obtener los totales generales para COMPONENTES980.HTML:", error);
                    showCustomAlert(`Error al cargar datos para la página de componentes: ${error.message}`);
                }
            });

            // Event listener para el botón de Inspecciones
            btnInspections.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showCustomAlert('Debes iniciar sesión para ver las inspecciones.');
                    return;
                }
                // --- ENLACE ACTUALIZADO A INSPECIONES980.HTML ---
                window.location.href = 'INSPECIONES980.HTML';
            });
        }

        // Configura la posición y la distancia de caída de la careta de Anonymous.
        function animateIntroElements() {
            const helicopter = document.getElementById('helicopter-svg');
            const authContainer = document.getElementById('auth-container');
            const anonymousMask = document.getElementById('anonymous-mask-img');
            const revealCircle = document.getElementById('reveal-circle');

            if (!helicopter || !authContainer || !anonymousMask || !revealCircle) {
                console.warn("Algunos elementos de la interfaz de usuario no se encontraron.");
                return;
            }

            const heliRect = helicopter.getBoundingClientRect();
            const authRect = authContainer.getBoundingClientRect();
            
            const maskDropDistance = authRect.top - heliRect.bottom - (anonymousMask.offsetHeight / 2);

            document.documentElement.style.setProperty('--mask-drop-distance', `${maskDropDistance}px`);

            revealCircle.style.top = `${authRect.top + (authRect.height / 2)}px`;
            revealCircle.style.left = `50%`;
        }

        // Iniciar la aplicación cuando la ventana esté completamente cargada
        window.addEventListener("load", () => {
            iniciar();
            setTimeout(animateIntroElements, 100);
        });
    </script>
</body>
</html>
