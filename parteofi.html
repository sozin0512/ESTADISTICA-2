<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parte de Personal: Oficiales</title>
    <!-- Tailwind CSS CDN para un estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaci√≥n de fondo sutil para un toque moderno */
        @keyframes backgroundPan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, #e0f2fe, #f0f8ff, #e0f2fe); /* Degradado suave */
            background-size: 200% 200%; /* Tama√±o m√°s grande para la animaci√≥n */
            animation: backgroundPan 20s ease infinite; /* Animaci√≥n de movimiento lento */
            color: #334155;
            min-height: 100vh; /* Asegura que la animaci√≥n ocupe toda la altura */
            display: flex; /* Para centrar el contenido verticalmente si es m√°s peque√±o */
            justify-content: center;
            align-items: center;
            padding: 1rem; /* A√±adir padding por defecto para evitar que el contenido toque los bordes */
        }

        /* Contenedor principal estilizado como una tarjeta con neumorfismo suave */
        .container {
            max-width: 800px; /* Ancho ajustado para la p√°gina de entrada de datos */
            width: 100%; /* Permite que el contenedor se ajuste */
            margin: 2rem auto; /* Ajuste el margen ya que el body es flex */
            padding: 2.8rem; /* M√°s padding interno */
            background-color: #ffffff;
            border-radius: 1.8rem; /* Bordes muy redondeados */
            /* Sombras tipo neumorfismo suave */
            box-shadow: 10px 10px 30px rgba(174, 174, 192, 0.4), 
                        -10px -10px 30px rgba(255, 255, 255, 0.7);
            border: none; /* Elimina el borde anterior */
            transition: transform 0.3s ease-in-out; /* Transici√≥n para un ligero hover */
        }
        .container:hover {
            transform: translateY(-5px); /* Efecto de elevaci√≥n al pasar el rat√≥n */
        }

        /* Estilos para inputs num√©ricos */
        input[type="number"] {
            border-radius: 0.8rem; /* M√°s redondeado */
            padding: 0.9rem 1.3rem; /* M√°s padding */
            border: 1px solid #e2e8f0; /* Borde m√°s claro */
            background-color: #f7fafc; /* Fondo ligeramente gris√°ceo */
            text-align: center;
            width: 120px; /* Ancho ajustable */
            -moz-appearance: textfield;
            transition: all 0.3s ease-in-out; /* Transici√≥n m√°s suave y larga */
            font-weight: 500;
            color: #1f2937;
            /* Sombra interna sutil para un efecto "hundido" */
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.05), inset -2px -2px 5px rgba(255, 255, 255, 0.8);
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #6366f1; /* Morado/√≠ndigo al enfocar */
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.3), /* Anillo de enfoque m√°s pronunciado */
                        inset 2px 2px 5px rgba(0, 0, 0, 0.05); /* Mantener sombra interna */
            background-color: #ffffff; /* Fondo blanco al enfocar */
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Estilos de tabla */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 1.5rem; /* Bordes muy redondeados para toda la tabla */
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.07); /* Sombra m√°s pronunciada para la tabla */
            background-color: #ffffff; /* Asegurar fondo blanco */
        }
        th, td {
            text-align: left;
            padding: 1.4rem 1.7rem; /* M√°s padding para celdas */
            border-bottom: 1px solid #edf2f7; /* L√≠nea divisoria muy suave */
        }
        th {
            background: linear-gradient(45deg, #4f46e5, #6366f1); /* Degradado √≠ndigo para encabezados */
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Sombra de texto m√°s fuerte */
            font-size: 1rem; /* Tama√±o de fuente ligeramente ajustado */
            letter-spacing: 0.06em; /* Espaciado de letras */
            text-transform: uppercase;
        }
        /* Bordes redondeados para las esquinas del thead */
        thead tr:first-child th:first-child { border-top-left-radius: 1.5rem; }
        thead tr:first-child th:last-child { border-top-right-radius: 1.5rem; }

        tr:last-child td {
            border-bottom: none;
        }
        tbody tr {
            transition: all 0.25s ease-in-out; /* Transici√≥n para hover de fila */
        }
        tbody tr:hover {
            background-color: #f0f4f8; /* Fondo m√°s oscuro al pasar el rat√≥n */
            transform: scale(1.01); /* Liger√≠simo zoom */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); /* Sombra al pasar el rat√≥n */
        }
        tbody tr:nth-child(even) { /* Cebra para filas, ligeramente m√°s oscuro */
            background-color: #f7f9fb;
        }

        /* Estilos para la fila del total */
        tfoot tr {
            background: linear-gradient(45deg, #10b981, #34d399); /* Degradado verde esmeralda para el total */
            font-weight: bold;
            color: #ffffff;
            font-size: 1.35rem; /* Fuente m√°s grande */
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15); /* Sombra m√°s fuerte hacia arriba */
        }
        /* Bordes redondeados para las esquinas del tfoot */
        tfoot tr:last-child td:first-child { border-bottom-left-radius: 1.5rem; }
        tfoot tr:last-child td:last-child { border-bottom-right-radius: 1.5rem; }

        /* Mensaje de "no hay datos" */
        #no-data-message {
            font-style: italic;
            color: #94a3b8; /* Gris m√°s claro */
            margin-top: 2rem;
            font-size: 1.2rem; /* M√°s grande */
            text-align: center;
        }

        /* Estilos para el modal personalizado */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Fondo m√°s oscuro y opaco */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.4s ease-in-out; /* Transici√≥n m√°s larga para el overlay */
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 3.5rem; /* M√°s padding */
            border-radius: 2rem; /* Bordes muy redondeados */
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.35); /* Sombra muy dram√°tica */
            max-width: 650px; /* Un poco m√°s ancho */
            width: 90%;
            text-align: center;
            transform: translateY(-50px) scale(0.9); /* Efecto de entrada m√°s pronunciado y ligeramente encogido */
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-out; /* Rebote y opacidad */
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal-content h3 {
            font-size: 2.5rem; /* T√≠tulo de modal m√°s grande */
            color: #4f46e5;
            margin-bottom: 1.8rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .modal-content textarea {
            min-height: 160px; /* Mayor altura */
            resize: vertical;
            transition: all 0.3s ease-in-out;
            border-color: #e2e8f0; /* Borde m√°s claro */
            border-radius: 1rem; /* M√°s redondeado */
            font-size: 1.05rem; /* Tama√±o de fuente ligeramente m√°s grande */
            line-height: 1.6;
            padding: 1.2rem; /* M√°s padding */
            background-color: #f7fafc; /* Fondo ligeramente gris√°ceo */
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.03); /* Sombra interna sutil */
        }
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.3);
            background-color: #ffffff;
        }
        .modal-content button {
            border-radius: 1rem; /* Botones muy redondeados */
            font-weight: 700;
            padding: 1.1rem 2.5rem; /* M√°s padding */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efecto de rebote en botones */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Sombra en botones */
            font-size: 1.1rem; /* Bot√≥n de texto ligeramente m√°s grande */
        }
        .modal-content button:hover {
            transform: translateY(-5px); /* Efecto de elevaci√≥n m√°s notorio */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); /* Sombra m√°s fuerte al pasar el rat√≥n */
        }
        .modal-content button.bg-indigo-600:hover {
            background-color: #4338ca;
        }
        .modal-content button.bg-gray-300:hover {
            background-color: #9ca3af; /* Gris un poco m√°s oscuro y saturado */
        }

        /* Estilos para el √°rea de notas en la tabla */
        .note-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff; /* Fondo blanco */
            border-radius: 1rem; /* M√°s redondeado */
            padding: 0.9rem 1.2rem;
            min-height: 58px; /* Mayor altura m√≠nima */
            border: 1px solid #eef2f7;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.05), -2px -2px 8px rgba(255, 255, 255, 0.8); /* Sombra ligera tipo neumorfismo */
        }
        .note-display:hover {
            background-color: #f8fafc; /* Color de fondo al pasar el rat√≥n */
            border-color: #e2e8f0; /* Borde m√°s oscuro al pasar el rat√≥n */
            transform: translateY(-3px); /* Efecto de elevaci√≥n m√°s notorio */
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.08), -5px -5px 15px rgba(255, 255, 255, 0.6); /* Sombra al pasar el rat√≥n */
        }
        .note-display span {
            color: #475569;
            font-size: 1rem; /* Tama√±o de fuente ligeramente m√°s grande para la nota */
            line-height: 1.4;
        }
        .edit-pencil-icon {
            width: 22px; /* Icono m√°s grande */
            height: 22px;
            fill: #94a3b8; /* Color de icono gris m√°s suave */
            transition: fill 0.3s ease-in-out;
        }
        .note-display:hover .edit-pencil-icon {
            fill: #4f46e5; /* Icono se vuelve √≠ndigo al pasar el rat√≥n */
        }
        
        /* --- MEDIA QUERIES PARA ADAPTACI√ìN A M√ìVILES --- */
        @media (max-width: 768px) { /* Para tabletas y m√≥viles */
            body {
                padding: 0.5rem; /* Menos padding en los bordes del cuerpo */
            }
            .container {
                margin: 1rem auto; /* Reducir margen superior/inferior */
                padding: 1.5rem; /* M√°s compacto en pantallas peque√±as */
                border-radius: 1rem; /* Bordes menos redondeados para ahorrar espacio */
                box-shadow: 5px 5px 15px rgba(174, 174, 192, 0.2), 
                            -5px -5px 15px rgba(255, 255, 255, 0.5); /* Sombra m√°s suave */
            }

            h1 {
                font-size: 2.5rem; /* T√≠tulo m√°s peque√±o */
                margin-bottom: 0.5rem; /* Menos espacio debajo del t√≠tulo */
            }
            p {
                font-size: 0.9rem; /* P√°rrafos m√°s peque√±os */
                margin-bottom: 1rem; /* Menos espacio debajo del p√°rrafo */
            }

            /* Ajustes para la tabla en m√≥vil */
            th, td {
                padding: 0.8rem 1rem; /* Reducir padding de celdas */
                font-size: 0.85rem; /* Reducir tama√±o de fuente en celdas */
            }
            th:nth-child(2), td:nth-child(2) { /* Ajustar la columna de "Cantidad" */
                text-align: center;
                width: 70px; /* Un ancho m√°s fijo para la cantidad */
            }
            td:nth-child(3) { /* Columna de notas */
                white-space: normal; /* Permitir que el texto de las notas se ajuste */
                word-wrap: break-word; /* Romper palabras largas si es necesario */
            }
            .note-display {
                padding: 0.5rem 0.8rem; /* Padding m√°s compacto para las notas individuales */
                min-height: unset; /* Eliminar altura m√≠nima fija para notas */
            }
            .note-display span {
                font-size: 0.8rem; /* Fuente m√°s peque√±a para el texto de la nota */
            }
            .edit-pencil-icon {
                width: 18px; /* Icono m√°s peque√±o */
                height: 18px;
            }
            #no-data-message {
                font-size: 1rem; /* Mensaje de no datos m√°s peque√±o */
            }
            tfoot tr { /* Total general */
                font-size: 1.1rem; /* Reducir el tama√±o del total general */
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center mb-8 text-gray-800 tracking-tight">
            üéñÔ∏è Parte de Personal: <span class="text-indigo-600">Oficiales</span>
        </h1>
        <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
            Utiliza esta secci√≥n para reportar la cantidad de personal y notas espec√≠ficas para la **Parte Oficiales**.
        </p>

        <!-- Formulario de Entrada de Datos -->
        <div class="p-8 bg-white rounded-xl shadow-lg border border-gray-100 mb-10">
            <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">Entrada de Datos del Personal</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-indigo-600">
                        <tr>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-center">Cantidad</th>
                            <th class="px-6 py-4">Notas</th>
                        </tr>
                    </thead>
                    <tbody id="oficiales-part-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de entrada de datos se insertar√°n aqu√≠ con JavaScript -->
                    </tbody>
                    <tfoot class="bg-emerald-500">
                        <tr>
                            <td class="px-6 py-4">Total de Oficiales</td>
                            <td id="oficiales-total" class="px-6 py-4 text-center">0</td>
                            <td class="px-6 py-4"></td> <!-- Celda vac√≠a -->
                        </tr>
                    </tfoot>
                </table>
            </div>
            <p id="no-data-message" class="text-center mt-8 hidden">
                ¬°No hay datos para esta parte a√∫n!
            </p>
        </div>

        <!-- Secci√≥n para mostrar el ID de Usuario (para depuraci√≥n y pruebas de m√∫ltiples usuarios) -->
        <div class="text-center text-gray-500 text-sm mt-8">
            ID de Usuario (para depuraci√≥n): <span id="user-id-display" class="font-mono text-gray-700 break-all">Cargando...</span>
        </div>
    </div>

    <!-- Modal personalizado para edici√≥n de notas -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="font-extrabold"></h3>
            
            <textarea id="modal-input-note" placeholder="Escribe aqu√≠ tu nota..." class="w-full"></textarea>

            <div class="flex justify-center mt-6">
                <button id="modal-confirm-button" class="bg-indigo-600 text-white mr-4">Guardar Nota</button>
                <button id="modal-cancel-button" class="bg-gray-300 text-gray-800">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        // *** CONFIGURACI√ìN DE FIREBASE PROPORCIONADA POR EL USUARIO ***
        const firebaseConfig = {
            apiKey: "AIzaSyBisvGozOBQ88dfY5KPC2mYlYc-qmZfSB4",
            authDomain: "parte-dca91.firebaseapp.com",
            projectId: "parte-dca91",
            storageBucket: "parte-dca91.firebasestorage.app",
            messagingSenderId: "267969738051",
            appId: "1:267969738051:web:1cbf9f6b907fc787782bf6",
            measurementId: "G-3938E048HW"
        };
        const appId = firebaseConfig.appId; // Usamos el appId de tu configuraci√≥n
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ***************************************************************

        let db;
        let auth;
        let userId; 

        // ID √∫nico para este reporte de parte de oficiales
        const MY_PART_REPORT_ID = "oficiales_report"; 

        // Definici√≥n de los estados del personal
        const staffStatuses = [
            { value: "disponible", label: "Disponible" },
            { value: "estudiando en el pais", label: "Estudiando en el Pa√≠s" },
            { value: "estudiando en el extranjero", label: "Estudiando en el Extranjero" },
            { value: "vacaciones", label: "Vacaciones" },
            { value: "asignado", label: "Asignado" },
            { value: "servicio", label: "Servicio" },
            { value: "pendiente de vuelo", label: "Pendiente de Vuelo" },
            { value: "mision pais", label: "Misi√≥n Pa√≠s" },
            { value: "mision ciudad", label: "Misi√≥n Ciudad" },
            { value: "clinica", label: "Cl√≠nica" },
            { value: "hospital militar", label: "Hospital Militar" },
            { value: "libre", label: "Libre" },
            { value: "faltistas", label: "Faltistas" },
            { value: "desertor", label: "Desertor" }
        ];

        // --- Elementos del DOM ---
        const oficialesPartTableBody = document.getElementById('oficiales-part-table-body');
        const oficialesTotal = document.getElementById('oficiales-total');
        const noDataMessage = document.getElementById('no-data-message');
        const userIdDisplay = document.getElementById('user-id-display');

        // Modal elements
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalInputNote = document.getElementById('modal-input-note');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        // Estado actual de los conteos y notas de esta parte
        let currentPartData = {};

        /**
         * Muestra el modal personalizado para edici√≥n de nota.
         * @param {string} title - T√≠tulo del modal.
         * @param {Object} [initialValues={}] - Objeto con valores iniciales (e.g., { note: '...' }).
         * @returns {Promise<string|boolean>} - Promesa que resuelve con la nota editada o false si se cancela.
         */
        function showNoteModal(title, initialValues = {}) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalInputNote.value = initialValues.note || '';
                customModalOverlay.classList.add('visible');
                modalInputNote.focus();

                const confirmHandler = () => {
                    hideCustomModal();
                    resolve(modalInputNote.value);
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    modalCancelButton.removeEventListener('click', cancelHandler);
                };

                const cancelHandler = () => {
                    hideCustomModal();
                    resolve(false);
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    modalCancelButton.removeEventListener('click', cancelHandler);
                };

                modalConfirmButton.addEventListener('click', confirmHandler);
                modalCancelButton.addEventListener('click', cancelHandler);
            });
        }

        /** Oculta el modal personalizado. */
        function hideCustomModal() {
            customModalOverlay.classList.remove('visible');
        }

        /**
         * Renderiza la tabla de entrada de datos de la parte de oficiales.
         * @param {Object} partData - Objeto con los conteos y notas de cada estado.
         */
        function renderOficialesPartTable(partData) {
            oficialesPartTableBody.innerHTML = '';
            let totalOficiales = 0;

            staffStatuses.forEach(status => {
                const count = partData[status.value]?.count || 0;
                const note = partData[status.value]?.note || '';
                totalOficiales += count;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-800">${status.label}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-center">
                        <input type="number" 
                                class="w-24 text-center rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" 
                                value="${count}" 
                                min="0" 
                                data-status="${status.value}">
                    </td>
                    <td class="px-6 py-4 text-left">
                        <div class="note-display" data-status="${status.value}" data-note="${note}">
                            <span class="truncate">${note || 'A√±adir nota...'}</span>
                            <svg class="edit-pencil-icon ml-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M14.06 9.06L9 14.12l-1.63-1.63a.75.75 0 00-1.06 1.06l2.16 2.16c.29.29.77.29 1.06 0L15.12 10.12a.75.75 0 00-1.06-1.06zM17.5 4.75a2.25 2.25 0 00-2.25 2.25v2.25a.75.75 0 001.5 0V7a.75.75 0 01.75-.75h2.25a.75.75 0 000-1.5H17.5zM6.75 4.75a.75.75 0 000 1.5h2.25a.75.75 0 01.75.75v2.25a.75.75 0 001.5 0V7a2.25 2.25 0 00-2.25-2.25H6.75zM17.5 17.25a.75.75 0 000 1.5h-2.25a.75.75 0 01-.75-.75v-2.25a.75.75 0 00-1.5 0V17a2.25 2.25 0 002.25 2.25h2.25a.75.75 0 000-1.5H17.5zM6.75 17.25a2.25 2.25 0 002.25 2.25h2.25a.75.75 0 000-1.5h-2.25a.75.75 0 01-.75-.75v-2.25a.75.75 0 00-1.5 0V17.25zM12 10.25a.75.75 0 00-.75.75v2.25a.75.75 0 001.5 0V11a.75.75 0 00-.75-.75z" />
                            </svg>
                        </div>
                    </td>
                `;
                oficialesPartTableBody.appendChild(row);
            });

            oficialesTotal.textContent = totalOficiales;

            if (totalOficiales === 0) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
            }
        }

        /**
         * Guarda los conteos y notas de los oficiales en Firestore.
         * @param {Object} countsData - Objeto con los conteos y notas de cada estado.
         */
        async function saveOficialesCounts(countsData) {
            if (!userId) {
                console.error("No hay ID de usuario. No se puede guardar.");
                return;
            }
            try {
                // Los reportes son p√∫blicos, por eso la ruta es /public/data/reports
                const docRef = doc(db, `artifacts/${appId}/public/data/reports`, MY_PART_REPORT_ID);
                await setDoc(docRef, countsData);
                console.log("Datos de oficiales guardados con √©xito.");
            } catch (error) {
                console.error("Error al guardar los datos de oficiales:", error);
            }
        }

        // --- Inicializaci√≥n de Firebase y Listener de Datos ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autenticaci√≥n con token personalizada exitosa.");
                } catch (error) {
                    console.error("Error al autenticar con token personalizada:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
                console.log("Inicio de sesi√≥n an√≥nimo exitoso.");
            }

            // Once authenticated, get the user ID and listen for changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("Usuario autenticado. UID:", userId);

                    // Escuchar cambios en el documento de esta parte
                    const docRef = doc(db, `artifacts/${appId}/public/data/reports`, MY_PART_REPORT_ID);
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentPartData = docSnap.data();
                            renderOficialesPartTable(currentPartData);
                        } else {
                            console.log("No existen datos para la parte de oficiales. Inicializando tabla.");
                            currentPartData = {}; // Resetear si no hay datos
                            // Inicializar currentPartData con 0s y notas vac√≠as
                            staffStatuses.forEach(status => {
                                currentPartData[status.value] = { count: 0, note: '' };
                            });
                            renderOficialesPartTable(currentPartData);
                        }
                    }, (error) => {
                        console.error("Error al escuchar el documento de Firestore:", error);
                    });

                } else {
                    console.log("Usuario no autenticado.");
                    userIdDisplay.textContent = "No autenticado";
                }
            });

            // Listener para el input de cantidades (guardado autom√°tico)
            oficialesPartTableBody.addEventListener('input', () => {
                const inputs = oficialesPartTableBody.querySelectorAll('input[type="number"]');
                const newData = {};
                inputs.forEach(input => {
                    const statusValue = input.dataset.status;
                    newData[statusValue] = {
                        count: parseInt(input.value, 10) || 0,
                        note: currentPartData[statusValue]?.note || '' // Mantener la nota existente
                    };
                });
                saveOficialesCounts(newData); // Guardar autom√°ticamente al cambiar un input
            });

            // Listener para la edici√≥n de notas (delegaci√≥n de eventos)
            oficialesPartTableBody.addEventListener('click', async (event) => {
                const noteDisplayDiv = event.target.closest('.note-display');
                if (noteDisplayDiv) {
                    const statusValue = noteDisplayDiv.dataset.status;
                    const initialNote = noteDisplayDiv.dataset.note || '';

                    const newNote = await showNoteModal(`Editar Nota para ${staffStatuses.find(s => s.value === statusValue).label}`, { note: initialNote });
                    
                    if (newNote !== false) { // Si el usuario no cancel√≥
                        currentPartData[statusValue].note = newNote;
                        noteDisplayDiv.dataset.note = newNote; // Actualizar el dataset para la pr√≥xima edici√≥n
                        noteDisplayDiv.querySelector('span').textContent = newNote || 'A√±adir nota...';
                        saveOficialesCounts(currentPartData); // Guardar los cambios autom√°ticamente
                    }
                }
            });

            // Agrega un listener para el evento 'popstate' para detectar la navegaci√≥n hacia atr√°s del navegador
            window.addEventListener('popstate', (event) => {
                // Redirige a la p√°gina principal si el usuario navega hacia atr√°s
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
