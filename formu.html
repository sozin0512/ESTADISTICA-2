<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FAH-980 - Registro Diario (Febrero 2026)</title>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary: #1d4ed8;
      --accent: #3b82f6;
      --success: #10b981;
      --bg: #f8fafc;
      --card: white;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
    }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
      min-height: 100vh;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 2rem; }
    h1 { color: var(--primary); margin-bottom: 0.4rem; }
    .subtitle { color: var(--muted); font-size: 1.1rem; }
    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.07);
      padding: 1.8rem;
      border: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .card-title {
      font-size: 1.35rem;
      color: var(--primary);
      margin-bottom: 1.2rem;
      padding-bottom: 0.6rem;
      border-bottom: 2px solid var(--accent);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.4rem 1.8rem;
    }
    .form-group { margin-bottom: 1.2rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #334155; }
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1.05rem;
    }
    input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
    .preview-box { margin-top: 0.6rem; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.95rem; }
    .current-val { color: var(--muted); }
    .projected-val { color: var(--success); font-weight: 600; font-size: 1.1rem; }
    .day-selector { margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 500; }
    .day-selector select { padding: 8px 12px; font-size: 1rem; border-radius: 6px; border: 1px solid #cbd5e1; }
    .buttons { margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; }
    button { padding: 12px 24px; font-size: 1.05rem; border: none; border-radius: 8px; cursor: pointer; }
    .btn-save { background: var(--success); color: white; }
    .btn-save:hover { background: #059669; }
    .btn-clear { background: #f1f5f9; color: #334155; }
    .btn-clear:hover { background: #e2e8f0; }
    .message { padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center; font-weight: 500; display: none; }
    .success { background: #ecfdf5; color: #065f46; }
    .error   { background: #fef2f2; color: #991b1b; }
    .loading { text-align: center; padding: 6rem 1rem; font-size: 1.3rem; color: var(--muted); }

    /* Estilos para el listado de evidencias */
    #evidenciasSelect {
      width: 100%;
      max-width: 600px;
      height: 220px;
      font-size: 1rem;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 1.5rem;
    }
    #evidenciaDetalle {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.2rem;
      background: #f8fafc;
    }
    #evidenciaDetalle img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>FAH-980 – Registro Diario</h1>
      <div class="subtitle" id="currentPeriod">Cargando febrero 2026 (1-2026)...</div>
    </header>

    <div id="loading" class="loading">Leyendo datos de febrero...</div>
    <div id="message" class="message"></div>

    <div id="formContent" style="display:none;">
      <div class="card">
        <div class="card-title">Registrando para el día</div>

        <div class="day-selector">
          Día:
          <select id="daySelect">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7" selected>7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>AC HRS</label>
            <input type="number" step="0.01" id="add_ac_hrs" value="0">
            <div class="preview-box">
              Actual: <span class="current-val" id="current_ac_hrs">—</span><br>
              Nuevo total: <span class="projected-val" id="preview_ac_hrs">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>Aterrizajes</label>
            <input type="number" id="add_aterrizajes" value="0">
            <div class="preview-box">
              Actual: <span id="current_aterrizajes">—</span><br>
              Nuevo total: <span id="preview_aterrizajes">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>RINS</label>
            <input type="number" id="add_rins" value="0">
            <div class="preview-box">
              Actual: <span id="current_rins">—</span><br>
              Nuevo total: <span id="preview_rins">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>ENGINE HRS 1</label>
            <input type="number" step="0.01" id="add_eng_hrs_1" value="0">
            <div class="preview-box">
              Actual: <span id="current_eng_hrs_1">—</span><br>
              Nuevo total: <span id="preview_eng_hrs_1">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>ENGINE STARTS 1</label>
            <input type="number" id="add_eng_starts_1" value="0">
            <div class="preview-box">
              Actual: <span id="current_eng_starts_1">—</span><br>
              Nuevo total: <span id="preview_eng_starts_1">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>FLIGHTS 1</label>
            <input type="number" id="add_flights_1" value="0">
            <div class="preview-box">
              Actual: <span id="current_flights_1">—</span><br>
              Nuevo total: <span id="preview_flights_1">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>CICLOS 1</label>
            <input type="number" id="add_ciclos_1" value="0">
            <div class="preview-box">
              Actual: <span id="current_ciclos_1">—</span><br>
              Nuevo total: <span id="preview_ciclos_1">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>ENGINE HRS 2</label>
            <input type="number" step="0.01" id="add_eng_hrs_2" value="0">
            <div class="preview-box">
              Actual: <span id="current_eng_hrs_2">—</span><br>
              Nuevo total: <span id="preview_eng_hrs_2">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>ENGINE STARTS 2</label>
            <input type="number" id="add_eng_starts_2" value="0">
            <div class="preview-box">
              Actual: <span id="current_eng_starts_2">—</span><br>
              Nuevo total: <span id="preview_eng_starts_2">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>FLIGHTS 2</label>
            <input type="number" id="add_flights_2" value="0">
            <div class="preview-box">
              Actual: <span id="current_flights_2">—</span><br>
              Nuevo total: <span id="preview_flights_2">—</span>
            </div>
          </div>

          <div class="form-group">
            <label>CICLOS 2</label>
            <input type="number" id="add_ciclos_2" value="0">
            <div class="preview-box">
              Actual: <span id="current_ciclos_2">—</span><br>
              Nuevo total: <span id="preview_ciclos_2">—</span>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button class="btn-save" id="saveBtn">Guardar este día</button>
          <button class="btn-clear" id="clearBtn">Limpiar campos</button>
        </div>
      </div>

      <!-- Listado de evidencias -->
      <div class="card" id="evidenciasSection">
        <div class="card-title">Evidencias de registros</div>
        <button class="btn-save" id="verListadoBtn">Ver Listado de Evidencias</button>

        <div id="listadoContent" style="display: none; margin-top: 1.5rem;">
          <select id="evidenciasSelect" size="6"></select>
          <div id="evidenciaDetalle">
            <p>Selecciona una entrada para ver los detalles.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Elementos ocultos para captura de foto -->
  <video id="video" autoplay playsinline style="display: none;"></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8",
      authDomain: "fah-980-ceb96.firebaseapp.com",
      databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
      projectId: "fah-980-ceb96",
      storageBucket: "fah-980-ceb96.firebasestorage.app",
      messagingSenderId: "57890484294",
      appId: "1:57890484294:web:8a27759a4da0b262e99a47",
      measurementId: "G-HSZMRM7ZCS"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const basePath = 'artifacts/fah-980-master-v1/public/data/MAINTENANCE_LOGS';
    const targetPeriod = '1-2026'; // febrero 2026
    const PASSWORD_ACCESO = "Kevin";

    let currentPeriod = targetPeriod;
    let currentTotals = {};

    document.getElementById('currentPeriod').textContent = `Cargando febrero 2026 (${targetPeriod})...`;

    db.ref(`${basePath}/${targetPeriod}`).once('value')
      .then(snap => {
        currentTotals = snap.val() || {};

        updateCurrentDisplay('ac_hrs', currentTotals.vienen_ac_hrs || 0);
        updateCurrentDisplay('aterrizajes', currentTotals.vienen_aterrizajes || 0);
        updateCurrentDisplay('rins', currentTotals.vienen_rins || 0);
        updateCurrentDisplay('eng_hrs_1', currentTotals.vienen_eng_hrs_1 || 0);
        updateCurrentDisplay('eng_starts_1', currentTotals.vienen_eng_starts_1 || 0);
        updateCurrentDisplay('flights_1', currentTotals.vienen_flights_1 || 0);
        updateCurrentDisplay('ciclos_1', currentTotals.vienen_ciclos_1 || 0);
        updateCurrentDisplay('eng_hrs_2', currentTotals.vienen_eng_hrs_2 || 0);
        updateCurrentDisplay('eng_starts_2', currentTotals.vienen_eng_starts_2 || 0);
        updateCurrentDisplay('flights_2', currentTotals.vienen_flights_2 || 0);
        updateCurrentDisplay('ciclos_2', currentTotals.vienen_ciclos_2 || 0);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('formContent').style.display = 'block';

        initPreview();
      })
      .catch(err => {
        showMessage(`Error al cargar febrero 2026 (${targetPeriod}): ${err.message}`, "error");
        console.error(err);
      });

    // ───────────────────────────────────────────────
    //  Captura de foto + ubicación
    // ───────────────────────────────────────────────
    async function capturarEvidencia() {
      try {
        // Cámara
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);
        await new Promise(r => setTimeout(r, 800)); // breve espera para estabilizar

        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        const photoBase64 = canvas.toDataURL('image/jpeg', 0.82);

        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;

        // Ubicación
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 12000,
            maximumAge: 0
          });
        });

        const { latitude: lat, longitude: lng } = position.coords;

        // Fecha y hora
        const now = new Date();
        const fecha = now.toLocaleDateString('es-HN');
        const hora = now.toLocaleTimeString('es-HN', { hour12: false });
        const diaSemana = now.toLocaleDateString('es-HN', { weekday: 'long' });

        return {
          timestamp: now.getTime(),
          fecha,
          hora,
          diaSemana,
          lat,
          lng,
          photo: photoBase64
        };

      } catch (err) {
        console.error("Error capturando evidencia:", err);
        let mensaje = "No se pudo capturar la evidencia.";
        if (err.name === 'NotAllowedError') mensaje += "\nPermiso de cámara o ubicación denegado.";
        if (err.name === 'PositionError') mensaje += "\nNo se pudo obtener la ubicación.";
        alert(mensaje);
        return null;
      }
    }

    // ───────────────────────────────────────────────
    //  Guardar datos + evidencia
    // ───────────────────────────────────────────────
    document.getElementById('saveBtn')?.addEventListener('click', async () => {
      const day = document.getElementById('daySelect').value;

      // Intentamos capturar evidencia
      const evidencia = await capturarEvidencia();

      // Si no se obtuvo evidencia, preguntamos si continuar
      if (!evidencia) {
        if (!confirm("No se pudo capturar foto o ubicación.\n¿Deseas guardar los datos de todos modos?")) {
          return;
        }
      }

      const updates = {};

      const fields = {
        'ac_hrs': 'add_ac_hrs',
        'aterrizajes': 'add_aterrizajes',
        'rins': 'add_rins',
        'eng_hrs_1': 'add_eng_hrs_1',
        'eng_starts_1': 'add_eng_starts_1',
        'flights_1': 'add_flights_1',
        'ciclos_1': 'add_ciclos_1',
        'eng_hrs_2': 'add_eng_hrs_2',
        'eng_starts_2': 'add_eng_starts_2',
        'flights_2': 'add_flights_2',
        'ciclos_2': 'add_ciclos_2'
      };

      Object.keys(fields).forEach(key => {
        const value = Number(document.getElementById(fields[key]).value) || 0;
        if (value !== 0) {
          updates[`${key}/${day}`] = value;
        }
      });

      if (Object.keys(updates).length === 0 && !evidencia) {
        showMessage("No ingresaste ningún valor nuevo", "error");
        return;
      }

      let promise = db.ref(`${basePath}/${currentPeriod}`).update(updates);

      if (evidencia) {
        promise = promise.then(() => {
          return db.ref(`${basePath}/${currentPeriod}/evidencias/${day}`).set(evidencia);
        });
      }

      promise
        .then(() => {
          showMessage(`Día ${day} guardado correctamente`, "success");

          db.ref(`${basePath}/${currentPeriod}`).once('value')
            .then(snap => {
              currentTotals = snap.val() || {};
              loadAndShowTotals(currentTotals);
            });

          // Refrescar listado si está visible
          if (document.getElementById('listadoContent').style.display !== 'none') {
            cargarListadoEvidencias();
          }
        })
        .catch(err => {
          showMessage("Error al guardar: " + err.message, "error");
          console.error(err);
        });
    });

    // ───────────────────────────────────────────────
    //  Ver listado con contraseña
    // ───────────────────────────────────────────────
    document.getElementById('verListadoBtn')?.addEventListener('click', () => {
      const pass = prompt("Ingrese la contraseña para ver el listado:");
      if (pass !== PASSWORD_ACCESO) {
        alert("Contraseña incorrecta.");
        return;
      }

      document.getElementById('listadoContent').style.display = 'block';
      cargarListadoEvidencias();
    });

    async function cargarListadoEvidencias() {
      try {
        const snap = await db.ref(`${basePath}/${currentPeriod}/evidencias`).once('value');
        const evidencias = snap.val() || {};

        const select = document.getElementById('evidenciasSelect');
        select.innerHTML = '';

        Object.entries(evidencias).forEach(([dia, data]) => {
          if (!data || !data.timestamp) return;

          const option = document.createElement('option');
          option.value = dia;
          option.textContent = `${data.fecha}  ${data.hora}  (${data.diaSemana})  - Día ${dia}`;
          select.appendChild(option);
        });

        select.onchange = () => mostrarDetalleEvidencia(evidencias, select.value);

        if (select.options.length > 0) {
          select.selectedIndex = 0;
          mostrarDetalleEvidencia(evidencias, select.value);
        } else {
          document.getElementById('evidenciaDetalle').innerHTML = '<p>No hay evidencias registradas aún para este período.</p>';
        }

      } catch (err) {
        console.error(err);
        document.getElementById('evidenciaDetalle').innerHTML = '<p>Error al cargar las evidencias.</p>';
      }
    }

    function mostrarDetalleEvidencia(evidencias, dia) {
      const data = evidencias[dia];
      if (!data) return;

      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${data.lat},${data.lng}`;

      const html = `
        <p><strong>Día:</strong> ${dia}</p>
        <p><strong>Fecha y hora:</strong> ${data.fecha} ${data.hora} (${data.diaSemana})</p>
        <p><strong>Ubicación:</strong> 
          <a href="${mapsUrl}" target="_blank" rel="noopener">Ver en Google Maps</a>
          <br><small>(${data.lat.toFixed(6)}, ${data.lng.toFixed(6)})</small>
        </p>
        <div style="margin-top: 1.2rem;">
          <img src="${data.photo}" alt="Evidencia día ${dia}">
        </div>
      `;

      document.getElementById('evidenciaDetalle').innerHTML = html;
    }

    // ───────────────────────────────────────────────
    //  Funciones existentes (sin cambios)
    // ───────────────────────────────────────────────
    document.getElementById('clearBtn')?.addEventListener('click', () => {
      document.querySelectorAll('input[type="number"]').forEach(i => i.value = '0');
      const fields = ['ac_hrs','aterrizajes','rins','eng_hrs_1','eng_starts_1','flights_1','ciclos_1','eng_hrs_2','eng_starts_2','flights_2','ciclos_2'];
      fields.forEach(f => updatePreview(f));
    });

    function showMessage(text, type = 'success') {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 6000);
    }

    function loadAndShowTotals(data) {
      updateCurrentDisplay('ac_hrs', data.vienen_ac_hrs || 0);
      updateCurrentDisplay('aterrizajes', data.vienen_aterrizajes || 0);
      updateCurrentDisplay('rins', data.vienen_rins || 0);
      updateCurrentDisplay('eng_hrs_1', data.vienen_eng_hrs_1 || 0);
      updateCurrentDisplay('eng_starts_1', data.vienen_eng_starts_1 || 0);
      updateCurrentDisplay('flights_1', data.vienen_flights_1 || 0);
      updateCurrentDisplay('ciclos_1', data.vienen_ciclos_1 || 0);
      updateCurrentDisplay('eng_hrs_2', data.vienen_eng_hrs_2 || 0);
      updateCurrentDisplay('eng_starts_2', data.vienen_eng_starts_2 || 0);
      updateCurrentDisplay('flights_2', data.vienen_flights_2 || 0);
      updateCurrentDisplay('ciclos_2', data.vienen_ciclos_2 || 0);

      initPreview();
    }

    function updateCurrentDisplay(field, value) {
      const el = document.getElementById(`current_${field}`);
      if (el) {
        el.textContent = field.includes('hrs') ? Number(value).toFixed(1) : Math.round(value);
      }
      updatePreview(field);
    }

    function initPreview() {
      const fields = [
        'ac_hrs', 'aterrizajes', 'rins',
        'eng_hrs_1', 'eng_starts_1', 'flights_1', 'ciclos_1',
        'eng_hrs_2', 'eng_starts_2', 'flights_2', 'ciclos_2'
      ];

      fields.forEach(field => {
        const input = document.getElementById(`add_${field}`);
        if (input) {
          input.addEventListener('input', () => updatePreview(field));
          updatePreview(field);
        }
      });
    }

    function updatePreview(field) {
      const input = document.getElementById(`add_${field}`);
      const currentEl = document.getElementById(`current_${field}`);
      const previewEl = document.getElementById(`preview_${field}`);

      if (!input || !currentEl || !previewEl) return;

      const current = parseFloat(currentEl.textContent) || 0;
      const added = parseFloat(input.value) || 0;
      const projected = current + added;

      previewEl.textContent = field.includes('hrs') ? projected.toFixed(1) : Math.round(projected);
    }
  </script>
</body>
</html>
