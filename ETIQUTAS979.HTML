<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiqueta de Mantenimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            min-height: 100vh;
        }

        .sticker-container {
            width: 100%;
            max-width: 600px;
            background-color: #f7f7f7;
            padding: 1rem;
            border: 2px solid #ccc;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
        }

        /* Custom colors for the document */
        .bg-custom-blue {
            background-color: #002D62;
        }
        .bg-custom-yellow {
            background-color: #F8D670;
        }
        
        .editable-cell {
            outline: 1px solid transparent;
            cursor: pointer;
            transition: outline 0.2s ease-in-out;
            word-wrap: break-word;
        }

        .editable-cell:focus {
            outline: 1px solid #000;
        }
        
        /* Print styles */
        @media print {
            body {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .sticker-container {
                box-shadow: none !important;
                border: 2px solid #ccc !important;
            }
            .no-print {
                display: none !important;
            }
            .editable-cell {
                outline: none !important;
            }
            #signatureCanvas {
                border: none !important;
            }
            .bg-custom-blue, .bg-custom-yellow {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Main sticker container -->
    <div class="sticker-container">

        <!-- Header banner with logo and text -->
        <div class="bg-custom-yellow p-4 text-center rounded-t-lg border-2 border-black border-b-0">
            <div id="image-viewer" class="mb-2">
                <p class="font-bold text-gray-700 mb-2"></p>
    
            </div>
            <p class="text-sm font-bold text-gray-800 mt-1">ESCN. HELICÓPTEROS</p>
            <p class="text-xs text-gray-800">FUERZA AÉREA HONDUREÑA</p>
        </div>
        <div class="bg-red-500text-center font-bold text-gray-800 text-lg py-1 border-2 border-black border-t-0"></div>

        <!-- Data table with 4 columns -->
        <div class="grid grid-cols-4 gap-0 text-xs border-2 border-black border-t-0 rounded-b-lg overflow-hidden">
            <!-- Row 1: FECHA INICIO & FECHA FINALIZACIÓN -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">FECHA INICIO</div>
            <div id="fecha_inicio" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">FECHA FINALIZACIÓN</div>
            <div id="fecha_finalizacion" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>

            <!-- Row 2: MODELO & ENG 1 S/N TSN / TSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">MODELO</div>
            <div id="modelo" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 1 S/N TSN / TSO</div>
            <div id="eng1_tsn_tso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 3: NÚMERO DE SERIE & ENG 1 S/N CSN / CSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">NÚMERO DE SERIE</div>
            <div id="numero_de_serie" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 1 S/N CSN / CSO</div>
            <div id="eng1_csn_cso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 4: MATRÍCULA & ENG 2 S/N TSN / TSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">MATRÍCULA</div>
            <div id="matricula" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 2 S/N TSN / TSO</div>
            <div id="eng2_tsn_tso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 5: A/C TT & ENG 2 S/N CSN / CSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">A/C TT</div>
            <div id="ac_tt" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 2 S/N CSN / CSO</div>
            <div id="eng2_csn_cso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 6: TQ EVENTS & C-BOX S/N TSN / TSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">TQ EVENTS</div>
            <div id="tq" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">C-BOX S/N TSN / TSO</div>
            <div id="cbox_tsn_tso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>

            <!-- Row 7: LANDINGS & C-BOX S/N CSN / CSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">LANDINGS</div>
            <div id="landings" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">C-BOX S/N CSN / CSO</div>
            <div id="cbox_csn_cso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
        </div>
        
        <!-- Text and signature sections -->
        <div class="mt-4 border-2 border-black rounded-lg p-2 bg-white">
            <div class="flex justify-between items-center space-x-4">
                <h3 class="font-bold text-sm editable-cell flex-shrink-0" contenteditable="true">Se Completaron los siguientes trabajos:</h3>
                <!-- Dropdown to add tasks -->
                <div class="no-print flex-grow">
                    <select id="task-type-select" class="w-full px-2 py-1 border border-black rounded-md bg-gray-50 text-xs">
                        <!-- Options will be dynamically generated here -->
                    </select>
                </div>
            </div>

            <div id="trabajos-container" class="space-y-2 mt-2">
                <!-- Content will be dynamically generated here -->
            </div>
            
            <p id="certificacion" class="italic text-gray-700 text-xs mb-4 mt-4 editable-cell font-bold" contenteditable="true">
                Yo certifico que los trabajos arriba descritos fueron efectuados de acuerdo a los procedimientos del Manual de Mantenimiento y por lo tanto la aeronave es puesta en servicio.
            </p>
            
            <!-- Signature container -->
            <div class="flex flex-col items-center">
                <!-- Signature -->
                <canvas id="signatureCanvas" class="border border-black w-full h-20 rounded-md bg-white"></canvas>
                <button id="clearSignatureBtn" class="no-print mt-2 px-2 py-1 bg-red-500 text-white text-xs rounded-md hover:bg-red-600 transition-colors duration-200">Limpiar Firma</button>

                <!-- Data below the signature -->
                <div class="flex justify-between items-center w-full mt-4 text-xs">
                   
                    <div class="flex items-center space-x-2">
                        <p class="font-bold">Serie</p>
                        <p id="serie" class="editable-cell text-sm font-bold" contenteditable="true"></p>
                    </div>
                      <div class="flex items-center space-x-2">
                        <p class="font-bold">JEFE DE TALLER</p>
                        <p id="jefe_taller" class="editable-cell text-sm font-bold" contenteditable="true"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="font-bold">Lic. No.</p>
                        <p id="lic_no" class="editable-cell text-sm font-bold" contenteditable="true"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons and records container, outside the sticker -->
    <div class="no-print w-full max-w-lg mt-4 flex flex-col items-center space-y-4">
        <!-- New file upload and scan buttons -->
        <div class="flex flex-col items-center space-y-2 w-full p-4 border rounded-md border-gray-300 bg-gray-200">
            <h3 class="font-bold text-lg text-gray-700">Escanear Documento (IA)</h3>
            <p class="text-xs text-gray-500">Sube una imagen del documento para rellenar los datos automáticamente.</p>
            <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm">
            <button id="scanImageBtn" class="w-full px-6 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 transition-colors duration-200">
                Escanear Imagen
            </button>
        </div>
        
        <div class="flex space-x-4">
            <button id="printAndSaveButton" class="px-6 py-2 bg-green-500 text-white font-bold rounded-md transition-colors duration-200">
                Imprimir y Guardar
            </button>
            <button id="showRecordsButton" class="px-6 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 transition-colors duration-200">
                Mostrar Registros Guardados
            </button>
        </div>
        <button id="newRecordButton" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-md hover:bg-gray-600 transition-colors duration-200">
            Nuevo Registro
        </button>

        <!-- Status and loading bar -->
        <div id="statusContainer" class="mt-4 w-full">
            <div id="statusMessage" class="mt-4 text-center text-sm font-semibold"></div>
        </div>
        <div id="recordsContainer" class="mt-4 w-full">
            <!-- Saved records will be displayed here -->
        </div>
    </div>

    <!-- Modal to ask for the user's name -->
    <div id="nameModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Ingresa tu Nombre</h2>
            <p class="mb-4 text-sm">Este nombre se guardará como la persona que realiza el registro.</p>
            <input type="text" id="userNameInput" placeholder="Nombre completo" class="w-full p-2 border border-gray-300 rounded-md">
            <div class="flex justify-end mt-4 space-x-2">
                <button id="closeModalBtn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-md hover:bg-gray-500 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="saveAndPrintBtn" class="px-4 py-2 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition-colors duration-200">
                    Guardar y Usar Ctrl + P
                </button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set logging level for debugging
        setLogLevel('debug');

        // =========================================================================
        // === Pega tu configuración de Firebase aquí para que funcione fuera de Canvas ===
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAnDAVVRTnl_SHejO7lyqrkGbPcFNyIBHc",
            authDomain: "reportesti-4104T7.firebaseapp.com",
            projectId: "reportesti-41047",
            storageBucket: "reportesti-41047.appspot.com",
            messagingSenderId: "997680984231",
            appId: "1:997680984231:web:d9c27e1ac8eaf9473feb82"
        };
        // =========================================================================

        const appId = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // State management
        let currentDocId = null;

        // UI Elements
        const taskTypeSelect = document.getElementById('task-type-select');
        const trabajosContainer = document.getElementById('trabajos-container');
        const printAndSaveButton = document.getElementById('printAndSaveButton');
        const showRecordsButton = document.getElementById('showRecordsButton');
        const newRecordButton = document.getElementById('newRecordButton');
        const recordsContainer = document.getElementById('recordsContainer');
        const statusMessage = document.getElementById('statusMessage');
        const nameModal = document.getElementById('nameModal');
        const userNameInput = document.getElementById('userNameInput');
        const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.getElementById('clearSignatureBtn');
        const imageUpload = document.getElementById('imageUpload');
        const scanImageBtn = document.getElementById('scanImageBtn');
        const mainImage = document.getElementById('main-image');

        // --- Data Structure for Inspections ---
        const inspections = {
            scheduled_inspections_a: {
                label: "Scheduled Inspections - Part A",
                items: {
                    daily_inspection: { title: "Daily Inspection (DMC-412-A-05-40-00-00A-281A-A / 00022)", hours: 10 },
                    '100_hour': { title: "100 Hour/12 Month Inspection (DMC-412-A-05-40-00-01A-281A-A / 00023)", hours: 100 },
                    '1000_hour': { title: "1000 Hour Inspection (DMC-412-A-05-40-00-02A-281A-A / 00024)", hours: 1000 },
                    '5000_hour': { title: "5000 Hour/5 Year Inspection (DMC-412-A-05-40-00-03A-281A-A / 00025)", hours: 5000 },
                }
            },
            scheduled_inspections_b: {
                label: "Scheduled Inspections - Part B",
                items: {
                    '25_hour': { title: "25 Hour/30 Day Inspection (DMC-412-A-05-40-00-04A-281A-A / 00026)", hours: 25 },
                    '300_hour': { title: "300 Hour/12 Month Inspection (DMC-412-A-05-40-00-05A-281A-A / 00027)", hours: 300 },
                    '600_hour': { title: "600 Hour/12 Month Inspection (DMC-412-A-05-40-00-06A-281A-A / 00028)", hours: 600 },
                    '5000_hour': { title: "5000 Hour/5 Year Inspection (DMC-412-A-05-40-00-07A-281A-A / 00029)", hours: 5000 },
                }
            },
            special_inspections: {
                label: "Special Inspections",
                items: {
                    description: { title: "Description (DMC-412-A-05-47-00-00A-042A-A / 00030)" },
                    daily_10_hour: { title: "Daily/10 Hour Inspection, Whichever Occurs First Until 250 Hours (DMC-412-A-05-47-00-00A-283A-A / 00031)", hours: 10 },
                    '1_5_flight_hours_main_rotor': { title: "Between 1 and 5 Flight Hours After Main Rotor Hub Installation (DMC-412-A-05-47-00-01A-283A-A / 00032)", hours: 5 },
                    '1_5_flight_hours_tailboom': { title: "Between 1 and 5 Flight Hours After Tailboom Installation or Attachment Bolt Replacement (DMC-412-A-05-47-00-00A-283B-A / 00033)", hours: 5 },
                    '1_5_flight_hours_tail_rotor_gearbox': { title: "Between 1 and 5 Flight Hours After Tail Rotor Gearbox or Intermediate Gearbox Installation (DMC-412-A-05-47-00-32A-283A-A / 00033.1)", hours: 5 },
                    '1_25_flight_hours_expandable_blade_bolt': { title: "Between 1 and 25 Flight Hours After Expandable Blade Bolt Installation (DMC-412-A-05-47-00-02A-283A-A / 00034)", hours: 25 },
                    '5_10_flight_hours_tail_rotor_hub': { title: "Between 5 and 10 Hours of Flight After Tail Rotor Hub and Blade Assembly Installation (DMC-412-A-05-47-00-03A-283A-A / 00035)", hours: 10 },
                    '25_hours_for_the_next_four': { title: "Each 25 Hours For the Next Four Inspections (DMC-412-A-05-47-00-04A-283A-A / 00036)", hours: 25 },
                    '25_hours_tail_rotor': { title: "Each 25 Hours of Tail Rotor Operation (DMC-412-A-05-47-00-05A-283A-A / 00037)", hours: 25 },
                    '25_hours_tailboom_attachment': { title: "Each 25 Hours Tailboom Attachment Inspection (DMC-412-A-05-47-00-30A-283A-A / 00039)", hours: 25 },
                    '50_hours_after_installation': { title: "50 Hours After Installation of Components (DMC-412-A-05-47-00-06A-283A-A / 00038)", hours: 50 },
                    '50_hours_tailboom_attachment': { title: "Each 50 Hours Tailboom Attachment Inspection (DMC-412-A-05-47-00-51A-283A-A / 00038.1)", hours: 50 },
                    '100_hours_tailboom_vertical_fin': { title: "Each 100 Hours Tailboom Vertical Fin Spar Cap Inspection (DMC-412-A-05-47-00-31A-283A-A / 00040)", hours: 100 },
                    '100_hours_collective_lever': { title: "Each 100 Hours of Collective Lever Operation (DMC-412-A-05-47-00-08A-283A-A / 00041)", hours: 100 },
                    '150_hours_starter_generator': { title: "Each 150 Hours of Starter Generator (200SG119Q) Operation (DMC-412-A-05-47-00-09A-283A-A / 00042)", hours: 150 },
                    '300_hours_expandable_blade_bolt': { title: "Each 300 Hours or 6 Months of Expandable Blade Bolt Operation (DMC-412-A-05-47-00-10A-283A-A / 00043)", hours: 300 },
                    '600_hours_tail_rotor_driveshaft': { title: "Each 600 Hours of Tail Rotor Driveshaft Operation or 12 Months (DMC-412-A-05-47-00-11A-283A-A / 00044)", hours: 600 },
                    '600_hours_tailboom_attachment_bolts': { title: "Each 600 Hours or 12 Months of Tailboom Attachment Bolts (DMC-412-A-05-47-00-00B-283B-A / 00045)", hours: 600 },
                    '600_hours_main_driveshaft': { title: "Each 600 Hours of Main Driveshaft Operation or 12 Months (DMC-412-A-05-47-00-12A-283A-A / 00046)", hours: 600 },
                    '600_hours_magnetic_brake': { title: "Each 600 Hours or 12 Months Inspection Of Magnetic Brake Assembly (DMC-412-A-05-47-00-50A-283A-A / 00047)", hours: 600 },
                    '1000_hours_component': { title: "Each 1000 Hours of Component Operation (DMC-412-A-05-47-00-13A-283A-A / 00048)", hours: 1000 },
                    '1000_hours_crosstube': { title: "Each 12 Months or 2500 Landings of Aft High Crosstube Operation (DMC-412-A-05-47-00-14A-283A-A / 00049)", hours: 1000 },
                    '24_months_control_bolt': { title: "Each 24 Months of Control Bolt Operation (DMC-412-A-05-47-00-15A-283A-A / 00050)" },
                    '24_months_main_rotor_mast': { title: "Each 24 Months of Main Rotor Mast Operation (DMC-412-A-05-47-00-16A-283A-A / 00051)" },
                    '2500_hours_main_rotor_hub': { title: "Each 2500 Hours of Main Rotor Hub Assembly Operation (DMC-412-A-05-47-00-17A-283A-A / 00052)", hours: 2500 },
                    '2500_hours_main_rotor_blade': { title: "Each 2500 Hours of Main Rotor Blade Operation (DMC-412-A-05-47-00-18A-283A-A / 00053)", hours: 2500 },
                    '2500_or_3000_hours_main_rotor_mast': { title: "Each 2500 or 3000 Hours or 5 Years of Main Rotor Mast (412-040-366-109 and Subsequent) Operation (DMC-412-A-05-47-00-19A-283A-A / 00054)", hours: 3000 },
                    '2500_hours_tail_rotor_drive_system': { title: "Each 2500 Hours of Tail Rotor Drive System Operation (DMC-412-A-05-47-00-20A-283A-A / 00055)", hours: 2500 },
                    '3000_hours_main_rotor_mast': { title: "Each 3000 Hours or 5 Years of Main Rotor Mast (412-040-366-103 and -105) Operation (DMC-412-A-05-47-00-21A-283A-A / 00056)", hours: 3000 },
                    '3000_hours_transmission_2': { title: "Each 3000 Hours of Transmission (412-040-002) Operation (DMC-412-A-05-47-00-22A-283A-A / 00057)", hours: 3000 },
                    '3000_hours_transmission_4': { title: "Each 3000 Hours of Transmission (412-040-004/412-040-007/412-040-802) Operation (DMC-412-A-05-47-00-23A-283A-A / 00058)", hours: 3000 },
                    '3600_hours_airframe': { title: "3600 Hours Total Airframe Time and Each 300 Hours/12 Months Inspection (DMC-412-A-05-47-00-24A-283A-A / 00059)", hours: 3600 },
                    '3000_hours_transmission_mount': { title: "Each 3000 Hours or 5 Years Of Transmission Mount Assembly (204-031-927) And Friction Damper Assembly (204-031-920) Operation (DMC-412-A-05-47-00-28A-283A-A / 00060)", hours: 3000 },
                    '2500_hours_collective_stick_tube': { title: "Each 2500 Hours or 10 Years Inspection Of Collective Stick Tube (DMC-412-A-05-47-00-29A-283A-A / 00061)", hours: 2500 },
                }
            },
            remi: {
                label: "Remoción / Instalación",
                items: {
                    main: { title: "Remoción / Instalación de Componente" }
                }
            },
            motores: {
                label: "Motores",
                items: {
                    '25_hrs': { title: "Inspección de 25 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 25 },
                    '50_hrs': { title: "Inspección de 50 hrs / 6 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 50 },
                    '100_hrs': { title: "Inspección de 100 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 100 },
                    '150_hrs': { title: "Inspección de 150 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 150 },
                    '150_hrs_6_meses': { title: "Inspección de 150 hrs / 6 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 150 },
                    '150_hrs_12_meses': { title: "Inspección de 150 hrs / 12 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 150 },
                    '300_hrs': { title: "Inspección de 300 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 300 },
                    '600_hrs': { title: "Inspección de 600 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 600 },
                    '900_hrs': { title: "Inspección de 900 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)", hours: 900 }
                }
            }
        };
        
        const removalDescription = "Se removió [Parte] P/N [Número de parte] S/N [Número de serie], Reparable, por horas para Overhaul cumplidas.";
        const installationDescription = "Se instaló [Parte] P/N [Número de parte] S/N [Número de serie], Reparable, por horas para Overhaul cumplidas.";
        
        // Initial values for editable fields
        const initialValues = {
            fecha_inicio: '',
            modelo: '',
            numero_de_serie: '',
            matricula: '',
            ac_tt: '',
            tq: '',
            landings: '',
            fecha_finalizacion: '',
            eng1_tsn_tso: '',
            eng1_csn_cso: '',
            eng2_tsn_tso: '',
            eng2_csn_cso: '',
            cbox_tsn_tso: '',
            cbox_csn_cso: '',
            certificacion: 'Yo certifico que los trabajos arriba descritos fueron efectuados de acuerdo a los procedimientos del Manual de Mantenimiento y por lo tanto la aeronave es puesta en servicio.',
            serie: '',
            jefe_taller: '',
            lic_no: ''
        };

        // --- Authentication & Initialization Logic ---
        async function initAuthAndApp() {
            try {
                statusMessage.textContent = 'Iniciando autenticación...';
                await signInAnonymously(auth);
                statusMessage.textContent = 'Autenticación colaborativa exitosa. Todos los usuarios pueden ver y editar los registros.';
                statusMessage.style.color = 'green';
                printAndSaveButton.disabled = false;
                showRecordsButton.disabled = false;
                scanImageBtn.disabled = false;
            } catch (error) {
                console.error("Error de autenticación: ", error);
                statusMessage.textContent = 'Error de autenticación. No se pueden guardar ni cargar datos.';
                statusMessage.style.color = 'red';
                printAndSaveButton.disabled = true;
                showRecordsButton.disabled = true;
                scanImageBtn.disabled = true;
            }
        }

        // --- Form generation functions ---
        function populateTaskSelector() {
            taskTypeSelect.innerHTML = '<option value="none">Seleccionar y Añadir Trabajo</option>';
            for (const groupKey in inspections) {
                const group = inspections[groupKey];
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.label;
                for (const itemKey in group.items) {
                    const item = group.items[itemKey];
                    const option = document.createElement('option');
                    option.value = `${groupKey}.${itemKey}`;
                    option.textContent = item.title;
                    optgroup.appendChild(option);
                }
                taskTypeSelect.appendChild(optgroup);
            }
        }

        function createItemElement(text, itemKey) {
            const itemRow = document.createElement('div');
            itemRow.classList.add('flex', 'items-center', 'text-xs', 'space-x-1', 'group');
            itemRow.dataset.itemKey = itemKey;
            itemRow.innerHTML = `
                <span class="font-bold flex-none w-4 item-number"></span>
                <p class="editable-cell flex-grow font-bold text-gray-800" contenteditable="true">${text}</p>
                <button class="remove-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 transition-colors duration-200 opacity-0 group-hover:opacity-100 no-print text-xl leading-none">&minus;</button>
            `;
            const removeBtn = itemRow.querySelector('.remove-item-btn');
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const groupBlock = itemRow.closest('[id^="trabajo-group-"]');
                itemRow.remove();
                if (groupBlock && groupBlock.querySelectorAll('.list-content > div').length === 0) {
                   // Optional: remove group block if it becomes empty
                   // groupBlock.remove(); 
                }
                updateItemNumbers();
            });
            return itemRow;
        }
        
        function addItemToGroupBlock(groupKey, itemKey) {
            const groupData = inspections[groupKey];
            const itemData = groupData.items[itemKey];
            if (!itemData) return;

            let groupBlock = document.getElementById(`trabajo-group-${groupKey}`);

            // Create group block if it doesn't exist
            if (!groupBlock) {
                groupBlock = document.createElement('div');
                groupBlock.id = `trabajo-group-${groupKey}`;
                groupBlock.dataset.groupKey = groupKey;
                groupBlock.classList.add('mt-4');

                const header = document.createElement('div');
                header.classList.add('flex', 'justify-between', 'items-center', 'font-bold', 'text-sm', 'text-white', 'bg-custom-blue', 'p-1', 'rounded-t-md');
                header.innerHTML = `
                    <p>${groupData.label}</p>
                    <button class="remove-block-btn text-white hover:text-red-300 font-bold px-2 no-print text-xl">&times;</button>
                `;
                header.querySelector('.remove-block-btn').onclick = () => {
                    groupBlock.remove();
                    updateItemNumbers();
                };
                groupBlock.appendChild(header);

                const contentContainer = document.createElement('div');
                contentContainer.classList.add('border-2', 'border-t-0', 'border-black', 'rounded-b-md', 'p-2', 'bg-white', 'space-y-2');
                const listContent = document.createElement('div');
                listContent.classList.add('list-content', 'space-y-1');
                contentContainer.appendChild(listContent);
                groupBlock.appendChild(contentContainer);
                trabajosContainer.appendChild(groupBlock);
            }

            const listContent = groupBlock.querySelector('.list-content');

            // Prevent adding duplicate items
            if (listContent.querySelector(`[data-item-key="${itemKey}"]`)) {
                return; // Silently exit if item already exists
            }
            
            // Special handling for remi/installation
            if (groupKey === 'remi') {
                 listContent.appendChild(createItemElement(removalDescription, 'remi_remocion'));
                 listContent.appendChild(createItemElement(installationDescription, 'remi_instalacion'));
            } else {
                 listContent.appendChild(createItemElement(itemData.title, itemKey));
            }
           
            updateItemNumbers();
        }

        function updateItemNumbers() {
            const allItems = document.querySelectorAll('#trabajos-container .item-number');
            allItems.forEach((item, index) => {
                item.textContent = `${index + 1}.`;
            });
        }
        
        taskTypeSelect.addEventListener('change', () => {
            const selectedValue = taskTypeSelect.value;
            if (selectedValue === 'none') return;

            const [groupKey, itemKey] = selectedValue.split('.');
            const selectedItemData = inspections[groupKey]?.items[itemKey];

            // If the selected item has an 'hours' property, add all inspections with fewer or equal hours from the same group
            if (selectedItemData && typeof selectedItemData.hours === 'number') {
                const parentGroup = inspections[groupKey].items;
                for (const currentItemKey in parentGroup) {
                    const currentItemData = parentGroup[currentItemKey];
                    if (typeof currentItemData.hours === 'number' && currentItemData.hours <= selectedItemData.hours) {
                        addItemToGroupBlock(groupKey, currentItemKey);
                    }
                }
            } else {
                // Otherwise, just add the single selected item
                addItemToGroupBlock(groupKey, itemKey);
            }

            taskTypeSelect.value = 'none'; // Reset dropdown after selection
        });


        // --- Signature Pad functionality ---
        let drawing = false;

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function startPosition(e) { drawing = true; draw(e); }
        function endPosition() { drawing = false; ctx.beginPath(); }
        function draw(e) {
            if (!drawing) return;
            let x, y;
            const rect = canvas.getBoundingClientRect();
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPosition(e); });
        canvas.addEventListener('touchend', endPosition);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });

        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        function loadSignature(base64Data) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = base64Data;
        }

        // --- Firestore save and update functionality ---
        async function saveToFirestore(userName) {
            const documentsPath = `/artifacts/${appId}/public/data/mantenimiento_data`;
            
            const trabajos_realizados = [];
            const groupBlocks = trabajosContainer.querySelectorAll(':scope > div[id^="trabajo-group-"]');
            
            groupBlocks.forEach(block => {
                const groupKey = block.dataset.groupKey;
                const groupLabel = inspections[groupKey].label;
                const items = [];
                
                block.querySelectorAll('.list-content > div').forEach(itemDiv => {
                    items.push({
                        key: itemDiv.dataset.itemKey,
                        text: itemDiv.querySelector('p').textContent
                    });
                });
                
                if (items.length > 0) {
                    trabajos_realizados.push({
                        groupKey: groupKey,
                        groupLabel: groupLabel,
                        items: items
                    });
                }
            });

            const signatureData = canvas.toDataURL();

            const dataToSave = {
                fecha_inicio: document.getElementById('fecha_inicio').textContent,
                modelo: document.getElementById('modelo').textContent,
                numero_de_serie: document.getElementById('numero_de_serie').textContent,
                matricula: document.getElementById('matricula').textContent,
                ac_tt: document.getElementById('ac_tt').textContent,
                tq: document.getElementById('tq').textContent,
                landings: document.getElementById('landings').textContent,
                fecha_finalizacion: document.getElementById('fecha_finalizacion').textContent,
                eng1_tsn_tso: document.getElementById('eng1_tsn_tso').textContent,
                eng1_csn_cso: document.getElementById('eng1_csn_cso').textContent,
                eng2_tsn_tso: document.getElementById('eng2_tsn_tso').textContent,
                eng2_csn_cso: document.getElementById('eng2_csn_cso').textContent,
                cbox_tsn_tso: document.getElementById('cbox_tsn_tso').textContent,
                cbox_csn_cso: document.getElementById('cbox_csn_cso').textContent,
                trabajos_realizados: trabajos_realizados,
                certificacion: document.getElementById('certificacion').textContent,
                serie: document.getElementById('serie').textContent,
                jefe_taller: document.getElementById('jefe_taller').textContent,
                licencia_no: document.getElementById('lic_no').textContent,
                firma: signatureData,
                guardado_por: userName,
                timestamp: new Date()
            };

            try {
                statusMessage.textContent = 'Guardando datos...';
                if (currentDocId) {
                    await updateDoc(doc(db, documentsPath, currentDocId), dataToSave);
                    statusMessage.textContent = '¡Datos actualizados con éxito!';
                    console.log("Documento actualizado con ID: ", currentDocId);
                } else {
                    const docRef = await addDoc(collection(db, documentsPath), dataToSave);
                    statusMessage.textContent = '¡Datos guardados con éxito!';
                    console.log("Documento añadido con ID: ", docRef.id);
                }
                statusMessage.style.color = 'green';
                return true;
            } catch (e) {
                statusMessage.textContent = 'Error al guardar los datos.';
                statusMessage.style.color = 'red';
                console.error("Error al añadir/actualizar documento: ", e);
                return false;
            }
        }

        // --- AI Scan Functionality ---
        scanImageBtn.addEventListener('click', async () => {
            const file = imageUpload.files[0];
            if (!file) {
                statusMessage.textContent = 'Por favor, selecciona una imagen primero.';
                statusMessage.style.color = 'red';
                return;
            }

            statusMessage.textContent = 'Escaneando imagen... por favor espera.';
            scanImageBtn.disabled = true;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const fileDataUrl = e.target.result;
                mainImage.src = fileDataUrl; // Update the main image viewer

                const base64Data = fileDataUrl.split(',')[1];
                const apiKey = "AIzaSyAFpL-UJVno1ddDeNpDg843w4wfJZOLdhM"; // La API Key se provee en runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const prompt = "Extrae los datos de la etiqueta de mantenimiento en la imagen. No incluyas los títulos de las celdas, solo los valores. Si un campo está vacío, déjalo como una cadena vacía. Devuelve los datos como un objeto JSON con las siguientes claves: 'fecha_inicio', 'fecha_finalizacion', 'modelo', 'eng1_tsn_tso', 'numero_de_serie', 'eng1_csn_cso', 'matricula', 'eng2_tsn_tso', 'ac_tt', 'eng2_csn_cso', 'tq', 'cbox_tsn_tso', 'landings', 'cbox_csn_cso', 'firma', 'serie', 'licencia', 'motor1_tsn_tso', 'motor2_tsn_tso', 'motor1_csn_cso', 'motor2_csn_cso'. Para el campo 'firma', describe si la firma es visible o no.";
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "fecha_inicio": { "type": "STRING" },
                                "fecha_finalizacion": { "type": "STRING" },
                                "modelo": { "type": "STRING" },
                                "eng1_tsn_tso": { "type": "STRING" },
                                "numero_de_serie": { "type": "STRING" },
                                "eng1_csn_cso": { "type": "STRING" },
                                "matricula": { "type": "STRING" },
                                "eng2_tsn_tso": { "type": "STRING" },
                                "eng2_csn_cso": { "type": "STRING" },
                                "ac_tt": { "type": "STRING" },
                                "tq": { "type": "STRING" },
                                "cbox_tsn_tso": { "type": "STRING" },
                                "landings": { "type": "STRING" },
                                "cbox_csn_cso": { "type": "STRING" },
                                "motor1_tsn_tso": { "type": "STRING" },
                                "motor2_tsn_tso": { "type": "STRING" },
                                "motor1_csn_cso": { "type": "STRING" },
                                "motor2_csn_cso": { "type": "STRING" },
                                "firma": { "type": "STRING" },
                                "serie": { "type": "STRING" },
                                "licencia": { "type": "STRING" }
                            }
                        }
                    }
                };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const data = JSON.parse(jsonString);

                    // Fill form fields with data from the AI
                    document.getElementById('fecha_inicio').textContent = data.fecha_inicio || '';
                    document.getElementById('fecha_finalizacion').textContent = data.fecha_finalizacion || '';
                    document.getElementById('modelo').textContent = data.modelo || '';
                    document.getElementById('eng1_tsn_tso').textContent = data.eng1_tsn_tso || '';
                    document.getElementById('numero_de_serie').textContent = data.numero_de_serie || '';
                    document.getElementById('eng1_csn_cso').textContent = data.eng1_csn_cso || '';
                    document.getElementById('matricula').textContent = data.matricula || '';
                    document.getElementById('eng2_tsn_tso').textContent = data.eng2_tsn_tso || '';
                    document.getElementById('ac_tt').textContent = data.ac_tt || '';
                    document.getElementById('eng2_csn_cso').textContent = data.eng2_csn_cso || '';
                    document.getElementById('tq').textContent = data.tq || '';
                    document.getElementById('cbox_tsn_tso').textContent = data.cbox_tsn_tso || '';
                    document.getElementById('landings').textContent = data.landings || '';
                    document.getElementById('cbox_csn_cso').textContent = data.cbox_csn_cso || '';
                    document.getElementById('serie').textContent = data.serie || '';
                    document.getElementById('lic_no').textContent = data.licencia || '';
                    
                    statusMessage.textContent = 'Datos escaneados y rellenados con éxito.';
                    statusMessage.style.color = 'green';
                } catch (error) {
                    statusMessage.textContent = 'Error al escanear la imagen. Por favor, inténtalo de nuevo.';
                    statusMessage.style.color = 'red';
                    console.error("Error al llamar a la API de Gemini: ", error);
                } finally {
                    scanImageBtn.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        });

        // --- Event listeners and logic flow ---
        printAndSaveButton.addEventListener('click', () => {
            nameModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            nameModal.classList.add('hidden');
        });

        saveAndPrintBtn.addEventListener('click', async () => {
            const userName = userNameInput.value.trim();
            if (userName) {
                nameModal.classList.add('hidden');
                statusMessage.textContent = 'Guardando datos...';
                statusMessage.style.color = 'black';
                const saved = await saveToFirestore(userName);
                if (saved) {
                    statusMessage.textContent = '¡Datos guardados con éxito! Ahora puedes imprimir usando Ctrl + P (o Cmd + P en Mac).';
                    statusMessage.style.color = 'blue';
                }
            } else {
                userNameInput.placeholder = '¡Por favor, ingresa tu nombre!';
            }
        });

        showRecordsButton.addEventListener('click', async () => {
            recordsContainer.innerHTML = '';
            statusMessage.textContent = 'Cargando registros...';
            statusMessage.style.color = 'black';
            
            try {
                const documentsPath = `/artifacts/${appId}/public/data/mantenimiento_data`;
                const q = query(collection(db, documentsPath));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recordsContainer.innerHTML = `<p class="text-center text-gray-500">No hay registros guardados.</p>`;
                    statusMessage.textContent = 'Registros cargados.';
                    statusMessage.style.color = 'green';
                    return;
                }

                recordsContainer.innerHTML = `<h3 class="font-bold text-lg text-gray-700 mb-2">Registros Guardados</h3>`;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const recordDiv = document.createElement('div');
                    recordDiv.classList.add('record-item', 'p-4', 'border', 'border-gray-300', 'bg-white', 'rounded-md', 'mb-2', 'cursor-pointer', 'hover:bg-gray-50');
                    recordDiv.innerHTML = `
                        <p class="font-bold">ID: ${doc.id}</p>
                        <p class="text-sm">Matrícula: ${data.matricula || 'N/A'}</p>
                        <p class="text-sm">Guardado por: ${data.guardado_por || 'Anónimo'}</p>
                        <p class="text-xs text-gray-500">Fecha: ${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A'}</p>
                    `;
                    recordDiv.addEventListener('click', () => {
                        loadRecord(data, doc.id);
                    });
                    recordsContainer.appendChild(recordDiv);
                });
                statusMessage.textContent = 'Registros cargados con éxito.';
                statusMessage.style.color = 'green';

            } catch (error) {
                statusMessage.textContent = 'Error al cargar los registros.';
                statusMessage.style.color = 'red';
                console.error("Error al cargar documentos: ", error);
            }
        });

        function loadRecord(data, docId) {
            currentDocId = docId;
            statusMessage.textContent = `Registro ID: ${docId} cargado. Puedes editar y guardar.`;
            statusMessage.style.color = 'blue';

            // Fill editable cells
            document.getElementById('fecha_inicio').textContent = data.fecha_inicio || '';
            document.getElementById('fecha_finalizacion').textContent = data.fecha_finalizacion || '';
            document.getElementById('modelo').textContent = data.modelo || '';
            document.getElementById('eng1_tsn_tso').textContent = data.eng1_tsn_tso || '';
            document.getElementById('numero_de_serie').textContent = data.numero_de_serie || '';
            document.getElementById('eng1_csn_cso').textContent = data.eng1_csn_cso || '';
            document.getElementById('matricula').textContent = data.matricula || '';
            document.getElementById('eng2_tsn_tso').textContent = data.eng2_tsn_tso || '';
            document.getElementById('ac_tt').textContent = data.ac_tt || '';
            document.getElementById('eng2_csn_cso').textContent = data.eng2_csn_cso || '';
            document.getElementById('tq').textContent = data.tq || '';
            document.getElementById('cbox_tsn_tso').textContent = data.cbox_tsn_tso || '';
            document.getElementById('landings').textContent = data.landings || '';
            document.getElementById('cbox_csn_cso').textContent = data.cbox_csn_cso || '';
            document.getElementById('certificacion').textContent = data.certificacion || '';
            document.getElementById('serie').textContent = data.serie || '';
            document.getElementById('jefe_taller').textContent = data.jefe_taller || '';
            document.getElementById('lic_no').textContent = data.licencia_no || '';

            // Load signature
            if (data.firma) {
                loadSignature(data.firma);
            } else {
                clearBtn.click();
            }

            // Load trabajos
            trabajosContainer.innerHTML = '';
            if (data.trabajos_realizados && Array.isArray(data.trabajos_realizados)) {
                data.trabajos_realizados.forEach(groupData => {
                    const groupKey = groupData.groupKey;
                    
                    let groupBlock = document.createElement('div');
                    groupBlock.id = `trabajo-group-${groupKey}`;
                    groupBlock.dataset.groupKey = groupKey;
                    groupBlock.classList.add('mt-4');

                    const header = document.createElement('div');
                    header.classList.add('flex', 'justify-between', 'items-center', 'font-bold', 'text-sm', 'text-white', 'bg-custom-blue', 'p-1', 'rounded-t-md');
                    header.innerHTML = `
                        <p>${groupData.groupLabel}</p>
                        <button class="remove-block-btn text-white hover:text-red-300 font-bold px-2 no-print text-xl">&times;</button>
                    `;
                    header.querySelector('.remove-block-btn').onclick = () => groupBlock.remove();
                    groupBlock.appendChild(header);

                    const contentContainer = document.createElement('div');
                    contentContainer.classList.add('border-2', 'border-t-0', 'border-black', 'rounded-b-md', 'p-2', 'bg-white');
                    const listContent = document.createElement('div');
                    listContent.classList.add('list-content', 'space-y-1');
                    
                    if (groupData.items && Array.isArray(groupData.items)) {
                        groupData.items.forEach(item => {
                            listContent.appendChild(createItemElement(item.text, item.key));
                        });
                    }
                    contentContainer.appendChild(listContent);
                    groupBlock.appendChild(contentContainer);
                    trabajosContainer.appendChild(groupBlock);
                });
            }
            updateItemNumbers();
        }

        newRecordButton.addEventListener('click', () => {
            currentDocId = null;
            document.querySelectorAll('.editable-cell').forEach(cell => {
                const initialValue = initialValues[cell.id];
                cell.textContent = initialValue !== undefined ? initialValue : '';
            });
            clearBtn.click();
            trabajosContainer.innerHTML = '';
            taskTypeSelect.value = 'none';
            statusMessage.textContent = 'Nuevo registro iniciado.';
            statusMessage.style.color = 'black';
        });

        // Initial setup
        initAuthAndApp();
        populateTaskSelector();
    </script>
</body>
</html>
