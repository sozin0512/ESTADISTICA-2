<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiqueta de Mantenimiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            min-height: 100vh;
        }

        .sticker-container {
            width: 100%;
            max-width: 600px;
            background-color: #f7f7f7;
            padding: 1rem;
            border: 2px solid #ccc;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
        }

        /* Custom colors for the document */
        .bg-custom-blue {
            background-color: #002D62;
        }
        .bg-custom-yellow {
            background-color: #F8D670;
        }
        
        .editable-cell {
            outline: 1px solid transparent;
            cursor: pointer;
            transition: outline 0.2s ease-in-out;
            word-wrap: break-word;
        }

        .editable-cell:focus {
            outline: 1px solid #000;
        }
        
        /* Print styles */
        @media print {
            body {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .sticker-container {
                box-shadow: none !important;
                border: 2px solid #ccc !important;
            }
            .no-print {
                display: none !important;
            }
            .editable-cell {
                outline: none !important;
            }
            #signatureCanvas {
                border: none !important;
            }
            .bg-custom-blue, .bg-custom-yellow {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Main sticker container -->
    <div class="sticker-container">

        <!-- Header banner with logo and text -->
        <div class="bg-custom-yellow p-4 text-center rounded-t-lg border-2 border-black border-b-0">
            <div class="flex justify-center items-center">
                <img src="IIIIIIIII.png" alt="Logo de ESCN. Helicópteros" class="w-24 h-24 rounded-full border-2 border-black p-2 bg-gray-100 object-contain">
            </div>
            <p class="text-sm font-bold text-gray-800 mt-1">ESCN. HELICÓPTEROS</p>
            <p class="text-xs text-gray-800">FUERZA AÉREA HONDUREÑA</p>
        </div>
        <div class="bg-white text-center font-bold text-gray-800 text-lg py-1 border-2 border-black border-t-0">FAH</div>

        <!-- Data table with 4 columns -->
        <div class="grid grid-cols-4 gap-0 text-xs border-2 border-black border-t-0 rounded-b-lg overflow-hidden">
            <!-- Row 1: FECHA INICIO & FECHA FINALIZACIÓN -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">FECHA INICIO</div>
            <div id="fecha_inicio" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">FECHA FINALIZACIÓN</div>
            <div id="fecha_finalizacion" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>

            <!-- Row 2: MODELO & ENG 1 S/N TSN / TSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">MODELO</div>
            <div id="modelo" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 1 S/N TSN / TSO</div>
            <div id="eng1_tsn_tso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 3: NÚMERO DE SERIE & ENG 1 S/N CSN / CSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">NÚMERO DE SERIE</div>
            <div id="numero_de_serie" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 1 S/N CSN / CSO</div>
            <div id="eng1_csn_cso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 4: MATRÍCULA & ENG 2 S/N TSN / TSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">MATRÍCULA</div>
            <div id="matricula" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 2 S/N TSN / TSO</div>
            <div id="eng2_tsn_tso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 5: A/C TT & ENG 2 S/N CSN / CSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">A/C TT</div>
            <div id="ac_tt" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">ENG 2 S/N CSN / CSO</div>
            <div id="eng2_csn_cso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
            
            <!-- Row 6: TQ EVENTS & C-BOX S/N TSN / TSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">TQ EVENTS</div>
            <div id="tq" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">C-BOX S/N TSN / TSO</div>
            <div id="cbox_tsn_tso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>

            <!-- Row 7: LANDINGS & C-BOX S/N CSN / CSO -->
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">LANDINGS</div>
            <div id="landings" class="p-1 text-black bg-custom-yellow border-r-2 border-white border-b-2 editable-cell font-bold" contenteditable="true"></div>
            <div class="p-1 font-bold text-white bg-custom-blue border-r-2 border-white border-b-2">C-BOX S/N CSN / CSO</div>
            <div id="cbox_csn_cso" class="p-1 text-black bg-custom-yellow border-b-2 border-white editable-cell font-bold" contenteditable="true"></div>
        </div>
        
        <!-- Text and signature sections -->
        <div class="mt-4 border-2 border-black rounded-lg p-2 bg-white">
            <div class="flex items-center space-x-2">
                <h3 class="font-bold text-sm editable-cell" contenteditable="true">Se Completaron los siguientes trabajos:</h3>
                <!-- Button hidden on print -->
                <div class="no-print">
                    <select id="task-type-select" class="px-2 py-1 border border-black rounded-md bg-gray-50 text-xs">
                        <option value="none">Seleccionar Tipo de Trabajo</option>
                        <option value="inspection_1">Inspección #1</option>
                        <option value="inspection_2">Inspección #2</option>
                        <option value="inspection_3">Inspección #3</option>
                        <option value="inspection_4">Inspección #4</option>
                        <option value="inspection_5">Inspección #5</option>
                        <option value="inspection_6">Inspección #6</option>
                        <option value="remi">Remoción / Instalación</option>
                        <option value="motores">Motores</option>
                    </select>
                </div>
            </div>

            <div id="trabajos-container" class="space-y-2 mt-2">
                <!-- Content will be dynamically generated here -->
            </div>
            
            <p id="certificacion" class="italic text-gray-700 text-xs mb-4 mt-4 editable-cell font-bold" contenteditable="true">
                Yo certifico que los trabajos arriba descritos fueron efectuados de acuerdo a los procedimientos del Manual de Mantenimiento y por lo tanto la aeronave es puesta en servicio.
            </p>
            
            <!-- Signature container -->
            <div class="flex flex-col items-center">
                <!-- Signature -->
                <canvas id="signatureCanvas" class="border border-black w-full h-20 rounded-md bg-white"></canvas>
                <button id="clearSignatureBtn" class="no-print mt-2 px-2 py-1 bg-red-500 text-white text-xs rounded-md hover:bg-red-600 transition-colors duration-200">Limpiar Firma</button>

                <!-- Data below the signature -->
                <div class="flex justify-between items-center w-full mt-4 text-xs">
                    <div class="flex items-center space-x-2">
                        <p class="font-bold">Serie</p>
                        <p id="firma" class="editable-cell text-sm font-bold" contenteditable="true"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="font-bold">Jefe de Taller</p>
                        <p id="jefe_taller" class="editable-cell text-sm font-bold" contenteditable="true"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="font-bold">Lic. No.</p>
                        <p id="lic_no" class="editable-cell text-sm font-bold" contenteditable="true"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons and records container, outside the sticker -->
    <div class="no-print w-full max-w-lg mt-4 flex flex-col items-center space-y-4">
        <!-- New file upload and scan buttons -->
        <div class="flex flex-col items-center space-y-2 w-full p-4 border rounded-md border-gray-300 bg-gray-200">
            <h3 class="font-bold text-lg text-gray-700">Escanear Documento (IA)</h3>
            <p class="text-xs text-gray-500">Sube una imagen del documento para rellenar los datos automáticamente.</p>
            <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm">
            <button id="scanImageBtn" class="w-full px-6 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 transition-colors duration-200">
                Escanear Imagen
            </button>
        </div>
        
        <div class="flex space-x-4">
            <button id="printAndSaveButton" class="px-6 py-2 bg-green-500 text-white font-bold rounded-md transition-colors duration-200">
                Imprimir y Guardar
            </button>
            <button id="showRecordsButton" class="px-6 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 transition-colors duration-200">
                Mostrar Registros Guardados
            </button>
        </div>
        <button id="newRecordButton" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-md hover:bg-gray-600 transition-colors duration-200">
            Nuevo Registro
        </button>

        <!-- Status and loading bar -->
        <div id="statusContainer" class="mt-4 w-full">
            <div id="statusMessage" class="mt-4 text-center text-sm font-semibold"></div>
        </div>
        <div id="recordsContainer" class="mt-4 w-full">
            <!-- Saved records will be displayed here -->
        </div>
    </div>

    <!-- Modal to ask for the user's name -->
    <div id="nameModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Ingresa tu Nombre</h2>
            <p class="mb-4 text-sm">Este nombre se guardará como la persona que realiza el registro.</p>
            <input type="text" id="userNameInput" placeholder="Nombre completo" class="w-full p-2 border border-gray-300 rounded-md">
            <div class="flex justify-end mt-4 space-x-2">
                <button id="closeModalBtn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-md hover:bg-gray-500 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="saveAndPrintBtn" class="px-4 py-2 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition-colors duration-200">
                    Guardar y Usar Ctrl + P
                </button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set logging level for debugging
        setLogLevel('debug');

        // =========================================================================
        // === Pega tu configuración de Firebase aquí para que funcione fuera de Canvas ===
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAnDAVVRTnl_SHejO7lyqrkGbPcFNyIBHc",
            authDomain: "reportesti-41047.firebaseapp.com",
            projectId: "reportesti-41047",
            storageBucket: "reportesti-41047.firebasestorage.app",
            messagingSenderId: "997680984231",
            appId: "1:997680984231:web:d9c27e1ac8eaf9473feb82"
        };
        // =========================================================================

        const appId = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // State management
        let currentDocId = null;

        // UI Elements
        const taskTypeSelect = document.getElementById('task-type-select');
        const trabajosContainer = document.getElementById('trabajos-container');
        const printAndSaveButton = document.getElementById('printAndSaveButton');
        const showRecordsButton = document.getElementById('showRecordsButton');
        const newRecordButton = document.getElementById('newRecordButton');
        const recordsContainer = document.getElementById('recordsContainer');
        const statusMessage = document.getElementById('statusMessage');
        const nameModal = document.getElementById('nameModal');
        const userNameInput = document.getElementById('userNameInput');
        const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.getElementById('clearSignatureBtn');
        const imageUpload = document.getElementById('imageUpload');
        const scanImageBtn = document.getElementById('scanImageBtn');

        // Static data for form generation
        const inspections = {
            inspection_1: {
                title: "Se completó la inspección #1, de 100 horas y 12 meses. (MM 5-00-00 / Tabla 5-1)",
                sections: [
                    {
                        title: "Programa de Limitaciones de Aeronavegabilidad",
                        items: [
                            "Inspección de 25 hrs (MM 4-00-00 / Tabla 4-1)"
                        ]
                    },
                    {
                        title: "Inspecciones Programadas-Parte “A”",
                        items: [
                            "Inspección diaria-parte “A” (MM 5-00-00 / Para 5-5)",
                            "Inspección # 1 de 100 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)"
                        ]
                    },
                    {
                        title: "Inspecciones Especiales",
                        items: [
                            "Inspección de 25 hrs (MM 5-00-00 / Para 5-17, 5-18.)",
                            "Inspección de 100 hrs de operación de la collective lever (MM 5-00-00 / Para 5-21)"
                        ]
                    },
                    {
                        title: "Lubricación",
                        items: [
                            "Lubricación de 25 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de 50 hrs (MM 12-00-00 / Tabla 12-3)"
                        ]
                    },
                    {
                        title: "Inspecciones Adicionales",
                        items: [
                            "Ciclaje de la batería de nickel y cadmium – 100 hrs (MM 96-00-00 / Para 96-25, 96-26)"
                        ]
                    },
                    {
                        title: "Boletines de Servicio (ASB's) Recurrentes",
                        items: [
                            "ASB 412-96-89 (to prevent fatigue failure of the T/R yoke assembly P/N 212-011-702-ALL)",
                            "ASB 412-00-100 (inspection of cap angle P/N 212-030-191-001)",
                            "ASB 412-00-102 Rev. “A”. (T/R counterweight bell crank retention nut)",
                            "ASB 412-11-148 Rev. “A”. (inspection of collective lever P/N 412-010-408-101)",
                            "ASB 412-13-155 (inspection of tail rotor blade P/N 212-010-750-ALL)"
                        ]
                    },
                    {
                        title: "Trabajos Adicionales",
                        items: [
                            "Se instaló sello del mástil, nuevo P/N 412-340-012-101",
                            "Se completó pintura general de la aeronave (gris claro parte superior y gris oscuro parte inferior del fuselaje)"
                        ]
                    }
                ]
            },
            inspection_2: {
                title: "Se completó la inspección #2 de 200 horas. (MM 5-00-00 / Tabla 5-1)",
                sections: [
                    {
                        title: "Inspecciones Programadas-Parte “A”",
                        items: [
                            "Inspección de 25 hrs (MM 4-00-00 / Tabla 4-1)",
                            "Inspección diaria-parte “A” (MM 5-00-00 / Para 5-5)",
                            "Inspección # 2 de 200 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)",
                            "Inspección de 12 meses - first aid kit",
                            "Chequeo de 12 meses del peso - fire extinguisher cabin",
                            "Chequeo de 12 meses del peso - fire extinguisher cockpit"
                        ]
                    },
                    {
                        title: "Inspecciones Especiales",
                        items: [
                            "Inspección de 25 hrs (MM 5-00-00 / Para 5-17, 5-18.)",
                            "Inspección de 100 hrs de operación de la collective lever (MM 5-00-00 / Para 5-21)",
                            "Inspección de 300 hrs / 6 meses de operación de los pernos expandibles de las palas del rotor principal (MM 5-00-00 / para 5-22a)",
                            "Inspección de 600 hrs / 12 meses de operación de los ejes impulsores del rotor de cola (MM 5-00-00 / para 5-23)",
                            "Inspección de 600 hrs / 12 meses de operación del eje impulsor principal (MM 5-00-00 / para 5-24)",
                            "Inspección de 24 meses de operación de los pernos de los controles de vuelo (MM 5-00-00 / para 5-27)",
                            "Inspección de 24 meses de operación del mástil del rotor principal (MM 5-00-00 / Para 5-27A)"
                        ]
                    },
                    {
                        title: "Inspecciones Adicionales",
                        items: [
                            "Ciclaje de la batería de nickel y cadmium – 100 hrs (MM 96-00-00 / Para 96-25, 96-26)",
                            "Inspección de los tapones de llenado del sistema de combustible, sistema de aceite y sistema hidráulico, por propio funcionamiento y sellado– 12 meses (MM 5-00-00 / para 5-6)",
                            "Inspección del sistema de instrumentos- 12 meses (MM 5-00-00 / para 5-6):",
                            "   Calibración de los sistemas compass del piloto y copiloto y compass magnético standby.",
                            "   Drenado del sistema pitot-static por cualquier humedad acumulada.",
                            "   Prueba del sistema pitot-static por fugas."
                        ]
                    },
                    {
                        title: "Lubricación",
                        items: [
                            "Lubricación de 25 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de 50 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de las balineras colgantes del rotor de cola – 300 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Cambio de aceite de la caja de 42º- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                            "Cambio de aceite de la caja de 90º- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                            "Cambio de aceite y filtro externo de la transmisión- 3000 hrs / 12 meses (MM 12-00-00 / Tabla 12-1)"
                        ]
                    },
                    {
                        title: "Inspecciones de Autoridad Reguladora",
                        items: [
                            "Inspección de 12 meses compass swing-412",
                            "Chequeo por fuga Sistema estático pitot-24 (FAR 91.413).",
                            "Recertificación del transponder - 24 meses (FAR 91.411).",
                            "Inspección de 24 meses altimetro del copiloto (FAR91.411 / car 571 app “b”)."
                        ]
                    },
                    {
                        title: "Boletines de Servicio (ASB's) Recurrentes",
                        items: [
                            "ASB 412-96-89 (to prevent fatigue failure of the T/R yoke assembly P/N 212-011-702-ALL)",
                            "ASB 412-00-100 (inspection of cap angle P/N 212-030-191-001)",
                            "ASB 412-00-102 Rev. “A”. (T/R counterweight bell crank retention nut)",
                            "ASB 412-09-137 (main rotor blade expandable bolt inspection P/N 412-010-137-103)",
                            "ASB 412-11-148 Rev. “A”. (inspection of collective lever P/N 412-010-408-101)",
                            "ASB 412-13-155 (inspection of tail rotor blade P/N 212-010-750-ALL)"
                        ]
                    },
                    {
                        title: "Programa de Retiro & Overhaul de Componentes",
                        items: [
                            "Se instaló Nuevo M/R Control System Bolts Kit P/N 412-704-112-105, 1EA.",
                            "Se instaló Nuevo M/R Supplemental Control System Bolts Kit P/N 20-057-5-24D, 3EA."
                        ]
                    },
                    {
                        title: "Trabajos Adicionales",
                        items: [
                            "Se instaló Nuevo Sello del Mástil, P/N 412-340-012-101, 1EA.",
                            "Se instaló Nuevos Bushings de la Collective Lever, P/N 412-010-421-103, 2EA.",
                            "Se instaló Nuevo Bellcrank del Sistema Antitorque, P/N 212-001-759-101, 1EA.",
                            "Se instaló Nuevo Panel Assy P/N 205-032-811-077, 1EA."
                        ]
                    }
                ]
            },
            inspection_3: {
                title: "Inspección #3 (300 HORAS)",
                sections: [
                    {
                        title: "Programa de Limitaciones de Aeronavegabilidad",
                        items: [
                            "Inspección de 25 hrs (MM 4-00-00 / Tabla 4-1)."
                        ]
                    },
                    {
                        title: "Inspecciones Programadas-Parte “A”",
                        items: [
                            "Inspección diaria-parte “A” (MM 5-00-00 / Para 5-5).",
                            "Inspección # 2 de 200 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6).",
                            "Inspección de 12 meses - first aid kit.",
                            "Chequeo de 12 meses del peso - fire extinguisher cabin.",
                            "Chequeo de 12 meses del peso - fire extinguisher cockpit."
                        ]
                    },
                    {
                        title: "Inspecciones Especiales",
                        items: [
                            "Inspección de 25 hrs (MM 5-00-00 / Para 5-17, 5-18.).",
                            "Inspección de 100 hrs de operación de la collective lever (MM 5-00-00 / Para 5-21).",
                            "Inspección de 300 hrs / 6 meses de operación de los pernos expandibles de las palas del rotor principal (MM 5-00-00 / para 5-22a).",
                            "Inspección de 600 hrs / 12 meses de operación de los ejes impulsores del rotor de cola (MM 5-00-00 / para 5-23).",
                            "Inspección de 600 hrs / 12 meses de operación del eje impulsor principal (MM 5-00-00 / para 5-24).",
                            "Inspección de 24 meses de operación de los pernos de los controles de vuelo (MM 5-00-00 / para 5-27).",
                            "Inspección de 24 meses de operación del mástil del rotor principal (MM 5-00-00 / Para 5-27A)."
                        ]
                    },
                    {
                        title: "Inspecciones Adicionales",
                        items: [
                            "Ciclaje de la batería de nickel y cadmium – 100 hrs (MM 96-00-00 / Para 96-25, 96-26).",
                            "Inspección de los tapones de llenado del sistema de combustible, sistema de aceite y sistema hidráulico, por propio funcionamiento y sellado– 12 meses (MM 5-00-00 / para 5-6).",
                            "Inspección del sistema de instrumentos- 12 meses (MM 5-00-00 / para 5-6):",
                            "    Calibración de los sistemas compass del piloto y copiloto y compass magnético standby.",
                            "    Drenado del sistema pitot-static por cualquier humedad acumulada.",
                            "    Prueba del sistema pitot-static por fugas."
                        ]
                    },
                    {
                        title: "Lubricación",
                        items: [
                            "Lubricación de 25 hrs (MM 12-00-00 / Tabla 12-3).",
                            "Lubricación de 50 hrs (MM 12-00-00 / Tabla 12-3).",
                            "Lubricación de las balineras colgantes del rotor de cola – 300 hrs (MM 12-00-00 / Tabla 12-3).",
                            "Cambio de aceite de la caja de 42º- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1).",
                            "Cambio de aceite de la caja de 90º- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1).",
                            "Cambio de aceite y filtro externo de la transmisión- 3000 hrs / 12 meses (MM 12-00-00 / Tabla 12-1)."
                        ]
                    },
                    {
                        title: "Inspecciones de Autoridad Reguladora",
                        items: [
                            "Inspección de 12 meses compass swing-412.",
                            "Chequeo por fuga Sistema estático pitot-24 (FAR 91.413).",
                            "Recertificación del transponder - 24 meses (FAR 91.411).",
                            "Inspección de 24 meses altimetro del copiloto (FAR91.411 / car 571 app “b”)."
                        ]
                    },
                    {
                        title: "Boletines de Servicio (ASB's) Recurrentes",
                        items: [
                            "ASB 412-96-89 (to prevent fatigue failure of the T/R yoke assembly P/N 212-011-702-ALL).",
                            "ASB 412-00-100 (inspection of cap angle P/N 212-030-191-001).",
                            "ASB 412-00-102 Rev. “A”. (T/R counterweight bell crank retention nut).",
                            "ASB 412-09-137 (main rotor blade expandable bolt inspection P/N 412-010-137-103).",
                            "ASB 412-11-148 Rev. “A”. (inspection of collective lever P/N 412-010-408-101).",
                            "ASB 412-13-155 (inspection of tail rotor blade P/N 212-010-750-ALL)."
                        ]
                    },
                    {
                        title: "Programa de Retiro & Overhaul de Componentes",
                        items: [
                            "Se instaló Nuevo M/R Control System Bolts Kit P/N 412-704-112-105, 1EA.",
                            "Se instaló Nuevo M/R Supplemental Control System Bolts Kit P/N 20-057-5-24D, 3EA."
                        ]
                    },
                    {
                        title: "Trabajos Adicionales",
                        items: [
                            "Se instaló Nuevo Sello del Mástil, P/N 412-340-012-101, 1EA.",
                            "Se instaló Nuevos Bushings de la Collective Lever, P/N 412-010-421-103, 2EA.",
                            "Se instaló Nuevo Bellcrank del Sistema Antitorque, P/N 212-001-759-101, 1EA.",
                            "Se instaló Nuevo Panel Assy P/N 205-032-811-077, 1EA."
                        ]
                    }
                ]
            },
            inspection_4: {
                title: "Inspección #4 de 100 horas / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)",
                sections: [
                    {
                        title: "Programa de Limitaciones de Aeronavegabilidad",
                        items: [
                            "Inspección de 25 hrs (MM 4-00-00 / Tabla 4-1)"
                        ]
                    },
                    {
                        title: "Inspecciones Programadas-Parte “A”",
                        items: [
                            "Inspección diaria-parte “A” (MM 5-00-00 / Para 5-5)",
                            "Inspección # 4 de 100 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)"
                        ]
                    },
                    {
                        title: "Inspecciones Especiales",
                        items: [
                            "Inspección de 25 hrs (MM 5-00-00 / Para 5-17, 5-18.)",
                            "Inspección de 100 hrs de operación de la collective lever (MM 5-00-00 / Para 5-21)"
                        ]
                    },
                    {
                        title: "Lubricación",
                        items: [
                            "Lubricación de 25 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de 50 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Cambio de aceite de la caja de 42°- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                            "Cambio de aceite de la caja de 90°- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)"
                        ]
                    },
                    {
                        title: "Inspecciones de Autoridad Reguladora",
                        items: [
                            "Inspección de 100 hrs / anual del artex 406 emergency locator transmitter (ELT)"
                        ]
                    },
                    {
                        title: "Inspecciones Adicionales",
                        items: [
                            "Ciclaje de la batería de nickel y cadmium – 100 hrs (MM 96-00-00 / Para 96-25, 96-26)"
                        ]
                    },
                    {
                        title: "Inspección de Kits de Equipo Opcional",
                        items: [
                            "Inspección de 25 hrs // 100 hrs del air conditioning system (412AC-208M chapter 3 page 9)",
                            "Inspección diaria // 100 hrs de los crosstubes (AA-01136 Rev. “M” page 59)",
                            "Inspección diaria // 100 hrs de los skid tubes (AA-01139 Rev. “I” page 33)",
                            "Inspección de 100 hrs del wire strike protection system (ER 82737 Rev. “H”)",
                            "Inspección de 100 hrs del heli-access steps (MMS-D412-630 Rev. “C”)"
                        ]
                    },
                    {
                        title: "Boletines de Servicio (ASB's) Recurrentes",
                        items: [
                            "ASB 412-96-89 (to prevent fatigue failure of the T/R yoke assembly P/N 212-011-702-ALL)",
                            "ASB 412-00-100 (inspection of cap angle P/N 212-030-191-001)",
                            "ASB 412-00-102 Rev. “A”. (T/R counterweight bell crank retention nut)",
                            "ASB 412-11-148 Rev. “A”. (inspection of collective lever P/N 412-010-408-101)",
                            "ASB 412-13-155 (inspection of tail rotor blade P/N 212-010-750-ALL)"
                        ]
                    },
                    {
                        title: "Trabajos Adicionales",
                        items: [
                            "Se removió Actuator Linear P/N 204-060-762-103 S/N 2388 y se instaló Actuator Linear P/N 204-060-762-5 S/N REF982, proveniente de overhaul."
                        ]
                    }
                ]
            },
            inspection_5: {
                title: "Inspección #5 de 100 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)",
                sections: [
                    {
                        title: "Programa de Limitaciones de Aeronavegabilidad",
                        items: [
                            "Inspección de 25 hrs (MM 4-00-00 / Tabla 4-1)",
                        ]
                    },
                    {
                        title: "Inspecciones Programadas-Parte “A”",
                        items: [
                            "Inspección diaria-parte “A” (MM 5-00-00 / Para 5-5)",
                            "Inspección # 5 de 100 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)",
                            "Inspección de 5000 hrs / 5 años (MM 5-00-00 / Para 5-8)",
                        ]
                    },
                    {
                        title: "Inspecciones Especiales",
                        items: [
                            "Inspección de 25 hrs (MM 5-00-00 / Para 5-17, 5-18.)",
                            "Inspección de 100 hrs de operación de la collective lever (MM 5-00-00 / Para 5-21)",
                            "Inspección de 300 hrs / 6 meses de operación de los pernos expandibles de las palas del rotor principal (MM 5-00-00 / para 5-22A)",
                        ]
                    },
                    {
                        title: "Lubricación",
                        items: [
                            "Lubricación de 25 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de 50 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Cambio de aceite de la caja de 42º- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                            "Cambio de aceite de la caja de 90º- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                        ]
                    },
                    {
                        title: "Inspecciones de Autoridad Reguladora",
                        items: [
                            "Inspección de 100 hrs / anual del artex 406 emergency locator transmitter (ELT)",
                        ]
                    },
                    {
                        title: "Inspecciones Adicionales",
                        items: [
                            "Ciclaje de la batería de nickel y cadmium – 100 hrs (MM 96-00-00 / Para 96-25, 96-26)",
                            "Chequeo del peso del extintor de fuego 3BR- 6 meses",
                        ]
                    },
                    {
                        title: "Inspección de Kits de Equipo Opcional",
                        items: [
                            "Inspección de 25 hrs // 100 hrs del air conditioning system (412AC-208M chapter 3 page 9)",
                            "Inspección diaria // 100 hrs de los crosstubes (AA-01136 Rev. “M” page 59)",
                            "Inspección diaria // 100 hrs de los skid tubes (AA-01139 Rev. “I” page 33)",
                            "Inspección de 100 hrs del wire strike protection system (ER 82737 Rev. “H”)",
                            "Inspección de 100 hrs del heli-access steps (MMS-D412-630 Rev. “C”)",
                        ]
                    },
                    {
                        title: "Inspecciones Periódicas del Twin-Pac",
                        items: [
                            "Inspección de 25 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 50 hrs / 6 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 100 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 150 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 150 hrs / 6 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 150 hrs / 12 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 300 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 600 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 900 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                        ]
                    }
                ]
            },
            inspection_6: {
                title: "Inspección #6 de 600 horas. (MM 5-00-00 / Tabla 5-1)",
                sections: [
                    {
                        title: "Programa de Limitaciones de Aeronavegabilidad",
                        items: [
                            "Inspección de 25 hrs (MM 4-00-00 / Tabla 4-1)"
                        ]
                    },
                    {
                        title: "Inspecciones Programadas-Parte “A”",
                        items: [
                            "Inspección diaria-parte “A” (MM 5-00-00 / Para 5-5)",
                            "Inspección de fase # 6 de 100 hrs / 12 meses-parte “A” (MM 5-00-00 / Para 5-6)"
                        ]
                    },
                    {
                        title: "Inspecciones Especiales",
                        items: [
                            "Inspección de 25 hrs (MM 5-00-00 / Para 5-17, 5-18.)",
                            "Inspección de 100 hrs de operación de la collective lever (MM 5-00-00 / Para 5-21)",
                            "Inspección de 300 hrs / 6 meses de operación de los pernos expandibles de las palas del rotor principal (MM 5-00-00 / para 5-22a)",
                            "Inspección de 600 hrs / 12 meses de operación de los ejes impulsores del rotor de cola (MM 5-00-00 / para 5-23)",
                            "Inspección de 600 hrs / 12 meses de operación del eje impulsor principal (MM 5-00-00 / para 5-24)",
                            "Inspección de 24 meses de operación de los pernos de los controles de vuelo (MM 5-00-00 / para 5-27)",
                            "Inspección de 24 meses de operación del mástil del rotor principal (MM 5-00-00 / Para 5-27A)",
                            "Inspección de 3600 hrs total del fuselaje y cada 300 hrs / 12 meses (MM 5-00-00 / Para 5-35)"
                        ]
                    },
                    {
                        title: "Lubricación",
                        items: [
                            "Lubricación de 25 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de 50 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Lubricación de las balineras colgantes del rotor de cola – 300 hrs (MM 12-00-00 / Tabla 12-3)",
                            "Cambio de aceite de la caja de 42°- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                            "Cambio de aceite de la caja de 90°- 300 hrs / 180 días (MM 12-00-00 / Tabla 12-1)",
                            "Cambio de aceite y filtro externo de la transmisión- 3000 hrs / 12 meses (MM 12-00-00 / Tabla 12-1)"
                        ]
                    },
                    {
                        title: "Inspecciones de Autoridad Reguladora",
                        items: [
                            "Inspección de 12 meses compass swing-412",
                            "Inspección de 100 hrs / anual del artex 406 emergency locator transmitter (ELT)",
                            "Chequeo por fuga Sistema estático pitot-24 (FAR 91.413).",
                            "Recertificación del transponder - 24 meses (FAR 91.411).",
                            "Inspección de 24 meses altimetro del copiloto (FAR91.411 / car 571 app “b”).",
                            "Inspección de 24 meses altimetro del copiloto (FAR91.411 / car 571 app “b”)."
                        ]
                    },
                    {
                        title: "Inspecciones Adicionales",
                        items: [
                            "Chequeo del peso del extintor de fuego 3BR- 6 meses",
                            "Inspección del sistema de instrumentos- 12 meses (MM 5-00-00 / para 5-6):",
                            "    Calibración de los sistemas compass del piloto y copiloto y compass magnético standby.",
                            "    Drenado del sistema pitot-static por cualquier humedad acumulada.",
                            "    Prueba del sistema pitot-static por fugas.",
                            "Ciclaje de la batería de nickel y cadmium – 100 hrs (MM 96-00-00 / Para 96-25, 96-26)",
                            "Inspección de los tapones de llenado del sistema de combustible, sistema de aceite y sistema hidráulico, por propio funcionamiento y sellado– 12 meses (MM 5-00-00 / para 5-6)"
                        ]
                    },
                    {
                        title: "Inspección de Kits de Equipo Opcional",
                        items: [
                            "Inspección de 25 hrs // 100 hrs del air conditioning system (412AC-208M chapter 3 page 9)",
                            "Inspección diaria // 100 hrs de los crosstubes (AA-01136 Rev. “M” page 59)",
                            "Inspección diaria // 100 hrs de los skid tubes (AA-01139 Rev. “I” page 33)",
                            "Inspección de 100 hrs del wire strike protection system (ER 82737 Rev. “H”)",
                            "Inspección de 100 hrs del heli-access steps (MMS-D412-630 Rev. “C”)"
                        ]
                    },
                    {
                        title: "Boletines de Servicio (ASB's) Recurrentes",
                        items: [
                            "ASB 412-96-89 (to prevent fatigue failure of the T/R yoke assembly P/N 212-011-702-ALL)",
                            "ASB 412-00-100 (inspection of cap angle P/N 212-030-191-001)",
                            "ASB 412-00-102 Rev. “A”. (T/R counterweight bell crank retention nut)",
                            "ASB 412-11-148 Rev. “A”. (inspection of collective lever P/N 412-010-408-101)",
                            "ASB 412-13-155 (inspection of tail rotor blade P/N 212-010-750-ALL)",
                            "ASB 412-09-137 (inspection of main rotor blade expandable bolt inspection P/N 412-010-137-103)"
                        ]
                    },
                    {
                        title: "Programa de Retiro & Overhaul de Componentes",
                        items: [
                            "Se instaló Nuevo M/R Control System Bolts Kit P/N 412-704-112-105, 1EA.",
                            "Se instaló Nuevo M/R Supplemental Control System Bolts Kit P/N 20-057-5-24D, 3EA."
                        ]
                    },
                    {
                        title: "Trabajos Adicionales",
                        items: [
                            "Se instaló Nuevo Sello del Mástil, P/N 412-340-012-101, 1EA.",
                            "Se instaló Nuevos Bushings de la Collective Lever, P/N 412-010-421-103, 2EA.",
                            "Se instaló Nuevo Bellcrank del Sistema Antitorque, P/N 212-001-759-101, 1EA.",
                            "Se instaló Nuevo Panel Assy P/N 205-032-811-077, 1EA."
                        ]
                    }
                ]
            },
            remi: {
                title: "Remoción / Instalación",
                items: []
            },
            motores: {
                title: "Motores",
                sections: [
                    {
                        title: "Inspecciones Periódicas del Twin-Pac",
                        items: [
                            "Inspección de 25 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 50 hrs / 6 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 100 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 150 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 150 hrs / 6 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 150 hrs / 12 meses motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 300 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 600 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)",
                            "Inspección de 900 hrs motor # 1 & # 2 (EM 72-00-00 / Table 601)"
                        ]
                    }
                ]
            }
        };

        const removalDescription = "Se removió [Parte] P/N [Número de parte] S/N [Número de serie], Reparable, por horas para Overhaul cumplidas.";
        const installationDescription = "Se instaló [Parte] P/N [Número de parte] S/N [Número de serie], Reparable, por horas para Overhaul cumplidas.";
        
        // Initial values for editable fields
        const initialValues = {
            fecha_inicio: '',
            modelo: '',
            numero_de_serie: '',
            matricula: '',
            ac_tt: '',
            tq: '',
            envents: '',
            landings: '',
            fecha_finalizacion: '',
            eng1_tsn_tso: '',
            eng1_csn_cso: '',
            eng2_tsn_tso: '',
            eng2_csn_cso: '',
            cbox_tsn_tso: '',
            cbox_csn_cso: '',
            certificacion: 'Yo certifico que los trabajos arriba descritos fueron efectuados de acuerdo a los procedimientos del Manual de Mantenimiento y por lo tanto la aeronave es puesta en servicio.',
            firma: '',
            jefe_taller: '',
            lic_no: ''
        };

        // --- Authentication & Initialization Logic ---
        async function initAuthAndApp() {
            try {
                statusMessage.textContent = 'Iniciando autenticación...';
                await signInAnonymously(auth);
                statusMessage.textContent = 'Autenticación colaborativa exitosa. Todos los usuarios pueden ver y editar los registros.';
                statusMessage.style.color = 'green';
                printAndSaveButton.disabled = false;
                showRecordsButton.disabled = false;
                scanImageBtn.disabled = false;
            } catch (error) {
                console.error("Error de autenticación: ", error);
                statusMessage.textContent = 'Error de autenticación. No se pueden guardar ni cargar datos.';
                statusMessage.style.color = 'red';
                printAndSaveButton.disabled = true;
                showRecordsButton.disabled = true;
                scanImageBtn.disabled = true;
            }
        }

        // --- Form generation functions ---
        function createItemElement(text, index) {
            const itemRow = document.createElement('div');
            itemRow.classList.add('flex', 'items-center', 'text-xs', 'space-x-1', 'group');
            itemRow.innerHTML = `
                <span class="font-bold flex-none w-4 item-number">${index}.</span>
                <p class="editable-cell flex-grow font-bold text-gray-800" contenteditable="true">${text}</p>
                <button class="remove-item-btn text-red-500 hover:text-red-700 font-bold px-2 py-1 transition-colors duration-200 opacity-0 group-hover:opacity-100 no-print text-xl leading-none">&minus;</button>
            `;
            const removeBtn = itemRow.querySelector('.remove-item-btn');
            removeBtn.addEventListener('click', () => {
                itemRow.remove();
                updateItemNumbers();
            });
            return itemRow;
        }

        function createSectionElement(section) {
            const sectionContainer = document.createElement('div');
            sectionContainer.classList.add('space-y-1', 'border-2', 'border-black', 'rounded-md', 'p-2', 'bg-white');
            
            const sectionTitleBar = document.createElement('div');
            sectionTitleBar.classList.add('flex', 'justify-between', 'items-center', 'bg-custom-yellow', 'rounded-t-md', 'p-1', 'border-b-2', 'border-black');
            sectionTitleBar.innerHTML = `
                <p class="font-bold text-sm text-gray-800">${section.title}</p>
                <button class="add-item-btn text-black hover:text-gray-700 font-bold text-xl leading-none px-2 py-1 no-print">&plus;</button>
            `;
            const addItemBtn = sectionTitleBar.querySelector('.add-item-btn');
            addItemBtn.addEventListener('click', () => {
                const newItem = createItemElement("Nuevo ítem", 0);
                sectionContainer.querySelector('.list-content').appendChild(newItem);
                updateItemNumbers();
            });
            sectionContainer.appendChild(sectionTitleBar);

            const listContent = document.createElement('div');
            listContent.classList.add('list-content', 'space-y-1');
            section.items.forEach(item => {
                listContent.appendChild(createItemElement(item, 0));
            });
            sectionContainer.appendChild(listContent);
            
            return sectionContainer;
        }

        function generateInspectionRows(inspectionKey) {
            trabajosContainer.innerHTML = '';
            if (inspections[inspectionKey]) {
                const sectionData = inspections[inspectionKey];
                
                // Main title for the inspection type
                const mainTitle = document.createElement('p');
                mainTitle.classList.add('font-bold', 'text-sm', 'text-white', 'bg-custom-blue', 'p-1', 'mt-2', 'w-full', 'rounded-md', 'text-center');
                mainTitle.textContent = sectionData.title;
                trabajosContainer.appendChild(mainTitle);

                // Check if the inspection data has a 'sections' property
                if (sectionData.sections) {
                    sectionData.sections.forEach(section => {
                        trabajosContainer.appendChild(createSectionElement(section));
                    });
                } else if (sectionData.items) {
                    // This is for other inspections with a simple list structure
                    const listContainer = document.createElement('div');
                    listContainer.classList.add('space-y-1', 'border-2', 'border-black', 'rounded-md', 'p-2', 'bg-white');
                    sectionData.items.forEach(item => {
                        listContainer.appendChild(createItemElement(item, 0));
                    });
                    trabajosContainer.appendChild(listContainer);
                }
            }
            updateItemNumbers();
        }

        function generateRemiRows() {
            trabajosContainer.innerHTML = '';
            const listContainer = document.createElement('div');
            listContainer.classList.add('space-y-1', 'border-2', 'border-black', 'rounded-md', 'p-2', 'bg-white');
            
            listContainer.appendChild(createItemElement(removalDescription, 1));
            listContainer.appendChild(createItemElement(installationDescription, 2));
            trabajosContainer.appendChild(listContainer);
        }

        function updateItemNumbers() {
            const allItems = document.querySelectorAll('.list-content .item-number');
            allItems.forEach((item, index) => {
                item.textContent = `${index + 1}.`;
            });
        }
        
        taskTypeSelect.addEventListener('change', () => {
            const selectedType = taskTypeSelect.value;
            if (selectedType.startsWith('inspection')) {
                generateInspectionRows(selectedType);
            } else if (selectedType === 'remi') {
                generateRemiRows();
            } else if (selectedType === 'motores') {
                generateInspectionRows('motores');
            } else {
                trabajosContainer.innerHTML = '';
            }
            updateItemNumbers();
        });

        // Set initial state to Inspection #1
        taskTypeSelect.value = 'inspection_1';
        taskTypeSelect.dispatchEvent(new Event('change'));

        // --- Signature Pad functionality ---
        let drawing = false;

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function startPosition(e) { drawing = true; draw(e); }
        function endPosition() { drawing = false; ctx.beginPath(); }
        function draw(e) {
            if (!drawing) return;
            let x, y;
            const rect = canvas.getBoundingClientRect();
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPosition(e); });
        canvas.addEventListener('touchend', endPosition);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });

        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        function loadSignature(base64Data) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = base64Data;
        }

        // --- Firestore save and update functionality ---
        async function saveToFirestore(userName) {
            const documentsPath = `/artifacts/${appId}/public/data/mantenimiento_data`;
            
            const trabajos = [];
            document.querySelectorAll('#trabajos-container p').forEach(p => {
                trabajos.push(p.textContent);
            });
            const signatureData = canvas.toDataURL();

            const dataToSave = {
                fecha_inicio: document.getElementById('fecha_inicio').textContent,
                modelo: document.getElementById('modelo').textContent,
                numero_de_serie: document.getElementById('numero_de_serie').textContent,
                matricula: document.getElementById('matricula').textContent,
                ac_tt: document.getElementById('ac_tt').textContent,
                tq: document.getElementById('tq').textContent,
                envents: document.getElementById('envents').textContent,
                landings: document.getElementById('landings').textContent,
                fecha_finalizacion: document.getElementById('fecha_finalizacion').textContent,
                eng1_tsn_tso: document.getElementById('eng1_tsn_tso').textContent,
                eng1_csn_cso: document.getElementById('eng1_csn_cso').textContent,
                eng2_tsn_tso: document.getElementById('eng2_tsn_tso').textContent,
                eng2_csn_cso: document.getElementById('eng2_csn_cso').textContent,
                cbox_tsn_tso: document.getElementById('cbox_tsn_tso').textContent,
                cbox_csn_cso: document.getElementById('cbox_csn_cso').textContent,
                trabajos_realizados: trabajos,
                certificacion: document.getElementById('certificacion').textContent,
                firma: document.getElementById('firma').textContent,
                jefe_taller: document.getElementById('jefe_taller').textContent,
                licencia_no: document.getElementById('lic_no').textContent,
                firma_digital: signatureData,
                guardado_por: userName,
                timestamp: new Date()
            };

            try {
                statusMessage.textContent = 'Guardando datos...';
                if (currentDocId) {
                    await updateDoc(doc(db, documentsPath, currentDocId), dataToSave);
                    statusMessage.textContent = '¡Datos actualizados con éxito!';
                    console.log("Documento actualizado con ID: ", currentDocId);
                } else {
                    const docRef = await addDoc(collection(db, documentsPath), dataToSave);
                    statusMessage.textContent = '¡Datos guardados con éxito!';
                    console.log("Documento añadido con ID: ", docRef.id);
                }
                statusMessage.style.color = 'green';
                return true;
            } catch (e) {
                statusMessage.textContent = 'Error al guardar los datos.';
                statusMessage.style.color = 'red';
                console.error("Error al añadir/actualizar documento: ", e);
                return false;
            }
        }

        // --- AI Scan Functionality ---
        scanImageBtn.addEventListener('click', async () => {
            const file = imageUpload.files[0];
            if (!file) {
                statusMessage.textContent = 'Por favor, selecciona una imagen primero.';
                statusMessage.style.color = 'red';
                return;
            }

            statusMessage.textContent = 'Escaneando imagen... por favor espera.';
            scanImageBtn.disabled = true;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                const apiKey = ""; // La API Key se provee en runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const prompt = "Extrae los datos de la etiqueta de mantenimiento en la imagen. No incluyas los títulos de las celdas, solo los valores. Si un campo está vacío, déjalo como una cadena vacía. Devuelve los datos como un objeto JSON con las siguientes claves: 'fecha_inicio', 'fecha_finalizacion', 'modelo', 'eng1_tsn_tso', 'numero_de_serie', 'eng1_csn_cso', 'matricula', 'eng2_tsn_tso', 'ac_tt', 'eng2_csn_cso', 'tq', 'cbox_tsn_tso', 'landings', 'cbox_csn_cso', 'firma', 'jefe_taller', 'licencia', 'motor1_tsn_tso', 'motor2_tsn_tso', 'motor1_csn_cso', 'motor2_csn_cso'. Para el campo 'firma', describe si la firma es visible o no.";
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "fecha_inicio": { "type": "STRING" },
                                "fecha_finalizacion": { "type": "STRING" },
                                "modelo": { "type": "STRING" },
                                "eng1_tsn_tso": { "type": "STRING" },
                                "numero_de_serie": { "type": "STRING" },
                                "eng1_csn_cso": { "type": "STRING" },
                                "matricula": { "type": "STRING" },
                                "eng2_tsn_tso": { "type": "STRING" },
                                "eng2_csn_cso": { "type": "STRING" },
                                "ac_tt": { "type": "STRING" },
                                "tq": { "type": "STRING" },
                                "cbox_tsn_tso": { "type": "STRING" },
                                "landings": { "type": "STRING" },
                                "cbox_csn_cso": { "type": "STRING" },
                                "motor1_tsn_tso": { "type": "STRING" },
                                "motor2_tsn_tso": { "type": "STRING" },
                                "motor1_csn_cso": { "type": "STRING" },
                                "motor2_csn_cso": { "type": "STRING" },
                                "firma": { "type": "STRING" },
                                "jefe_taller": { "type": "STRING" },
                                "licencia": { "type": "STRING" }
                            }
                        }
                    }
                };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const data = JSON.parse(jsonString);

                    // Fill form fields with data from the AI
                    document.getElementById('fecha_inicio').textContent = data.fecha_inicio || '';
                    document.getElementById('fecha_finalizacion').textContent = data.fecha_finalizacion || '';
                    document.getElementById('modelo').textContent = data.modelo || '';
                    document.getElementById('eng1_tsn_tso').textContent = data.eng1_tsn_tso || '';
                    document.getElementById('numero_de_serie').textContent = data.numero_de_serie || '';
                    document.getElementById('eng1_csn_cso').textContent = data.eng1_csn_cso || '';
                    document.getElementById('matricula').textContent = data.matricula || '';
                    document.getElementById('eng2_tsn_tso').textContent = data.eng2_tsn_tso || '';
                    document.getElementById('ac_tt').textContent = data.ac_tt || '';
                    document.getElementById('eng2_csn_cso').textContent = data.eng2_csn_cso || '';
                    document.getElementById('tq').textContent = data.tq || '';
                    document.getElementById('cbox_tsn_tso').textContent = data.cbox_tsn_tso || '';
                    document.getElementById('landings').textContent = data.landings || '';
                    document.getElementById('cbox_csn_cso').textContent = data.cbox_csn_cso || '';
                    document.getElementById('firma').textContent = data.firma || '';
                    document.getElementById('jefe_taller').textContent = data.jefe_taller || '';
                    document.getElementById('lic_no').textContent = data.licencia || '';
                    
                    statusMessage.textContent = 'Datos escaneados y rellenados con éxito.';
                    statusMessage.style.color = 'green';
                } catch (error) {
                    statusMessage.textContent = 'Error al escanear la imagen. Por favor, inténtalo de nuevo.';
                    statusMessage.style.color = 'red';
                    console.error("Error al llamar a la API de Gemini: ", error);
                } finally {
                    scanImageBtn.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        });

        // --- Event listeners and logic flow ---
        printAndSaveButton.addEventListener('click', () => {
            nameModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            nameModal.classList.add('hidden');
        });

        saveAndPrintBtn.addEventListener('click', async () => {
            const userName = userNameInput.value.trim();
            if (userName) {
                nameModal.classList.add('hidden');
                statusMessage.textContent = 'Guardando datos...';
                statusMessage.style.color = 'black';
                const saved = await saveToFirestore(userName);
                if (saved) {
                    statusMessage.textContent = '¡Datos guardados con éxito! Ahora puedes imprimir usando Ctrl + P (o Cmd + P en Mac).';
                    statusMessage.style.color = 'blue';
                }
            } else {
                userNameInput.placeholder = '¡Por favor, ingresa tu nombre!';
            }
        });

        showRecordsButton.addEventListener('click', async () => {
            recordsContainer.innerHTML = '';
            statusMessage.textContent = 'Cargando registros...';
            statusMessage.style.color = 'black';
            
            try {
                const documentsPath = `/artifacts/${appId}/public/data/mantenimiento_data`;
                const q = query(collection(db, documentsPath));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    recordsContainer.innerHTML = `<p class="text-center text-gray-500">No hay registros guardados.</p>`;
                    statusMessage.textContent = 'Registros cargados.';
                    statusMessage.style.color = 'green';
                    return;
                }

                recordsContainer.innerHTML = `<h3 class="font-bold text-lg text-gray-700 mb-2">Registros Guardados</h3>`;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const recordDiv = document.createElement('div');
                    recordDiv.classList.add('record-item', 'p-4', 'border', 'border-gray-300', 'bg-white', 'rounded-md', 'mb-2', 'cursor-pointer', 'hover:bg-gray-50');
                    recordDiv.innerHTML = `
                        <p class="font-bold">ID: ${doc.id}</p>
                        <p class="text-sm">Matrícula: ${data.matricula || 'N/A'}</p>
                        <p class="text-sm">Guardado por: ${data.guardado_por || 'Anónimo'}</p>
                        <p class="text-xs text-gray-500">Fecha: ${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A'}</p>
                    `;
                    recordDiv.addEventListener('click', () => {
                        loadRecord(data, doc.id);
                    });
                    recordsContainer.appendChild(recordDiv);
                });
                statusMessage.textContent = 'Registros cargados con éxito.';
                statusMessage.style.color = 'green';

            } catch (error) {
                statusMessage.textContent = 'Error al cargar los registros.';
                statusMessage.style.color = 'red';
                console.error("Error al cargar documentos: ", error);
            }
        });

        function loadRecord(data, docId) {
            currentDocId = docId;
            statusMessage.textContent = `Registro ID: ${docId} cargado. Puedes editar y guardar.`;
            statusMessage.style.color = 'blue';

            // Fill editable cells
            document.getElementById('fecha_inicio').textContent = data.fecha_inicio || '';
            document.getElementById('fecha_finalizacion').textContent = data.fecha_finalizacion || '';
            document.getElementById('modelo').textContent = data.modelo || '';
            document.getElementById('eng1_tsn_tso').textContent = data.eng1_tsn_tso || '';
            document.getElementById('numero_de_serie').textContent = data.numero_de_serie || '';
            document.getElementById('eng1_csn_cso').textContent = data.eng1_csn_cso || '';
            document.getElementById('matricula').textContent = data.matricula || '';
            document.getElementById('eng2_tsn_tso').textContent = data.eng2_tsn_tso || '';
            document.getElementById('ac_tt').textContent = data.ac_tt || '';
            document.getElementById('eng2_csn_cso').textContent = data.eng2_csn_cso || '';
            document.getElementById('tq').textContent = data.tq || '';
            document.getElementById('cbox_tsn_tso').textContent = data.cbox_tsn_tso || '';
            document.getElementById('landings').textContent = data.landings || '';
            document.getElementById('cbox_csn_cso').textContent = data.cbox_csn_cso || '';
            document.getElementById('certificacion').textContent = data.certificacion || '';
            document.getElementById('firma').textContent = data.firma || '';
            document.getElementById('jefe_taller').textContent = data.jefe_taller || '';
            document.getElementById('lic_no').textContent = data.licencia_no || '';

            // Load signature
            if (data.firma_digital) {
                loadSignature(data.firma_digital);
            } else {
                clearBtn.click();
            }

            // Load trabajos
            trabajosContainer.innerHTML = '';
            if (data.trabajos_realizados && Array.isArray(data.trabajos_realizados)) {
                let itemCounter = 1;
                data.trabajos_realizados.forEach(itemText => {
                    const itemRow = createItemElement(itemText, itemCounter);
                    trabajosContainer.appendChild(itemRow);
                    itemCounter++;
                });
            }
            updateItemNumbers();
        }

        newRecordButton.addEventListener('click', () => {
            currentDocId = null;
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.textContent = initialValues[cell.id] !== undefined ? initialValues[cell.id] : '';
            });
            clearBtn.click();
            trabajosContainer.innerHTML = '';
            taskTypeSelect.value = 'none';
            statusMessage.textContent = 'Nuevo registro iniciado.';
            statusMessage.style.color = 'black';
        });

        // Initial setup
        initAuthAndApp();
    </script>
</body>
</html>
