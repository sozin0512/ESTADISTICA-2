<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inspecciones FAH-945</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #e9ecef; }
        .container { max-width: 98%; margin: 1.5rem auto; background: white; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .header-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: #343a40; padding: 1px; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .header-item { background-color: white; padding: 0.5rem 1rem; }
        .header-item strong { display: block; font-size: 0.75rem; color: #6c757d; }
        .header-item span { font-size: 1rem; font-weight: 600; }
        .actions-bar { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #f8f9fa; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.25rem; border: 1px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-yellow { background-color: #ffc107; border-color: #ffc107; color: #212529; }
        .btn-blue { background-color: #0d6efd; border-color: #0d6efd; color: white; }
        .btn-green { background-color: #198754; border-color: #198754; color: white; }
        .btn-orange { background-color: #fd7e14; border-color: #fd7e14; color: white; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; color: white; padding: 0.2rem 0.5rem; font-size: 0.7rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { border: 1px solid #dee2e6; padding: 0.6rem 0.5rem; text-align: center; vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: 700; }
        .category-header td { background-color: #343a40; color: white; font-weight: bold; font-size: 0.85rem; text-align: center; padding: 0.4rem; }
        .task-name, .ref-cell, .freq-cell { text-align: left; }
        [contenteditable="true"] { background-color: #fff3cd; outline-color: #ffc107; padding: 0.5rem; }
        .status-vigente { background-color: #198754; color: white; font-weight: bold; }
        .status-vencida { background-color: #dc3545; color: white; font-weight: bold; }
        .loader-container { text-align: center; padding: 4rem 0; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #343a40; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="date"], input[type="text"] { width: 100%; border: 1px solid #ced4da; border-radius: 0.25rem; padding: 0.25rem; background-color: #f8f9fa; }
        .hours-input, .date-input { cursor: pointer; background-color: #e9ecef !important; }
        .delete-btn-cell { width: 40px; }
        
        #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: bottom 0.5s ease-in-out; z-index: 1050; }
        #toast-notification.show { bottom: 30px; }
        #toast-notification.success { background-color: #198754; }
        #toast-notification.error { background-color: #dc3545; }
        #toast-notification.info { background-color: #0d6efd; }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-grid { grid-template-columns: 1fr; }
            .actions-bar { justify-content: center; }
            
            #inspections-table thead { display: none; }
            #inspections-table tr { display: block; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; }
            #inspections-table .category-header { display: none; }
            #inspections-table td { display: block; text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
            #inspections-table td:last-child { border-bottom: 0; }
            #inspections-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }
        }

        /* Print Styles */
        @media print {
            body { background-color: white; font-size: 10pt; }
            .container { box-shadow: none; border: 1px solid #ccc; margin: 0; max-width: 100%; border-radius: 0; }
            .no-print { display: none !important; }
            .header-grid { border-radius: 0; }
            table { font-size: 9pt; }
            th, td { padding: 4px; }
            input { border: none; background-color: transparent !important; }
            .status-vigente, .status-vencida { color: black !important; background-color: transparent !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .status-vencida { font-weight: bold; border: 1px solid black; }
            @page { size: letter landscape; margin: 0.5in; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-grid">
            <div class="header-item"><strong>1. NOMENCLATURA</strong> <span id="header-nomenclatura">HELICOPTERO</span></div>
            <div class="header-item"><strong>2. MODELO</strong> <span id="header-modelo">BELL UH-1H</span></div>
            <div class="header-item"><strong>3. No. SERIE</strong> <span id="header-serie">FAH-945</span></div>
            <div class="header-item"><strong>4. HORAS TOTALES DE VUELO (AC HRS)</strong> <span id="ac-hours-display">...</span></div>
            <div class="header-item"><strong>4a. FECHA</strong> <span id="header-fecha"></span></div>
            <div class="header-item"><strong>4b. PAGINA No</strong> <span>1</span></div>
        </div>

        <div class="actions-bar no-print">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fas fa-search text-gray-400"></i>
                </span>
                <input id="searchInput" class="w-full md:w-64 pl-10 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar inspección...">
            </div>
            <div class="flex items-center gap-2 flex-wrap justify-end">
                <button id="btnVerVencidas" class="btn btn-yellow"><i class="fas fa-exclamation-triangle"></i> Ver Vencidas</button>
                <button id="btnAgregarCategoria" class="btn btn-green hidden"><i class="fas fa-plus"></i> Nueva Categoría</button>
                <button id="btnModoEdicion" class="btn btn-blue"><i class="fas fa-edit"></i> Modo Edición (Ctrl+E)</button>
                <button id="btnPrint" class="btn btn-secondary"><i class="fas fa-print"></i> Imprimir</button>
                <button id="btnRegresar" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Regresar</button>
            </div>
        </div>
        
        <div id="loader-container">
            <div class="loader"></div>
            <p>Cargando datos de inspección...</p>
        </div>

        <table id="inspections-table" class="hidden">
            <thead>
                <tr>
                    <th class="delete-btn-cell"></th>
                    <th>5. ARTICULO PARA SER INSPECCIONADO</th>
                    <th>6. REFERENCIA</th>
                    <th>7. FRECUENCIA</th>
                    <th>Última Realizada</th>
                    <th>SIG. CUMPLIMIENTO</th>
                    <th>Restante</th>
                    <th>VIGENCIA</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Hours Assistant Modal -->
    <div id="hours-assistant-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-xl font-bold text-center mb-1">Asistente de Horas</h3>
            <p id="modal-title-hours" class="text-center text-gray-600 mb-4"></p>
            <div class="space-y-3">
                <div class="p-3 border rounded-md bg-green-50 border-green-200">
                    <p class="font-semibold text-green-800">Opción Rápida: Reiniciar Ciclo</p>
                    <p class="text-sm text-gray-600 mb-2">Registra la última inspección con las horas de vuelo y/o fecha actuales para empezar un nuevo ciclo.</p>
                    <button id="btn-reiniciar-ciclo" class="btn btn-green w-full">Usar Horas y Fecha Actuales: <span id="modal-current-hrs"></span></button>
                </div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción A: Asumir que se acaba de cumplir</p><p class="text-sm text-gray-600 mb-2">Calcula la última inspección como: (Horas Actuales - Frecuencia).</p><button id="btn-opcion-a-hrs" class="btn btn-secondary w-full">Calcular y Registrar</button></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción B: Asumir a mitad de ciclo</p><p class="text-sm text-gray-600 mb-2">Calcula la última inspección como: (Horas Actuales - Frecuencia / 2).</p><button id="btn-opcion-b-hrs" class="btn btn-secondary w-full">Calcular y Registrar</button></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción C: Calcular desde el próximo cumplimiento</p><p class="text-sm text-gray-600">Introduce el valor del próximo cumplimiento y el sistema calculará el anterior.</p><div class="flex gap-2 mt-2"><input type="number" id="input-next-due-hrs" placeholder="Ej: 600" class="flex-grow p-2 border rounded-md"><button id="btn-opcion-c-hrs" class="btn btn-blue">Calcular</button></div></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción D: Registrar cumplimiento en horas pasadas</p><p class="text-sm text-gray-600">Introduce las horas de vuelo exactas (AC HRS) en las que se realizó la inspección.</p><div class="flex gap-2 mt-2"><input type="number" id="input-past-hrs" placeholder="Ej: 4850.5" class="flex-grow p-2 border rounded-md"><button id="btn-opcion-d-hrs" class="btn btn-orange">Registrar</button></div></div>
            </div>
            <div class="mt-4 text-right"><button id="btn-close-modal-hrs" class="btn btn-secondary">Cerrar</button></div>
        </div>
    </div>
    
    <!-- Date Assistant Modal -->
    <div id="date-assistant-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-xl font-bold text-center mb-1">Asistente de Fechas</h3>
            <p id="modal-title-date" class="text-center text-gray-600 mb-4"></p>
            <div class="space-y-3">
                <div class="p-3 border rounded-md bg-green-50 border-green-200"><p class="font-semibold text-green-800">Opción Rápida: Reiniciar Ciclo</p><p class="text-sm text-gray-600 mb-2">Registra la última inspección con la fecha de hoy para empezar un nuevo ciclo.</p><button id="btn-date-reiniciar-ciclo" class="btn btn-green w-full">Usar Fecha Actual</button></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción A: Asumir que se acaba de cumplir</p><p class="text-sm text-gray-600 mb-2">Calcula la última inspección restando la frecuencia a la fecha de hoy.</p><button id="btn-opcion-a-date" class="btn btn-secondary w-full">Calcular y Registrar</button></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción B: Asumir a mitad de ciclo</p><p class="text-sm text-gray-600 mb-2">Calcula la última inspección restando la mitad de la frecuencia a la fecha de hoy.</p><button id="btn-opcion-b-date" class="btn btn-secondary w-full">Calcular y Registrar</button></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción C: Calcular desde el próximo cumplimiento</p><p class="text-sm text-gray-600">Introduce la fecha del próximo cumplimiento y el sistema calculará la anterior.</p><div class="flex gap-2 mt-2"><input type="date" id="input-next-due-date" class="flex-grow p-2 border rounded-md"><button id="btn-opcion-c-date" class="btn btn-blue">Calcular</button></div></div>
                <div class="p-3 border rounded-md"><p class="font-semibold">Opción D: Registrar cumplimiento en fecha pasada</p><p class="text-sm text-gray-600">Introduce la fecha exacta en la que se realizó la inspección.</p><div class="flex gap-2 mt-2"><input type="date" id="input-past-date" class="flex-grow p-2 border rounded-md"><button id="btn-opcion-d-date" class="btn btn-orange">Registrar</button></div></div>
            </div>
            <div class="mt-4 text-right"><button id="btn-close-modal-date" class="btn btn-secondary">Cerrar</button></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, writeBatch, updateDoc, deleteDoc, deleteField, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, auth, db, userId;
        let currentAcHrs = 0;
        let allInspectionDefinitions = [];
        let isEditMode = false;
        let activeRowForModal = null;


        // --- INICIO: Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpZUx4sy6VIKGHzsMCNX4eQQ9sasQhy9Q",
            authDomain: "fah-945.firebaseapp.com",
            databaseURL: "https://fah-945-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fah-945",
            storageBucket: "fah-945.appspot.com",
            messagingSenderId: "789748725591",
            appId: "1:789748725591:web:f7f551a77be0092531f012",
            measurementId: "G-3JW0YYE2QQ"
        };
        // Usamos un ID de aplicación compartido para que todos los usuarios vean los mismos datos en tiempo real.
        const appId = 'FAH-945-SHARED-CONTROL';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- FIN: Configuración de Firebase ---

        const acHrsDisplay = document.getElementById('ac-hours-display');
        const loaderContainer = document.getElementById('loader-container');
        const inspectionsTable = document.getElementById('inspections-table');
        const tableBody = inspectionsTable.querySelector("tbody");
        const btnModoEdicion = document.getElementById('btnModoEdicion');
        const btnAgregarCategoria = document.getElementById('btnAgregarCategoria');
        const hoursModal = document.getElementById('hours-assistant-modal');
        const dateModal = document.getElementById('date-assistant-modal');

        async function main() {
            document.getElementById('header-fecha').textContent = new Date().toLocaleDateString('es-ES');
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await initialize();
                    } else {
                        if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                        else { await signInAnonymously(auth); }
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                loaderContainer.innerHTML = `<p class="text-red-600">Error de inicialización de Firebase.</p>`;
            }
        }

        async function initialize() {
            if (!userId) return;
            loaderContainer.classList.remove('hidden');
            inspectionsTable.classList.add('hidden');

            currentAcHrs = parseFloat(sessionStorage.getItem('acHrsForInspection')) || 0;
            acHrsDisplay.textContent = currentAcHrs > 0 ? currentAcHrs.toFixed(2) : "N/A";
            
            const defsRef = collection(db, `artifacts/${appId}/public/data/inspection_definitions`);
            const dataDocRef = doc(db, `artifacts/${appId}/public/data/inspection_data/all_inspections`);

            try {
                const definitionsSnapshot = await getDocs(defsRef);
                if (definitionsSnapshot.empty) {
                    await seedDatabase();
                    return; 
                }
                allInspectionDefinitions = definitionsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                onSnapshot(dataDocRef, (docSnap) => {
                    const savedData = docSnap.exists() ? docSnap.data() : {};
                    renderTable(allInspectionDefinitions, savedData);
                    loaderContainer.classList.add('hidden');
                    inspectionsTable.classList.remove('hidden');
                });

            } catch (error) {
                console.error("Error loading data:", error);
                loaderContainer.innerHTML = `<p class="text-red-600">Error al cargar datos.</p>`;
            }
        }

        async function seedDatabase() {
            showToast("Configurando su base de datos por primera vez...", "info");
            const seedData = [
                // --- Daily, Phase and Component Inspections ---
                { name: "Daily Inspection", ref: "TM 55-1520-210-PMD", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Phase A Inspection", ref: "TM 55-1520-210-PMD", freq: 150, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Phase B Inspection", ref: "TM 55-1520-210-PMD", freq: 150, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Phase C Inspection", ref: "TM 55-1520-210-PMD", freq: 150, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Phase D Inspection", ref: "TM 55-1520-210-PMD", freq: 150, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Check engine chip detector, inspect for metal particles. Clean and reinstall.", ref: "TM 55-1520-210-10", freq: 25, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Check engine oil level. Service as required.", ref: "TM 11-1520-210-CL", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Check pitot and static ports for obstructions.", ref: "TM 55-1520-210-PMD", freq: 40, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Check security and condition of all mounted avionics in the avionics bay.", ref: "TM 55-1520-210-23-7", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Check security and condition of antennas.", ref: "TM 55-1520-210-23-7", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Check transmission oil level. Service as required.", ref: "M-UH1-P30-01, cases 1", freq: 15, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Drain fuel from main tanks sumps to check for water, sediment and proper fuel grade.", ref: "C-UH1-P30-01, cases 1", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Fuel sample and contamination test.", ref: "TM 55-1520-210-PMD", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Fuselage - visually inspect skin for wrinkles, cracks or other damage.", ref: "TM 55-1520-210-23-1", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect batteries for cleanliness and corrosion, check vent lines for obstruction and security.", ref: "TM 55-1520-210-23-8", freq: 100, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect first aid kits. Check for condition and required contents.", ref: "C-UH1-P30-01, cases 1", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect landing gear for condition, tail skid for security and condition.", ref: "TM 55-1520-210-23-1", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect main rotor blades for condition - nicks, scratches, debonding, cracks and security.", ref: "CHECK LIST-UH-1H, Section II", freq: 10, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect portable fire extinguisher. Check condition and pressure gauge is in the green.", ref: "CHECK LIST-UH-1H, Section II", freq: 1, base: "Months", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect stabilator bar for condition, security of weights and attachment to main rotor hub.", ref: "TM 55-1520-210-23-1", freq: 10, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect tail rotor blades for condition, nicks, scratches, debonding and security of blades.", ref: "CHECK LIST-UH-1H, Section II", freq: 10, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect tail rotor pitch links for condition and security.", ref: "Tel-1 1500-204-23-4", freq: "Short time", base: "Short time", category: "Daily, Phase and Component Inspections" },
                { name: "Main rotor hub strap pack inspection for broken strands, corrosion and condition.", ref: "UH-M-A-1-Chapter 5", freq: 12, base: "Months", category: "Daily, Phase and Component Inspections" },
                { name: "Perform one-time inspection of transmission pylon support links for cracks.", ref: "TB 1-1520-228-20-137", freq: "One time", base: "One time", category: "Daily, Phase and Component Inspections" },
                { name: "Replace all nine tail rotor driveshaft flexible coupling-to-driveshaft bolts and nuts.", ref: "TB 1-1520-210-20-80", freq: "Short time", base: "Short time", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect for correct installation of oil cooler inlet and outlet hoses.", ref: "TB 1-1520-210-30-01", freq: "One time", base: "One time", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect hydraulic system filter differential pressure indicators.", ref: "TM-55-1520-210-PMD", freq: "Daily", base: "Days", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect for missing/damaged sealant on main rotor and tail rotor blades.", ref: "TM-55-1520-210-23-1", freq: 300, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Perform one time inspection of the main rotor blades for debonding.", ref: "TB 1-1520-210-20-101", freq: "One time", base: "One time", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect engine compressor case for cracks.", ref: "TB 1-2840-229-20-15-1", freq: "One time", base: "One time", category: "Daily, Phase and Component Inspections" },
                { name: "Visually inspect main rotor pitch horns for cracks.", ref: "TB 1-1520-210-20-102", freq: 25, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Perform one-time inspection for presence of aluminum pigmented sealant.", ref: "TB 1-1520-210-20-102", freq: "One time", base: "One time", category: "Daily, Phase and Component Inspections" },
                { name: "Tail boom attach fittings.", ref: "TM-55-1520-210-23-2", freq: 300, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Tail boom attach fittings.", ref: "TB 1-1520-210-23-42-1", freq: 600, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Tail boom structural inspection.", ref: "TM-55-1520-210-23-1", freq: 300, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect main driveshaft coupling flexible packs for broken strands, corrosion and condition.", ref: "TB 1-1520-210-20-104", freq: 25, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Tail rotor blade assemblies inspection.", ref: "TM-55-1520-210-23-2", freq: 300, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect main rotor blades for skin separation and debonding.", ref: "TB 1-1520-210-20-106", freq: 10, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Inspect main rotor hub for cracks.", ref: "TB 1-1520-210-23-38-1", freq: "On Condition", base: "On Condition", category: "Daily, Phase and Component Inspections" },
                { name: "Tail rotor blade and doubler assembly inspection for cracks.", ref: "TB 1-1520-210-23-37-1", freq: "On Condition", base: "On Condition", category: "Daily, Phase and Component Inspections" },
                { name: "Inspection of cargo hook for cracks.", ref: "TB 1-1520-210-23-35", freq: "On Condition", base: "On Condition", category: "Daily, Phase and Component Inspections" },
                { name: "Main rotor blade inspection for cracks.", ref: "TB 1-1520-210-20-120", freq: 25, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "One time visual inspection of external hoist for cracks.", ref: "TB 1-1520-210-20-121", freq: "One time", base: "One time", category: "Daily, Phase and Component Inspections" },
                { name: "Inspection of main rotor blade grips for cracks.", ref: "TB 1-1520-210-23-40-2", freq: 150, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Main rotor blade spindle inspection.", ref: "TM 55-1520-210-23-1", freq: 300, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                { name: "Main rotor blade grips.", ref: "TM 55-1520-210-23-1", freq: 300, base: "Hours-Airframe", category: "Daily, Phase and Component Inspections" },
                
                // --- Lubrication ---
                { name: "Crosshead bearing", ref: "TM 55-1520-210-23-1, chapter 1, page 1.53", freq: 25, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Trunnion bearings", ref: "TM 55-1520-210-23-1, chapter 1, page 1.53", freq: 25, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Silent chain (204-001-739-3)", ref: "TM 55-1520-210-23-1, chapter 1, page 1.53", freq: 25, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Grip bearings", ref: "TM 55-1520-210-23-1, chapter 1, page 1.53", freq: 25, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Power cylinder support", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Grip grease fitting", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Pillow block grease fitting", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Plate oil reservoir", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Scissors pivot cover plate", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Collective sleeve bearings", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Scissors bearings", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Swashplate bearings", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Collective lever trunnion", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Outer control plate trunnions", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Control plate trunnions", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Stabilizer frame bearing", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Mixing lever bearing", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Pitch change link universal", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 to 1.53", freq: 50, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Axle pivot point", ref: "TM 55-1520-210-23-1, chapter 1, page1.52", freq: 6, base: "Months", category: "Lubrication" },
                { name: "Actuating cylinder trunnions", ref: "TM 55-1520-210-23-1, chapter 1, page1.52", freq: 6, base: "Months", category: "Lubrication" },
                { name: "Wheel bearings", ref: "TM 55-1520-210-23-1, chapter 1, page1.52", freq: 6, base: "Months", category: "Lubrication" },
                { name: "Pin assembly", ref: "TM 55-1520-210-23-1, chapter 1, page1.52", freq: 6, base: "Months", category: "Lubrication" },
                { name: "Securing pin", ref: "TM 55-1520-210-23-1, chapter 1, page1.52", freq: 6, base: "Months", category: "Lubrication" },
                { name: "Tail rotor pedal adjuster gears", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Cyclic control rod ends (with grease fittings only)", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Engine mount control tube rod ends (with grease fittings only)", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Droop cam slider", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Servo control tube rod ends", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Cargo suspension latch", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Flight control tube rod ends", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Plate oil reservoir", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Collective sleeve splines", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51 & 1.52", freq: 150, base: "Hours-Airframe", category: "Lubrication" },
                { name: "Main driveshaft couplings (205-040-004)", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51", freq: "600 / 12", base: "Hours-Airframe / Months", category: "Lubrication" },
                { name: "Quill flexible couplings", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51", freq: "600 / 12", base: "Hours-Airframe / Months", category: "Lubrication" },
                { name: "Tail rotor driveshaft flexible couplings", ref: "TM 55-1520-210-23-1, chapter 1, pages 1.51", freq: "600 / 12", base: "Hours-Airframe / Months", category: "Lubrication" },

                // --- Recurring TB's, SOF's, AMAM's and ASAM's ---
                { name: "Visual Inspection of Vertical Fin Spar", ref: "TB 1-1520-210-30-01", freq: "Daily", base: "Days", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Perform visual inspection, using 10X magnification, of the Main Rotor Grips. Inspect for cracking, paying particular attention to the bottom of the lower tang.", ref: "UH-1-03-ASAM-01", freq: 25, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Clean tail rotor blades in accordance with cleaning instructions (paragraph 5-117a. through d. only and paragraph 5-117 h.(4))", ref: "TB 1-1520-210-20-32", freq: 50, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Clean tail rotor blades in accordance with cleaning instructions (paragraph 1-19). Inspect tail rotor blades in accordance with paragraph 5-117a. through d. only and paragraph 5-117 h.(4)", ref: "TB 1-1520-210-20-32", freq: 30, base: "Days", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "X-ray inspection of Vertical Fin Spar", ref: "TB 1-1520-210-30-01", freq: 75, base: "N/A", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "±10 percent a fluorescent penetrant inspection of the 42 degree gearbox assembly input and output quill bevel gearshafts.", ref: "TB 1-1520-210-30-02", freq: 150, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Tap Hammer Inspection of Vertical Fin Spar", ref: "TB 1-1520-210-30-01", freq: 150, base: "N/A", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Drain and refill 42 degree gearbox after 25 flight hours to remove any fluorescent penetrant residuals.", ref: "TB 1-1520-210-30-02", freq: 25, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Replace Stabilizer Bar Mixing Lever Bearings P/N MS27641-8", ref: "UH-1-09-AMAM-01", freq: 150, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Replace Scissors Assembly Pivot Bearings P/N MS27641-8", ref: "UH-1-09-AMAM-01", freq: 150, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Main rotor blade 204-011-250-005, -113, inspection upper and lower surfaces (station 24.5 to station 85 with 3X power magnifying glass and station 26.0 and 30.0 with 10X power magnifying glass)", ref: "ASB UH-1H-17-18", freq: 25, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Magnetic brake assembly 204-001-376-003 visual inspection of the stop assemblies", ref: "ASB UH-1H-17-19", freq: "300 / 12", base: "Hours-Airframe / Months", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Main rotor blade 204-011-250-113, wipe the upper and lower skin surfaces of the blades between blade station 100 to 215 with cheesecloth. Inspect the area paying attention to the trailing edge and any blade surface which may have snagged the cheesecloth or caused it to fray.", ref: "ASB UH-1H-18-20", freq: "Daily", base: "Days", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Main rotor blade 204-011-250-113, inspect the upper and lower skin surfaces, wipe the last 4 inches of the trailing edge between blade station 100 and 215 with an alcohol-soaked cloth and wipe dry with a clean cloth. Using a strong light source at an oblique angle, check for evidence of a dark line. A dark line represents excess alcohol bleeding out of possible cracks or edge voids.", ref: "ASB UH-1H-18-20", freq: 25, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Recurring torque check of the tailboom attachment hardware.", ref: "ASB UH-1H-22-23", freq: "600 / 12", base: "Hours-Airframe / Months", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Recurring inspection of the tailboom attachment hardware.", ref: "ASB UH-1H-22-23", freq: "5000 / 5", base: "Hours-Airframe / Years", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },
                { name: "Main Beam Cap Angle, P/N 205-030-163-093 Inspection.", ref: "ASB UH-1H-24-23", freq: 25, base: "Hours-Airframe", category: "Recurring TB's, SOF's, AMAM's and ASAM's" },

                // --- Engine Inspections ---
                { name: "Starter gear drive spline inspection.", ref: "SB T53-L-13B-0001 R17 / Refer Honeywell MM No. 350-2, 72-00-00", freq: 300, base: "Hours-Airframe", category: "Engine Inspections" },
                { name: "Fuel manifold inspection.", ref: "SB T53-L-13B-0001 R17 / Refer Honeywell MM No. 350-2, 73-10-02", freq: 600, base: "Hours-Airframe", category: "Engine Inspections" },
                { name: "Fuel control silicone oil level inspection.", ref: "SB T53-L-13B-0001 R17 / Refer Honeywell MM No. 350-2, 72-00-00", freq: 1000, base: "Hours-Airframe", category: "Engine Inspections" },
                { name: "Perform vibration test of engine, with gear P/N 1-070-062-06 installed.", ref: "SB T53-L-13B-0100-R2 / AD 2002-03-01", freq: 1000, base: "Hours-Airframe", category: "Engine Inspections" },
                { name: "Hot end inspection on T53-L-13B Engine, PN 1-000-060-22.", ref: "TM 55-2840-229-23", freq: 1200, base: "Hours-Airframe", category: "Engine Inspections" },
                { name: "Fuel control recurrent drive shaft assembly inspection.", ref: "SB T53-L-13B-0138 R1 / G.P.E.C.S 73-42 R1 / AD 2006-11-16", freq: 1250, base: "Hours-Airframe", category: "Engine Inspections" },

                // --- Phase Maintenance Inspection ---
                { name: "150-hour phased maintenance inspection-No.1", ref: "TM 55-1520-210-PM", freq: 150, base: "Hours-Airframe", category: "Phase Maintenance Inspection" },
                { name: "150-hour phased maintenance inspection-No.2", ref: "TM 55-1520-210-PM", freq: 150, base: "Hours-Airframe", category: "Phase Maintenance Inspection" },
                { name: "150-hour phased maintenance inspection-No.3", ref: "TM 55-1520-210-PM", freq: 150, base: "Hours-Airframe", category: "Phase Maintenance Inspection" },
                { name: "150-hour phased maintenance inspection-No.4", ref: "TM 55-1520-210-PM", freq: 150, base: "Hours-Airframe", category: "Phase Maintenance Inspection" },
                { name: "150-hour phased maintenance inspection-No.5", ref: "TM 55-1520-210-PM", freq: 150, base: "Hours-Airframe", category: "Phase Maintenance Inspection" },
                { name: "150-hour phased maintenance inspection-No.6", ref: "TM 55-1520-210-PM", freq: 150, base: "Hours-Airframe", category: "Phase Maintenance Inspection" },

                // --- Inspections ---
                { name: "Form A - 150 Hour Forward Vertical Fin Spar Inspection", ref: "Report No. GHT-392-105 Revision 5, Page 9", freq: 150, base: "Hours-Airframe", category: "Inspections" },
                { name: "Form B - 300-Hour Forward Vertical Fin Spar Inspection", ref: "Report No. GHT-392-105 Revision 5, Page 10", freq: 300, base: "Hours-Airframe", category: "Inspections" },
                { name: "Visually inspect the tailboom assembly skin joint at Boom Station (BS) 194 or fretting, corrosion, loose or working rivets, or a crack.", ref: "Docket No. 2002-SW-31-AD", freq: 100, base: "Hours-Airframe", category: "Inspections" },
                { name: "Radiographically inspect the tailboom assembly skin joint at Boom Station (BS) 194.", ref: "Docket No. 2002-SW-31-AD", freq: 500, base: "Hours-Airframe", category: "Inspections" },

                // --- Corrosion Program Medium Helicopters ---
                { name: "Daily visual corrosion inspection", ref: "CSSD-PSE-87-001 / CHAPTER 30-20-00 / PAGE 21 to 26", freq: "Daily", base: "Days", category: "Corrosion Program Medium Helicopters" },
                { name: "100 hours or 90-day corrosion inspection", ref: "CSSD-PSE-87-001 / CHAPTER 30-20-00 / PAGE 27 to 35", freq: "100 / 3", base: "Hours-Airframe / Months", category: "Corrosion Program Medium Helicopters" },

                // --- Avionics Inspection ---
                { name: "5 years inspection", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 2 / 190-01102-00", freq: 5, base: "Years", category: "Avionics Inspection" },
                { name: "5 years inspection-GRS 77H AHRS", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 2 / 190-01102-00", freq: 5, base: "Years", category: "Avionics Inspection" },
                { name: "Periodic maintenance instructions GDU 620, GRS 77H, GDC 74H, GMU 44, GTP 59", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 3 / 190-01102-00", freq: 100, base: "Hours-Airframe", category: "Avionics Inspection" },
                { name: "On condition inspection GDU 620, GRS 77H, GDC 74H, GMU 44, GTP 59", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 3 / 190-01102-00", freq: "On Condition", base: "On Condition", category: "Avionics Inspection" },
                { name: "2200 hours / 12 years inspection, GDU 620, GRS 77H, GDC 74H, GMU 44, GTP 59", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 3 / 190-01102-00", freq: "2200 / 12", base: "Hours-Airframe / Years", category: "Avionics Inspection" },
                { name: "Equipment Removal & replacement", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 8 / 190-01007-A3", freq: "On Condition", base: "On Condition", category: "Avionics Inspection" },
                { name: "Cleaning the Front Panel", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 8 / 190-01007-A3", freq: "On Condition", base: "On Condition", category: "Avionics Inspection" },
                { name: "Display Backlight", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 8 / 190-01007-A3", freq: "On Condition", base: "On Condition", category: "Avionics Inspection" },
                { name: "Battery Replacement", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 8 / 190-01007-A3", freq: 10, base: "Years", category: "Avionics Inspection" },
                { name: "Equipment Visual Check", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 9 / 190-01007-A3", freq: 12, base: "Months", category: "Avionics Inspection" },
                { name: "Test-TVS-Lightning Protection", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 9 / 190-01007-XB", freq: 24, base: "Months", category: "Avionics Inspection" },
                { name: "Test-Lightning Protection", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 9 / 190-01007-XB", freq: "After lightning strike", base: "Special", category: "Avionics Inspection" },
                { name: "Test-Bonding Check (IFR-certified aircraft only)", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 10 / 190-01007-XB", freq: "2000 / 10", base: "Hours-Airframe / Years", category: "Avionics Inspection" },
                { name: "Altimeter system and altitude reporting equipment test and inspection", ref: "14 CFR Part 91/ 411 / 14 CFR Part 43 Appendix E", freq: 24, base: "Months", category: "Avionics Inspection" },
                { name: "ATC transponder tests and inspections", ref: "14 CFR Part 91/ 413 / 14 CFR Part 43 Appendix F", freq: 24, base: "Months", category: "Avionics Inspection" },
                { name: "Perform at regular inspection intervals (150 hours)", ref: "ICA-AMT-UH-1H-FAH-945-001 / 0040-17001-01", freq: 150, base: "Hours-Airframe", category: "Avionics Inspection" },
                { name: "Perform at regular inspection intervals (150 hours)", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 11 / 0040-17001-01", freq: 150, base: "Hours-Airframe", category: "Avionics Inspection" },
                { name: "Perform preflight inspection before each flight", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 11 / C46-5042-003", freq: "Preflight", base: "Preflight", category: "Avionics Inspection" },
                { name: "12 calendar months inspection", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 12 TO 13 / 0045-15501-01", freq: 12, base: "Months", category: "Avionics Inspection" },
                { name: "24 calendar months inspection", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 12 TO 13 / 0045-15501-01", freq: 24, base: "Months", category: "Avionics Inspection" },
                { name: "Perform at regular inspection intervals (150 hours)", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 12 / 0045-15501-01", freq: 150, base: "Hours-Airframe", category: "Avionics Inspection" },
                { name: "Perform at regular inspection intervals (150 hours)", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 13 / 0045-15501-01", freq: 150, base: "Hours-Airframe", category: "Avionics Inspection" },
                { name: "12 calendar months inspection", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 14 / 009-15500-001", freq: 12, base: "Months", category: "Avionics Inspection" },
                { name: "Perform at regular inspection intervals (150 hours)", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 14 / 009-15500-001", freq: 150, base: "Hours-Airframe", category: "Avionics Inspection" },
                { name: "Perform preflight inspection before each flight", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 14 / 190-01227-05", freq: "Preflight", base: "Preflight", category: "Avionics Inspection" },
                { name: "12 calendar months inspection", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 14 TO 15 NO0907N014 CFR Part 91.207", freq: 12, base: "Months", category: "Avionics Inspection" },
                { name: "Battery Replacement", ref: "ICA-AMT-UH-1H-FAH-945-001 PAGE 14 TO 15 NO0907N014 CFR Part 91.207", freq: 5, base: "Years", category: "Avionics Inspection" },
                { name: "Perform preflight inspection before each flight", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 15 / NO0907N014", freq: "Preflight", base: "Preflight", category: "Avionics Inspection" },
                { name: "Periodic maintenance instructions", ref: "ICA-AMT-UH-1H-FAH-945-001, PAGE 15 / 208-025-000", freq: 150, base: "Hours-Airframe", category: "Avionics Inspection" },
                
                // --- Non-Recurring Special Inspections ---
                { name: "On initial installation of a new or overhauled engine or when maintenance has been performed that affects the fuel flow, airflow or gas path of the engine.", ref: "TM 55-2840-229-23", freq: "Initial installation", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "Engine post-installation inspection.", ref: "TM 55-2840-229-23 / TM 55-4920-401-13&P", freq: "Post-installation", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "Prior to installation of outside air temperature gauge.", ref: "TM 1-1500-204-23-4", freq: "Prior to installation", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "On initial installation of main rotor hub", ref: "Paragraph 1-7", freq: "Initial installation", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After the first flight of main rotor hub.", ref: "Paragraph 1-7", freq: "After the first flight", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After 10 hours of flight of main rotor hub.", ref: "Paragraph 1-7", freq: 10, base: "Hours-Airframe", category: "Non-Recurring Special Inspections" },
                { name: "Each 50 hours thereafter of main rotor hub.", ref: "Paragraph 1-7", freq: 50, base: "Hours-Airframe", category: "Non-Recurring Special Inspections" },
                { name: "5 to 10 flight hours after replacement of either the T/R sprocket, T/R control chain, T/R speed rig cables, T/R control cables or any combination thereof, or after any maintenance action resulting in of the tail rotor control cable tension.", ref: "TM 55-1520-210-23-1", freq: 10, base: "Hours-Airframe", category: "Non-Recurring Special Inspections" },
                { name: "5 to 10 flight hours after installation of M/R static stop plate assembly (P/N 204-011-207-105).", ref: "TM 55-1520-210-23-1", freq: 10, base: "Hours-Airframe", category: "Non-Recurring Special Inspections" },
                { name: "5 to 10 flight hours after installation of tail rotor.", ref: "TM 55-1520-210-23-1", freq: 10, base: "Hours-Airframe", category: "Non-Recurring Special Inspections" },
                { name: "First flight after installation of tail boom.", ref: "TM 55-1520-210-23-1", freq: "After the first flight", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After electrical equipment, engine change, or major structural equipment changes likely to affect the compass.", ref: "TM 1-1500-204-23-4 page 4-24 through 4-30", freq: "After changes", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After the helicopter has been subject to salt water or salt water spray.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "Helicopters which are being operated under salt laen atmospheric environmental conditions.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "Immediately after exposure to water from airframe or engine washing, or at next daily inspection after exposure to rain, snow sleet or ice.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After helicopter has been operated in rain, ice, or heavy snow.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After parked aircraft is exposed to sleet, freezing rain, or snow.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After the helicopter has been either parked or operated in rain, ice or heavy snow.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After AOAP notification of high concentrations of copper, aluminum, iron, sludge, or a combination of these in the 90° gearbox.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After initial installation of rescue hoist assembly on aircraft.", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "After multiple and consecutive cable extensions (4 or more) at one time under no load (high performance hoist).", ref: "TM 55-1520-210-23-1", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "Aircraft in flyable storage.", ref: "Appendix E", freq: "After", base: "Special", category: "Non-Recurring Special Inspections" },
                { name: "Between 1 and 5 flight hours after tailboom installation or attachment bolt replacement.", ref: "ASB UH-1H-22-23", freq: 5, base: "Hours-Airframe", category: "Non-Recurring Special Inspections" }
            ];
            
            const batch = writeBatch(db);
            const defsRef = collection(db, `artifacts/${appId}/public/data/inspection_definitions`);
            seedData.forEach(inspection => {
                const docRef = doc(defsRef);
                batch.set(docRef, inspection);
            });
            await batch.commit();
            showToast("Base de datos configurada. Recargando...", "success");
            await initialize(); 
        }

        function renderTable(definitions, savedData) {
            tableBody.innerHTML = '';
            const grouped = definitions.reduce((acc, item) => {
                (acc[item.category] = acc[item.category] || []).push(item);
                return acc;
            }, {});

            const sortedCategories = Object.keys(grouped).sort();

            for (const category of sortedCategories) {
                const headerRow = document.createElement('tr');
                headerRow.className = 'category-header';
                headerRow.innerHTML = `<td colspan="8">${category.toUpperCase()}</td>`;
                tableBody.appendChild(headerRow);

                grouped[category].sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                    const data = savedData[item.id] || {};
                    const lastDate = data.lastDate || '';
                    const lastHours = data.lastHours || '';
                    
                    const row = document.createElement('tr');
                    row.dataset.id = item.id;
                    row.innerHTML = `
                        <td data-label="" class="delete-btn-cell"></td>
                        <td data-label="Inspección" class="task-name" contenteditable="false">${item.name}</td>
                        <td data-label="Referencia" class="ref-cell" contenteditable="false">${item.ref}</td>
                        <td data-label="Frecuencia" class="freq-cell" contenteditable="false">${item.freq} ${item.base}</td>
                        <td data-label="Última Realizada">
                            <input type="text" value="${lastHours}" class="w-full text-center hours-input" placeholder="Hrs" readonly>
                            <input type="date" value="${lastDate}" class="w-full date-input" readonly>
                        </td>
                        <td data-label="Próx. Cumplimiento"></td>
                        <td data-label="Restante"></td>
                        <td data-label="Vigencia"></td>
                    `;
                    tableBody.appendChild(row);
                    updateRowUI(row);
                });
            }
        }
        
        function updateRowUI(row) {
             const inspectionId = row.dataset.id;
             const definition = allInspectionDefinitions.find(d => d.id === inspectionId);
             if (!definition) return;

             const lastHours = row.querySelector('.hours-input').value;
             const lastDate = row.querySelector('.date-input').value;
             const { nextDueDate, nextDueHrs, remaining, status } = calculateStatus(lastDate, lastHours, definition.freq, definition.base);

             row.cells[5].innerHTML = `<span>${nextDueHrs}</span><br><span>${nextDueDate}</span>`;
             row.cells[6].textContent = remaining;
             row.cells[7].textContent = status;
             row.cells[7].className = status === 'VIGENTE' ? 'status-vigente' : 'status-vencida';
        }


        function calculateStatus(lastDateStr, lastHoursStr, freq, base) {
            let nextDueDate = '---', nextDueHrs = '---', remaining = '---', status = 'VIGENTE';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const nonCalculatedBases = ['condition', 'preflight', 'after', 'one time', 'short time', 'special', 'n/a'];
            if (!base || nonCalculatedBases.some(term => String(base).toLowerCase().includes(term))) {
                return { nextDueDate: 'N/A', nextDueHrs: 'N/A', remaining: 'N/A', status: 'VIGENTE' };
            }

            const freqs = String(freq).split('/').map(f => parseFloat(f.trim()));
            const bases = String(base).split('/').map(b => b.trim().toLowerCase());
            
            let remainingDays = Infinity, remainingHours = Infinity;
            let finalNextDate = null, finalNextHours = Infinity;

            const lastHours = parseFloat(lastHoursStr);
            const lastDate = lastDateStr ? new Date(lastDateStr + 'T12:00:00') : null;

            bases.forEach((b, index) => {
                const f = freqs[index];
                if (b.includes('hour') && !isNaN(lastHours) && !isNaN(f)) {
                    if ((lastHours + f) < finalNextHours) finalNextHours = lastHours + f;
                }
                if (lastDate && (b.includes('day') || b.includes('month') || b.includes('year') || b.includes('día') || b.includes('mes') || b.includes('año'))) {
                    const nextDate = new Date(lastDate);
                    if (b.includes('day') || b.includes('día')) nextDate.setDate(nextDate.getDate() + (f || 1)); // Handle "Daily"
                    else if (b.includes('month') || b.includes('mes')) nextDate.setMonth(nextDate.getMonth() + f);
                    else if (b.includes('year') || b.includes('año')) nextDate.setFullYear(nextDate.getFullYear() + f);
                    if (!finalNextDate || nextDate < finalNextDate) finalNextDate = nextDate;
                }
            });
            
            if (finalNextHours !== Infinity) {
                nextDueHrs = finalNextHours.toFixed(2);
                remainingHours = finalNextHours - currentAcHrs;
            }
            if (finalNextDate) {
                nextDueDate = finalNextDate.toLocaleDateString('es-ES', { year: '2-digit', month: '2-digit', day: '2-digit' });
                remainingDays = Math.floor((finalNextDate - today) / (1000 * 60 * 60 * 24));
            }

            if ((currentAcHrs > 0 && remainingHours <= 0) || remainingDays <= 0) status = 'VENCIDA';

            if (remainingDays !== Infinity && remainingHours !== Infinity) remaining = `${remainingHours.toFixed(2)}h / ${remainingDays}d`;
            else if (remainingHours !== Infinity) remaining = `${remainingHours.toFixed(2)}h`;
            else if (remainingDays !== Infinity) remaining = `${remainingDays}d`;

            return { nextDueDate, nextDueHrs, remaining, status };
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        async function handleAutoSave(row, field, value) {
            const id = row.dataset.id;
            const dataDocRef = doc(db, `artifacts/${appId}/public/data/inspection_data/all_inspections`);
            try {
                 await setDoc(dataDocRef, { [id]: { [field]: value } }, { merge: true });
                showToast('Cambio guardado');
            } catch (error) {
                 console.error("Error en autoguardado:", error);
                 showToast('Error al guardar', 'error');
            }
        }
        
        function handleEditRequest() {
            if (isEditMode) {
                toggleEditMode();
            } else {
                const password = prompt("Ingrese la contraseña para activar el modo de edición:");
                if (password === "Kevin") {
                    toggleEditMode();
                } else if (password !== null) {
                    showToast("Contraseña incorrecta", "error");
                }
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.querySelectorAll('.add-inspection-row').forEach(row => row.remove());

            btnAgregarCategoria.classList.toggle('hidden');

            tableBody.querySelectorAll('tr[data-id]').forEach(row => {
                const taskNameCell = row.querySelector('.task-name');
                const refCell = row.querySelector('.ref-cell');
                const freqCell = row.querySelector('.freq-cell');
                const deleteCell = row.querySelector('.delete-btn-cell');
                
                taskNameCell.setAttribute('contenteditable', isEditMode);
                refCell.setAttribute('contenteditable', isEditMode);
                freqCell.setAttribute('contenteditable', isEditMode);
                
                if(isEditMode) {
                    deleteCell.innerHTML = `<button class="btn btn-danger delete-btn"><i class="fas fa-trash-alt"></i></button>`;
                } else {
                    deleteCell.innerHTML = '';
                }
            });

            if (isEditMode) {
                tableBody.querySelectorAll('.category-header').forEach(headerRow => {
                    const category = headerRow.querySelector('td').textContent.trim();
                    const addRow = document.createElement('tr');
                    addRow.className = 'add-inspection-row';
                    addRow.innerHTML = `<td colspan="8"><button class="btn btn-green w-full add-inspection-btn" data-category="${category}">+ Agregar Inspección a ${category}</button></td>`;
                    headerRow.parentNode.insertBefore(addRow, headerRow.nextSibling);
                });
            }

            btnModoEdicion.innerHTML = isEditMode ? '<i class="fas fa-check"></i> Salir Edición' : '<i class="fas fa-edit"></i> Modo Edición (Ctrl+E)';
            showToast(isEditMode ? 'Modo de edición activado' : 'Modo de edición desactivado', 'info');
        }

        async function handleDelete(row) {
            const id = row.dataset.id;
            if (!id || !confirm('¿Estás seguro de que quieres eliminar esta inspección permanentemente?')) return;

            const defDocRef = doc(db, `artifacts/${appId}/public/data/inspection_definitions`, id);
            const dataDocRef = doc(db, `artifacts/${appId}/public/data/inspection_data/all_inspections`);

            try {
                const batch = writeBatch(db);
                batch.delete(defDocRef);
                batch.update(dataDocRef, { [id]: deleteField() });
                await batch.commit();
                
                showToast('Inspección eliminada');
            } catch (error) {
                console.error("Error al eliminar:", error);
                showToast('Error al eliminar', 'error');
            }
        }
        
        function getHourFrequency(definition) {
            const freqs = String(definition.freq).split('/').map(f => parseFloat(f.trim()));
            const bases = (definition.base || '').split('/').map(b => b.trim().toLowerCase());
            const hourIndex = bases.findIndex(b => b.includes('hour'));
            return hourIndex !== -1 ? freqs[hourIndex] : 0;
        }
        
        function parseFrequency(text) {
            const parts = text.trim().split(/\s+/);
            const freq = parseFloat(parts[0]) || parts[0];
            const base = parts.slice(1).join(' ');
            return { freq, base };
        }

        function handleAddNewInspection(button) {
            const category = button.dataset.category;
            const newRow = document.createElement('tr');
            newRow.className = 'new-inspection-row';
            newRow.innerHTML = `
                <td><button class="btn btn-green save-new-btn"><i class="fas fa-save"></i></button></td>
                <td contenteditable="true" class="task-name">Nueva Inspección</td>
                <td contenteditable="true" class="ref-cell">Referencia</td>
                <td contenteditable="true" class="freq-cell">100 Hours-Airframe</td>
                <td colspan="4">Complete los datos y guarde</td>
            `;
            button.closest('tr').insertAdjacentElement('afterend', newRow);
            newRow.querySelector('.task-name').focus();
            button.disabled = true;
        }

        async function saveNewInspection(button) {
            const row = button.closest('tr');
            const name = row.cells[1].textContent.trim();
            const ref = row.cells[2].textContent.trim();
            const freqText = row.cells[3].textContent.trim();
            const category = row.previousElementSibling.querySelector('.add-inspection-btn').dataset.category;

            if (!name || !ref || !freqText) {
                showToast("Por favor complete todos los campos.", "error");
                return;
            }

            const { freq, base } = parseFrequency(freqText);
            const newInspectionData = { name, ref, freq, base, category };

            try {
                const defsRef = collection(db, `artifacts/${appId}/public/data/inspection_definitions`);
                await addDoc(defsRef, newInspectionData);
                showToast("Inspección agregada con éxito");
            } catch (error) {
                console.error("Error al guardar nueva inspección:", error);
                showToast("Error al guardar.", "error");
            }
        }

        // --- Modals Logic ---
        function openHoursAssistant(row) {
            activeRowForModal = row;
            const id = row.dataset.id;
            const definition = allInspectionDefinitions.find(d => d.id === id);
            if (!definition) return;
            
            document.getElementById('modal-title-hours').textContent = `${definition.name} (${definition.freq} ${definition.base})`;
            document.getElementById('modal-current-hrs').textContent = currentAcHrs.toFixed(2);
            document.getElementById('input-next-due-hrs').value = '';
            document.getElementById('input-past-hrs').value = '';

            hoursModal.classList.remove('hidden');
        }

        function openDateAssistant(row) {
            activeRowForModal = row;
            const id = row.dataset.id;
            const definition = allInspectionDefinitions.find(d => d.id === id);
            if (!definition) return;

            document.getElementById('modal-title-date').textContent = `${definition.name} (${definition.freq} ${definition.base})`;
            document.getElementById('input-next-due-date').value = '';
            document.getElementById('input-past-date').value = '';

            dateModal.classList.remove('hidden');
        }
        
        function closeHoursAssistant() { hoursModal.classList.add('hidden'); activeRowForModal = null; }
        function closeDateAssistant() { dateModal.classList.add('hidden'); activeRowForModal = null; }

        function updateHoursAndSave(newHours) {
            if (activeRowForModal && !isNaN(newHours)) {
                handleAutoSave(activeRowForModal, 'lastHours', newHours.toFixed(2));
            }
            closeHoursAssistant();
        }
        
        function updateDateAndSave(newDate) {
            if (activeRowForModal && newDate) {
                const dateString = newDate.toISOString().split('T')[0];
                handleAutoSave(activeRowForModal, 'lastDate', dateString);
            }
            closeDateAssistant();
        }

        function updateAndSaveCycle() {
            if (!activeRowForModal) return;
            const id = activeRowForModal.dataset.id;
            const definition = allInspectionDefinitions.find(d => d.id === id);
            if (!definition) return;

            handleAutoSave(activeRowForModal, 'lastHours', currentAcHrs.toFixed(2));

            const base = (definition.base || '').toLowerCase();
            if (base.includes('day') || base.includes('month') || base.includes('year')) {
                const today = new Date().toISOString().split('T')[0];
                handleAutoSave(activeRowForModal, 'lastDate', today);
            }
            closeHoursAssistant();
        }
        
        function getDateFrequency(definition) {
            const freqs = String(definition.freq).split('/').map(f => parseFloat(f.trim()));
            const bases = (definition.base || '').split('/').map(b => b.trim().toLowerCase());
            const dateIndex = bases.findIndex(b => b.includes('day') || b.includes('month') || b.includes('year') || b.includes('día') || b.includes('mes') || b.includes('año'));
            if (dateIndex === -1) return null;
            return { freq: freqs[dateIndex], base: bases[dateIndex] };
        }

        function calculatePastDate(baseDate, amount, unit, factor = 1) {
            const newDate = new Date(baseDate);
            amount = amount * factor;
            if (unit.includes('day')|| unit.includes('día')) newDate.setDate(newDate.getDate() - amount);
            else if (unit.includes('month') || unit.includes('mes')) newDate.setMonth(newDate.getMonth() - amount);
            else if (unit.includes('year') || unit.includes('año')) newDate.setFullYear(newDate.getFullYear() - amount);
            return newDate;
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const allRows = Array.from(tableBody.querySelectorAll('tr'));

            // Filter inspection rows (those with data-id)
            allRows.forEach(row => {
                if (row.dataset.id) {
                    const taskName = row.querySelector('.task-name')?.textContent.toLowerCase() || '';
                    const ref = row.querySelector('.ref-cell')?.textContent.toLowerCase() || '';
                    const isVisible = taskName.includes(searchTerm) || ref.includes(searchTerm);
                    row.style.display = isVisible ? '' : 'none';
                }
            });

            // Show/Hide category headers based on visible children
            const categoryHeaders = allRows.filter(row => row.classList.contains('category-header'));
            categoryHeaders.forEach(header => {
                let nextElement = header.nextElementSibling;
                let hasVisibleInspections = false;
                while (nextElement && !nextElement.classList.contains('category-header')) {
                    if (nextElement.style.display !== 'none' && (nextElement.dataset.id || nextElement.classList.contains('new-inspection-row') || nextElement.classList.contains('add-inspection-row'))) {
                        hasVisibleInspections = true;
                        break;
                    }
                    nextElement = nextElement.nextElementSibling;
                }
                header.style.display = hasVisibleInspections ? '' : 'none';
            });
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'e') { e.preventDefault(); handleEditRequest(); }
        });
        
        document.getElementById('searchInput').addEventListener('input', filterTable);

        btnModoEdicion.addEventListener('click', handleEditRequest);
        
        btnAgregarCategoria.addEventListener('click', async () => {
            const categoryName = prompt("Ingrese el nombre de la nueva categoría:");
            if (categoryName && categoryName.trim() !== '') {
                const newInspectionData = {
                    name: "Nueva Inspección en esta categoría",
                    ref: "N/A",
                    freq: 0,
                    base: "N/A",
                    category: categoryName.trim().toUpperCase()
                };

                try {
                    const defsRef = collection(db, `artifacts/${appId}/public/data/inspection_definitions`);
                    await addDoc(defsRef, newInspectionData);
                    showToast("Nueva categoría y primera inspección agregadas.");
                } catch (error) {
                    console.error("Error al agregar nueva categoría:", error);
                    showToast("Error al guardar la categoría.", "error");
                }
            }
        });

        tableBody.addEventListener('blur', async (e) => {
            if (isEditMode && e.target.matches('[contenteditable="true"]')) {
                const row = e.target.closest('tr');
                if (!row.dataset.id) return;
                const id = row.dataset.id;
                const defDocRef = doc(db, `artifacts/${appId}/public/data/inspection_definitions`, id);
                let updateData = {};
                if (e.target.classList.contains('task-name')) updateData.name = e.target.textContent;
                else if (e.target.classList.contains('ref-cell')) updateData.ref = e.target.textContent;
                else if (e.target.classList.contains('freq-cell')) Object.assign(updateData, parseFrequency(e.target.textContent));
                if (Object.keys(updateData).length > 0) {
                     try {
                        await updateDoc(defDocRef, updateData);
                        const defIndex = allInspectionDefinitions.findIndex(d => d.id === id);
                        if(defIndex > -1) allInspectionDefinitions[defIndex] = {...allInspectionDefinitions[defIndex], ...updateData};
                        updateRowUI(row);
                        showToast('Cambio guardado');
                    } catch (error) { console.error("Error al actualizar:", error); showToast('Error al actualizar', 'error'); }
                }
            }
        }, true);

        tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || !row.dataset.id) { 
                if (e.target.closest('.add-inspection-btn')) handleAddNewInspection(e.target.closest('.add-inspection-btn'));
                else if (e.target.closest('.save-new-btn')) saveNewInspection(e.target.closest('.save-new-btn'));
                return;
            }
            if (e.target.closest('.delete-btn')) {
                 handleDelete(row);
            } else if (e.target.classList.contains('hours-input')) {
                 openHoursAssistant(row);
            } else if (e.target.classList.contains('date-input')) {
                const id = row.dataset.id;
                const def = allInspectionDefinitions.find(d => d.id === id);
                if (def) {
                    const base = (def.base || '').toLowerCase();
                    const isDateBased = ['day', 'día', 'month', 'mes', 'year', 'año'].some(term => base.includes(term));
                    if (isDateBased) {
                        openDateAssistant(row);
                    }
                }
            }
        });

        // Hours Modal Listeners
        document.getElementById('btn-close-modal-hrs').addEventListener('click', closeHoursAssistant);
        document.getElementById('btn-reiniciar-ciclo').addEventListener('click', updateAndSaveCycle);
        document.getElementById('btn-opcion-a-hrs').addEventListener('click', () => { const def = allInspectionDefinitions.find(d => d.id === activeRowForModal.dataset.id); updateHoursAndSave(currentAcHrs - getHourFrequency(def)); });
        document.getElementById('btn-opcion-b-hrs').addEventListener('click', () => { const def = allInspectionDefinitions.find(d => d.id === activeRowForModal.dataset.id); updateHoursAndSave(currentAcHrs - (getHourFrequency(def) / 2)); });
        document.getElementById('btn-opcion-c-hrs').addEventListener('click', () => { const nextDue = parseFloat(document.getElementById('input-next-due-hrs').value); if(isNaN(nextDue)) return; const def = allInspectionDefinitions.find(d => d.id === activeRowForModal.dataset.id); updateHoursAndSave(nextDue - getHourFrequency(def)); });
        document.getElementById('btn-opcion-d-hrs').addEventListener('click', () => { const past = parseFloat(document.getElementById('input-past-hrs').value); if(!isNaN(past)) updateHoursAndSave(past); });

        // Date Modal Listeners
        document.getElementById('btn-close-modal-date').addEventListener('click', closeDateAssistant);
        document.getElementById('btn-date-reiniciar-ciclo').addEventListener('click', () => updateDateAndSave(new Date()));
        document.getElementById('btn-opcion-a-date').addEventListener('click', () => { const def = allInspectionDefinitions.find(d => d.id === activeRowForModal.dataset.id); const freq = getDateFrequency(def); if(!freq) return; updateDateAndSave(calculatePastDate(new Date(), freq.freq, freq.base)); });
        document.getElementById('btn-opcion-b-date').addEventListener('click', () => { const def = allInspectionDefinitions.find(d => d.id === activeRowForModal.dataset.id); const freq = getDateFrequency(def); if(!freq) return; updateDateAndSave(calculatePastDate(new Date(), freq.freq, freq.base, 0.5)); });
        document.getElementById('btn-opcion-c-date').addEventListener('click', () => { const nextDueStr = document.getElementById('input-next-due-date').value; if(!nextDueStr) return; const nextDueDate = new Date(nextDueStr + 'T12:00:00'); const def = allInspectionDefinitions.find(d => d.id === activeRowForModal.dataset.id); const freq = getDateFrequency(def); if(!freq) return; updateDateAndSave(calculatePastDate(nextDueDate, freq.freq, freq.base)); });
        document.getElementById('btn-opcion-d-date').addEventListener('click', () => { const pastStr = document.getElementById('input-past-date').value; if(pastStr) updateDateAndSave(new Date(pastStr + 'T12:00:00')); });


        document.getElementById('btnVerVencidas').addEventListener('click', () => {
             const vencidas = [];
            tableBody.querySelectorAll('tr[data-id]').forEach(row => {
                const statusCell = row.cells[7];
                if (statusCell && statusCell.textContent === 'VENCIDA') {
                    const inspectionId = row.dataset.id;
                    const definition = allInspectionDefinitions.find(d => d.id === inspectionId);
                    if (definition) {
                        const lastHours = row.querySelector('.hours-input').value;
                        const lastDate = row.querySelector('.date-input').value;
                        const category = definition.category;
                        vencidas.push({ ...definition, lastHours, lastDate, category });
                    }
                }
            });

            if (vencidas.length > 0) {
                sessionStorage.setItem('vencidas', JSON.stringify(vencidas));
                sessionStorage.setItem('currentAcHrs', currentAcHrs);
                window.location.href = 'vencidas.html'; 
            } else {
                showToast('No hay inspecciones vencidas para mostrar.', 'info');
            }
        });

        document.getElementById('btnPrint').addEventListener('click', () => window.print());
        document.getElementById('btnRegresar').addEventListener('click', () => window.history.back());

        main();
    </script>
</body>
</html>

