<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado de Componentes FAH-980</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: linear-gradient(to bottom, #87CEEB 0%, #ADD8E6 100%);
            padding-top: 40px;
            overflow-x: hidden;
        }

        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 2.25rem;
            color: #2c3e50;
            margin-bottom: 2rem;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 1400px;
            margin-bottom: 20px;
            overflow-x: hidden;
        }

        .top-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            justify-content: center;
            width: 100%;
            max-width: 1400px;
        }

        .back-button, .print-all-button, .add-component-button {
            padding: 0.75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
            cursor: pointer;
        }

        .back-button:hover, .print-all-button:hover, .add-component-button:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }

        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .summary-card {
            background-color: #fefefe;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card h4 {
            font-weight: bold;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .summary-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .component-detail-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            width: 100%;
        }

        .component-card {
            background-color: #fefefe;
            border: 1px solid #e0e0e0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .component-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .component-card h4 {
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.75rem;
        }

        .component-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .component-info-grid p {
            font-size: 0.95rem;
            color: #555;
        }

        .component-info-grid p strong {
            color: #333;
        }

        .remaining-life-section {
            background-color: #eef2ff;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: auto;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #c7d2fe;
        }

        .remaining-red { color: #dc2626; }
        .remaining-orange { color: #ea580c; }
        .remaining-green { color: #16a34a; }
        .remaining-blue { color: #3b82f6; } /* Nuevo estilo para "Condición" */

        .month-year-selector, .search-area {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }

        .month-year-selector label, .search-area label {
            font-weight: bold;
            color: #2c3e50;
        }

        .month-year-selector select, .search-area input {
            padding: 0.6rem 1rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            background-color: #f8fafc;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .month-year-selector select:focus, .search-area input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .card-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 0.5rem;
        }

        .edit-button, .print-single-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .edit-button:hover, .print-single-button:hover {
            background-color: #2563eb;
        }

        dialog {
            border: none;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 90%;
            background-color: #ffffff;
            z-index: 1000;
        }

        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        dialog h3 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        dialog form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        dialog form div {
            display: flex;
            flex-direction: column;
        }

        dialog form label {
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: #444;
            font-size: 0.9rem;
        }

        dialog form input[type="text"],
        dialog form input[type="number"],
        dialog form input[type="date"],
        dialog form select {
            padding: 0.6rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            font-size: 0.95rem;
            background-color: #f8fafc;
        }

        dialog form input:focus,
        dialog form select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        dialog .form-buttons {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        dialog .form-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        dialog .form-buttons .save-button {
            background-color: #22c55e;
            color: white;
            border: none;
        }
        dialog .form-buttons .save-button:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
        }

        dialog .form-buttons .cancel-button {
            background-color: #ef4444;
            color: white;
            border: none;
        }
        dialog .form-buttons .cancel-button:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }

        @media (max-width: 640px) {
            dialog form {
                grid-template-columns: 1fr;
            }
            dialog .form-buttons {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 0.5rem;
            height: 1.2rem;
            overflow: hidden;
            margin-top: 1rem;
            border: 1px solid #ccc;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            background-size: 200% 100%;
            animation: flow 0.8s linear infinite;
        }

        /* Colores para la barra de progreso */
        .progress-red { 
            background-image: linear-gradient(90deg, #dc2626 0%, #ef4444 50%, #dc2626 100%);
        }
        .progress-orange { 
            background-image: linear-gradient(90deg, #ea580c 0%, #f97316 50%, #ea580c 100%);
        }
        .progress-green { 
            background-image: linear-gradient(90deg, #16a34a 0%, #22c55e 50%, #16a34a 100%);
        }
        .progress-blue { /* Nueva clase para la barra de progreso azul */
            background-image: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #3b82f6 100%);
        }

        @keyframes flow {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: -100% 0%;
            }
        }

        @media print {
            body {
                background: none;
                padding: 0;
                margin: 0;
                color: black;
            }
            .top-buttons, .month-year-selector, .search-area, .edit-button, .print-single-button, .add-component-button, dialog, .summary-section {
                display: none !important;
            }
            h2, h3 {
                color: black !important;
                text-align: center;
                margin-bottom: 1rem;
            }
            .container {
                box-shadow: none;
                border: none;
                padding: 0;
                width: 100%;
                max-width: none;
            }
            .summary-card {
                display: none !important;
            }
            .component-detail-section {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-top: 0;
            }
            .component-card {
                border: 1px solid #ccc;
                box-shadow: none;
                page-break-inside: avoid;
                margin-bottom: 1rem;
                padding: 1rem;
            }
            .component-card h4 {
                border-bottom: 1px solid #eee;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .component-info-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .remaining-life-section, .progress-bar-container {
                margin-top: 0.5rem;
                border: none;
                background-color: transparent;
            }
            .progress-bar-fill {
                background-image: none !important;
                background-color: #ddd !important;
                color: #333 !important;
                animation: none !important;
            }
            body.print-single-component .component-card:not(.print-this-one) {
                display: none !important;
            }
            body.print-single-component .component-card.print-this-one {
                display: block !important;
                width: 100%;
                margin: 0 auto;
            }
        }

    </style>
</head>
<body>
    <div class="top-buttons">
        <a href="HORAS980.HTML" class="back-button">Volver a Datos de Vuelo</a>
        <button id="printAllComponentsButton" class="print-all-button">Imprimir Todos los Componentes</button>
        <button id="addComponentButton" class="add-component-button">Agregar Componente</button>
    </div>
    <h2 class="mt-8">Estado de Componentes</h2>

    <div class="container">
        <h3 class="text-xl font-semibold mb-4 text-center" id="summaryHeading">Resumen de Totales del Mes (desde Datos de Vuelo)</h3>
        
        <div class="month-year-selector">
            <label for="monthSelect">Mes:</label>
            <select id="monthSelect"></select>
            <label for="yearSelect">Año:</label>
            <select id="yearSelect"></select>
        </div>

        <div id="generalSummary" class="summary-section">
            <p class="text-center text-gray-600 col-span-full">Cargando resumen del mes...</p>
        </div>

        <h3 class="text-xl font-semibold mb-4 mt-8 text-center">Detalle de Componentes Principales</h3>
        
        <div class="search-area">
            <input type="text" id="componentSearchInput" placeholder="Buscar componente por nombre, serie o parte..." class="rounded-md">
        </div>

        <div id="componentDetails" class="component-detail-section">
            <p class="text-center text-gray-600 col-span-full">Cargando detalles de componentes...</p>
        </div>
    </div>

    <!-- Diálogo de Edición de Componente -->
    <dialog id="editComponentDialog">
        <h3>Editar Componente</h3>
        <form id="editComponentForm">
            <input type="hidden" id="edit-serialNumber-hidden">

            <div>
                <label for="edit-name">Descripción:</label>
                <input type="text" id="edit-name" name="name">
            </div>
            <div>
                <label for="edit-partNumber">N° de Parte:</label>
                <input type="text" id="edit-partNumber" name="partNumber">
            </div>
            <div>
                <label for="edit-serialNumber">N° de Serie:</label>
                <input type="text" id="edit-serialNumber" name="serialNumber">
            </div>
            <div>
                <label for="edit-installationDate">Instalado:</label>
                <input type="date" id="edit-installationDate" name="installationDate">
            </div>
            <div>
                <label for="edit-location">Ubicación:</label>
                <input type="text" id="edit-location" name="location">
            </div>
            <div>
                <label for="edit-type">Tipo de Vida:</label>
                <select id="edit-type" name="type">
                    <option value="hours">Horas</option>
                    <option value="cycles">Ciclos</option>
                    <option value="months">Meses</option>
                    <option value="condition">Condición</option> <!-- Nueva opción -->
                </select>
            </div>

            <div class="col-span-2 grid grid-cols-3 gap-4">
                <div>
                    <label for="edit-currentTSNHours">TSN (Hrs):</label>
                    <input type="number" id="edit-currentTSNHours" name="currentTSNHours" step="0.1">
                </div>
                <div>
                    <label for="edit-currentTSNCycles">TSN (Ciclos):</label>
                    <input type="number" id="edit-currentTSNCycles" name="currentTSNCycles" step="0.1">
                </div>
                <div>
                    <label for="edit-currentTSNDays">TSN (Días/Meses):</label>
                    <input type="number" id="edit-currentTSNDays" name="currentTSNDays" step="0.1">
                </div>
            </div>

            <div class="col-span-2 grid grid-cols-3 gap-4">
                <div>
                    <label for="edit-currentTSOHours">TSO (Hrs):</label>
                    <input type="number" id="edit-currentTSOHours" name="currentTSOHours" step="0.1">
                </div>
                <div>
                    <label for="edit-currentTSOCycles">TSO (Ciclos):</label>
                    <input type="number" id="edit-currentTSOCycles" name="currentTSOCycles" step="0.1">
                </div>
                <div>
                    <label for="edit-currentTSODays">TSO (Días/Meses):</label>
                    <input type="number" id="edit-currentTSODays" name="currentTSODays" step="0.1">
                </div>
            </div>

            <div class="col-span-2 grid grid-cols-3 gap-4">
                <div>
                    <label for="edit-lifeLimitHours">Vida Límite (Hrs):</label>
                    <input type="number" id="edit-lifeLimitHours" name="lifeLimitHours" step="0.1">
                </div>
                <div>
                    <label for="edit-lifeLimitCycles">Vida Límite (Ciclos):</label>
                    <input type="number" id="edit-lifeLimitCycles" name="lifeLimitCycles" step="0.1">
                </div>
                <div>
                    <label for="edit-lifeLimitDays">Vida Límite (Días/Meses):</label>
                    <input type="number" id="edit-lifeLimitDays" name="lifeLimitDays" step="0.1">
                </div>
            </div>

            <div>
                <label for="edit-dueDateTT">Vencimiento (A LAS TT):</label>
                <input type="text" id="edit-dueDateTT" name="dueDateTT">
            </div>
            <div>
                <label for="edit-status">Estado:</label>
                <input type="text" id="edit-status" name="status">
            </div>
            <div>
                <label for="edit-lastInspectionDate">Última Inspección:</label>
                <input type="date" id="edit-lastInspectionDate" name="lastInspectionDate">
            </div>
            <div>
                <label for="edit-nextInspectionDue">Próxima Inspección:</label>
                <input type="date" id="edit-nextInspectionDue" name="nextInspectionDue">
            </div>

            <div class="form-buttons">
                <button type="button" class="cancel-button" id="cancelEditButton">Cancelar</button>
                <button type="submit" class="save-button">Guardar Cambios</button>
            </div>
        </form>
    </dialog>

    <script type="module">
        // Importa las funciones necesarias de Firebase SDK para Realtime Database
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // Configuración de Firebase (debe ser la misma que en HORAS980.HTML si la usas)
        const firebaseConfig = {
            apiKey: "AIzaSyC6pUgMRSRCZLZfW0Cy1b00AFN6nkPjsF8",
            authDomain: "fah-980-ceb96.firebaseapp.com",
            databaseURL: "https://fah-980-ceb96-default-rtdb.firebaseio.com",
            projectId: "fah-980-ceb96",
            storageBucket: "fah-980-ceb96.firebasestorage.app",
            messagingSenderId: "57890484294",
            appId: "1:57890484294:web:8a27759a4da0b262e99a47",
            measurementId: "G-HSZMRM7ZCS"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        const generalSummaryDiv = document.getElementById('generalSummary');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const componentDetailsDiv = document.getElementById('componentDetails');
        const componentSearchInput = document.getElementById('componentSearchInput');
        const printAllComponentsButton = document.getElementById('printAllComponentsButton');
        const addComponentButton = document.getElementById('addComponentButton'); // Nuevo botón

        // Referencias al diálogo y formulario de edición
        const editComponentDialog = document.getElementById('editComponentDialog');
        const editComponentForm = document.getElementById('editComponentForm');
        const cancelEditButton = document.getElementById('cancelEditButton');

        // Inputs del formulario de edición
        const editInputs = {
            serialNumberHidden: document.getElementById('edit-serialNumber-hidden'),
            name: document.getElementById('edit-name'),
            partNumber: document.getElementById('edit-partNumber'),
            serialNumber: document.getElementById('edit-serialNumber'),
            installationDate: document.getElementById('edit-installationDate'),
            location: document.getElementById('edit-location'),
            type: document.getElementById('edit-type'),
            currentTSNHours: document.getElementById('edit-currentTSNHours'),
            currentTSNCycles: document.getElementById('edit-currentTSNCycles'),
            currentTSNDays: document.getElementById('edit-currentTSNDays'),
            currentTSOHours: document.getElementById('edit-currentTSOHours'),
            currentTSOCycles: document.getElementById('edit-currentTSOCycles'),
            currentTSODays: document.getElementById('edit-currentTSODays'),
            lifeLimitHours: document.getElementById('edit-lifeLimitHours'),
            lifeLimitCycles: document.getElementById('edit-lifeLimitCycles'),
            lifeLimitDays: document.getElementById('edit-lifeLimitDays'),
            dueDateTT: document.getElementById('edit-dueDateTT'),
            status: document.getElementById('edit-status'),
            lastInspectionDate: document.getElementById('edit-lastInspectionDate'),
            nextInspectionDue: document.getElementById('edit-nextInspectionDue'),
        };

        // Define __app_id con un valor por defecto si no está definida
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Variables para el mes y año seleccionados
        let currentMonth = new Date().getMonth(); // 0-indexed (0 for January)
        let currentYear = new Date().getFullYear();

        // Variables globales para almacenar los totales mensuales
        let currentAcHrs = 0; 
        let currentRins = 0;

        const months = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];
        const years = Array.from({ length: 11 }, (_, i) => new Date().getFullYear() - 5 + i);

        // Contador global para números de serie de nuevos componentes generados
        let globalSerialCounter = 1;

        // Función para generar un nuevo componente con valores por defecto
        function generateComponent(name, partNumber = "GEN-PN", type = "hours", lifeLimit = 2000, currentTSN = 500, location = "General") {
            // Asegura que los valores predeterminados numéricos sean flotantes y tengan 1 decimal
            lifeLimit = parseFloat(lifeLimit.toFixed(1));
            currentTSN = parseFloat(currentTSN.toFixed(1));

            const serialNum = `FAH-${String(globalSerialCounter++).padStart(4, '0')}`;
            let lifeLimitHours = 0, lifeLimitCycles = 0, lifeLimitDays = 0;
            let currentTSNHours = 0, currentTSNCycles = 0, currentTSNDays = 0;
            let dueDateTT = "";

            if (type === "hours") {
                lifeLimitHours = lifeLimit;
                currentTSNHours = currentTSN;
                dueDateTT = `${lifeLimit} hrs`;
            } else if (type === "cycles") {
                lifeLimitCycles = lifeLimit;
                currentTSNCycles = currentTSN;
                dueDateTT = `${lifeLimit} ciclos`;
            } else if (type === "months") {
                lifeLimitDays = lifeLimit * 30; // Suponiendo 30 días por mes para el límite de vida
                currentTSNDays = currentTSN * 30; // Suponiendo 30 días por mes para el TSN
                dueDateTT = `${lifeLimit} meses`;
            } else if (type === "condition") { // Nueva condición
                lifeLimitHours = 0; // No aplica
                lifeLimitCycles = 0; // No aplica
                lifeLimitDays = 0; // No aplica
                currentTSNHours = 0; // No aplica
                currentTSNCycles = 0; // No aplica
                currentTSNDays = 0; // No aplica
                dueDateTT = "CONDICIÓN";
            }

            return {
                name: name,
                partNumber: partNumber,
                serialNumber: serialNum,
                installationDate: "2023-01-01", // Fecha de instalación por defecto
                location: location,
                type: type,
                currentTSNHours: parseFloat(currentTSNHours.toFixed(1)), // Asegura un decimal
                currentTSNCycles: parseFloat(currentTSNCycles.toFixed(1)), // Asegura un decimal
                currentTSNDays: parseFloat(currentTSNDays.toFixed(1)), // Asegura un decimal
                currentTSOHours: parseFloat(((type === "condition" ? 0 : currentTSNHours) * 0.2).toFixed(1)), // TSO como porcentaje del TSN, con un decimal
                currentTSOCycles: parseFloat(((type === "condition" ? 0 : currentTSNCycles) * 0.2).toFixed(1)),
                currentTSODays: parseFloat(((type === "condition" ? 0 : currentTSNDays) * 0.2).toFixed(1)),
                lifeLimitHours: parseFloat(lifeLimitHours.toFixed(1)), // Asegura un decimal
                lifeLimitCycles: parseFloat(lifeLimitCycles.toFixed(1)), // Asegura un decimal
                lifeLimitDays: parseFloat(lifeLimitDays.toFixed(1)), // Asegura un decimal
                dueDateTT: dueDateTT,
                status: "Operativo",
                lastInspectionDate: "2024-01-01",
                nextInspectionDue: "2025-01-01"
            };
        }

        // Lista inicial de componentes reconstruida exhaustivamente
        const initialPrincipalComponents = [
            generateComponent("M/R BLADE (RED)", "MRB-R", "hours", 5000, 4800, "Rotor Principal"),
            generateComponent("M/R BLADE (RED)", "MRB-R", "hours", 5000, 4750, "Rotor Principal"),
            generateComponent("M/R BLADE (BLUE)", "MRB-B", "hours", 5000, 3500, "Rotor Principal"),
            generateComponent("M/R BLADE (BLUE)", "MRB-B", "hours", 5000, 3450, "Rotor Principal"),
            generateComponent("M/R BLADE (ORANGE)", "MRB-O", "hours", 5000, 4100, "Rotor Principal"),
            generateComponent("M/R BLADE (ORANGE)", "MRB-O", "hours", 5000, 4050, "Rotor Principal"),
            generateComponent("M/R BLADE (GREEN)", "MRB-G", "hours", 5000, 1200, "Rotor Principal"),
            generateComponent("M/R BLADE (GREEN)", "MRB-G", "hours", 5000, 1150, "Rotor Principal"),
            
            generateComponent("BOLT EXPANDABLE", "BOLT-EXP", "cycles", 500, 450, "Varios"),
            generateComponent("BOLT EXPANDABLE", "BOLT-EXP", "cycles", 500, 400, "Varios"),
            generateComponent("BOLT EXPANDABLE", "BOLT-EXP", "cycles", 500, 350, "Varios"),
            generateComponent("BOLT EXPANDABLE", "BOLT-EXP", "cycles", 500, 300, "Varios"),
            
            generateComponent("BLADE BOLT ASSY", "BBA-PN", "cycles", 1000, 800, "Rotor Principal"),
            generateComponent("BLADE BOLT ASSY", "BBA-PN", "cycles", 1000, 750, "Rotor Principal"),
            generateComponent("BLADE BOLT ASSY", "BBA-PN", "cycles", 1000, 700, "Rotor Principal"),
            generateComponent("BLADE BOLT ASSY", "BBA-PN", "cycles", 1000, 650, "Rotor Principal"),
            
            generateComponent("M/R HUB ASSEMBLY", "MRH-A", "hours", 4000, 3900, "Principal"),
            generateComponent("M/R HUB ASSEMBLY", "MRH-B", "hours", 4000, 2800, "Principal"),
            generateComponent("YOKE ASSEMBLY", "YOKE-A", "hours", 2500, 1800, "Principal"),
            generateComponent("YOKE ASSEMBLY", "YOKE-B", "hours", 2500, 1500, "Principal"),
            generateComponent("SEAT, LOWER CONE", "SLC-PN", "hours", 1500, 500, "Tren de Aterrizaje"),
            generateComponent("PLATE ASSEMBLY", "PLATE-A", "hours", 1000, 300, "Estructura"),
            generateComponent("PLATE ASSEMBLY", "PLATE-B", "hours", 1000, 250, "Estructura"),
            generateComponent("SEAT, UPPER CONE", "SUC-PN", "hours", 1500, 600, "Tren de Aterrizaje"),
            
            ...Array(8).fill(null).map((_, i) => generateComponent("DRIVE PIN", `PIN-DR-${globalSerialCounter++}`, "cycles", 1000, 750 - (i * 50), "Tren de Aterrizaje")),
            ...Array(8).fill(null).map((_, i) => generateComponent("ARM ASSEMBLY", `ARM-A-${globalSerialCounter++}`, "hours", 1200, 500 - (i * 20), "Controles de Vuelo")),
            ...Array(16).fill(null).map((_, i) => generateComponent("BRACKET ASSEMBLY", `BRKT-A-${globalSerialCounter++}`, "hours", 1500, 600 - (i * 10), "Estructura")),
            ...Array(12).fill(null).map((_, i) => generateComponent("DAMPER BRIDGE ASSY", `DBA-PN-${globalSerialCounter++}`, "hours", 1500, 1200 - (i * 50), "Rotor Principal")),
            
            generateComponent("SPINDLE AND DAMPER BRG", "SDB-PN-1", "cycles", 800, 650, "Rotor Principal"),
            generateComponent("SPINDLE AND DAMPER BRG", "SDB-PN-2", "cycles", 800, 600, "Rotor Principal"),
            generateComponent("SPINDLE AND DAMPER BRG", "SDB-PN-3", "cycles", 800, 550, "Rotor Principal"),
            generateComponent("SPINDLE AND DAMPER BRG", "SDB-PN-4", "cycles", 800, 500, "Rotor Principal"),
            
            generateComponent("PITCH HORN ASSY", "PHA-PN-1", "hours", 1000, 700, "Rotor Principal"),
            generateComponent("PITCH HORN ASSY", "PHA-PN-2", "hours", 1000, 650, "Rotor Principal"),
            generateComponent("PITCH HORN ASSY", "PHA-PN-3", "hours", 1000, 600, "Rotor Principal"),
            generateComponent("PITCH HORN ASSY", "PHA-PN-4", "hours", 1000, 550, "Rotor Principal"),
            
            generateComponent("FITTING", "FIT-PN-1", "cycles", 700, 550, "Cola"),
            generateComponent("FITTING", "FIT-PN-2", "cycles", 700, 500, "Cola"),
            generateComponent("FITTING", "FIT-PN-3", "cycles", 700, 450, "Cola"),
            generateComponent("FITTING", "FIT-PN-4", "cycles", 700, 400, "Cola"),
            
            ...Array(4).fill(null).map((_, i) => generateComponent("BOLT, WEIGHT", `BW-PN-${globalSerialCounter++}`, "cycles", 500, 300 - (i * 20), "Varios")),
            ...Array(4).fill(null).map((_, i) => generateComponent("BOLT, ARM", `BA-PN-${globalSerialCounter++}`, "cycles", 500, 350 - (i * 20), "Varios")),
            ...Array(16).fill(null).map((_, i) => generateComponent("BOLT, BRACKET", `BB-PN-${globalSerialCounter++}`, "cycles", 500, 200 - (i * 10), "Varios")),
            
            generateComponent("BUSHING, YOKE", "BY-PN", "hours", 1000, 400, "Principal"),
            generateComponent("CAP", "CAP-PN", "months", 24, 12, "Varios"),
            generateComponent("CONE SUPERIOR", "CS-PN", "hours", 800, 300, "Tren de Aterrizaje"),
            generateComponent("CONE INFERIOR", "CI-PN", "hours", 800, 300, "Tren de Aterrizaje"),
            
            ...Array(8).fill(null).map((_, i) => generateComponent("CAM TO UPPER YOKE", `CTUY-PN-${globalSerialCounter++}`, "cycles", 1000, 600 - (i * 20), "Controles de Vuelo")),
            ...Array(8).fill(null).map((_, i) => generateComponent("UPPER YOKE TO CAM", `UYTC-PN-${globalSerialCounter++}`, "cycles", 1000, 550 - (i * 20), "Controles de Vuelo")),
            ...Array(4).fill(null).map((_, i) => generateComponent("CLEVIS TO CAM", `CTC-PN-${globalSerialCounter++}`, "cycles", 800, 400 - (i * 20), "Controles de Vuelo")),
            ...Array(4).fill(null).map((_, i) => generateComponent("CLEVIS ASSY TO LWR CONE", `CALC-PN-${globalSerialCounter++}`, "cycles", 800, 350 - (i * 20), "Controles de Vuelo")),
            
            generateComponent("CONTROL SYSTEM BOLTS", "CSB-PN", "hours", 2000, 800, "Controles de Vuelo"),
            
            ...Array(3).fill(null).map((_, i) => generateComponent("SUP. CONTROL SYST. BOLT", `SCSB-PN-${globalSerialCounter++}`, "hours", 1000, 400 - (i * 20), "Controles de Vuelo")),
            
            ...Array(4).fill(null).map((_, i) => generateComponent("M/R PITCH LINK ASSY", `MRPLA-PN-${globalSerialCounter++}`, "hours", 1200, 900 - (i * 50), "Rotor Principal")),
            ...Array(4).fill(null).map((_, i) => generateComponent("P/C LINK TUBE", `PCLT-PN-${globalSerialCounter++}`, "hours", 1000, 700 - (i * 50), "Rotor Principal")),
            ...Array(6).fill(null).map((_, i) => generateComponent("BEARING ROD END", `BRE-PN-${globalSerialCounter++}`, "cycles", 500, 300 - (i * 20), "Varios")),
            
            generateComponent("HUB & SLEEVE ASSY", "HSA-PN", "hours", 2000, 1800, "Controles de Vuelo"),
            generateComponent("SCISSORS HUB", "SHUB-PN", "hours", 1500, 1000, "Controles de Vuelo"),
            
            ...Array(5).fill(null).map((_, i) => generateComponent("LEVER DRIVER ASSY", `LDA-PN-${globalSerialCounter++}`, "hours", 1000, 700 - (i * 50), "Controles de Vuelo")),
            
            generateComponent("COLLECTIVE SLEEVE", "CSLEEVE-PN", "hours", 1500, 1200, "Controles de Vuelo"),
            
            generateComponent("SWASHPLATE LINK ASSY", "SLA-PN-1", "hours", 1000, 800, "Controles de Vuelo"),
            generateComponent("SWASHPLATE LINK ASSY", "SLA-PN-2", "hours", 1000, 750, "Controles de Vuelo"),

            generateComponent("LINK TUBE", "LTUBE-PN-1", "hours", 800, 500, "Controles de Vuelo"),
            generateComponent("LINK TUBE", "LTUBE-PN-2", "hours", 800, 450, "Controles de Vuelo"),

            generateComponent("SWASHPLATE & SUPPORT", "SSA-PN", "hours", 3200, 2900, "Controles de Vuelo"),
            generateComponent("GIMBAL RING", "GRING-PN", "hours", 2500, 1800, "Controles de Vuelo"),
            generateComponent("OUTER RING", "ORING-PN", "hours", 2500, 1700, "Controles de Vuelo"),
            generateComponent("SUPPORT ASSY", "SUPA-PN", "hours", 2000, 1500, "Controles de Vuelo"),
            generateComponent("COLLECTIVE LEVER", "CL-PN-1", "hours", 1500, 1000, "Controles de Vuelo"),
            generateComponent("COLLECTIVE LEVER", "CL-PN-2", "hours", 1500, 950, "Controles de Vuelo"),
            
            generateComponent("MAST ASSEMBLY", "MAST-A-1", "hours", 4500, 3800, "Estructura"),
            generateComponent("MAST ASSEMBLY", "MAST-A-2", "hours", 4500, 3600, "Estructura"),
            generateComponent("MAST ASSEMBLY", "MAST-A-3", "hours", 4500, 3400, "Estructura"),
            generateComponent("MAST POLE", "MP-PN-1", "hours", 4500, 3800, "Estructura"),
            generateComponent("MAST POLE", "MP-PN-2", "hours", 4500, 3600, "Estructura"),
            
            generateComponent("TRANSMISSION ASSY", "TX-A", "hours", 8000, 6800, "Transmisión"),
            generateComponent("TRANSMISSION ASSY", "TX-B", "hours", 6000, 5200, "Transmisión"),
            
            generateComponent("QUILL ASSY. HYD. DRIVE", "QAHD-PN", "hours", 1000, 700, "Transmisión"),
            generateComponent("QUILL ASSEMBLY", "QA-A", "hours", 3000, 2500, "Transmisión"), 
            generateComponent("QUILL ASSEMBLY", "QA-B", "hours", 3000, 2800, "Transmisión"),
            generateComponent("SPIDER", "SPIDER-PN-1", "cycles", 1000, 700, "Transmisión"),
            generateComponent("SPIDER", "SPIDER-PN-2", "cycles", 1000, 650, "Transmisión"),
            generateComponent("ROTOR BRAKE QUILL", "RBQ-PN", "hours", 1500, 800, "Transmisión"),
            generateComponent("DRIVESHAFT ASSY", "DS-A", "hours", 4000, 3200, "Transmisión"),
            
            generateComponent("HYDRAULIC CYLINDER ASSY", "HCA-A", "hours", 2500, 2000, "Controles de Vuelo"),
            generateComponent("HYDRAULIC CYLINDER ASSY", "HCA-B", "hours", 2500, 2300, "Controles de Vuelo"),
            generateComponent("HYDRAULIC CYLINDER ASSY", "HCA-C", "hours", 2500, 1500, "Controles de Vuelo"),
            
            generateComponent("HYD. SERVO ACTUATOR", "HSA-PN", "hours", 3000, 2500, "Controles de Vuelo"),
            
            ...Array(6).fill(null).map((_, i) => generateComponent("HANGER ASSY", `HA-PN-${globalSerialCounter++}`, "hours", 2200, 1800 - (i * 50), "Transmisión")),
            
            ...Array(4).fill(null).map((_, i) => generateComponent("T/R DRIVESHAFT COUPLING", `TRDC-PN-${globalSerialCounter++}`, "hours", 1000, 700 - (i * 50), "Transmisión")),
            
            generateComponent("42 GEARBOX", "42GB-PN-1", "hours", 3000, 2000, "Transmisión"),
            generateComponent("42 GEARBOX", "42GB-PN-2", "hours", 3000, 1800, "Transmisión"),
            generateComponent("90 GEARBOX", "90GB-PN-1", "hours", 3500, 2500, "Rotor de Cola"), 
            generateComponent("90 GEARBOX", "90GB-PN-2", "hours", 3500, 2400, "Rotor de Cola"),
            
            generateComponent("T/R HUB ASSY", "TRHA-PN", "hours", 2000, 1500, "Rotor de Cola"),
            generateComponent("T/R YOKE IDLER ASSY", "TRYIA-PN", "hours", 1500, 1000, "Rotor de Cola"),
            generateComponent("LEVER ASSY", "LVR-PN", "hours", 1200, 800, "Rotor de Cola"),
            generateComponent("T/R RETENTION NUT", "TRRN-PN", "months", 36, 24, "Rotor de Cola"),
            generateComponent("CROSSHEAD LINK ASSY", "CHLA-PN", "hours", 1000, 700, "Rotor de Cola"),
            
            generateComponent("T/R BLADE", "TRB-PN-1", "hours", 3000, 2500, "Rotor de Cola"),
            generateComponent("T/R BLADE", "TRB-PN-2", "hours", 3000, 2700, "Rotor de Cola"),
            
            generateComponent("FIRE EXTINGUISHER # 1", "FE-A01-1", "months", 60, 48, "Cabina"),
            generateComponent("FIRE EXTINGUISHER # 1", "FE-A01-2", "months", 60, 55, "Cabina"),
            
            generateComponent("CARTRIDGE", "CART-A01-1", "months", 60, 48, "Cabina"),
            generateComponent("CARTRIDGE", "CART-A01-2", "months", 60, 55, "Cabina"),
            generateComponent("CARTRIDGE", "CART-A02-1", "months", 60, 49, "Cabina"), 
            generateComponent("CARTRIDGE", "CART-A02-2", "months", 60, 56, "Cabina"), 

            generateComponent("FIRE EXTINGUISHER # 2", "FE-A02-1", "months", 60, 48, "Cabina"),
            generateComponent("FIRE EXTINGUISHER # 2", "FE-A02-2", "months", 60, 55, "Cabina"),
            
            generateComponent("STARTER GENERATOR # 1", "SG-B01-1", "hours", 1500, 1200, "Motor 1"),
            generateComponent("STARTER GENERATOR # 2", "SG-B01-2", "hours", 1500, 1400, "Motor 2"),
            
            generateComponent("BLOWER OIL COOLER BEARING", "BOCB-C01-1", "cycles", 800, 650, "Motor 1"),
            generateComponent("BLOWER OIL COOLER BEARING", "BOCB-C01-2", "cycles", 800, 780, "Motor 2"),
            generateComponent("BLOWER OIL COOLER BEARING", "BOCB-C01-3", "cycles", 800, 660, "Motor 1"), 
            generateComponent("BLOWER OIL COOLER BEARING", "BOCB-C01-4", "cycles", 800, 790, "Motor 2"),

            generateComponent("ENGINE PT6T-3B # 1", "PT6T-3B-1", "hours", 3600, 3000, "Motor 1"),
            generateComponent("ENGINE PT6T-3B # 2", "PT6T-3B-2", "hours", 3600, 3050, "Motor 2"), 

            generateComponent("MANUAL FUEL CONTROL", "MFC-D01-1A", "hours", 2000, 1600, "Motor 1"),
            generateComponent("MANUAL FUEL CONTROL", "MFC-D01-1B", "hours", 2000, 1550, "Motor 1"),
            generateComponent("MANUAL FUEL CONTROL", "MFC-D01-2A", "hours", 2000, 1500, "Motor 2"),
            generateComponent("MANUAL FUEL CONTROL", "MFC-D01-2B", "hours", 2000, 1450, "Motor 2"),

            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-1A", "hours", 2000, 1800, "Motor 1"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-1B", "hours", 2000, 1950, "Motor 1"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-1C", "hours", 2000, 1500, "Motor 1"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-1D", "hours", 2000, 1700, "Motor 1"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-2A", "hours", 2000, 1750, "Motor 2"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-2B", "hours", 2000, 1900, "Motor 2"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-2C", "hours", 2000, 1400, "Motor 2"),
            generateComponent("AUTOMATIC FUEL CONTROL", "AFC-E01-2D", "hours", 2000, 1650, "Motor 2"),
            
            generateComponent("FUEL PUMP", "FP-F01-1A", "hours", 1800, 1500, "Motor 1"),
            generateComponent("FUEL PUMP", "FP-F01-1B", "hours", 1800, 1480, "Motor 1"),
            generateComponent("FUEL PUMP", "FP-F01-2A", "hours", 1800, 1450, "Motor 2"),
            generateComponent("FUEL PUMP", "FP-F01-2B", "hours", 1800, 1430, "Motor 2"),

            generateComponent("OIL TO FUEL HEATER", "OFH-G01-1A", "hours", 1800, 1700, "Motor 1"),
            generateComponent("OIL TO FUEL HEATER", "OFH-G01-1B", "hours", 1800, 1650, "Motor 1"),
            generateComponent("OIL TO FUEL HEATER", "OFH-G01-2A", "hours", 1800, 1600, "Motor 2"),
            generateComponent("OIL TO FUEL HEATER", "OFH-G01-2B", "hours", 1800, 1580, "Motor 2"),

            generateComponent("BLEED VALVE", "BV-H01-1A", "hours", 1200, 900, "Motor 1"),
            generateComponent("BLEED VALVE", "BV-H01-1B", "hours", 1200, 880, "Motor 1"),
            generateComponent("BLEED VALVE", "BV-H01-2A", "hours", 1200, 850, "Motor 2"),
            generateComponent("BLEED VALVE", "BV-H01-2B", "hours", 1200, 830, "Motor 2"),

            generateComponent("FLOW DIVIDER", "FD-I01-1A", "hours", 1200, 1100, "Motor 1"),
            generateComponent("FLOW DIVIDER", "FD-I01-1B", "hours", 1200, 1080, "Motor 1"),
            generateComponent("FLOW DIVIDER", "FD-I01-2A", "hours", 1200, 1050, "Motor 2"),
            generateComponent("FLOW DIVIDER", "FD-I01-2B", "hours", 1200, 1030, "Motor 2"),

            generateComponent("FUEL SURGE ACCUMULATOR", "FSA-J01-1A", "hours", 1000, 800, "Motor 1"),
            generateComponent("FUEL SURGE ACCUMULATOR", "FSA-J01-1B", "hours", 1000, 780, "Motor 1"),
            generateComponent("FUEL SURGE ACCUMULATOR", "FSA-J01-2A", "hours", 1000, 750, "Motor 2"),
            generateComponent("FUEL SURGE ACCUMULATOR", "FSA-J01-2B", "hours", 1000, 730, "Motor 2"),

            generateComponent("TRIM COMPENSATOR", "TC-K01-1A", "hours", 1000, 950, "Motor 1"),
            generateComponent("TRIM COMPENSATOR", "TC-K01-1B", "hours", 1000, 930, "Motor 1"),
            generateComponent("TRIM COMPENSADOR", "TC-K01-2A", "hours", 1000, 900, "Motor 2"), 
            generateComponent("TRIM COMPENSADOR", "TC-K01-2B", "hours", 1000, 880, "Motor 2"),

            generateComponent("IGNITION EXCITER", "IE-L01-1A", "cycles", 500, 400, "Motor 1"),
            generateComponent("IGNITION EXCITER", "IE-L01-1B", "cycles", 500, 390, "Motor 1"),
            generateComponent("IGNITION EXCITER", "IE-L01-2A", "cycles", 500, 380, "Motor 2"),
            generateComponent("IGNITION EXCITER", "IE-L01-2B", "cycles", 500, 370, "Motor 2"),

            generateComponent("IGNITION CABLE (2)", "IC-M01-1A", "cycles", 500, 480, "Motor 1"),
            generateComponent("IGNITION CABLE (2)", "IC-M01-1B", "cycles", 500, 470, "Motor 1"),
            generateComponent("IGNITION CABLE (2)", "IC-M01-2A", "cycles", 500, 450, "Motor 2"),
            generateComponent("IGNITION CABLE (2)", "IC-M01-2B", "cycles", 500, 440, "Motor 2"),
            
            generateComponent("DISK- STG 1 P.T.", "DS1PT-N01-1A", "cycles", 2500, 2000, "Motor 1"),
            generateComponent("DISK- STG 1 P.T.", "DS1PT-N01-1B", "cycles", 2500, 2300, "Motor 1"),
            generateComponent("DISK- STG 1 P.T.", "DS1PT-N01-2A", "cycles", 2500, 1900, "Motor 2"),
            generateComponent("DISK- STG 1 P.T.", "DS1PT-N01-2B", "cycles", 2500, 2200, "Motor 2"),
            
            generateComponent("IMPELLER", "IMP-O01-1A", "cycles", 2000, 1600, "Motor 1"),
            generateComponent("IMPELLER", "IMP-O01-1B", "cycles", 2000, 1580, "Motor 1"),
            generateComponent("IMPELLER", "IMP-O01-2A", "cycles", 2000, 1550, "Motor 2"),
            generateComponent("IMPELLER", "IMP-O01-2B", "cycles", 2000, 1530, "Motor 2"),

            generateComponent("DISK- STG 3 COMPRESSOR", "DS3C-P01-1A", "cycles", 2000, 1800, "Motor 1"),
            generateComponent("DISK- STG 3 COMPRESSOR", "DS3C-P01-1B", "cycles", 2000, 1780, "Motor 1"),
            generateComponent("DISK- STG 3 COMPRESSOR", "DS3C-P01-2A", "cycles", 2000, 1750, "Motor 2"),
            generateComponent("DISK- STG 3 COMPRESSOR", "DS3C-P01-2B", "cycles", 2000, 1730, "Motor 2"),

            generateComponent("DISK- STG 2 COMPRESSOR", "DS2C-Q01-1A", "cycles", 2000, 1950, "Motor 1"),
            generateComponent("DISK- STG 2 COMPRESSOR", "DS2C-Q01-1B", "cycles", 2000, 1920, "Motor 1"),
            generateComponent("DISK- STG 2 COMPRESSOR", "DS2C-Q01-2A", "cycles", 2000, 1850, "Motor 2"),
            generateComponent("DISK- STG 2 COMPRESSOR", "DS2C-Q01-2B", "cycles", 2000, 1820, "Motor 2"),

            generateComponent("REAR HUB", "RH-R01-1A", "cycles", 1500, 1200, "Motor 1"),
            generateComponent("REAR HUB", "RH-R01-1B", "cycles", 1500, 1400, "Motor 1"),
            generateComponent("REAR HUB", "RH-R01-2A", "cycles", 1500, 1150, "Motor 2"),
            generateComponent("REAR HUB", "RH-R01-2B", "cycles", 1500, 1350, "Motor 2"),
            
            generateComponent("DISK- COMPRESSOR TURBINE", "DCT-S01-1A", "cycles", 1800, 1500, "Motor 1"),
            generateComponent("DISK- COMPRESSOR TURBINE", "DCT-S01-1B", "cycles", 1800, 1450, "Motor 1"),
            generateComponent("DISK- COMPRESSOR TURBINE", "DCT-S01-2A", "cycles", 1800, 1400, "Motor 2"),
            generateComponent("DISK- COMPRESSOR TURBINE", "DCT-S01-2B", "cycles", 1800, 1350, "Motor 2"),
            
            generateComponent("COMBINING GEARBOX", "CGB-T01", "hours", 4000, 3200, "Transmisión Central"),
            generateComponent("NF GOVERNOR # 1", "NFG-U01-1", "hours", 1500, 1200, "Motor 1"),
            generateComponent("NF GOVERNOR # 2", "NFG-U01-2", "hours", 1500, 1400, "Motor 2"),
            generateComponent("TORQUE CONTROL UNIT", "TCU-V01", "hours", 1200, 900, "Motor"),
            generateComponent("AFT CROSSTUBE", "ACT-W01", "hours", 2500, 2000, "Estructura"),
            generateComponent("MOTOR & BLADE ASSY #1", "MBA-X01-1", "hours", 1000, 800, "Tren de Aterrizaje"),
            generateComponent("MOTOR & BLADE ASSY #2", "MBA-X01-2", "hours", 1000, 950, "Tren de Aterrizaje"),
            generateComponent("SPEED REDUCER BEARING", "SRB-Y01", "cycles", 800, 650, "Transmisión"),
            generateComponent("COMPRESSOR ASSY", "CA-Z01", "hours", 1800, 1500, "Motor"),
            generateComponent("ARTEX 406 ELT BATTERY", "ELT-AA01-1", "months", 12, 10, "Aviónica"),
            generateComponent("ARTEX 406 ELT BATTERY", "ELT-AA01-2", "months", 12, 5, "Aviónica"),
            // Nuevos componentes de tipo "condicion" para demostración
            generateComponent("SENSOR DE PRESIÓN", `SEN-P-COND-${globalSerialCounter++}`, "condition", 0, 0, "Motor"),
            generateComponent("VÁLVULA DE CIERRE", `VALV-C-COND-${globalSerialCounter++}`, "condition", 0, 0, "Combustible"),
            generateComponent("INDICADOR DE TEMPERATURA", `IND-T-COND-${globalSerialCounter++}`, "condition", 0, 0, "Cabina"),
        ];


        // Variable para almacenar los componentes cargados desde Firebase
        let principalComponents = [];


        /**
         * Calcula la vida restante de un componente basándose en su tipo principal.
         * @param {object} component - El objeto del componente.
         * @returns {number|string} Vida restante calculada o un marcador para "condicion".
         */
        function calculateRemainingLife(component) {
            // Asegúrate de que el componente sea válido
            if (!component) return 0;

            if (component.type === "condition") { // Nuevo tipo "condition"
                return "CONDICION_TYPE"; // Marcador especial para "condición"
            }

            let totalLife = 0;
            let currentLife = 0;
            let remaining = 0;

            // Usa parseFloat y toFixed(1) para manejar decimales consistentemente
            if (component.type === "hours") {
                totalLife = parseFloat(component.lifeLimitHours) || 0;
                currentLife = currentAcHrs; // Horas acumuladas del helicóptero (ya es float)
                remaining = totalLife - currentLife; 
            } else if (component.type === "cycles") {
                totalLife = parseFloat(component.lifeLimitCycles) || 0;
                currentLife = currentRins; // RINS acumulados del helicóptero (ya es float)
                remaining = totalLife - currentLife; 
            } else if (component.type === "months") { 
                totalLife = parseFloat(component.lifeLimitDays) || 0; // Se asume que lifeLimitDays es el total de días de vida útil
                if (component.installationDate) {
                    const today = new Date();
                    const installationDate = new Date(component.installationDate);
                    // Calcula los días transcurridos desde la instalación
                    const timeDiff = today.getTime() - installationDate.getTime();
                    currentLife = parseFloat((timeDiff / (1000 * 60 * 60 * 24)).toFixed(1)); // Convertir a float y redondear
                    remaining = Math.max(0, totalLife - currentLife);
                } else {
                    remaining = totalLife; // Si no hay fecha de instalación, se asume vida completa restante
                }
            }
            return parseFloat(remaining.toFixed(1)); // Devuelve con un decimal
        }

        /**
         * Determina la clase de color para el valor restante.
         * @param {number|string} remaining - Vida restante actual o el marcador "CONDICION_TYPE".
         * @param {number} totalLife - Vida útil total del componente.
         * @returns {string} Clase CSS para el color.
         */
        function getRemainingColorClass(remaining, totalLife) {
            if (remaining === "CONDICION_TYPE") { // Maneja el tipo "condition"
                return 'remaining-blue'; // Nueva clase para color azul
            }
            if (totalLife === 0) return '';

            if (remaining <= 0) { 
                return 'remaining-red';
            } else {
                const percentageOfTotalLifeRemaining = (remaining / totalLife) * 100; 
                if (percentageOfTotalLifeRemaining < 20) {
                    return 'remaining-orange';
                } else {
                    return 'remaining-green';
                }
            }
        }

        /**
         * Calcula el porcentaje de vida consumida para la barra de progreso.
         * @param {object} component - El objeto del componente.
         * @returns {number} Porcentaje de vida consumida (0-100).
         */
        function calculateConsumedLifePercentage(component) {
            if (!component) return 0;

            if (component.type === "condition") { // Nuevo tipo "condition"
                return 100; // Siempre mostrar barra llena para "condición"
            }

            let totalLife = 0;
            let currentConsumed = 0;

            if (component.type === "hours") {
                totalLife = parseFloat(component.lifeLimitHours) || 0;
                currentConsumed = currentAcHrs;
            } else if (component.type === "cycles") {
                totalLife = parseFloat(component.lifeLimitCycles) || 0;
                currentConsumed = currentRins;
            } else if (component.type === "months") {
                totalLife = parseFloat(component.lifeLimitDays) || 0;
                if (component.installationDate) {
                    const today = new Date();
                    const installationDate = new Date(component.installationDate);
                    const timeDiff = today.getTime() - installationDate.getTime();
                    currentConsumed = parseFloat((timeDiff / (1000 * 60 * 60 * 24)).toFixed(1)); // Convertir a float y redondear
                }
            }

            if (totalLife === 0) return 0;
            return Math.min(100, Math.max(0, (currentConsumed / totalLife) * 100));
        }

        // Función para poblar los selectores de mes y año
        function populateMonthYearSelectors() {
            monthSelect.innerHTML = '';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                if (index === currentMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });

            yearSelect.innerHTML = '';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });

            monthSelect.addEventListener('change', (event) => {
                currentMonth = parseInt(event.target.value);
                loadMonthlyTotalsFromFirebase();
            });
            yearSelect.addEventListener('change', (event) => {
                currentYear = parseInt(event.target.value);
                loadMonthlyTotalsFromFirebase();
            });
        }

        // Función para cargar los totales mensuales desde Firebase Realtime Database
        function loadMonthlyTotalsFromFirebase() {
            const rutaDatosMes = `artifacts/${appId}/public_data/datos_vuelo/${currentYear}/${currentMonth}`;

            onValue(ref(database, rutaDatosMes), (snapshot) => {
                let monthlyTotals = { 'AC HRS': "0", 'ATERRIZAJES': "0", 'RINS': "0" };

                if (snapshot.exists()) {
                    const fetchedData = snapshot.val();
                    console.log(`Datos brutos de Firebase para ${months[currentMonth]} ${currentYear} (desde ${rutaDatosMes}):`, fetchedData);

                    if (Array.isArray(fetchedData) && fetchedData[0] && fetchedData[0][34] !== undefined) {
                        currentAcHrs = parseFloat(fetchedData[0][34]) || 0;
                        monthlyTotals['AC HRS'] = fetchedData[0][34];
                    } else {
                        console.warn("Datos para AC HRS no encontrados o en formato inesperado.");
                        currentAcHrs = 0;
                    }
                    if (Array.isArray(fetchedData) && fetchedData[1] && fetchedData[1][34] !== undefined) {
                        monthlyTotals['ATERRIZAJES'] = fetchedData[1][34];
                    } else {
                        console.warn("Datos para ATERRIZAJES no encontrados o en formato inesperado.");
                    }
                    if (Array.isArray(fetchedData) && fetchedData[2] && fetchedData[2][34] !== undefined) {
                        currentRins = parseFloat(fetchedData[2][34]) || 0;
                        monthlyTotals['RINS'] = fetchedData[2][34];
                    } else {
                        console.warn("Datos para RINS no encontrados o en formato inesperado.");
                        currentRins = 0;
                    }
                } else {
                    console.log(`No se encontraron datos para ${months[currentMonth]} ${currentYear} en Firebase Realtime Database.`);
                    currentAcHrs = 0;
                    currentRins = 0;
                }

                const totalsToRender = [
                    { name: "AC HRS", current: monthlyTotals['AC HRS'], type: "monthly_total" },
                    { name: "ATERRIZAJES", current: monthlyTotals['ATERRIZAJES'], type: "monthly_total" },
                    { name: "RINS", current: monthlyTotals['RINS'], type: "monthly_total" },
                    { name: "FECHA ACTUAL", current: new Date().toLocaleDateString('es-ES'), type: "current_date" }
                ];
                renderSummary(totalsToRender);
                filterAndRenderComponents();
            }, (error) => {
                console.error("Error al cargar los totales del mes desde Firebase Realtime Database:", error);
                generalSummaryDiv.innerHTML = `<p class="text-center text-red-600 col-span-full">Error al cargar los datos: ${error.message}</p>`;
            });
        }

        // Función para renderizar el resumen
        function renderSummary(data) {
            if (data.length === 0) {
                generalSummaryDiv.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay datos disponibles para el resumen.</p>';
                return;
            }

            generalSummaryDiv.innerHTML = '';
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                card.innerHTML = `
                    <h4>${item.name}</h4>
                    <p class="value">${item.current}</p>
                `;
                generalSummaryDiv.appendChild(card);
            });
        }

        // Función para cargar los componentes desde Firebase
        function loadComponentsFromFirebase() {
            const componentsRef = ref(database, `artifacts/${appId}/public_data/components`);
            
            onValue(componentsRef, (snapshot) => {
                let fetchedComponents = [];
                if (snapshot.exists()) {
                    const componentsObject = snapshot.val();
                    // Verificar si componentsObject es un objeto iterable con propiedades esperadas
                    if (typeof componentsObject === 'object' && componentsObject !== null && !Array.isArray(componentsObject)) {
                        fetchedComponents = Object.keys(componentsObject)
                                                  .map(key => componentsObject[key])
                                                  .filter(component => component && component.serialNumber); // Filtra nulos/indefinidos y componentes sin serial
                    } else {
                        console.warn("Datos de componentes en Firebase en formato inesperado o vacío:", componentsObject);
                    }
                }

                if (fetchedComponents.length > 0) {
                    principalComponents = fetchedComponents;
                    console.log("Componentes cargados desde Firebase:", principalComponents.length); // Muestra el número de componentes
                    // Encontrar el número de serie más alto para el contador global
                    const maxSerial = principalComponents.reduce((max, comp) => {
                        const serialNumMatch = comp.serialNumber ? comp.serialNumber.match(/FAH-(\d+)/) : null;
                        return serialNumMatch ? Math.max(max, parseInt(serialNumMatch[1])) : max;
                    }, 0);
                    globalSerialCounter = maxSerial + 1; // Establece el contador al siguiente número disponible
                    filterAndRenderComponents();
                } else {
                    console.log("No se encontraron componentes válidos en Firebase o los datos estaban vacíos/malformados. Inicializando con datos predefinidos...");
                    // Reinicializar la base de datos con la lista completa y correcta
                    principalComponents = initialPrincipalComponents;
                    const updates = {};
                    // Reiniciar el contador global para la inicialización
                    globalSerialCounter = 1; 
                    initialPrincipalComponents.forEach(comp => {
                        // Regenerar el serial para los componentes iniciales si el contador global fue reseteado
                        const newComp = { ...comp, serialNumber: `FAH-${String(globalSerialCounter++).padStart(4, '0')}` };
                        if (newComp.serialNumber) { 
                            updates[newComp.serialNumber] = newComp;
                        }
                    });

                    set(componentsRef, updates)
                        .then(() => {
                            console.log("Datos iniciales de componentes guardados en Firebase.");
                            filterAndRenderComponents();
                        })
                        .catch((error) => {
                            console.error("Error al guardar los datos iniciales de componentes:", error);
                            componentDetailsDiv.innerHTML = `<p class="text-center text-red-600 col-span-full">Error al inicializar componentes: ${error.message}</p>`;
                        });
                }
            }, (error) => {
                console.error("Error al cargar los componentes desde Firebase:", error);
                componentDetailsDiv.innerHTML = `<p class="text-center text-red-600 col-span-full">Error al cargar componentes: ${error.message}</p>`;
            });
        }


        /**
         * Abre el diálogo de edición y precarga los datos del componente.
         * @param {object} component - El objeto del componente a editar.
         */
        function openEditDialog(component = null) { // Permite llamar sin componente para "Agregar"
            // Limpiar el formulario antes de cargar nuevos datos o vaciarlo para un nuevo componente
            editComponentForm.reset(); 
            editInputs.serialNumberHidden.value = ''; // Borra el serial oculto por si es un nuevo componente

            if (component) {
                // Si se pasa un componente, precarga sus datos para edición
                editInputs.serialNumberHidden.value = component.serialNumber || '';
                editInputs.name.value = component.name || '';
                editInputs.partNumber.value = component.partNumber || '';
                editInputs.serialNumber.value = component.serialNumber || '';
                editInputs.installationDate.value = component.installationDate || '';
                editInputs.location.value = component.location || '';
                editInputs.type.value = component.type || 'hours';

                // Asegura que los valores numéricos se muestren como flotantes (sin toFixed aquí, solo parseFloat)
                editInputs.currentTSNHours.value = parseFloat(component.currentTSNHours) || 0;
                editInputs.currentTSNCycles.value = parseFloat(component.currentTSNCycles) || 0;
                editInputs.currentTSNDays.value = parseFloat(component.currentTSNDays) || 0;
                editInputs.currentTSOHours.value = parseFloat(component.currentTSOHours) || 0;
                editInputs.currentTSOCycles.value = parseFloat(component.currentTSOCycles) || 0;
                editInputs.currentTSODays.value = parseFloat(component.currentTSODays) || 0;
                editInputs.lifeLimitHours.value = parseFloat(component.lifeLimitHours) || 0;
                editInputs.lifeLimitCycles.value = parseFloat(component.lifeLimitCycles) || 0;
                editInputs.lifeLimitDays.value = parseFloat(component.lifeLimitDays) || 0;

                editInputs.dueDateTT.value = component.dueDateTT || '';
                editInputs.status.value = component.status || '';
                editInputs.lastInspectionDate.value = component.lastInspectionDate || '';
                editInputs.nextInspectionDue.value = component.nextInspectionDue || '';

                editComponentDialog.querySelector('h3').textContent = 'Editar Componente';

                // Deshabilitar/habilitar campos según el tipo de vida existente
                toggleNumericFields(component.type === 'condition');
            } else {
                // Si no se pasa componente, prepara para un nuevo componente
                editComponentDialog.querySelector('h3').textContent = 'Agregar Nuevo Componente';
                editInputs.type.value = 'hours'; // Por defecto, Horas
                editInputs.serialNumber.value = `FAH-${String(globalSerialCounter).padStart(4, '0')}`; // Nuevo serial sugerido
                editInputs.installationDate.valueAsDate = new Date(); // Fecha actual
                editInputs.lastInspectionDate.valueAsDate = new Date(); // Fecha actual
                editInputs.nextInspectionDue.valueAsDate = new Date(new Date().setFullYear(new Date().getFullYear() + 1)); // Un año en el futuro

                // Asegurarse de que los campos numéricos estén habilitados por defecto para "hours"
                toggleNumericFields(false);
                editInputs.dueDateTT.value = ""; // Limpiar el vencimiento
            }

            editComponentDialog.showModal();
        }

        /**
         * Habilita o deshabilita los campos numéricos del formulario.
         * @param {boolean} disable - Si es true, los campos se deshabilitan; si es false, se habilitan.
         */
        function toggleNumericFields(disable) {
            const fieldsToToggle = [
                'currentTSNHours', 'currentTSNCycles', 'currentTSNDays',
                'currentTSOHours', 'currentTSOCycles', 'currentTSODays',
                'lifeLimitHours', 'lifeLimitCycles', 'lifeLimitDays'
            ];

            fieldsToToggle.forEach(field => {
                editInputs[field].disabled = disable;
                if (disable) {
                    editInputs[field].value = 0; // Opcional: poner a 0 si se deshabilita
                }
            });

            editInputs.dueDateTT.disabled = disable;
            if (disable) {
                editInputs.dueDateTT.value = "CONDICIÓN";
            } else {
                // Si se habilita, restaurar el valor si no es un componente nuevo, o dejar vacío
                // Para esto, necesitaríamos guardar el valor original antes de deshabilitar
                // Por ahora, simplemente lo limpio si se vuelve a habilitar, para un nuevo componente.
                // En edición, el valor se cargaría desde 'component' nuevamente.
                if (!editInputs.serialNumberHidden.value) { // Si es un nuevo componente
                    editInputs.dueDateTT.value = "";
                }
            }
        }

        /**
         * Maneja el envío del formulario de edición para guardar los cambios en Firebase.
         * @param {Event} event - El evento de envío del formulario.
         */
        async function saveEditedComponent(event) {
            event.preventDefault();

            const oldSerialNumber = editInputs.serialNumberHidden.value; // Será vacío para nuevos componentes
            let newSerialNumber = editInputs.serialNumber.value.trim(); 

            if (!newSerialNumber) {
                console.error("Error: El número de serie no puede estar vacío. Por favor, introduce un valor.");
                return; 
            }

            // Asegurar que el nuevo serial no sea un duplicado si estamos agregando uno nuevo
            if (!oldSerialNumber && principalComponents.some(comp => comp.serialNumber === newSerialNumber)) {
                console.error("Error: El número de serie ya existe. Por favor, elige uno diferente.");
                return;
            }

            const selectedType = editInputs.type.value;

            const updatedComponentData = {
                name: editInputs.name.value.trim() || '', 
                partNumber: editInputs.partNumber.value.trim() || '',
                serialNumber: newSerialNumber, 
                installationDate: editInputs.installationDate.value || '',
                location: editInputs.location.value.trim() || '',
                type: selectedType,
                
                // Usar parseFloat para permitir decimales, o 0 si es "condition"
                currentTSNHours: (selectedType === 'condition' ? 0 : parseFloat(editInputs.currentTSNHours.value) || 0),
                currentTSNCycles: (selectedType === 'condition' ? 0 : parseFloat(editInputs.currentTSNCycles.value) || 0),
                currentTSNDays: (selectedType === 'condition' ? 0 : parseFloat(editInputs.currentTSNDays.value) || 0),
                currentTSOHours: (selectedType === 'condition' ? 0 : parseFloat(editInputs.currentTSOHours.value) || 0),
                currentTSOCycles: (selectedType === 'condition' ? 0 : parseFloat(editInputs.currentTSOCycles.value) || 0),
                currentTSODays: (selectedType === 'condition' ? 0 : parseFloat(editInputs.currentTSODays.value) || 0),
                lifeLimitHours: (selectedType === 'condition' ? 0 : parseFloat(editInputs.lifeLimitHours.value) || 0),
                lifeLimitCycles: (selectedType === 'condition' ? 0 : parseFloat(editInputs.lifeLimitCycles.value) || 0),
                lifeLimitDays: (selectedType === 'condition' ? 0 : parseFloat(editInputs.lifeLimitDays.value) || 0),

                dueDateTT: (selectedType === 'condition' ? 'CONDICIÓN' : editInputs.dueDateTT.value.trim() || ''),
                status: editInputs.status.value.trim() || '',
                lastInspectionDate: editInputs.lastInspectionDate.value || '',
                nextInspectionDue: editInputs.nextInspectionDue.value || '',
            };

            try {
                // Si el número de serie ha cambiado (es una edición y el serial fue modificado) o es un componente nuevo
                if (oldSerialNumber && oldSerialNumber !== newSerialNumber) {
                    const oldComponentRef = ref(database, `artifacts/${appId}/public_data/components/${oldSerialNumber}`);
                    await set(oldComponentRef, null); // Elimina el componente antiguo
                    console.log(`Componente con serial antiguo ${oldSerialNumber} eliminado.`);
                }

                // Guarda o actualiza el componente con el nuevo (o el mismo) número de serie
                const newComponentRef = ref(database, `artifacts/${appId}/public_data/components/${newSerialNumber}`);
                await set(newComponentRef, updatedComponentData);

                console.log("Componente guardado/actualizado en Firebase:", updatedComponentData);
                editComponentDialog.close();
            } catch (error) {
                console.error("Error al guardar el componente en Firebase:", error);
            }
        }

        // Función para renderizar los detalles de los componentes
        function renderComponentDetails(componentsToDisplay) {
            componentDetailsDiv.innerHTML = '';

            if (componentsToDisplay.length === 0) {
                componentDetailsDiv.innerHTML = '<p class="text-center text-gray-600 col-span-full">No se encontraron componentes que coincidan con la búsqueda.</p>';
                return;
            }

            componentsToDisplay.forEach(component => {
                if (!component || !component.serialNumber) { 
                    console.warn("Componente mal formado encontrado y omitido:", component);
                    return;
                }

                const lifeLimitHours = parseFloat(component.lifeLimitHours) || 0;
                const lifeLimitCycles = parseFloat(component.lifeLimitCycles) || 0;
                const lifeLimitDays = parseFloat(component.lifeLimitDays) || 0;

                const remainingLife = calculateRemainingLife(component);
                const totalLifeForColor = component.type === "hours" ? lifeLimitHours : 
                                          component.type === "cycles" ? lifeLimitCycles : 
                                          lifeLimitDays;
                
                let colorClass = getRemainingColorClass(remainingLife, totalLifeForColor);
                let progressBarColorClass = '';

                let unit = "unidades";
                let remainingLifeDisplay = ""; 
                let progressBarText = "";

                if (component.type === "condition") { // Lógica específica para "condicion"
                    remainingLifeDisplay = "CONDICIÓN";
                    unit = "";
                    colorClass = 'remaining-blue';
                    progressBarColorClass = 'progress-blue';
                    progressBarText = "CONDICIÓN";
                } else {
                    remainingLifeDisplay = remainingLife.toFixed(1);
                    if (component.type === "hours") {
                        unit = "hrs";
                    } else if (component.type === "cycles") {
                        unit = "ciclos";
                    } else if (component.type === "months") {
                        unit = "días";
                    }

                    if (remainingLife <= 0) {
                        progressBarColorClass = 'progress-red';
                    } else {
                        const percentageOfTotalLifeRemaining = (remainingLife / totalLifeForColor) * 100;
                        if (percentageOfTotalLifeRemaining < 20) {
                            progressBarColorClass = 'progress-orange';
                        } else {
                            progressBarColorClass = 'progress-green';
                        }
                    }
                    progressBarText = `${calculateConsumedLifePercentage(component).toFixed(0)}% Consumido`;
                }


                const card = document.createElement('div');
                card.className = 'component-card';
                card.id = `component-${component.serialNumber}`; 
                card.innerHTML = `
                    <h4>${component.name || 'Sin Descripción'}</h4>
                    <div class="card-buttons">
                        <button class="edit-button" data-serial="${component.serialNumber}">Editar</button>
                        <button class="print-single-button" data-serial="${component.serialNumber}">Imprimir</button>
                    </div>
                    <div class="component-info-grid">
                        <p><strong>No. Parte:</strong> ${component.partNumber || 'N/A'}</p>
                        <p><strong>No. Serie:</strong> ${component.serialNumber || 'N/A'}</p>
                        <p><strong>Instalado:</strong> ${component.installationDate || 'N/A'}</p>
                        <p><strong>Ubicación:</strong> ${component.location || 'N/A'}</p>
                        
                        <p><strong>Vida Límite (Hrs):</strong> ${lifeLimitHours.toFixed(1)}</p>
                        <p><strong>Vida Límite (Ciclos):</strong> ${lifeLimitCycles.toFixed(1)}</p>
                        <p><strong>Vida Límite (Días):</strong> ${lifeLimitDays.toFixed(1)}</p>
                        <p><strong>Tipo de Vida:</strong> ${component.type || 'N/A'}</p>

                        <p><strong>TSN (Hrs):</strong> ${(parseFloat(component.currentTSNHours) || 0).toFixed(1)}</p>
                        <p><strong>TSN (Ciclos):</strong> ${(parseFloat(component.currentTSNCycles) || 0).toFixed(1)}</p>
                        <p><strong>TSN (Días):</strong> ${(parseFloat(component.currentTSNDays) || 0).toFixed(1)}</p>
                        <p><strong>TSO (Hrs):</strong> ${(parseFloat(component.currentTSOHours) || 0).toFixed(1)}</p>
                        <p><strong>TSO (Ciclos):</strong> ${(parseFloat(component.currentTSOCycles) || 0).toFixed(1)}</p>
                        <p><strong>TSO (Días):</strong> ${(parseFloat(component.currentTSODays) || 0).toFixed(1)}</p>

                        <p><strong>Última Inspección:</strong> ${component.lastInspectionDate || 'N/A'}</p>
                        <p><strong>Próxima Inspección:</strong> ${component.nextInspectionDue || 'N/A'}</p>
                        <p><strong>Vencimiento (A LAS TT):</strong> ${component.dueDateTT || 'N/A'}</p>
                        <p><strong>Estado:</strong> ${component.status || 'N/A'}</p>
                    </div>
                    <div class="remaining-life-section">
                        <span>Remanente:</span>
                        <span class="${colorClass}">${remainingLifeDisplay} ${unit}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill ${progressBarColorClass}" style="width: ${calculateConsumedLifePercentage(component)}%;">
                            ${progressBarText}
                        </div>
                    </div>
                `;
                componentDetailsDiv.appendChild(card);

                const editButton = card.querySelector('.edit-button');
                editButton.addEventListener('click', () => {
                    const selectedComponent = principalComponents.find(comp => comp && comp.serialNumber === editButton.dataset.serial);
                    if (selectedComponent) {
                        openEditDialog(selectedComponent);
                    }
                });

                const printSingleButton = card.querySelector('.print-single-button');
                printSingleButton.addEventListener('click', () => {
                    printComponents(component.serialNumber);
                });
            });
        }

        // Función para filtrar y renderizar componentes
        function filterAndRenderComponents() {
            const searchTerm = componentSearchInput.value.toLowerCase();
            const filteredComponents = principalComponents.filter(component => {
                if (!component) return false;
                const nameMatch = (component.name || '').toLowerCase().includes(searchTerm);
                const serialMatch = (component.serialNumber || '').toLowerCase().includes(searchTerm);
                const partMatch = (component.partNumber || '').toLowerCase().includes(searchTerm);
                return nameMatch || serialMatch || partMatch;
            });
            renderComponentDetails(filteredComponents);
        }

        /**
         * Función para manejar la impresión de componentes.
         * @param {string|null} serialNumber - El número de serie del componente a imprimir, o null para imprimir todos.
         */
        function printComponents(serialNumber = null) {
            const body = document.body;
            
            if (serialNumber) {
                body.classList.add('print-single-component');
                const componentToPrint = document.getElementById(`component-${serialNumber}`);
                if (componentToPrint) {
                    componentToPrint.classList.add('print-this-one');
                }
            }

            window.print();

            setTimeout(() => {
                if (serialNumber) {
                    body.classList.remove('print-single-component');
                    const componentToPrint = document.getElementById(`component-${serialNumber}`);
                    if (componentToPrint) {
                        componentToPrint.classList.remove('print-this-one');
                    }
                }
            }, 500);
        }

        // Se ejecuta cuando el DOM está completamente cargado
        document.addEventListener('DOMContentLoaded', () => {
            console.clear(); // Limpia la consola para una depuración más clara

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Usuario autenticado en COMPONENTES980.HTML:", user.uid);
                    populateMonthYearSelectors();
                    loadMonthlyTotalsFromFirebase();
                    loadComponentsFromFirebase(); // Carga los componentes desde Firebase

                    componentSearchInput.addEventListener('input', filterAndRenderComponents);
                    editComponentForm.addEventListener('submit', saveEditedComponent);
                    cancelEditButton.addEventListener('click', () => editComponentDialog.close());
                    printAllComponentsButton.addEventListener('click', () => printComponents());
                    addComponentButton.addEventListener('click', () => openEditDialog()); // Nuevo componente

                    // Listener para el cambio de tipo de vida en el diálogo de edición
                    editInputs.type.addEventListener('change', (event) => {
                        const isConditionType = event.target.value === 'condition';
                        toggleNumericFields(isConditionType);
                    });

                } else {
                    console.log("No hay usuario autenticado en COMPONENTES980.HTML. Intentando autenticación anónima...");
                    try {
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Autenticación con token inicial exitosa.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Autenticación anónima exitosa.");
                        }
                        // Vuelve a llamar la lógica de inicialización si la autenticación anónima es exitosa
                        populateMonthYearSelectors();
                        loadMonthlyTotalsFromFirebase();
                        loadComponentsFromFirebase();
                        componentSearchInput.addEventListener('input', filterAndRenderComponents);
                        editComponentForm.addEventListener('submit', saveEditedComponent);
                        cancelEditButton.addEventListener('click', () => editComponentDialog.close());
                        printAllComponentsButton.addEventListener('click', () => printComponents());
                        addComponentButton.addEventListener('click', () => openEditDialog()); // Nuevo componente

                        // Listener para el cambio de tipo de vida en el diálogo de edición
                        editInputs.type.addEventListener('change', (event) => {
                            const isConditionType = event.target.value === 'condition';
                            toggleNumericFields(isConditionType);
                        });

                    } catch (error) {
                        console.error("Error en la autenticación:", error);
                        generalSummaryDiv.innerHTML = '<p class="text-center text-red-600 col-span-full">Error de autenticación. Por favor, intenta de nuevo.</p>';
                        componentDetailsDiv.innerHTML = '<p class="text-center text-red-600 col-span-full">Error de autenticación. No se pueden cargar los componentes.</p>';
                    }
                }
            });
        });
    </script>
</body>
</html>
