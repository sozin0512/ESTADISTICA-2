<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos de Vuelo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Incluir Chart.js -->
    <style>
        /* Estilos personalizados para la aplicación */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Fondo con efecto de cielo y gradiente */
            background: linear-gradient(to bottom, #87CEEB 0%, #ADD8E6 100%); /* Azul cielo a azul claro */
            overflow-x: hidden; /* Evita el scroll horizontal causado por animaciones de entrada */
            position: relative; /* Necesario para posicionar el helicóptero y la careta absolutamente */
        }

        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 1.875rem; /* 30px */
            margin-bottom: 1.25rem; /* 20px */
            color: #2c3e50;
        }

        /* Estilos para el contenedor de autenticación */
        #auth-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 0.75rem; /* 12px, un poco más redondeado */
            max-width: 400px;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            background-color: #ffffff;
            /* Mejoras de diseño para el login */
            padding: 2.5rem; /* Más padding */
            box-shadow: 0 20px 30px -8px rgba(0, 0, 0, 0.25), 0 10px 10px -5px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada y suave */
            background: linear-gradient(135deg, #fdfefe 0%, #ffffff 100%); /* Gradiente suave */
            border: 1px solid #d1d5db; /* Borde más sutil */
            animation: fadeInScale 1s ease-out forwards; /* Animación de aparición con escala */
            position: relative; /* Para que el contenido dentro de auth-container no se superponga al helicóptero */
            z-index: 10; /* Asegura que esté debajo del helicóptero y la careta */
        }

        /* Animación de aparición con escala */
        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        #auth-container h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.75rem; /* 28px */
            margin-bottom: 1.75rem; /* Más espacio */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.15);
        }

        #auth-container input {
            width: calc(100% - 22px);
            padding: 12px; /* Más padding para inputs */
            margin: 10px 0; /* Más margen */
            border: 1px solid #d1d5db; /* Color de borde más suave */
            border-radius: 0.375rem; /* 6px */
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #auth-container input:focus {
            border-color: #4f46e5; /* Azul índigo al enfocar */
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.25); /* Sombra al enfocar */
            outline: none;
        }

        #auth-container button {
            padding: 12px 25px; /* Más padding para botones */
            margin: 8px 5px; /* Más margen */
            border: none;
            border-radius: 0.5rem; /* 8px, más redondeado */
            cursor: pointer;
            font-size: 1.05rem; /* Ligeramente más grande */
            font-weight: 700; /* Más negrita */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15); /* Sombra más pronunciada */
            text-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Sombra de texto más fuerte */
            position: relative; /* Para efectos de pseudo-elementos */
            overflow: hidden; /* Para que el pseudo-elemento no se desborde */
        }

        /* Efecto de brillo al pasar el ratón */
        #auth-container button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
            transition: all 0.4s ease;
        }
        #auth-container button:hover::before {
            left: 100%;
        }

        #auth-container button:active {
            transform: translateY(3px); /* Efecto de "presionar" más profundo */
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        #auth-container button:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.25); /* Sombra más grande al pasar el ratón */
        }

        /* Botones con gradientes y efectos */
        #login-btn {
            background: linear-gradient(to right, #22c55e, #10b981); /* Verde a verde azulado */
            color: white;
        }
        #login-btn:hover {
            background: linear-gradient(to right, #16a34a, #059669);
        }

        #signup-btn {
            background: linear-gradient(to right, #3b82f6, #2563eb); /* Azul a azul oscuro */
            color: white;
        }
        #signup-btn:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }

        #forgot-password-btn {
            background: linear-gradient(to right, #f59e0b, #eab308); /* Naranja a amarillo */
            color: white;
        }
        #forgot-password-btn:hover {
            background: linear-gradient(to right, #d97706, #ca8a04);
        }

        #logout-btn {
            background: linear-gradient(to right, #ef4444, #dc2626); /* Rojo a rojo oscuro */
            color: white;
        }
        #logout-btn:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }

        #auth-status {
            color: #dc2626;
            margin-top: 1.25rem; /* Más espacio */
            font-size: 1rem; /* 16px */
            font-weight: 600;
        }

        /* Estilos para la tabla y otros elementos */
        .led-persistente {
            background-color: #e0e0e0 !important;
            color: #0e0f0e;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .year-container, .tab-container, .button-container {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s ease;
        }

        .tab-button:hover {
            background-color: #d0d0d0;
        }

        .tab-button.active {
            background-color: #b0c4de;
            font-weight: bold;
            border-color: #90a4b0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.6875rem; /* 11px */
            margin-top: 1.25rem; /* 20px */
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        th, td {
            border: 1px solid #dcdcdc;
            padding: 0.375rem;
            text-align: center;
            min-width: 25px;
            white-space: nowrap;
        }

        th {
            background-color: #b0c4de;
            color: #333;
            font-weight: bold;
        }

        .nomenclatura {
            background-color: #e9e9e9;
            font-weight: bold;
            text-align: left;
        }

        .fila-total, .fila-general {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        /* Estilos para celdas editables y de solo lectura */
        td.editable-cell {
            background-color: #fefefe;
            cursor: text;
        }
        td.editable-cell:focus {
            outline: 2px solid #6cb2eb;
            background-color: #e6f7ff;
        }
        
        td.read-only-cell {
            background-color: #f9f9f9; /* Un color ligeramente diferente para indicar que no es editable */
            cursor: not-allowed;
        }
        /* Estilo para celdas con entrada inválida */
        td.invalid-input {
            border: 2px solid #ef4444; /* Borde rojo */
            background-color: #fee2e2; /* Fondo rojo claro */
        }

        /* Ocultar contenido principal por defecto */
        #main-app-content {
            display: none;
            width: 100%;
        }

        /* Contenedor para el título y el botón de cerrar sesión */
        #main-app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        #main-app-header h2 {
            margin-bottom: 0;
        }

        /* Estilos del helicóptero */
        #helicopter-svg {
            position: absolute;
            top: 20px; /* Posición final por encima del login */
            left: 50%;
            transform: translateX(-50%);
            width: 150px; /* Tamaño del helicóptero */
            height: auto;
            filter: drop-shadow(3px 5px 2px rgba(0, 0, 0, 0.2));
            z-index: 20; /* Asegura que esté por encima de todo */
            animation: flyInHeli 2s ease-out forwards, hover 3s ease-in-out infinite alternate 2s; /* Animación de entrada y flotación */
        }

        /* Animación de entrada del helicóptero */
        @keyframes flyInHeli {
            from { top: -150px; opacity: 0; transform: translateX(-50%) rotate(-15deg); }
            to { top: 20px; opacity: 1; transform: translateX(-50%) rotate(0deg); }
        }

        /* Animación de flotación del helicóptero */
        @keyframes hover {
            0% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
            100% { transform: translateX(-50%) translateY(0px); }
        }

        /* Estilos de la careta de Anonymous */
        #anonymous-mask-svg {
            position: absolute;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start hidden above helicopter */
            width: 60px; /* Size of the mask */
            height: auto;
            z-index: 15; /* Between helicopter and auth container */
            opacity: 0; /* Initially hidden */
            pointer-events: none; /* Make it not clickable */
            animation: dropAndRiseMask 4s ease-in-out forwards 2.5s; /* Starts at 2.5s, total 4s */
        }

        @keyframes dropAndRiseMask {
            0% { opacity: 0; transform: translateX(-50%) translateY(-100%); } /* Start hidden above */
            10% { opacity: 1; transform: translateX(-50%) translateY(0); } /* Appears just below heli */
            35% { transform: translateX(-50%) translateY(var(--mask-drop-distance)); } /* Drops down */
            65% { transform: translateX(-50%) translateY(var(--mask-drop-distance)); } /* Holds at bottom */
            90% { transform: translateX(-50%) translateY(0); } /* Rises back up */
            100% { opacity: 0; transform: translateX(-50%) translateY(-100%); } /* Disappears above */
        }

        /* Estilos del efecto de revelación (círculo blanco) */
        #reveal-circle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%) scale(0); /* Start small and hidden */
            width: 100px;
            height: 100px;
            background-color: white; /* Círculo blanco */
            border-radius: 50%;
            opacity: 0;
            z-index: 12; /* Under auth container */
            pointer-events: none;
            animation: revealEffect 1s ease-out forwards 3.9s; /* Starts when mask is down */
        }

        @keyframes revealEffect {
            0% { opacity: 0; transform: translateX(-50%) scale(0); }
            50% { opacity: 0.8; transform: translateX(-50%) scale(1); } /* Max size and opacity */
            100% { opacity: 0; transform: translateX(-50%) scale(1.5); } /* Fades out and grows more */
        }

        /* Estilos de impresión */
        @media print {
            body {
                margin: 0;
                padding: 10mm;
                font-size: 10px;
            }

            #auth-container,
            #helicopter-svg,
            #anonymous-mask-svg, /* Oculta la careta en la impresión */
            #reveal-circle, /* Oculta el círculo en la impresión */
            #main-app-header,
            .button-container,
            .tab-container,
            .year-container,
            #loading-overlay, /* Oculta el overlay de carga en la impresión */
            #confirm-modal-overlay /* Oculta el modal de confirmación en la impresión */ {
                display: none;
            }
            /* Mostrar el reporte estadístico y el botón de toggle en la impresión */
            #statistical-report,
            #statistical-report-toggle-btn,
            #report-type-selection { /* Asegurar que los selectores de reporte también se muestren */
                display: block !important;
            }

            #statistical-report {
                margin-top: 0;
                box-shadow: none;
                border: 1px solid #ccc; /* Borde simple para impresión */
                padding: 10px;
            }

            #myChart {
                height: 300px; /* Ajustar altura para impresión */
                margin-bottom: 10px;
            }

            #summary-table {
                font-size: 0.7rem; /* Tamaño de fuente más pequeño para la tabla en impresión */
            }

            h2 {
                margin-top: 0;
                margin-bottom: 5mm;
                text-align: center;
            }

            table {
                border-collapse: collapse;
                width: 100%;
                page-break-inside: avoid;
                table-layout: fixed; /* Añadido para mejor control del ancho de columna */
            }

            tr,
            td,
            th {
                border: 1px solid #000 !important;
                page-break-inside: avoid;
                page-break-after: auto;
                padding: 0.5px; /* Reducido para impresión */
                font-size: 6px; /* Reducido para impresión */
                white-space: normal; /* Permite que el texto se ajuste */
                word-wrap: break-word; /* Permite que las palabras largas se rompan */
                min-width: unset; /* Elimina la restricción de ancho mínimo */
            }

            /* Asegurar que el contenedor de la tabla no oculte el contenido */
            #contenedor-tablas {
                overflow-x: visible !important;
            }

            @page {
                size: A4 landscape;
                margin: 10mm;
            }
        }

        /* Media queries para responsividad */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            #auth-container {
                padding: 1.5rem;
                width: 95%;
            }
            #auth-container input {
                width: calc(100% - 16px);
            }
            #auth-container button {
                width: 100%;
                margin: 5px 0;
            }
            .flex.flex-col.sm:flex-row.justify-center.gap-2 {
                flex-direction: column;
                gap: 10px;
            }
            #main-app-header {
                flex-direction: column;
                align-items: center;
            }
            #main-app-header h2 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            #logout-btn {
                width: 100%;
            }
            .tab-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            table {
                font-size: 0.6rem;
            }
            th, td {
                padding: 0.25rem;
            }
            #helicopter-svg {
                width: 100px; /* Helicóptero más pequeño en móvil */
                top: 10px; /* Ajuste para móvil */
            }
        }

        /* Estilos para el overlay de carga */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el modal de confirmación */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Mayor que el loading overlay */
        }

        #confirm-modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 350px;
            width: 90%;
            animation: modalFadeIn 0.3s ease-out forwards;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #confirm-modal h4 {
            margin-top: 0;
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 20px;
        }

        #confirm-modal .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        #confirm-modal button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        #confirm-modal #confirm-yes {
            background-color: #ef4444; /* Rojo */
            color: white;
        }
        #confirm-modal #confirm-yes:hover {
            background-color: #dc2626;
        }

        #confirm-modal #confirm-no {
            background-color: #d1d5db; /* Gris */
            color: #333;
        }
        #confirm-modal #confirm-no:hover {
            background-color: #a1a1aa;
        }

        /* Estilos para los botones de navegación de mes */
        .month-nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .month-nav-buttons button {
            padding: 0.5rem 1rem;
            background-color: #60a5fa; /* Azul claro */
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .month-nav-buttons button:hover {
            background-color: #3b82f6; /* Azul más oscuro */
        }
        .month-nav-buttons button:disabled {
            background-color: #9ca3af; /* Gris deshabilitado */
            cursor: not-allowed;
        }
        /* Asegura que la clase hidden siempre oculte el elemento */
        .hidden {
            display: none !important;
        }

        /* Estilos para el reporte estadístico */
        #statistical-report {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 20px;
            width: 100%; /* Eliminar max-width para que ocupe todo el ancho */
        }

        #statistical-report h3 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        #myChart {
            max-width: 100%;
            height: 100%; /* Altura fluida */
            min-height: 300px; /* Altura mínima para legibilidad */
            margin-bottom: 20px;
        }

        #summary-table-container {
            overflow-x: auto; /* Scroll horizontal para la tabla de resumen si es necesario */
        }

        #summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        #summary-table th, #summary-table td {
            border: 1px solid #dcdcdc;
            padding: 8px;
            text-align: center;
        }

        #summary-table th {
            background-color: #e0e0e0;
            font-weight: bold;
        }

        #summary-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .increment-positive {
            color: #22c55e; /* Verde */
            font-weight: bold;
        }
        .increment-negative {
            color: #ef4444; /* Rojo */
            font-weight: bold;
        }
        .increment-zero {
            color: #6b7280; /* Gris */
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <svg id="helicopter-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
            <path d="M16 13.5C16 15.433 13.3137 17 10 17C6.68629 17 4 15.433 4 13.5C4 11.567 6.68629 10 10 10C13.3137 10 16 11.567 16 13.5Z" fill="#3498db" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 12.5C12 13.0523 11.5523 13.5 11 13.5H9C8.44772 13.5 8 13.0523 8 12.5C8 11.9477 8.44772 11.5 9 11.5H11C11.5523 11.5 12 11.9477 12 12.5Z" fill="#ecf0f1"></path>
            <path d="M16 13.5H20C20.5523 13.5 21 13.0523 21 12.5C21 11.9477 20.5523 11.5 20 11.5H16" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M5 16.5L4 18.5M15 16.5L16 18.5" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M4 18.5H16" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M10 10V4C10 3.44772 10.4477 3 11 3H13C13.5523 3 14 3.44772 14 4V10" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 2V1C12 0.447715 11.5523 0 11 0H9C8.44772 0 8 0.447715 8 1V2" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 2H18C18.5523 2 19 2.44772 19 3V5C19 5.55228 18.5523 6 18 6H12" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20 11.5V9.5C20 8.94772 20.4477 8.5 21 8.5H23C23.5523 8.5 24 8.94772 24 9.5V11.5" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20 11.5H22C22.5523 11.5 23 11.9477 23 12.5V14.5C23 15.0523 22.5523 15.5 22 15.5H20" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </g>
    </svg>

    <svg id="anonymous-mask-svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M50 0C22.4 0 0 22.4 0 50C0 77.6 22.4 100 50 100C77.6 100 100 77.6 100 50C100 22.4 77.6 0 50 0Z" fill="#F0F0F0" stroke="#333333" stroke-width="2"/>
        <circle cx="35" cy="40" r="8" fill="#333333"/>
        <circle cx="65" cy="40" r="8" fill="#333333"/>
        <path d="M30 65C30 65 40 75 50 75C60 75 70 65 70 65" stroke="#333333" stroke-width="4" stroke-linecap="round"/>
        <path d="M25 30C25 30 30 25 35 30" stroke="#333333" stroke-width="2" stroke-linecap="round"/>
        <path d="M75 30C75 30 70 25 65 30" stroke="#333333" stroke-width="2" stroke-linecap="round"/>
    </svg>

    <div id="reveal-circle"></div>

    <div id="auth-container" class="rounded-lg shadow-md p-6 bg-white">
        <h3 class="text-xl font-semibold mb-4">Acceso de Usuario</h3>
        <input type="email" id="email" placeholder="Correo electrónico" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="password" id="password" placeholder="Contraseña" class="w-full p-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <div class="flex flex-col sm:flex-row justify-center gap-2">
            <button id="login-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">Iniciar Sesión</button>
            <button id="signup-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Registrarse</button>
        </div>
        <button id="forgot-password-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors mt-4">Olvidé mi contraseña</button>
        <p id="auth-status" class="text-red-600 mt-3 text-sm"></p>
    </div>

    <div id="main-app-content">
        <div id="main-app-header" class="flex justify-between items-center mb-4">
            <h2 class="flex-grow text-center sm:text-left">DATOS DE VUELO FAH-990</h2>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors">Cerrar Sesión</button>
        </div>

        <div class="year-container">
            Año:
            <select id="select-year" class="p-2 border border-gray-300 rounded-md"></select>
        </div>

        <div class="month-nav-buttons">
            <button id="prev-month-btn">&lt; Mes Anterior</button>
            <div class="tab-container" id="meses"></div>
            <button id="next-month-btn">Mes Siguiente &gt;</button>
        </div>

        <div id="contenedor-tablas" class="overflow-x-auto"></div>

        <div class="button-container flex justify-center gap-4 mt-4">
            <button onclick="imprimirTabla()" class="px-6 py-2 bg-gray-700 text-white rounded-md shadow-md hover:bg-gray-800 transition-colors">Imprimir Tabla</button>
            <button id="export-csv-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 transition-colors">Exportar a CSV</button>
            <button id="statistical-report-toggle-btn" class="px-6 py-2 bg-purple-600 text-white rounded-md shadow-md hover:bg-purple-700 transition-colors">Ver Reporte Estadístico</button>
        </div>

        <!-- Controles de selección de tipo de reporte -->
        <div id="report-type-selection" class="flex justify-center gap-4 mt-4 hidden">
            <label class="inline-flex items-center">
                <input type="radio" name="reportType" value="annual" class="form-radio" checked>
                <span class="ml-2">Reporte Anual</span>
            </label>
            <label class="inline-flex items-center">
                <input type="radio" name="reportType" value="monthly" class="form-radio">
                <span class="ml-2">Reporte Mensual</span>
            </label>
        </div>

        <!-- Sección del Reporte Estadístico -->
        <div id="statistical-report" class="hidden">
            <h3 id="report-title" class="text-xl font-semibold mb-4"></h3>
            <div style="position: relative; height:40vh; width:80vw; max-width: 800px; margin: 0 auto;">
                <canvas id="myChart"></canvas>
            </div>
            <div id="no-report-data-message" class="text-center text-gray-600 mt-4 hidden">
                No hay datos suficientes para generar este reporte. Por favor, introduce algunos datos en la tabla.
            </div>
            <div id="summary-table-container">
                <table id="summary-table">
                    <thead>
                        <tr>
                            <!-- Los encabezados se añadirán dinámicamente aquí -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las filas de datos se añadirán dinámicamente aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Overlay de Carga -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirm-modal-overlay" class="hidden">
        <div id="confirm-modal">
            <h4 id="confirm-message">¿Estás seguro?</h4>
            <div class="button-group">
                <button id="confirm-yes">Sí</button>
                <button id="confirm-no">No</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase (asegúrate de que estas credenciales sean correctas para tu proyecto)
      const firebaseConfig = {
  apiKey: "AIzaSyCTc4mY9p239UnNwdQ_GnxCMPfm7jrIfxQ",
  authDomain: "fah-990.firebaseapp.com",
  databaseURL: "https://fah-990-default-rtdb.firebaseio.com",
  projectId: "fah-990",
  storageBucket: "fah-990.firebasestorage.app",
  messagingSenderId: "344019976448",
  appId: "1:344019976448:web:a2d462d0dc23695c2133e5",
  measurementId: "G-G4LNY0PPPZ"
};
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); // Inicializar el servicio de Autenticación de Firebase
        let dbRef = database.ref('datos_vuelo'); // Referencia a la raíz de tus datos de vuelo en la Realtime Database
        const userRolesRef = database.ref('user_roles'); // Referencia a la colección de roles de usuario

        // Referencias a los elementos de la interfaz de usuario de autenticación
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn'); 
        const logoutBtn = document.getElementById('logout-btn'); 
        const authStatus = document.getElementById('auth-status');
        const authContainer = document.getElementById('auth-container');
        const mainAppContent = document.getElementById('main-app-content'); 

        // Referencias a elementos del overlay de carga
        const loadingOverlay = document.getElementById('loading-overlay');

        // Referencias a elementos del modal de confirmación
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        let onConfirmCallback = null; // Variable para almacenar la función a ejecutar al confirmar

        // Variable global para el rol del usuario actual
        let currentUserRole = null;

        // -----------------------------------------------------------
        // Variables y configuraciones de la aplicación de vuelo
        // -----------------------------------------------------------
        const años = [2024, 2025, 2026]; // Años disponibles para la selección
        let añoActual = 2025; // Año actualmente seleccionado
        let mesActual = 0; // Mes actualmente seleccionado (0 para Enero, 11 para Diciembre)

        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // Se modifican los nombres de las filas para incluir las nuevas líneas.
        const nombresFilas = [
            "AC HRS", 
            "LANDINGS", 
            "ENGINE HRS 1", 
            "ENGINE N1 CYCLES 1", 
            "ENGINE N2 CYCLES 1", 
            "CREEP 1", 
            "ENGINE HRS 2", 
            "ENGINE N1 CYCLES 2", 
            "ENGINE N2 CYCLES 2", 
            "CREEP 2", 
            "CARGO HOOK HRS FLIGTH", 
            "CARGO HOOK CYCLE",
            "CARGO HOOK HRS LIFTING", 
            "CARGO HOOK LIFTING", 
            "CARGO HOOK LIFTING >400 KG ",
            "HOIST RESCUE HRS", 
            "HOIST RESCUE OP HRS", 
            "HOIST RESCUE CYCLE"
        ];

        // Referencias a los elementos de la interfaz de usuario de la tabla de vuelo
        const contenedorTablas = document.getElementById("contenedor-tablas");
        const contenedorMeses = document.getElementById("meses");
        const selectYear = document.getElementById("select-year");
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const statisticalReportToggleBtn = document.getElementById('statistical-report-toggle-btn');
        const statisticalReport = document.getElementById('statistical-report');
        const myChartCanvas = document.getElementById('myChart');
        const summaryTable = document.getElementById('summary-table');
        const reportTypeSelection = document.getElementById('report-type-selection');
        const reportTypeRadios = document.querySelectorAll('input[name="reportType"]');
        const reportTitle = document.getElementById('report-title');
        const noReportDataMessage = document.getElementById('no-report-data-message');


        let myChartInstance = null; // Para almacenar la instancia del gráfico Chart.js
        let currentReportType = 'annual'; // Tipo de reporte actual: 'annual' o 'monthly'

        // -----------------------------------------------------------
        // Funciones de Utilidad (Validación, Carga, Modal)
        // -----------------------------------------------------------

        /**
         * Muestra el overlay de carga.
         */
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        /**
         * Oculta el overlay de carga.
         */
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        /**
         * Muestra un modal de confirmación.
         * @param {string} message - El mensaje a mostrar en el modal.
         * @param {function} onConfirm - La función a ejecutar si el usuario confirma.
         */
        function showConfirmModal(message, onConfirm) {
            confirmMessage.textContent = message;
            onConfirmCallback = onConfirm;
            confirmModalOverlay.classList.remove('hidden');
        }

        /**
         * Oculta el modal de confirmación.
         */
        function hideConfirmModal() {
            console.log('Ocultando modal de confirmación.'); // Log para depuración
            confirmModalOverlay.classList.add('hidden');
            onConfirmCallback = null;
        }

        // Event listeners para el modal de confirmación
        confirmYesBtn.addEventListener('click', () => {
            console.log('Botón "Sí" clickeado.'); // Log para depuración
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirmModal();
        });

        confirmNoBtn.addEventListener('click', () => {
            console.log('Botón "No" clickeado.'); // Log para depuración
            hideConfirmModal();
        });

        /**
         * Valida el formato de tiempo HH:MM o numérico.
         * @param {string} value - El valor a validar.
         * @returns {boolean} True si el formato es válido, false en caso contrario.
         */
        function isValidTimeOrNumber(value) {
            if (value === "") return true; // Permitir celdas vacías

            // Formato HH:MM
            if (value.includes(":")) {
                const parts = value.split(":");
                if (parts.length !== 2) return false;
                const h = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                return !isNaN(h) && !isNaN(m) && h >= 0 && m >= 0 && m < 60;
            } else {
                // Formato numérico (entero o decimal)
                const num = parseFloat(value.replace(",", "."));
                return !isNaN(num) && num >= 0;
            }
        }

        /**
         * Valida el formato numérico (entero o decimal).
         * @param {string} value - El valor a validar.
         * @returns {boolean} True si el formato es válido, false en caso contrario.
         */
        function isValidNumber(value) {
            if (value === "") return true; // Permitir celdas vacías
            const num = parseFloat(value.replace(",", "."));
            return !isNaN(num) && num >= 0;
        }

        // -----------------------------------------------------------
        // Funciones de Autenticación
        // -----------------------------------------------------------

        // Event listener para el botón de registro
        signupBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                authStatus.textContent = 'Por favor, introduce un correo y una contraseña.';
                authStatus.style.color = 'red';
                return;
            }

            showLoading();
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('Usuario registrado:', user.email);
                authStatus.textContent = 'Registro exitoso. ¡Bienvenido!';
                authStatus.style.color = 'green';
                emailInput.value = ''; 
                passwordInput.value = '';

                await userRolesRef.child(user.uid).set('viewer');
                console.log('Rol de usuario asignado como viewer.');
            } catch (error) {
                console.error('Error al registrar:', error.message);
                authStatus.textContent = `Error al registrar: ${error.message}`;
                authStatus.style.color = 'red';
            } finally {
                hideLoading();
            }
        });

        // Event listener para el botón de inicio de sesión
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                authStatus.textContent = 'Por favor, introduce un correo y una contraseña.';
                authStatus.style.color = 'red';
                return;
            }

            showLoading();
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Usuario ha iniciado sesión:', userCredential.user.email);
                authStatus.textContent = 'Sesión iniciada. ¡Bienvenido!';
                authStatus.style.color = 'green';
                emailInput.value = ''; 
                passwordInput.value = '';
            } catch (error) {
                console.error('Error al iniciar sesión:', error.message);
                authStatus.textContent = `Error al iniciar sesión: ${error.message}`;
                authStatus.style.color = 'red';
            } finally {
                hideLoading();
            }
        });

        // Event listener para el botón de "Olvidé mi contraseña"
        forgotPasswordBtn.addEventListener('click', async () => {
            const email = emailInput.value;

            if (!email) {
                authStatus.textContent = 'Por favor, introduce tu correo electrónico para restablecer la contraseña.';
                authStatus.style.color = 'red';
                return;
            }

            showLoading();
            try {
                await auth.sendPasswordResetEmail(email);
                authStatus.textContent = 'Se ha enviado un correo de restablecimiento de contraseña a tu dirección.';
                authStatus.style.color = 'green'; 
            } catch (error) {
                console.error('Error al enviar correo de restablecimiento:', error.message);
                authStatus.textContent = `Error al restablecer contraseña: ${error.message}`;
                authStatus.style.color = 'red'; 
            } finally {
                hideLoading();
            }
        });

        // Event listener para el botón de cierre de sesión
        logoutBtn.addEventListener('click', () => {
            showConfirmModal('¿Estás seguro de que quieres cerrar sesión?', async () => {
                showLoading();
                try {
                    await auth.signOut();
                    console.log('Sesión cerrada');
                    authStatus.textContent = 'Sesión cerrada.';
                    authStatus.style.color = 'red';
                } catch (error) {
                    console.error('Error al cerrar sesión:', error.message);
                    authStatus.textContent = `Error al cerrar sesión: ${error.message}`;
                    authStatus.style.color = 'red';
                } finally {
                    hideLoading();
                }
            });
        });

        // Observador del estado de autenticación de Firebase
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('Usuario actual:', user.email, 'UID:', user.uid);
                authContainer.style.display = 'none'; 
                mainAppContent.style.display = 'block'; 

                authStatus.textContent = ''; 

                try {
                    const snapshot = await userRolesRef.child(user.uid).once('value');
                    currentUserRole = snapshot.val() || 'viewer'; 
                    console.log('Rol del usuario:', currentUserRole);
                    
                    if (!snapshot.exists()) {
                        console.log('Asignando rol por defecto "viewer" al usuario:', user.uid);
                        await userRolesRef.child(user.uid).set('viewer');
                        console.log('Rol "viewer" asignado exitosamente.');
                    }
                } catch (error) {
                    console.error("Error al obtener el rol del usuario:", error);
                    currentUserRole = 'viewer'; 
                } finally {
                    applyRolePermissions(currentUserRole);
                    // No mostrar loading para la carga inicial de datos de tabla
                    const currentMonthData = await dbRef.child(`${añoActual}/${meses.indexOf(meses[mesActual])}`).once('value');
                    cargarDatosEnTablaHTML(currentMonthData.val(), mesActual);
                }

            } else {
                console.log('No hay usuario logueado');
                authContainer.style.display = 'block'; 
                mainAppContent.style.display = 'none'; 
                authStatus.textContent = 'Por favor, inicia sesión o regístrate para acceder.';
                authStatus.style.color = 'red'; 
                currentUserRole = null; 
                applyRolePermissions(null); 
            }
        });


        // -----------------------------------------------------------
        // Funciones de Base de Datos (Firebase Realtime Database)
        // -----------------------------------------------------------

        /**
         * Guarda los datos de una tabla específica en Firebase Realtime Database.
         * Solo permite guardar si el usuario es un administrador.
         * @param {number} año - El año de los datos.
         * @param {string} mesNombre - El nombre del mes (ej. "Enero").
         * @param {Array<Array<string>>} datosTabla - Los datos de la tabla a guardar.
         */
        async function guardarDatosEnFirebase(año, mesNombre, datosTabla) {
            if (currentUserRole !== 'admin') {
                console.warn('Acceso denegado: Solo los administradores pueden guardar datos.');
                authStatus.textContent = 'Acceso denegado: Solo los administradores pueden guardar datos.';
                authStatus.style.color = 'orange'; 
                return; 
            }

            const ruta = `${año}/${meses.indexOf(mesNombre)}`; 
            try {
                await dbRef.child(ruta).set(datosTabla);
                console.log(`Datos guardados correctamente para ${mesNombre} (${ruta}) de ${año}`);
                authStatus.textContent = `Datos guardados para ${mesNombre} de ${año}.`;
                authStatus.style.color = 'green'; 
            } catch (error) {
                console.error("Error al guardar los datos:", error);
                authStatus.textContent = `Error al guardar los datos: ${error.message}`;
                authStatus.style.color = 'red'; 
            }
            // No se llama a hideLoading() aquí, ya que no se muestra showLoading() para cada edición de celda
        }

        /**
         * Carga los datos de una tabla específica desde Firebase Realtime Database.
         * @param {number} año - El año de los datos a cargar.
         * @param {string} mesNombre - El nombre del mes a cargar.
         */
        async function cargarDatosDesdeFirebase(año, mesNombre) {
            const ruta = `${año}/${meses.indexOf(mesNombre)}`; 
            
            console.log('DEBUG: Intentando cargar datos de la ruta:', ruta); 
            try {
                const snapshot = await dbRef.child(ruta).once('value'); 
                const datos = snapshot.val(); 
                console.log('DEBUG: Datos recibidos de Firebase para', ruta, ':', datos); 

                const tablaIndex = meses.indexOf(mesNombre); 
                if (datos && tablaIndex !== -1) {
                    console.log('DEBUG: Datos existen y se cargarán en la tabla con índice:', tablaIndex); 
                    cargarDatosEnTablaHTML(datos, tablaIndex); 
                    console.log(`Datos cargados correctamente para ${mesNombre} de ${año}`);
                } else {
                    console.log(`DEBUG: No hay datos guardados para ${mesNombre} (${ruta}) de ${año} o tabla no encontrada. Limpiando tabla.`); 
                    const tabla = document.querySelectorAll(".tabla-vuelo")[tablaIndex];
                    if (tabla) {
                        tabla.querySelectorAll('tbody tr').forEach(fila => {
                            fila.querySelectorAll('td[contenteditable="true"]').forEach((celda) => {
                                if (celda.parentNode.querySelector('.nomenclatura') !== celda) { 
                                    celda.textContent = "";
                                    celda.classList.remove("led-persistente");
                                }
                            });
                        });
                        actualizarTotales(); 
                    }
                }
                applyRolePermissions(currentUserRole);
            } catch (error) {
                console.error("DEBUG: Error al cargar los datos:", error); 
                authStatus.textContent = `Error al cargar los datos: ${error.message}`;
                authStatus.style.color = 'red';
            }
            // No se llama a hideLoading() aquí, ya que no se muestra showLoading() para cada carga de mes
        }

        /**
         * Carga los datos obtenidos de Firebase en la tabla HTML correspondiente.
         * @param {Array<Array<string>>} datos - Los datos a cargar.
         * @param {number} indiceTabla - El índice de la tabla HTML a actualizar.
         */
        function cargarDatosEnTablaHTML(datos, indiceTabla) {
            const tabla = document.querySelectorAll(`#contenedor-tablas > div`)[indiceTabla]?.querySelector('table tbody');
            console.log('DEBUG: Elemento de tabla HTML encontrado para cargar datos:', tabla); 
            if (tabla) {
                tabla.querySelectorAll('tr').forEach((fila, indexFila) => {
                    const datosFila = datos[indexFila];
                    if (datosFila) {
                        fila.querySelectorAll('td').forEach((celda, indexCelda) => {
                            if (indexCelda !== 0 && datosFila[indexCelda] !== undefined) {
                                celda.textContent = datosFila[indexCelda];
                                if (celda.textContent.trim() !== "") {
                                    celda.classList.add("led-persistente");
                                } else {
                                    celda.classList.remove("led-persistente");
                                }
                                // Asegurarse de quitar la clase de invalidación si el dato es válido al cargar
                                celda.classList.remove('invalid-input');
                            }
                        });
                    }
                });
                actualizarTotales(); 
            }
        }

        /**
         * Obtiene los datos actuales de una tabla HTML específica.
         * @param {number} indiceTabla - El índice de la tabla HTML de la que obtener los datos.
         * @returns {Array<Array<string>>} Los datos de la tabla.
         */
        function obtenerDatosTabla(indiceTabla) {
            const tabla = document.querySelectorAll(`#contenedor-tablas > div`)[indiceTabla]?.querySelector('table tbody');
            const datos = [];
            if (tabla) {
                tabla.querySelectorAll('tr').forEach(fila => {
                    const filaData = [];
                    fila.querySelectorAll('td').forEach(celda => {
                        filaData.push(celda.textContent);
                    });
                    datos.push(filaData);
                });
            }
            return datos;
        }

        // -----------------------------------------------------------
        // Funciones de Interfaz de Usuario y Lógica de Tabla
        // -----------------------------------------------------------

        /**
         * Aplica los permisos de la interfaz de usuario basados en el rol del usuario.
         * @param {string|null} role - El rol del usuario ('admin', 'viewer' o null si no está autenticado).
         */
        function applyRolePermissions(role) {
            const isAdministrator = (role === 'admin');
            const isAuthenticated = (role !== null); 

            document.querySelectorAll('.tabla-vuelo tbody tr').forEach(fila => {
                fila.querySelectorAll('td').forEach((celda, indexCelda) => {
                    if (indexCelda === 0 || indexCelda === 33 || indexCelda === 34) {
                        celda.contentEditable = 'false';
                        celda.classList.add('read-only-cell');
                        celda.classList.remove('editable-cell');
                    } else {
                        celda.contentEditable = isAdministrator ? 'true' : 'false';
                        if (isAdministrator) {
                            celda.classList.add('editable-cell');
                            celda.classList.remove('read-only-cell');
                        } else {
                            celda.classList.add('read-only-cell');
                            celda.classList.remove('editable-cell');
                        }
                    }
                });
            });

            selectYear.disabled = !isAuthenticated; 
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.disabled = !isAuthenticated; 
            });
            prevMonthBtn.disabled = !isAuthenticated || mesActual === 0;
            nextMonthBtn.disabled = !isAuthenticated || mesActual === meses.length - 1;
            exportCsvBtn.disabled = !isAuthenticated;
            statisticalReportToggleBtn.disabled = !isAuthenticated;
            reportTypeSelection.classList.toggle('hidden', !isAuthenticated);


            if (role === 'viewer') {
                authStatus.textContent = 'Has iniciado sesión como Visualizador. Puedes ver todos los datos, pero no puedes editar.';
                authStatus.style.color = 'blue';
            } else if (role === 'admin') {
                authStatus.textContent = 'Has iniciado sesión como Administrador. Puedes editar todos los datos.';
                authStatus.style.color = 'green';
            } else {
                authStatus.textContent = 'Por favor, inicia sesión o regístrate para acceder.';
                authStatus.style.color = 'red';
            }
        }


        /**
         * Carga las opciones de año en el selector.
         */
        function cargarAños() {
            selectYear.innerHTML = ""; 
            años.forEach((año) => {
                const option = document.createElement("option");
                option.value = año;
                option.textContent = año;
                selectYear.appendChild(option);
            });
            selectYear.value = añoActual; 
        }

        /**
         * Crea los botones para cada mes.
         */
        function crearBotonesMeses() {
            contenedorMeses.innerHTML = ""; 

            meses.forEach((mes, i) => {
                const btn = document.createElement("button");
                btn.className = "tab-button";
                btn.textContent = mes;
                btn.onclick = () => {
                    mesActual = i; 
                    mostrarTabla(i); 
                };
                contenedorMeses.appendChild(btn);
            });

            mostrarTabla(mesActual);
        }

        /**
         * Crea todas las estructuras de tabla HTML para cada mes del año actual.
         * @param {number} año - El año para el que se crean las tablas.
         */
        function crearTablasParaAño(año) {
            contenedorTablas.innerHTML = ""; 

            meses.forEach((mes, i) => {
                const div = document.createElement("div");
                div.className = "tabla-mes";
                div.style.display = i === mesActual ? "block" : "none"; 

                const tabla = document.createElement("table");
                tabla.className = "tabla-vuelo";

                const thead = document.createElement("thead");
                const encabezado = document.createElement("tr");
                encabezado.innerHTML = `<th>NOMENCLATURA</th><th contenteditable="true">VIENEN</th>`;
                for (let d = 1; d <= 31; d++) {
                    encabezado.innerHTML += `<th>${d}</th>`;
                }
                encabezado.innerHTML += `<th>MES TOTAL</th><th>GENERAL</th>`;
                thead.appendChild(encabezado);
                tabla.appendChild(thead);

                const tbody = document.createElement("tbody");

                nombresFilas.forEach((nombre) => {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `<td class="nomenclatura" contenteditable="false">${nombre}</td><td contenteditable="true"></td>`;
                    for (let d = 1; d <= 31; d++) {
                        fila.innerHTML += `<td contenteditable="true"></td>`;
                    }
                    fila.innerHTML += `<td class="fila-total" contenteditable="false"></td><td class="fila-general" contenteditable="false"></td>`;
                    tbody.appendChild(fila);
                });

                tabla.appendChild(tbody);
                div.appendChild(tabla);
                contenedorTablas.appendChild(div);
            });
        }

        /**
         * Muestra la tabla del mes especificado y actualiza los botones de mes.
         * También carga los datos de Firebase para el mes seleccionado y maneja la copia de datos del mes anterior.
         * @param {number} index - El índice del mes a mostrar.
         */
        async function mostrarTabla(index) {
            mesActual = index;
            document.querySelectorAll(".tabla-mes").forEach((div, i) => {
                div.style.display = i === index ? "block" : "none";
            });
            document.querySelectorAll(".tab-button").forEach((btn, i) => {
                btn.classList.toggle("active", i === index);
            });
            document.title = `Datos de Vuelo - ${meses[index]} ${añoActual}`;

            // Actualizar estado de los botones de navegación de mes
            prevMonthBtn.disabled = mesActual === 0;
            nextMonthBtn.disabled = mesActual === meses.length - 1;

            // Ocultar reporte estadístico al cambiar de mes
            statisticalReport.classList.add('hidden');
            noReportDataMessage.classList.add('hidden'); // Asegurarse de ocultar el mensaje de no datos
            reportTypeSelection.classList.add('hidden'); // Ocultar los selectores de tipo de reporte
            statisticalReportToggleBtn.textContent = 'Ver Reporte Estadístico';


            if (auth.currentUser) {
                // No mostrar loading para la carga de datos de tabla al cambiar de mes
                const currentMonthData = await dbRef.child(`${añoActual}/${meses.indexOf(meses[mesActual])}`).once('value');
                cargarDatosEnTablaHTML(currentMonthData.val(), mesActual);
            }

            if (mesActual > 0 && auth.currentUser) {
                await copiarValorGeneralAMesSiguiente(añoActual, mesActual - 1, mesActual);
            }
            applyRolePermissions(currentUserRole); // Re-aplicar permisos después de cargar/copiar
        }

        /**
         * Copia el valor de la columna "GENERAL" del mes de origen a la columna "VIENEN" del mes de destino.
         * Esto simula el traspaso de totales acumulados.
         * @param {number} año - El año de los datos.
         * @param {number} mesOrigenIndex - El índice del mes de donde se copian los datos.
         * @param {number} mesDestinoIndex - El índice del mes a donde se copian los datos.
         */
        async function copiarValorGeneralAMesSiguiente(año, mesOrigenIndex, mesDestinoIndex) {
            const rutaOrigen = `${año}/${mesOrigenIndex}`; 
            try {
                const snapshot = await dbRef.child(rutaOrigen).once('value');
                const datosOrigen = snapshot.val();
                if (datosOrigen) {
                    const tablaDestino = document.querySelectorAll(".tabla-vuelo")[mesDestinoIndex];
                    if (tablaDestino) {
                        datosOrigen.forEach((filaDatos, indexFila) => {
                            const valorGeneral = filaDatos[34];
                            if (valorGeneral !== undefined && valorGeneral !== null && valorGeneral.toString().trim() !== "") {
                                const filaDestino = tablaDestino.querySelectorAll("tbody tr")[indexFila];
                                if (filaDestino) {
                                    const celdaVienen = filaDestino.querySelectorAll("td")[1];
                                    if (celdaVienen) {
                                        celdaVienen.textContent = valorGeneral;
                                    }
                                }
                            }
                        });
                        actualizarTotales();
                        // Guardar los datos del mes destino en Firebase después de la copia si el usuario es admin
                        if (currentUserRole === 'admin') {
                            await guardarDatosEnFirebase(añoActual, meses[mesDestinoIndex], obtenerDatosTabla(mesDestinoIndex));
                        }
                    }
                }
            } catch (error) {
                console.error("Error al copiar datos entre meses:", error);
            }
        }

        /**
         * Recalcula y actualiza los valores de "MES TOTAL" y "GENERAL" para todas las filas de todas las tablas.
         * Maneja tanto valores numéricos como de tiempo (HH:MM).
         */
        function actualizarTotales() {
            document.querySelectorAll(".tabla-vuelo").forEach((tabla) => {
                const filas = tabla.querySelectorAll("tbody tr");
                filas.forEach((fila, filaIndex) => {
                    const celdas = fila.querySelectorAll("td");
                    const vienenStr = celdas[1].textContent.trim();
                    const valoresCeldas = [...celdas].slice(2, 33).map(td => td.textContent.trim());

                    const todasVacias = [vienenStr, ...valoresCeldas].every(val => val === "");
                    if (todasVacias) {
                        celdas[33].textContent = "";
                        celdas[34].textContent = "";
                        return;
                    }

                    // Helper to convert HH:MM string to minutes
                    const timeToMinutes = (val) => {
                        if (val.includes(":")) {
                            const [h, m] = val.split(":").map(Number);
                            return h * 60 + m;
                        }
                        return 0; // Should not happen if used correctly
                    };

                    // Helper to convert minutes to HH:MM string
                    const minutesToTime = (minutos) => {
                        if (minutos === 0) return "";
                        const h = Math.floor(minutos / 60);
                        const m = Math.round(minutos % 60);
                        return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}`;
                    };

                    const rowName = nombresFilas[filaIndex];
                    const isTimeRow = rowName.includes("HRS"); // General check for time rows
                    const isSpecialCalculationRow = [
                        nombresFilas.indexOf("CREEP 1"),
                        nombresFilas.indexOf("CREEP 2"),
                        nombresFilas.indexOf("ENGINE N1 CYCLES 1"),
                        nombresFilas.indexOf("ENGINE N2 CYCLES 1"),
                        nombresFilas.indexOf("ENGINE N1 CYCLES 2"),
                        nombresFilas.indexOf("ENGINE N2 CYCLES 2")
                    ].includes(filaIndex);

                    // Rows that should always be treated as decimal numbers, regardless of "HRS" in name
                    const forceDecimalDisplayRows = [
                        nombresFilas.indexOf("HOIST RESCUE OP HRS")
                    ];

                    const hoistRescueCycleIndex = nombresFilas.indexOf("HOIST RESCUE CYCLE");

                    if (forceDecimalDisplayRows.includes(filaIndex)) {
                        const vienen = vienenStr ? parseFloat(vienenStr.replace(",", ".")) : 0;
                        const valoresNumericos = valoresCeldas.map(v => parseFloat(v.replace(",", "."))).filter(num => !isNaN(num));
                        const total = valoresNumericos.reduce((acc, val) => acc + val, 0);
                        const general = total + vienen;

                        celdas[33].textContent = total > 0 ? total.toFixed(1) : "";
                        celdas[34].textContent = general > 0 ? general.toFixed(1) : "";
                    } else if (isTimeRow) {
                        // Handle standard time rows (e.g., AC HRS, ENGINE HRS)
                        const vienenMin = vienenStr ? timeToMinutes(vienenStr) : 0;
                        const totalMin = valoresCeldas.reduce((acc, val) => acc + (val ? timeToMinutes(val) : 0), 0);
                        const generalMin = vienenMin + totalMin;

                        celdas[33].textContent = minutesToTime(totalMin);
                        celdas[34].textContent = minutesToTime(generalMin);
                    } else {
                        // Handle standard numerical rows (e.g., LANDINGS, CARGO HOOK CYCLE, etc.)
                        const vienen = vienenStr ? parseFloat(vienenStr.replace(",", ".")) : 0;
                        const valoresNumericos = valoresCeldas.map(v => parseFloat(v.replace(",", "."))).filter(num => !isNaN(num));

                        let general;
                        let mesTotalDisplayValue;

                        if (isSpecialCalculationRow) {
                            general = valoresNumericos.length > 0 ? Math.max(...valoresNumericos) : 0;
                            let calculatedMesTotal = general - vienen;
                            mesTotalDisplayValue = calculatedMesTotal > 0 ? (Number.isInteger(calculatedMesTotal) ? calculatedMesTotal : calculatedMesTotal.toFixed(1)) : "";
                        } else {
                            const total = valoresNumericos.reduce((acc, val) => acc + val, 0);
                            general = total + vienen;

                            if (filaIndex === hoistRescueCycleIndex) {
                                // Specific handling for HOIST RESCUE CYCLE: round to nearest integer
                                mesTotalDisplayValue = total > 0 ? Math.round(total).toString() : "";
                                general = Math.round(general); // Round general here
                            } else {
                                mesTotalDisplayValue = total > 0 ? (Number.isInteger(total) ? total : total.toFixed(1)) : "";
                            }
                        }

                        // Ensure general is also rounded for display if it's HOIST RESCUE CYCLE
                        const mostrarGeneral = (filaIndex === hoistRescueCycleIndex) ?
                                               (general > 0 ? Math.round(general).toString() : "") :
                                               (general > 0 ? (Number.isInteger(general) ? general : general.toFixed(1)) : "");

                        celdas[33].textContent = mesTotalDisplayValue;
                        celdas[34].textContent = mostrarGeneral;
                    }
                });
            });
        }

        /**
         * Activa el event listener para el evento 'input' en todas las tablas de vuelo.
         * Este listener se encarga de actualizar los totales y guardar los datos en Firebase.
         */
        function activarActualizacion() {
            document.querySelectorAll(".tabla-vuelo").forEach((tabla) => {
                tabla.removeEventListener("input", handleTableInput);
                tabla.addEventListener("input", handleTableInput);
            });
        }

        /**
         * Manejador del evento 'input' para las celdas de la tabla.
         * Actualiza el estado visual de la celda, recalcula totales y guarda en Firebase.
         * @param {Event} e - El objeto de evento.
         */
        async function handleTableInput(e) { 
            const celda = e.target;
            if (celda.tagName === 'TD' && celda.contentEditable === 'true') {
                if (currentUserRole !== 'admin') {
                    console.warn('Acceso denegado: Solo los administradores pueden editar datos.');
                    authStatus.textContent = 'Acceso denegado: Solo los administradores pueden editar datos.';
                    authStatus.style.color = 'orange';
                    celda.textContent = celda.dataset.originalContent || '';
                    return; 
                }

                const fila = celda.parentElement;
                const filaIndex = Array.from(fila.parentNode.children).indexOf(fila);
                const celdaIndex = Array.from(celda.parentNode.children).indexOf(celda);
                const nombreFila = nombresFilas[filaIndex];

                // Define rows that should always be treated as decimal numbers for validation
                const forceDecimalValidationRows = [
                    nombresFilas.indexOf("HOIST RESCUE OP HRS")
                ];

                let isValid = true;
                if (forceDecimalValidationRows.includes(filaIndex)) {
                    isValid = isValidNumber(celda.textContent.trim());
                } else if (nombreFila.includes("HRS")) {
                    isValid = isValidTimeOrNumber(celda.textContent.trim());
                } else {
                    isValid = isValidNumber(celda.textContent.trim());
                }

                if (!isValid) {
                    celda.classList.add('invalid-input');
                    authStatus.textContent = `Error: Entrada inválida en la celda (${nombreFila}, día ${celdaIndex - 1}). Formato esperado: ${forceDecimalValidationRows.includes(filaIndex) || !nombreFila.includes("HRS") ? 'número (decimal permitido)' : 'HH:MM o número para HRS'}.`;
                    authStatus.style.color = 'red';
                    return; 
                } else {
                    celda.classList.remove('invalid-input');
                    authStatus.textContent = ''; 
                }

                celda.dataset.originalContent = celda.textContent;

                if (celdaIndex === 0 || celdaIndex === 33 || celdaIndex === 34) {
                    actualizarTotales(); 
                    return;
                }

                if (celda.textContent.trim() !== "") {
                    celda.classList.add("led-persistente");
                } else {
                    celda.classList.remove("led-persistente");
                }

                actualizarTotales(); 

                const tablaIndex = meses.indexOf(meses[mesActual]); 
                const datosActualizados = obtenerDatosTabla(tablaIndex);
                await guardarDatosEnFirebase(añoActual, meses[mesActual], datosActualizados); 
            }
        }

        /**
         * Imprime la tabla de datos de vuelo.
         */
        function imprimirTabla() {
            window.print();
        }

        /**
         * Exporta los datos de la tabla actual a un archivo CSV.
         */
        function exportTableToCSV() {
            const currentMonthName = meses[mesActual];
            const filename = `Datos_Vuelo_${currentMonthName}_${añoActual}.csv`;
            const tableData = obtenerDatosTabla(mesActual);

            // Obtener encabezados de la tabla
            const currentTable = document.querySelectorAll(`#contenedor-tablas > div`)[mesActual]?.querySelector('table');
            let headers = [];
            if (currentTable) {
                headers = Array.from(currentTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
            }

            // Unir encabezados y datos
            const csvRows = [];
            if (headers.length > 0) {
                csvRows.push(headers.join(','));
            }
            tableData.forEach(row => {
                csvRows.push(row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')); // Escapar comillas dobles
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Tu navegador no soporta la descarga directa de archivos CSV.');
            }
        }

        // -----------------------------------------------------------
        // Funciones de Reporte Estadístico
        // -----------------------------------------------------------

        /**
         * Convierte un valor de tiempo (HH:MM) a un número decimal de horas.
         * @param {string} timeStr - El valor de tiempo en formato HH:MM.
         * @returns {number} El valor en horas decimales.
         */
        function timeToDecimalHours(timeStr) {
            if (!timeStr || timeStr === "") return 0;
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                const hours = parseInt(parts[0]);
                const minutes = parseInt(parts[1]);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    return hours + (minutes / 60);
                }
            }
            // Si no es HH:MM, intentar parsear como número directamente
            const num = parseFloat(timeStr.replace(",", "."));
            return isNaN(num) ? 0 : num;
        }

        /**
         * Convierte un número decimal de horas a formato HH:MM.
         * @param {number} decimalHours - El valor en horas decimales.
         * @returns {string} El tiempo en formato HH:MM.
         */
        function decimalHoursToTime(decimalHours) {
            if (decimalHours === 0) return "00:00";
            const totalMinutes = Math.round(decimalHours * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        /**
         * Agrega los datos mensuales totales para el reporte anual.
         * @returns {Object} Un objeto con los datos agregados por mes para cada métrica.
         */
        async function fetchAnnualAggregatedData() {
            showLoading(); // Mostrar loading para la generación de reportes
            const aggregatedData = {};

            for (const rowName of nombresFilas) {
                aggregatedData[rowName] = [];
            }

            for (let i = 0; i < meses.length; i++) {
                const mesNombre = meses[i];
                const ruta = `${añoActual}/${i}`;
                
                try {
                    const snapshot = await dbRef.child(ruta).once('value');
                    const datosMes = snapshot.val();

                    if (datosMes) {
                        nombresFilas.forEach((rowName, rowIndex) => {
                            const rowData = datosMes[rowIndex];
                            if (rowData) {
                                const mesTotalValue = rowData[33]; // Columna "MES TOTAL"
                                if (rowName.includes("HRS")) {
                                    aggregatedData[rowName].push(timeToDecimalHours(mesTotalValue));
                                } else {
                                    const numValue = parseFloat(mesTotalValue.replace(",", "."));
                                    aggregatedData[rowName].push(isNaN(numValue) ? 0 : numValue);
                                }
                            } else {
                                aggregatedData[rowName].push(0); 
                            }
                        });
                    } else {
                        nombresFilas.forEach(rowName => {
                            aggregatedData[rowName].push(0);
                        });
                    }
                } catch (error) {
                    console.error(`Error al cargar datos para el reporte anual del mes ${mesNombre}:`, error);
                    nombresFilas.forEach(rowName => {
                        aggregatedData[rowName].push(0);
                    });
                }
            }
            hideLoading(); // Ocultar loading después de la generación de reportes
            return aggregatedData;
        }

        /**
         * Agrega los datos diarios para el reporte mensual del mes actual.
         * @returns {Object} Un objeto con los datos agregados por día para cada métrica.
         */
        async function fetchMonthlyDailyData(year, monthIndex) {
            // No se muestra showLoading/hideLoading aquí, ya que se maneja en la función que llama (renderMonthlyReport)
            const dailyData = {};
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate(); // Obtener el número de días en el mes

            for (const rowName of nombresFilas) {
                dailyData[rowName] = new Array(daysInMonth).fill(0); // Inicializar con ceros para cada día
            }

            const ruta = `${year}/${monthIndex}`;
            try {
                const snapshot = await dbRef.child(ruta).once('value');
                const datosMes = snapshot.val();

                if (datosMes) {
                    nombresFilas.forEach((rowName, rowIndex) => {
                        const rowData = datosMes[rowIndex];
                        if (rowData) {
                            for (let day = 1; day <= daysInMonth; day++) {
                                const dailyValue = rowData[day + 1]; // +1 porque la columna 0 es Nomenclatura, 1 es Vienen
                                if (dailyValue !== undefined && dailyValue !== null && dailyValue.toString().trim() !== "") {
                                    if (rowName.includes("HRS")) {
                                        dailyData[rowName][day - 1] = timeToDecimalHours(dailyValue);
                                    } else {
                                        const numValue = parseFloat(dailyValue.replace(",", "."));
                                        dailyData[rowName][day - 1] = isNaN(numValue) ? 0 : numValue;
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error(`Error al cargar datos diarios para el reporte mensual del mes ${meses[monthIndex]}:`, error);
            }
            return dailyData;
        }

        /**
         * Renderiza el gráfico y la tabla de resumen para el reporte anual.
         * @param {Object} aggregatedData - Los datos agregados por mes.
         */
        function renderAnnualReport(aggregatedData) {
            reportTitle.textContent = `Reporte Anual para el Año ${añoActual}`;

            const hasData = nombresFilas.some(rowName => aggregatedData[rowName] && aggregatedData[rowName].some(val => val > 0));

            if (!hasData) {
                myChartCanvas.classList.add('hidden');
                summaryTable.classList.add('hidden');
                noReportDataMessage.classList.remove('hidden');
                if (myChartInstance) {
                    myChartInstance.destroy(); // Destroy chart if no data
                    myChartInstance = null;
                }
                return;
            } else {
                myChartCanvas.classList.remove('hidden');
                summaryTable.classList.remove('hidden');
                noReportDataMessage.classList.add('hidden');
            }

            // Encabezados de la tabla de resumen anual
            summaryTable.querySelector('thead tr').innerHTML = '<th>Métrica</th>';
            meses.forEach(mes => {
                summaryTable.querySelector('thead tr').innerHTML += `<th>${mes}</th>`;
            });
            summaryTable.querySelector('thead tr').innerHTML += '<th>Incremento Anual</th>';
            summaryTable.querySelector('tbody').innerHTML = '';

            const chartLabels = meses;
            const chartDatasets = [];

            nombresFilas.forEach((rowName, index) => {
                const data = aggregatedData[rowName];
                const isTimeMetric = rowName.includes("HRS");

                let firstValue = data[0];
                let lastValue = data[data.length - 1];
                let annualIncrement = lastValue - firstValue;
                
                let annualIncrementDisplay = "";
                let incrementClass = "";

                if (annualIncrement > 0) {
                    incrementClass = "increment-positive";
                    annualIncrementDisplay = isTimeMetric ? `+${decimalHoursToTime(annualIncrement)}` : `+${annualIncrement.toFixed(1)}`;
                } else if (annualIncrement < 0) {
                    incrementClass = "increment-negative";
                    annualIncrementDisplay = isTimeMetric ? `-${decimalHoursToTime(Math.abs(annualIncrement))}` : `${annualIncrement.toFixed(1)}`;
                } else {
                    incrementClass = "increment-zero";
                    annualIncrementDisplay = isTimeMetric ? "00:00" : "0";
                }

                // Añadir datos a la tabla de resumen
                let rowHtml = `<tr><td class="nomenclatura">${rowName}</td>`;
                data.forEach(val => {
                    rowHtml += `<td>${isTimeMetric ? decimalHoursToTime(val) : (val % 1 === 0 ? val : val.toFixed(1))}</td>`;
                });
                rowHtml += `<td class="${incrementClass}">${annualIncrementDisplay}</td></tr>`;
                summaryTable.querySelector('tbody').innerHTML += rowHtml;

                // Añadir dataset para el gráfico (solo para algunas métricas principales)
                if (rowName === "AC HRS" || rowName === "LANDINGS" || rowName.includes("ENGINE HRS")) {
                    chartDatasets.push({
                        label: rowName,
                        data: data,
                        borderColor: getRandomColor(),
                        fill: false,
                        tension: 0.1
                    });
                }
            });

            // Destruir instancia de gráfico anterior si existe
            if (myChartInstance) {
                myChartInstance.destroy();
            }

            // Renderizar el nuevo gráfico
            myChartInstance = new Chart(myChartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Totales Mensuales para el Año ${añoActual}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        /**
         * Renderiza el gráfico y la tabla de resumen para el reporte mensual.
         * @param {Object} dailyData - Los datos agregados por día para el mes actual.
         */
        async function renderMonthlyReport(dailyData) {
            reportTitle.textContent = `Reporte Mensual: ${meses[mesActual]} ${añoActual}`;

            // Fetch previous month's data for comparison
            let previousMonthDailyData = null;
            if (mesActual > 0) {
                showLoading(); // Show loading for fetching previous month's data
                previousMonthDailyData = await fetchMonthlyDailyData(añoActual, mesActual - 1);
                hideLoading(); // Hide loading after fetching
            }

            const hasCurrentMonthData = nombresFilas.some(rowName => dailyData[rowName] && dailyData[rowName].some(val => val > 0));
            let hasPreviousMonthData = false;
            if (previousMonthDailyData) {
                hasPreviousMonthData = nombresFilas.some(rowName => previousMonthDailyData[rowName] && previousMonthDailyData[rowName].some(val => val > 0));
            }

            if (!hasCurrentMonthData && !hasPreviousMonthData) {
                myChartCanvas.classList.add('hidden');
                summaryTable.classList.add('hidden');
                noReportDataMessage.classList.remove('hidden');
                if (myChartInstance) {
                    myChartInstance.destroy();
                    myChartInstance = null;
                }
                return;
            } else {
                myChartCanvas.classList.remove('hidden');
                summaryTable.classList.remove('hidden');
                noReportDataMessage.classList.add('hidden');
            }

            const daysInMonth = new Date(añoActual, mesActual + 1, 0).getDate();
            const chartLabels = Array.from({ length: daysInMonth }, (_, i) => i + 1); // Días del mes

            // Encabezados de la tabla de resumen mensual
            summaryTable.querySelector('thead tr').innerHTML = '<th>Métrica</th>';
            chartLabels.forEach(day => {
                summaryTable.querySelector('thead tr').innerHTML += `<th>Día ${day}</th>`;
            });
            // Add the new column for monthly increment
            summaryTable.querySelector('thead tr').innerHTML += '<th>Incremento Mensual</th>';
            summaryTable.querySelector('tbody').innerHTML = '';

            const chartDatasets = [];

            nombresFilas.forEach((rowName, index) => {
                const data = dailyData[rowName]; // Current month's daily data
                const isTimeMetric = rowName.includes("HRS");

                // Calculate current month's total
                const currentMonthTotal = data.reduce((sum, val) => sum + val, 0);

                // Calculate previous month's total
                let previousMonthTotal = 0;
                if (previousMonthDailyData) {
                    previousMonthTotal = previousMonthDailyData[rowName].reduce((sum, val) => sum + val, 0);
                }

                // Calculate monthly increment
                const monthlyIncrement = currentMonthTotal - previousMonthTotal;

                let monthlyIncrementDisplay = "";
                let incrementClass = "";

                // Only show increment if there was a previous month to compare
                if (mesActual > 0) {
                    if (monthlyIncrement > 0) {
                        incrementClass = "increment-positive";
                        monthlyIncrementDisplay = isTimeMetric ? `+${decimalHoursToTime(monthlyIncrement)}` : `+${monthlyIncrement.toFixed(1)}`;
                    } else if (monthlyIncrement < 0) {
                        incrementClass = "increment-negative";
                        monthlyIncrementDisplay = isTimeMetric ? `-${decimalHoursToTime(Math.abs(monthlyIncrement))}` : `${monthlyIncrement.toFixed(1)}`;
                    } else {
                        incrementClass = "increment-zero";
                        monthlyIncrementDisplay = isTimeMetric ? "00:00" : "0";
                    }
                } else {
                    monthlyIncrementDisplay = "N/A"; // Not Applicable for the first month
                    incrementClass = "increment-zero";
                }

                // Add data to the summary table
                let rowHtml = `<tr><td class="nomenclatura">${rowName}</td>`;
                data.forEach(val => {
                    rowHtml += `<td>${isTimeMetric ? decimalHoursToTime(val) : (val % 1 === 0 ? val : val.toFixed(1))}</td>`;
                });
                // Add the monthly increment cell
                rowHtml += `<td class="${incrementClass}">${monthlyIncrementDisplay}</td></tr>`;
                summaryTable.querySelector('tbody').innerHTML += rowHtml;

                // Add dataset for the chart (only for some main metrics)
                if (rowName === "AC HRS" || rowName === "LANDINGS" || rowName.includes("ENGINE HRS")) {
                    chartDatasets.push({
                        label: rowName,
                        data: data,
                        borderColor: getRandomColor(),
                        fill: false,
                        tension: 0.1
                    });
                }
            });

            // Destroy previous chart instance if exists
            if (myChartInstance) {
                myChartInstance.destroy();
            }

            // Render the new chart
            myChartInstance = new Chart(myChartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Valores Diarios para ${meses[mesActual]} ${añoActual}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        /**
         * Función principal para renderizar el reporte estadístico basado en el tipo seleccionado.
         */
        async function updateStatisticalReport() {
            if (currentReportType === 'annual') {
                const aggregatedData = await fetchAnnualAggregatedData();
                renderAnnualReport(aggregatedData);
            } else if (currentReportType === 'monthly') {
                // Fetch current month's data first
                const dailyData = await fetchMonthlyDailyData(añoActual, mesActual);
                await renderMonthlyReport(dailyData); // Await renderMonthlyReport as it now fetches previous month data
            }
        }

        /**
         * Genera un color hexadecimal aleatorio.
         */
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // -----------------------------------------------------------
        // Inicialización y Event Listeners Globales
        // -----------------------------------------------------------

        /**
         * Configura la posición y la distancia de caída de la careta de Anonymous.
         * Se llama después de que los elementos HTML se han renderizado.
         */
        function animateIntroElements() {
            const helicopter = document.getElementById('helicopter-svg');
            const authContainer = document.getElementById('auth-container');
            const anonymousMask = document.getElementById('anonymous-mask-svg');
            const revealCircle = document.getElementById('reveal-circle');

            // Asegurarse de que los elementos existan antes de intentar calcular sus posiciones
            if (!helicopter || !authContainer || !anonymousMask || !revealCircle) {
                console.warn("Algunos elementos de la interfaz de usuario no se encontraron.");
                return;
            }

            // Obtener las dimensiones y posiciones de los elementos
            const heliRect = helicopter.getBoundingClientRect();
            const authRect = authContainer.getBoundingClientRect();
            
            // Calcular la distancia de caída de la máscara
            // Desde la parte inferior del helicóptero hasta la parte superior del contenedor de autenticación
            const maskDropDistance = authRect.top - heliRect.bottom - (anonymousMask.offsetHeight / 2); // Ajustar para centrar la máscara

            // Establecer la variable CSS para la altura final de la caída de la máscara
            document.documentElement.style.setProperty('--mask-drop-distance', `${maskDropDistance}px`);

            // Posicionar el círculo de revelación justo en la parte superior del contenedor de autenticación
            // Ajustar para que quede visualmente bien con la caída de la máscara
            revealCircle.style.top = `${authRect.top + (authRect.height / 2)}px`; // Centrar verticalmente en el contenedor de auth
            revealCircle.style.left = `50%`; // Centrar horizontalmente
        }

        /**
         * Función de inicialización de la aplicación.
         * Se ejecuta al cargar la ventana.
         */
        function iniciar() {
            cargarAños(); 
            crearTablasParaAño(añoActual); 
            crearBotonesMeses(); 
            activarActualizacion(); 
            // onAuthStateChanged se encarga de la carga inicial de datos y permisos
        }

        // Event listener para el cambio de año en el selector
        selectYear.addEventListener("change", async () => {
            añoActual = parseInt(selectYear.value); 
            crearTablasParaAño(añoActual); 
            crearBotonesMeses(); 
            activarActualizacion(); 
            if (auth.currentUser) {
                // No mostrar loading para la carga de datos de tabla al cambiar de año
                const currentMonthData = await dbRef.child(`${añoActual}/${meses.indexOf(meses[mesActual])}`).once('value');
                cargarDatosEnTablaHTML(currentMonthData.val(), mesActual);
            }
            applyRolePermissions(currentUserRole); // Re-aplicar permisos después de cambiar de año
        });

        // Event listeners para los botones de navegación de mes
        prevMonthBtn.addEventListener('click', () => {
            if (mesActual > 0) {
                mostrarTabla(mesActual - 1);
            }
        });

        nextMonthBtn.addEventListener('click', () => {
            if (mesActual < meses.length - 1) {
                mostrarTabla(mesActual + 1);
            }
        });

        // Event listener para el botón de exportar CSV
        exportCsvBtn.addEventListener('click', exportTableToCSV);

        // Event listener para el botón de reporte estadístico
        statisticalReportToggleBtn.addEventListener('click', async () => {
            if (statisticalReport.classList.contains('hidden')) {
                // Mostrar reporte y controles de tipo
                statisticalReport.classList.remove('hidden');
                reportTypeSelection.classList.remove('hidden');
                contenedorTablas.classList.add('hidden'); // Ocultar la tabla principal
                statisticalReportToggleBtn.textContent = 'Ocultar Reporte Estadístico';
                await updateStatisticalReport(); // Renderizar el reporte inicial
            } else {
                // Ocultar reporte y controles de tipo
                statisticalReport.classList.add('hidden');
                reportTypeSelection.classList.add('hidden');
                contenedorTablas.classList.remove('hidden'); // Mostrar la tabla principal
                statisticalReportToggleBtn.textContent = 'Ver Reporte Estadístico';
            }
        });

        // Event listeners para los radio buttons de tipo de reporte
        reportTypeRadios.forEach(radio => {
            radio.addEventListener('change', async (event) => {
                currentReportType = event.target.value;
                await updateStatisticalReport();
            });
        });

        // Iniciar la aplicación cuando la ventana esté completamente cargada
        window.addEventListener("load", () => {
            iniciar();
            setTimeout(animateIntroElements, 100); 
        });

        // Hacer la función imprimirTabla accesible globalmente
        window.imprimirTabla = imprimirTabla;
    </script>
</body>
</html>
