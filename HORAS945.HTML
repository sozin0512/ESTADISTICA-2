<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos de Vuelo FAH-945 (UH-1H)</title>
    <!-- Favicon placeholder para evitar el error 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游뚜</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Chosen Palette: Warm Neutrals with Subtle Accents */
        /* Estilos generales del cuerpo y fondo */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, #E0E0E0 0%, #F5F5F5 100%); /* Gris claro a Blanco muy suave */
            overflow-x: hidden; /* Evita el scroll horizontal */
            position: relative; /* Para posicionar elementos absolutos */
        }

        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 1.875rem; /* 30px */
            margin-bottom: 1.25rem; /* 20px */
            color: #4A4A4A; /* Gris oscuro para el texto principal */
        }

        /* Contenedor de autenticaci칩n */
        #auth-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 2.5rem; /* M치s padding */
            border: 1px solid #D1D1D1; /* Borde m치s sutil */
            border-radius: 0.75rem; /* 12px, m치s redondeado */
            max-width: 400px;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            background: linear-gradient(135deg, #fdfefe 0%, #ffffff 100%); /* Gradiente suave */
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -3px rgba(0, 0, 0, 0.05); /* Sombra pronunciada pero suave */
            animation: fadeInScale 1s ease-out forwards; /* Animaci칩n de aparici칩n */
            position: relative;
            z-index: 10;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        #auth-container h3 {
            margin-top: 0;
            color: #4A4A4A;
            font-size: 1.75rem; /* 28px */
            margin-bottom: 1.75rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        #auth-container input {
            width: calc(100% - 22px);
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #D1D1D1;
            border-radius: 0.375rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #auth-container input:focus {
            border-color: #A3C9A8; /* Tono verde suave */
            box-shadow: 0 0 0 4px rgba(163, 201, 168, 0.3);
            outline: none;
        }

        #auth-container button {
            padding: 12px 25px;
            margin: 8px 5px;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 10px rgba(0,0,0,0.1);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        #auth-container button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
            transition: all 0.4s ease;
        }
        #auth-container button:hover::before {
            left: 100%;
        }

        #auth-container button:active {
            transform: translateY(3px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }
        #auth-container button:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        /* Colores de botones de autenticaci칩n */
        #login-btn { background: linear-gradient(to right, #6B8E23, #8BC34A); color: white; } /* Verde Oliva a Verde Lima */
        #login-btn:hover { background: linear-gradient(to right, #5A781E, #7AA93A); }
        #signup-btn { background: linear-gradient(to right, #4682B4, #5CACEE); color: white; } /* Azul Acero a Azul Cielo */
        #signup-btn:hover { background: linear-gradient(to right, #3A719C, #4B9AD5); }
        #forgot-password-btn { background: linear-gradient(to right, #D2B48C, #EEDD82); color: white; } /* Bronceado a Amarillo Claro */
        #forgot-password-btn:hover { background: linear-gradient(to right, #BD9C7A, #DDCB75); }
        #logout-btn { background: linear-gradient(to right, #CD5C5C, #E9967A); color: white; } /* Rojo Indio a Salm칩n Oscuro */
        #logout-btn:hover { background: linear-gradient(to right, #B84D4D, #D2836E); }

        #auth-status {
            color: #DC2626;
            margin-top: 1.25rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* Contenedor principal de la aplicaci칩n */
        #main-app-content {
            display: none; /* Oculto por defecto */
            width: 100%;
        }
        #main-app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        #main-app-header h2 {
            margin-bottom: 0;
            color: #4A4A4A;
        }

        /* Estilos de la tabla y elementos relacionados */
        .user-id-container {
            text-align: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: #555;
        }
        .year-container, .tab-container, .button-container {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            background-color: #D3D3D3; /* Gris claro */
            border: 1px solid #A9A9A9; /* Gris oscuro */
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s ease;
        }
        .tab-button:hover { background-color: #C0C0C0; } /* Gris m치s oscuro */
        .tab-button.active {
            background-color: #B0C4DE; /* Azul acero claro */
            font-weight: bold;
            border-color: #778899; /* Gris pizarra */
        }

        table {
            border-collapse: collapse;
            width: auto; /* Ajustar ancho autom치ticamente */
            font-size: 0.6875rem; /* 11px */
            margin: 0 auto; /* Centrar tabla */
            margin-top: 1.25rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        th, td {
            border: 1px solid #E0E0E0; /* Gris muy claro */
            padding: 0.375rem;
            text-align: center;
            min-width: 25px;
            white-space: nowrap;
        }
        th {
            background-color: #D8BFD8; /* Ciruela clara */
            color: #4A4A4A;
            font-weight: bold;
        }
        .nomenclatura {
            background-color: #F8F8F8; /* Gris casi blanco */
            font-weight: bold;
            text-align: left;
            padding-left: 5px;
            min-width: 150px;
        }
        .motor-header {
            background-color: #FFD700; /* Oro */
            font-weight: bold;
            text-align: center;
        }

        /* Estilos para celdas editables y de solo lectura */
        td.editable-cell {
            background-color: #FDFDFD;
            cursor: text;
        }
        td.editable-cell:focus {
            outline: 2px solid #A3C9A8;
            background-color: #F0F8EE;
        }
        td.read-only-cell {
            background-color: #FAFAFA;
            cursor: not-allowed;
        }

        /* Estilos para el efecto LED */
        .led-persistente {
            background-color: #F8F7F7 !important;
            color: #0E0F0E;
            animation: resplandor 2s infinite;
            font-weight: bold;
        }
        @keyframes resplandor {
            0% { box-shadow: 0 0 5px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 0 10px rgba(0,0,0,0.2); }
            100% { box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        }
        .celda-modificada {
            animation: ledFlash 1s ease-in-out;
        }
        @keyframes ledFlash {
            0% { background-color: #A3C9A8; } /* Color de acento suave */
            50% { background-color: #F8F7F7; }
            100% { background-color: #F8F7F7; }
        }

        /* Estilos para el texto de RESTANTE */
        /* Eliminados */

        /* Nuevos estilos para las etiquetas y el parpadeo */
        /* Eliminados */

        /* Contenedor para el cuadro de recordatorio global */
        .recordatorio-global-container {
            margin-top: 15px;
            width: 100%;
            border: 1px solid #B0C4DE;
            background-color: #E6EAF0; /* Azul claro muy suave */
            padding: 5px;
            box-sizing: border-box;
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border-radius: 8px;
        }
        #recordatorio-textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #B0C4DE;
            background-color: #E6EAF0;
            resize: vertical;
            font-family: Arial, sans-serif;
            font-size: 11px;
            padding: 5px;
            box-sizing: border-box;
            border-radius: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        #recordatorio-textarea::placeholder { color: #666; }

        /* Contenedor para las opciones de impresi칩n */
        .print-options-container {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #D1D1D1;
            border-radius: 8px;
            background-color: #F8F8F8;
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .print-options-container label {
            margin: 0 10px;
            font-weight: normal;
            color: #4A4A4A;
        }

        /* Estilos del helic칩ptero */
        #helicopter-svg {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: auto;
            filter: drop-shadow(3px 5px 2px rgba(0, 0, 0, 0.2));
            z-index: 20;
            animation: flyInHeli 2s ease-out forwards, hover 3s ease-in-out infinite alternate 2s;
        }
        @keyframes flyInHeli {
            from { top: -150px; opacity: 0; transform: translateX(-50%) rotate(-15deg); }
            to { top: 20px; opacity: 1; transform: translateX(-50%) rotate(0deg); }
        }
        @keyframes hover {
            0% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
            100% { transform: translateX(-50%) translateY(0px); }
        }

        /* Estilos de la careta de Anonymous */
        #anonymous-mask-img {
            position: absolute;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
        }

        /* --- INICIO: Estilos del modal de REPORTE (NUEVO) --- */
        #reportModal {
            display: none; /* Oculto por defecto */
        }
        /* --- FIN: Estilos del modal de REPORTE (NUEVO) --- */


        /* Estilos de impresi칩n */
        @media print {
            /* --- INICIO: L칩gica de impresi칩n modificada --- */
            
            /* 1. Ocultar todo por defecto */
            body > *:not(.printable-report-area) {
                display: none;
            }

            /* 2. Reglas para cuando se imprime el REPORTE (usando el modal) */
            body.imprimiendo-reporte {
                margin: 0;
                padding: 0;
                background: none;
            }
            
            body.imprimiendo-reporte #reportModal {
                display: flex !important;
                flex-direction: column;
                position: static !important;
                background: white !important;
                inset: 0 !important;
                padding: 10mm !important;
                border: none !important;
                box-shadow: none !important;
            }

            body.imprimiendo-reporte #printableReportArea {
                display: block !important;
                overflow: visible !important;
            }
            
            /* Ocultar los botones del modal de reporte al imprimirlo */
            body.imprimiendo-reporte .report-modal-buttons {
                display: none !important;
            }

            /* Asegurar que el contenido del reporte use todo el ancho */
            body.imprimiendo-reporte #reportModalContent table {
                width: 100% !important;
                font-size: 10pt !important;
                border-collapse: collapse !important;
            }
             body.imprimiendo-reporte #reportModalContent th,
             body.imprimiendo-reporte #reportModalContent td {
                border: 1px solid #000 !important;
                padding: 4px !important;
                color: #000 !important;
             }

            
            body.imprimiendo-reporte #reportModalTitle {
                font-size: 18pt !important;
                text-align: center !important;
                margin-bottom: 20px !important;
                color: #000 !important;
            }

            /* 3. Reglas para cuando se imprime la TABLA PRINCIPAL (l칩gica original) */
            body:not(.imprimiendo-reporte) {
                 margin: 0;
                 padding: 10mm;
                 font-size: 10px;
            }
            body:not(.imprimiendo-reporte) .button-container, 
            body:not(.imprimiendo-reporte) .tab-container, 
            body:not(.imprimiendo-reporte) .year-container, 
            body:not(.imprimiendo-reporte) #auth-container, 
            body:not(.imprimiendo-reporte) #helicopter-svg, 
            body:not(.imprimiendo-reporte) #anonymous-mask-img, 
            body:not(.imprimiendo-reporte) #reveal-circle,
            body:not(.imprimiendo-reporte) #main-app-header, 
            body:not(.imprimiendo-reporte) .print-options-container, 
            body:not(.imprimiendo-reporte) .user-id-container,
            body:not(.imprimiendo-reporte) #motorStatusModal,
            body:not(.imprimiendo-reporte) #reportModal { /* Ocultar el modal de reporte si no es su impresi칩n */
                display: none !important; 
            }

            body:not(.imprimiendo-reporte) .print-header { display: block !important; }
            body:not(.imprimiendo-reporte) table {
                page-break-inside: avoid;
                width: 100% !important; 
                border-collapse: collapse !important;
            }
            body:not(.imprimiendo-reporte) th, 
            body:not(.imprimiendo-reporte) td {
                page-break-inside: avoid;
                page-break-after: auto;
                border: 1px solid #000 !important;
                padding: 2px !important;
                font-size: 9px !important; 
            }
            body:not(.imprimiendo-reporte) .nomenclatura {
                text-align: left !important;
                padding-left: 2px !important;
                min-width: 120px !important; 
            }
            body:not(.imprimiendo-reporte) .recordatorio-global-container, 
            body:not(.imprimiendo-reporte) #recordatorio-textarea {
                display: block !important; 
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                background-color: #e0e0e0 !important;
                border: 1px solid #000 !important;
            }
            body:not(.imprimiendo-reporte) #recordatorio-textarea::placeholder {
                text-shadow: none !important; 
                color: #000 !important;
            }
            /* Reglas espec칤ficas para ocultar elementos seg칰n la clase del body */
            body:not(.imprimiendo-reporte).print-no-reminders .recordatorio-global-container {
                display: none !important;
            }

            @page {
                /* La impresi칩n del reporte usar치 esto, la principal tambi칠n */
                size: A4 landscape;
                margin: 10mm;
            }
            /* --- FIN: L칩gica de impresi칩n modificada --- */
        }

        /* Estilos del modal de estado de motores */
        #motorStatusModal {
            display: none !important; /* Ocultar completamente el modal */
        }
    </style>
</head>
<body>
    <!-- Application Structure Plan: La aplicaci칩n est치 dise침ada como una Single Page Application (SPA) con una interfaz de usuario de tipo dashboard/tabla interactiva. Se estructura en secciones clave:
        1.  **Autenticaci칩n:** Un formulario de inicio de sesi칩n/registro al principio que controla el acceso a la aplicaci칩n principal.
        2.  **Encabezado de la Aplicaci칩n Principal:** Muestra el t칤tulo de la aplicaci칩n y un bot칩n de cierre de sesi칩n.
        3.  **Controles de Navegaci칩n de Datos:** Un selector de a침o y botones de pesta침as para navegar entre los meses. Esto permite a los usuarios explorar los datos de vuelo por per칤odo de tiempo.
        4.  **Tabla de Datos de Vuelo:** La secci칩n central y principal. Presenta una tabla detallada con datos diarios, totales mensuales y generales de vuelos y componentes de un solo motor. Las celdas son editables para usuarios autenticados.
        5.  **Recordatorios del Mes:** Un 치rea de texto debajo de la tabla para que los usuarios autenticados puedan guardar notas o recordatorios espec칤ficos del mes.
        6.  **Opciones de Impresi칩n:** Controles para personalizar la salida impresa de la tabla.
        7.  **Botones de Acci칩n:** Botones para imprimir la tabla, y acceder a modales de "Estado de Motores" y "Estado de Componentes".
        
        La estructura fue elegida para centralizar la entrada y visualizaci칩n de datos de vuelo por mes y a침o, haciendo la navegaci칩n temporal f치cil. La distinci칩n clara entre la tabla principal y los modales de estado permite un enfoque en diferentes niveles de detalle sin sobrecargar la vista principal. La edici칩n directa en la tabla y los recordatorios facilitan la interacci칩n y gesti칩n de datos.
    -->
    <!-- Visualization & Content Choices:
        - Report Info: Datos de vuelo y estado de componentes de un helic칩ptero.
        - Goal: Registrar y visualizar las horas de vuelo, aterrizajes, RINS y el estado de los componentes del motor a lo largo del tiempo.
        - Viz/Presentation Method:
            - **Tabla interactiva (HTML table):** Para los datos de vuelo diarios y totales. Permite la entrada directa de datos y la visualizaci칩n organizada de grandes conjuntos de n칰meros.
            - **츼rea de texto (HTML textarea):** Para los "Recordatorios del Mes". Facilita la entrada de notas cualitativa.
        - Interaction:
            - **Edici칩n directa en celdas:** Los usuarios autenticados pueden modificar los valores num칠ricos directamente en la tabla, lo que activa el guardado autom치tico en Firebase.
            - **Pesta침as (HTML buttons + JS):** Para cambiar entre los meses. Proporciona una navegaci칩n clara y r치pida entre los per칤odos de datos.
            - **Selector de a침o (HTML select + JS):** Para cambiar el a침o de visualizaci칩n de los datos.
        - Justification: La tabla es el formato m치s adecuado para la entrada de datos num칠ricos diarios. La navegaci칩n por pesta침as y selector de a침o hace que explorar los datos hist칩ricos sea intuitivo. La edici칩n en vivo y el autoguardado mejoran la usabilidad.
        - Library/Method: Vanilla JS para toda la l칩gica interactiva, Tailwind CSS para el dise침o responsive y la est칠tica.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <svg id="helicopter-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
            <path d="M16 13.5C16 15.433 13.3137 17 10 17C6.68629 17 4 15.433 4 13.5C4 11.567 6.68629 10 10 10C13.3137 10 16 11.567 16 13.5Z" fill="#8B4513" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Cuerpo marr칩n -->
            <path d="M12 12.5C12 13.0523 11.5523 13.5 11 13.5H9C8.44772 13.5 8 13.0523 8 12.5C8 11.9477 8.44772 11.5 9 11.5H11C11.5523 11.5 12 11.9477 12 12.5Z" fill="#F5F5DC"></path> <!-- Ventana beige claro -->
            <path d="M16 13.5H20C20.5523 13.5 21 13.0523 21 12.5C21 11.9477 20.5523 11.5 20 11.5H16" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Cola horizontal -->
            <path d="M5 16.5L4 18.5M15 16.5L16 18.5" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Tren de aterrizaje vertical -->
            <path d="M4 18.5H16" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Tren de aterrizaje horizontal -->
            <path d="M10 10V4C10 3.44772 10.4477 3 11 3H13C13.5523 3 14 3.44772 14 4V10" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Soporte del rotor principal -->
            <path d="M12 2V1C12 0.447715 11.5523 0 11 0H9C8.44772 0 8 0.447715 8 1V2" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Rotor principal vertical -->
            <path d="M12 2H18C18.5523 2 19 2.44772 19 3V5C19 5.55228 18.5523 6 18 6H12" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Rotor principal horizontal -->
            <path d="M20 11.5V9.5C20 8.94772 20.4477 8.5 21 8.5H23C23.5523 8.5 24 8.94772 24 9.5V11.5" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Rotor de cola vertical -->
            <path d="M20 11.5H22C22.5523 11.5 23 11.9477 23 12.5V14.5C23 15.0523 22.5523 15.5 22 15.5H20" stroke="#5A2D0D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <!-- Rotor de cola horizontal -->
        </g>
    </svg>

    <img id="anonymous-mask-img" src="https://wallpapercrafter.com/desktop/340779-Technology-Anonymous-Phone-Wallpaper.jpg" alt="Anonymous Mask">

    <div id="reveal-circle"></div>

    <div id="auth-container" class="rounded-lg shadow-md p-6 bg-white">
        <h3 class="text-xl font-semibold mb-4">Acceso de Usuario</h3>
        <input type="email" id="email" placeholder="Correo electr칩nico" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="password" id="password" placeholder="Contrase침a" class="w-full p-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <div class="flex flex-col sm:flex-row justify-center gap-2">
            <button id="login-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">Iniciar Sesi칩n</button>
            <button id="signup-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Registrarse</button>
        </div>
        <button id="forgot-password-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors mt-4">Olvid칠 mi contrase침a</button>
        <p id="auth-status" class="text-red-600 mt-3 text-sm"></p>
    </div>

    <div id="main-app-content">
        <div id="main-app-header" class="flex justify-between items-center mb-4">
            <h2 class="flex-grow text-center sm:text-left">DATOS DE VUELO FAH-945 (UH-1H)</h2>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors">Cerrar Sesi칩n</button>
        </div>

        <div class="user-id-container">
            ID de Usuario: <span id="user-id">Cargando...</span>
        </div>
        <div class="year-container">
            A침o: <select id="select-year" class="p-2 border border-gray-300 rounded-md"></select>
        </div>
        <div class="tab-container" id="meses"></div>

        <div class="print-header" id="print-month-header"></div>

        <div id="contenedor-tablas" class="overflow-x-auto"></div>
        
        <div class="recordatorio-global-container">
            <strong>Recordatorios del Mes:</strong>
            <textarea id="recordatorio-textarea" placeholder="Escribe tus recordatorios aqu칤"></textarea>
        </div>

        <div class="print-options-container">
            <strong>Opciones de Impresi칩n (Para Tabla Principal):</strong>
            <label><input type="radio" name="printOption" value="full" checked> Tabla Completa</label>
            <label><input type="radio" name="printOption" value="no-reminders"> Sin Recordatorios</label>
            <!-- Eliminado "Sin Columnas Amarillas" ya que no existen -->
        </div>

        <div class="button-container flex justify-center gap-4 mt-4">
            <!-- *** MODIFICADO: El ID sigue siendo el mismo, pero ahora tiene una nueva funci칩n *** -->
            <button id="btnImprimir" class="px-6 py-2 bg-gray-700 text-white rounded-md shadow-md hover:bg-gray-800 transition-colors">Generar Reporte del Mes</button>
            <!-- Eliminado el bot칩n "Estado de Motores" -->
            <button id="btnComponentStatus" class="px-6 py-2 bg-purple-500 text-white rounded-md shadow-md hover:bg-purple-600 transition-colors">Estado de Componentes</button>
            <button id="btnInspecciones" class="px-6 py-2 bg-teal-500 text-white rounded-md shadow-md hover:bg-teal-600 transition-colors">Inspecciones</button>
        </div>
    </div>

    <!-- Eliminado el modal de estado de motores completamente -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE REPORTE DETALLADO ==== -->
    <!-- ====================================================== -->
    <div id="reportModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <!-- Contenedor del modal -->
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-3xl w-full text-center flex flex-col max-h-[90vh]">
            
            <!-- 츼rea de contenido imprimible -->
            <div id="printableReportArea" class="overflow-y-auto flex-grow">
                <h3 id="reportModalTitle" class="text-2xl font-bold mb-4">Reporte Detallado</h3>
                <div id="reportModalContent" class="text-left">
                    <!-- El contenido del reporte se generar치 aqu칤 con JavaScript -->
                </div>
            </div>
            
            <!-- Botones (no se imprimen) -->
            <div class="report-modal-buttons flex justify-center gap-4 mt-6 flex-shrink-0">
                <button id="printReportBtn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Imprimir Reporte</button>
                <button id="closeReportBtn" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE REPORTE DETALLADO ==== -->
    <!-- ==================================================== -->


    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE INGRESO R츼PIDO (QR) ==== -->
    <!-- ====================================================== -->
    <div id="flightDataModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <!-- --- MODIFICADO: Contenedor de modal con flex-col y max-h --- -->
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center flex flex-col max-h-[90vh]">
            <!-- --- INICIO: Encabezado (no se desplaza) --- -->
            <div class="flex-shrink-0">
                <h3 class="text-2xl font-bold mb-4">Ingreso de Vuelo R치pido</h3>
                <p class="text-lg mb-4">Datos para el d칤a: <strong id="flightModalDate"></strong></p>
            </div>
            <!-- --- FIN: Encabezado --- -->

            <!-- --- MODIFICADO: Contenedor de campos (ahora se desplaza) --- -->
            <div class="space-y-4 text-left overflow-y-auto flex-grow pr-2">
                <div>
                    <label for="modalAcHrs" class="block text-sm font-medium text-gray-700">AC HRS</label>
                    <input type="number" id="modalAcHrs" placeholder="Ej: 1.5" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalAterrizajes" class="block text-sm font-medium text-gray-700">ATERRIZAJES</label>
                    <input type="number" id="modalAterrizajes" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalRins" class="block text-sm font-medium text-gray-700">RINS</label>
                    <input type="number" id="modalRins" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- ==== INICIO: NUEVOS CAMPOS (ENGINE HRS) ==== -->
                <div>
                    <label for="modalEngineHrs1" class="block text-sm font-medium text-gray-700">Engine Hrs</label>
                    <input type="number" id="modalEngineHrs1" placeholder="Ej: 1.5" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- ==== FIN: NUEVOS CAMPOS (ENGINE HRS) ==== -->
                <div>
                    <label for="modalEngineStarts1" class="block text-sm font-medium text-gray-700">Ciclos Motor (Starts)</label>
                    <input type="number" id="modalEngineStarts1" placeholder="Ej: 2" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="modalFlights1" class="block text-sm font-medium text-gray-700">Vuelos (Flights)</label>
                    <input type="number" id="modalFlights1" placeholder="Ej: 3" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- ==== FIN: NUEVOS CAMPOS QR ==== -->
            </div>
            <!-- --- FIN: Contenedor de campos --- -->

            <!-- --- INICIO: Pie de modal (botones, no se desplaza) --- -->
            <div class="flex justify-center gap-4 mt-6 flex-shrink-0">
                <button id="saveFlightDataBtn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Guardar</button>
                <button id="cancelFlightDataBtn" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
            <!-- --- FIN: Pie de modal --- -->
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE INGRESO R츼PIDO (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE CONFIRMACI칍N (QR) ==== -->
    <!-- ====================================================== -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4">Confirmar Totales</h3>
            <p class="text-lg mb-4">쮺oincide esto con tu reporte de vuelo?</p>
            
            <!-- ==== INICIO: MODAL DE CONFIRMACI칍N RECONSTRUIDO ==== -->
            <!-- Contenedor scrollable para la lista de todos los campos -->
            <div id="confirmationListContainer" class="max-h-64 overflow-y-auto space-y-3 text-left bg-gray-50 p-4 rounded-md mb-3">
                <!-- JavaScript llenar치 esta secci칩n din치micamente -->
                <!-- Ejemplo de c칩mo se ver치 un 칤tem:
                <div class="space-y-1">
                    <h4 class="font-bold text-lg text-blue-700">AC HRS</h4>
                    <div>
                        <span class="font-medium text-gray-700">Total Anterior (Vienen):</span>
                        <strong class="text-lg float-right text-gray-800">223.0</strong>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Reporte de Hoy:</span>
                        <strong class="text-lg float-right text-gray-800">+1.5</strong>
                    </div>
                    <hr class="my-1">
                    <div>
                        <span class="font-bold text-gray-900">NUEVO TOTAL GENERAL:</span>
                        <strong class="text-2xl float-right text-blue-700">224.5</strong>
                    </div>
                </div>
                -->
            </div>
            <!-- ==== FIN: MODAL DE CONFIRMACI칍N RECONSTRUIDO ==== -->

            <!-- ==== INICIO: NUEVO RECORDATORIO DE CAPTURA ==== -->
            <p class="text-sm font-medium text-gray-800 mt-5 bg-yellow-100 border border-yellow-300 rounded-md p-3 shadow-sm">
                <strong>Recordatorio:</strong> 춰REVISA BIEN LOS DATOS ANTES DE CONTINUAR FIJATE BIEN EN TU REPORTE DE VUELO ATT:ESTADISTICA 
                POWERED HACKER-01!
            </p>
            <!-- ==== FIN: NUEVO RECORDATORIO DE CAPTURA ==== -->

            <div class="mt-6">
                <button id="closeConfirmationBtn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Confirmado</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE CONFIRMACI칍N (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE ALERTA PERSONALIZADA ==== -->
    <!-- ====================================================== -->
    <div id="customAlertModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4 text-red-600">Error</h3>
            <p id="customAlertMessage" class="text-lg mb-6">Este es un mensaje de error.</p>
            <button id="customAlertCloseBtn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Entendido</button>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE ALERTA PERSONALIZADA ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE CONFLICTO DE DATOS (QR) ==== -->
    <!-- ====================================================== -->
    <div id="dataConflictModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4 text-yellow-600">Datos Existentes Detectados</h3>
            <p class="text-lg mb-6">Ya tienes datos registrados para este d칤a. 쯈u칠 deseas hacer?</p>
            <div classE="flex flex-col sm:flex-row justify-center gap-4">
                <button id="overwriteDataBtn" class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors mb-2 sm:mb-0">Borrar y Reemplazar</button>
                <button id="sumDataBtn" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors mb-2 sm:mb-0">Sumar a lo Existente</button>
                <button id="cancelConflictBtn" class="w-full sm:w-auto px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE CONFLICTO DE DATOS (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE NOMBRE DE MEC츼NICO (QR) ==== -->
    <!-- ====================================================== -->
    <div id="mechanicNameModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4">Registro de Mec치nico</h3>
            <p class="text-lg mb-4">Por 칰ltimo, 쯤ui칠n est치 llenando el reporte?</p>
            <div class="space-y-4 text-left">
                <div>
                    <label for="modalMechanicName" class="block text-sm font-medium text-gray-700">Nombre de Mec치nico a Bordo</label>
                    <input type="text" id="modalMechanicName" placeholder="Ej: Juan P칠rez" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="saveMechanicNameBtn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Guardar y Salir</button>
            </div>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE NOMBRE DE MEC츼NICO (QR) ==== -->
    <!-- ==================================================== -->

    <!-- ====================================================== -->
    <!-- ==== INICIO: NUEVO MODAL DE DESPEDIDA (QR) ==== -->
    <!-- ====================================================== -->
    <div id="goodbyeModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4 text-green-600">Registro Completo</h3>
            <p id="goodbyeMessage" class="text-lg mb-6">춰Gracias, Juan P칠rez! Tu reporte ha sido guardado.</p>
        </div>
    </div>
    <!-- ==================================================== -->
    <!-- ==== FIN: NUEVO MODAL DE DESPEDIDA (QR) ==== -->
    <!-- ==================================================== -->


    <script type="module">
        // Importa las funciones necesarias de Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, set, onValue, get } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';

        // Tu configuraci칩n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpZUx4sy6VIKGHzsMCNX4eQQ9sasQhy9Q",
            authDomain: "fah-945.firebaseapp.com",
            databaseURL: "https://fah-945-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fah-945",
            storageBucket: "fah-945.firebasestorage.app",
            messagingSenderId: "789748725591",
            appId: "1:789748725591:web:f7f551a77be0092531f012",
            measurementId: "G-3JW0YYE2QQ"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Define __app_id y sanitiza para que sea una ruta de Firebase v치lida
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        appId = appId.replace(/[.#$\[\]]/g, '_'); // Reemplaza caracteres inv치lidos con guion bajo

        // --- Variables Globales de Estado ---
        let userId = "anonimo"; // Almacena el ID del usuario. 춰Declaraci칩n faltante!
        let currentUserRole = "viewer"; // Almacena el rol del usuario. 춰Declaraci칩n faltante!
        const a침os = [2023, 2024, 2025, 2026, 2027]; // Define la lista de a침os. 춰Declaraci칩n faltante!
        let a침oActual = new Date().getFullYear(); // Define el a침o actual. 춰Declaraci칩n faltante!
        // Intenta obtener el 칰ltimo mes activo de localStorage, o usa el mes actual
        let mesActual = localStorage.getItem('lastActiveMonth') ? parseInt(localStorage.getItem('lastActiveMonth')) : new Date().getMonth();
        let pendingFlightData = null; // Variable global para guardar datos de QR temporalmente

        // === INICIO: NUEVA L칍GICA DE QR ===
        // 1. Capturar el par치metro de la URL INMEDIATAMENTE al cargar la p치gina.
        const urlParamsOnLoad = new URLSearchParams(window.location.search);
        const globalQrActionPending = urlParamsOnLoad.get('action') === 'addFlightData';
        // === FIN: NUEVA L칍GICA DE QR ===

        // Definici칩n de meses
        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // Definici칩n de todas las filas en el ORDEN FINAL DESEADO (para MOTOR #1 y #2)
        const nombresFilasOrdenadas = [
            "AC HRS",
            "ATERRIZAJES",
            "RINS",
            // --- Motor ---
            "CONTINGENCY EXCURSIONS",
            "ENGINE HRS", 
            "ENGINE STARTS", 
            "FLIGHTS", 
            "IMPELLER",
            "COMPRESOR COMPONENTS", 
            "GAS PRODUCER COMPONENTS", 
            "POWER TURBINE COMPONENTS", 
        ];

        // Referencias a elementos del DOM
        const contenedorTablas = document.getElementById("contenedor-tablas");
        const contenedorMeses = document.getElementById("meses");
        const selectYear = document.getElementById("select-year");
        const printMonthHeader = document.getElementById("print-month-header");
        const recordatorioTextarea = document.getElementById("recordatorio-textarea");
        const userIdDisplay = document.getElementById("user-id");

        // Elementos de autenticaci칩n
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const authContainer = document.getElementById('auth-container');
        const mainAppContent = document.getElementById('main-app-content');
        
        // --- MODIFICADO: Referencia al bot칩n de imprimir/reporte ---
        const btnImprimir = document.getElementById('btnImprimir');

        // Elementos del nuevo modal de QR
        const flightDataModal = document.getElementById('flightDataModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const flightModalDate = document.getElementById('flightModalDate');
        const saveFlightDataBtn = document.getElementById('saveFlightDataBtn');
        const cancelFlightDataBtn = document.getElementById('cancelFlightDataBtn');
        const closeConfirmationBtn = document.getElementById('closeConfirmationBtn');
        const modalAcHrs = document.getElementById('modalAcHrs');
        const modalAterrizajes = document.getElementById('modalAterrizajes');
        const modalRins = document.getElementById('modalRins');
        // === INICIO: NUEVOS ELEMENTOS MODAL QR ===
        const modalEngineHrs1 = document.getElementById('modalEngineHrs1'); // <-- A칌ADIDO
        const modalEngineStarts1 = document.getElementById('modalEngineStarts1');
        const modalFlights1 = document.getElementById('modalFlights1');
        // === FIN: NUEVOS ELEMENTOS MODAL QR ===
 
        // === INICIO: Elementos de los nuevos modales de Mec치nico y Despedida ===
        const mechanicNameModal = document.getElementById('mechanicNameModal');
        const modalMechanicName = document.getElementById('modalMechanicName');
        const saveMechanicNameBtn = document.getElementById('saveMechanicNameBtn');
        const goodbyeModal = document.getElementById('goodbyeModal');
        const goodbyeMessage = document.getElementById('goodbyeMessage');
        // === FIN: Elementos de los nuevos modales ===

        // Nuevo bot칩n de estado de componentes
        const btnComponentStatus = document.getElementById('btnComponentStatus');

        // === INICIO: Icono de Mec치nico (para Tooltip) ===
        const iconoMecanicoHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-3 w-3 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
        </svg>`;
        // === FIN: Icono de Mec치nico ===


        // Helper para extraer la nomenclatura base y la variante (Ya no es estrictamente necesario sin l칤mites, pero se mantiene si hay nombres con formato similar)
        function parseNomenclatura(nombreCompleto) {
            let nomenclaturaBase = '';
            let varianteClave = ''; 
            const matchNumericPart = nombreCompleto.match(/(\d+(?:\.\d+)?)$/);
            if (matchNumericPart) {
                varianteClave = matchNumericPart[1];
                nomenclaturaBase = nombreCompleto.substring(0, nombreCompleto.length - varianteClave.length).trim();
            } else {
                nomenclaturaBase = nombreCompleto; 
                varianteClave = '1.0'; 
            }
            return { nomenclaturaBase, varianteClave };
        }

        /**
         * Formatea un n칰mero para mostrarlo sin decimales si es un entero,
         * o con decimales si tiene parte fraccionaria.
         * @param {number|string} value El valor a formatear.
         * @returns {string} El valor formateado como string.
         */
        function formatNumber(value) {
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '';
            }
            if (num % 1 === 0) {
                return num.toString();
            } else {
                return num.toString();
            }
        }

        // -----------------------------------------------------------
        // Funciones de Autenticaci칩n
        // -----------------------------------------------------------

        signupBtn.addEventListener('click', () => { // ELIMINADO ASYNC
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) { authStatus.textContent = 'Por favor, introduce un correo y una contrase침a.'; return; }
            
            createUserWithEmailAndPassword(auth, email, password) // ELIMINADO AWAIT
                .then((userCredential) => { // A칌ADIDO .THEN
                    const user = userCredential.user;
                    authStatus.textContent = 'Registro exitoso. 춰Bienvenido!';
                    authStatus.style.color = 'green';
                    emailInput.value = '';
                    passwordInput.value = '';
                    // Devuelve la promesa de set
                    // *** MODIFICADO: A침adido el path de 'artifacts' ***
                    return set(ref(database, `artifacts/${appId}/user_roles/${user.uid}`), 'viewer'); 
                })
                .catch((error) => { // A칌ADIDO .CATCH
                    authStatus.textContent = `Error al registrar: ${error.message}`;
                    authStatus.style.color = 'red';
                });
        });

        loginBtn.addEventListener('click', () => { // ELIMINADO ASYNC
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) { authStatus.textContent = 'Por favor, introduce un correo y una contrase침a.'; return; }
            
            setPersistence(auth, browserLocalPersistence) // ELIMINADO AWAIT
                .then(() => { // A칌ADIDO .THEN
                    // Devuelve la promesa de signIn
                    return signInWithEmailAndPassword(auth, email, password); 
                })
                .then((userCredential) => { // A칌ADIDO .THEN
                    authStatus.textContent = 'Sesi칩n iniciada. 춰Bienvenido!';
                    authStatus.style.color = 'green';
                    emailInput.value = '';
                    passwordInput.value = '';
                })
                .catch((error) => { // A칌ADIDO .CATCH
                    authStatus.textContent = `Error al iniciar sesi칩n: ${error.message}`;
                    authStatus.style.color = 'red';
                });
        });

        forgotPasswordBtn.addEventListener('click', () => { // ELIMINADO ASYNC
            const email = emailInput.value;
            if (!email) { authStatus.textContent = 'Por favor, introduce tu correo electr칩nico para restablecer la contrase침a.'; authStatus.style.color = 'red'; return; }
            
            sendPasswordResetEmail(auth, email) // ELIMINADO AWAIT
                .then(() => { // A칌ADIDO .THEN
                    authStatus.textContent = 'Se ha enviado un correo de restablecimiento de contrase침a a tu direcci칩n.';
                    authStatus.style.color = 'green';
                })
                .catch((error) => { // A칌ADIDO .CATCH
                    authStatus.textContent = `Error al restablecer contrase침a: ${error.message}`;
                    authStatus.style.color = 'red';
                });
        });

        logoutBtn.addEventListener('click', () => { // ELIMINADO ASYNC
            signOut(auth) // ELIMINADO AWAIT
                .then(() => { // A칌ADIDO .THEN
                    authStatus.textContent = 'Sesi칩n cerrada.';
                    authStatus.style.color = 'red';
                })
                .catch((error) => { // A칌ADIDO .CATCH
                    authStatus.textContent = `Error al cerrar sesi칩n: ${error.message}`;
                    authStatus.style.color = 'red';
                });
        });

        onAuthStateChanged(auth, (user) => { // ELIMINADO ASYNC
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                
                authContainer.style.display = 'none';
                mainAppContent.style.display = 'block';
                authStatus.textContent = '';

                // --- L칩gica de autenticaci칩n reescrita con .then() ---
                // *** MODIFICADO: A침adido el path de 'artifacts' ***
                const rolePath = `artifacts/${appId}/user_roles/${userId}`;
                get(ref(database, rolePath)) // ELIMINADO AWAIT
                    .then((snapshot) => { // A칌ADIDO .THEN
                        currentUserRole = snapshot.val() || 'viewer';
                        
                        let roleSetPromise = Promise.resolve(); // Crear promesa resuelta
                        if (!snapshot.exists()) {
                            // Si no existe, la promesa ser치 la escritura
                            // *** MODIFICADO: A침adido el path de 'artifacts' ***
                            roleSetPromise = set(ref(database, rolePath), 'viewer');
                        }
                        return roleSetPromise; // Devolver la promesa (resuelta o de escritura)
                    })
                    .then(() => { // A칌ADIDO .THEN (se ejecuta despu칠s de establecer el rol si era necesario)
                        applyRolePermissions(currentUserRole);
                        return cargarDatosDelMes(a침oActual, mesActual); // Devolver la promesa de cargar datos
                    })
                    .then(() => { // A칌ADIDO .THEN (se ejecuta despu칠s de cargar los datos)
                        agregarEventosDeEdicion();
                        
                        // --- INICIO: L칍GICA DE QR MODIFICADA ---
                        // 3. Comprobar si la acci칩n QR estaba pendiente.
                        if (globalQrActionPending) {
                            // Devolver la promesa de checkURLParamsForQR
                            return checkURLParamsForQR(); 
                        }
                        // Si no, devolver una promesa resuelta
                        return Promise.resolve();
                        // --- FIN: L칍GICA DE QR MODIFICADA ---
                    })
                    .catch((error) => { // A칌ADIDO .CATCH (Maneja errores de get(role), set(role), o cargarDatosDelMes)
                        authStatus.textContent = `Error cr칤tico: ${error.message}. Por favor, recarga.`;
                        authStatus.style.color = 'red';
                        currentUserRole = 'viewer';
                        applyRolePermissions(currentUserRole);
                        
                        // Intentar cargar datos de todos modos en caso de error de rol
                        cargarDatosDelMes(a침oActual, mesActual)
                            .then(() => {
                                agregarEventosDeEdicion();
                            });
                    });
                // --- Fin de la l칩gica reescrita ---

            } else {
                userId = "anonimo";
                userIdDisplay.textContent = userId;
                
                authContainer.style.display = 'block';
                mainAppContent.style.display = 'none';

                // === INICIO: NUEVA L칍GICA DE QR PARA LOGOUT ===
                // Si la acci칩n QR estaba pendiente pero no hay sesi칩n,
                // mostramos un mensaje en el login.
                if (globalQrActionPending) {
                    authStatus.textContent = 'Por favor, inicia sesi칩n para registrar tu vuelo.';
                    authStatus.style.color = 'blue'; // Un color informativo
                } else {
                    authStatus.textContent = 'Por favor, inicia sesi칩n o reg칤strate para acceder.';
                    authStatus.style.color = 'red';
                }
                // === FIN: NUEVA L칍GICA DE QR PARA LOGOUT ===
                
                currentUserRole = null;
                applyRolePermissions(null);
            }
            
            // --- L칍GICA DE QR MOVIDA ---
            // La llamada a checkURLParamsForQR() se movi칩 al .then() de onAuthStateChanged
        });

        /**
         * Aplica los permisos de la interfaz de usuario basados en el rol del usuario.
         * Ahora, cualquier usuario autenticado puede editar.
         * @param {string|null} role - El rol del usuario ('admin', 'viewer' o null si no est치 autenticado).
         */
        function applyRolePermissions(role) {
            const isAuthenticated = (role !== null);

            document.querySelectorAll('.tabla-vuelo tbody tr').forEach(fila => {
                fila.querySelectorAll('td').forEach((celda) => {
                    const isNomenclatura = celda.classList.contains('nomenclatura');
                    const isTotalCell = celda.classList.contains('fila-total') || celda.classList.contains('fila-general');
                    const isMotorHeader = celda.classList.contains('motor-header');
                    const isVienenCell = celda.classList.contains('fila-vienen'); // <<< NUEVO CHECK

                    
                    // No hay m치s celdas de "Restante" o "Label" espec칤ficas despu칠s de la eliminaci칩n
                    if (isNomenclatura || isTotalCell || isMotorHeader) {
                        celda.contentEditable = 'false';
                        celda.classList.add('read-only-cell');
                        celda.classList.remove('editable-cell');
                    } else if (isVienenCell) { // <<< NUEVO BLOQUE
                        // La celda "VIENEN" solo es editable en Enero
                        if (mesActual === 0 && isAuthenticated) {
                            celda.contentEditable = 'true';
                            celda.classList.add('editable-cell');
                            celda.classList.remove('read-only-cell');
                        } else {
                            celda.contentEditable = 'false';
                            celda.classList.add('read-only-cell');
                            celda.classList.remove('editable-cell');
                        }
                    } else {
                        celda.contentEditable = isAuthenticated ? 'true' : 'false';
                        if (isAuthenticated) {
                            celda.classList.add('editable-cell');
                            celda.classList.remove('read-only-cell');
                        } else {
                            celda.classList.add('read-only-cell');
                            celda.classList.remove('editable-cell');
                        }
                    }
                });
            });

            selectYear.disabled = !isAuthenticated; 
            document.querySelectorAll('.tab-button').forEach(btn => { btn.disabled = !isAuthenticated; });
            recordatorioTextarea.readOnly = !isAuthenticated;
            btnImprimir.disabled = !isAuthenticated;
            btnComponentStatus.disabled = !isAuthenticated; 

            if (isAuthenticated) {
                authStatus.textContent = `Has iniciado sesi칩n. Puedes ver y editar todos los datos.`;
                authStatus.style.color = 'green';
            } else {
                authStatus.textContent = 'Por favor, inicia sesi칩n o reg칤strate para acceder.';
                authStatus.style.color = 'red';
            }
        }

        // ==================================================================
        // ==== INICIO: L칍GICA DE APLICACI칍N PRINCIPAL (FUNCIONES FALTANTES) ====
        // ==================================================================

        // --- Alerta personalizada ---
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');
        
        if (customAlertCloseBtn) {
            customAlertCloseBtn.addEventListener('click', () => {
                customAlertModal.style.display = 'none';
            });
        }

        /**
         * Muestra un modal de alerta personalizado en lugar de window.alert()
         * @param {string} message El mensaje a mostrar.
         */
        function showCustomAlert(message) {
            console.error(message); // Siempre registra el error en la consola
            if (customAlertMessage && customAlertModal) {
                customAlertMessage.textContent = message;
                customAlertModal.style.display = 'flex';
            } else {
                // Fallback si el modal no existe (aunque no deber칤a pasar)
                alert(message);
            }
        }

        // --- Carga de A침os ---
        function cargarA침os() {
            selectYear.innerHTML = '';
            a침os.forEach(a침o => {
                const option = document.createElement('option');
                option.value = a침o;
                option.textContent = a침o;
                if (a침o === a침oActual) {
                    option.selected = true;
                }
                selectYear.appendChild(option);
            });
        }

        // --- Creaci칩n de Botones de Meses ---
        function crearBotonesMeses() {
            contenedorMeses.innerHTML = '';
            meses.forEach((nombreMes, index) => {
                const button = document.createElement('button');
                button.textContent = nombreMes;
                button.className = 'tab-button';
                button.dataset.mes = index;
                if (index === mesActual) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => cambiarMes(index));
                contenedorMeses.appendChild(button);
            });
        }

        // --- Creaci칩n de Tablas HTML ---
        function crearTablasParaA침o(a침o) {
            contenedorTablas.innerHTML = ''; // Limpiar tablas existentes
            const diasEnMeses = [31, (a침o % 4 === 0 && a침o % 100 !== 0) || a침o % 400 === 0 ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            meses.forEach((nombreMes, indexMes) => {
                const dias = diasEnMeses[indexMes];
                const tablaContainer = document.createElement('div');
                tablaContainer.className = 'tabla-mes';
                tablaContainer.style.display = indexMes === mesActual ? 'block' : 'none';
                tablaContainer.dataset.mes = indexMes;

                const tabla = document.createElement('table');
                tabla.className = 'tabla-vuelo w-full';
                tabla.id = `tabla-${nombreMes.toLowerCase()}`;
                
                // Encabezado de la tabla
                let headerHTML = '<thead><tr><th>NOMENCLATURA</th><th>VIENEN</th>';
                for (let i = 1; i <= dias; i++) {
                    headerHTML += `<th>${i}</th>`;
                }
                headerHTML += '<th>MES TOTAL</th><th>GENERAL</th></tr></thead>';
                tabla.innerHTML = headerHTML;

                // Cuerpo de la tabla
                const tbody = document.createElement('tbody');
                
                nombresFilasOrdenadas.forEach((nombreFila, filaIndex) => {
                    // Insertar cabeceras de motor
                    if (nombreFila === "CONTINGENCY EXCURSIONS") {
                        const trHeader = document.createElement('tr');
                        trHeader.innerHTML = `<td colspan="${dias + 4}" class="motor-header">MOTOR</td>`;
                        tbody.appendChild(trHeader);
                    }

                    const tr = document.createElement('tr');
                    tr.dataset.nomenclatura = nombreFila;
                    
                    let rowHTML = `<td class="nomenclatura">${nombreFila}</td>`;
                    
                    // Celda "VIENEN" (Solo lectura)
                    rowHTML += `<td class="fila-vienen read-only-cell">0</td>`;

                    // Celdas de D칤as (Editables)
                    for (let i = 1; i <= dias; i++) {
                        rowHTML += `<td class="editable-cell" data-dia="${i}"></td>`;
                    }
                    
                    // Celda "MES TOTAL" (Solo lectura)
                    rowHTML += `<td class="fila-total read-only-cell">0</td>`;
                    
                    // Celda "GENERAL" (Solo lectura)
                    rowHTML += `<td class="fila-general read-only-cell">0</td>`;
                    
                    tr.innerHTML = rowHTML;
                    tbody.appendChild(tr);
                });
                
                tabla.appendChild(tbody);
                tablaContainer.appendChild(tabla);
                contenedorTablas.appendChild(tablaContainer);
            });
        }
        
        // --- L칩gica de Navegaci칩n de Tablas ---
        function cambiarMes(nuevoMes) { // ELIMINADO ASYNC
            if (nuevoMes === mesActual) return;

            // Guardar datos del mes actual antes de cambiar
            let savePromise = Promise.resolve(); // Empezar con una promesa resuelta
            if (auth.currentUser && userId !== "anonimo") {
                const currentMonthData = obtenerDatosTabla(mesActual);
                const currentMonthRecordatorio = recordatorioTextarea.value;
                // Asignar la promesa de guardado
                savePromise = guardarDatosEnFirebase(a침oActual, mesActual, currentMonthData, currentMonthRecordatorio); 
            }

            // Encadenar el resto de la l칩gica al guardado
            savePromise.then(() => {
                mesActual = nuevoMes;
                localStorage.setItem('lastActiveMonth', mesActual.toString()); // Guardar el mes activo
                mostrarTabla(mesActual);
                
                // Cargar datos del nuevo mes
                return cargarDatosDelMes(a침oActual, mesActual); // Devolver promesa
            })
            .then(() => {
                agregarEventosDeEdicion();
                applyRolePermissions(currentUserRole); // Re-aplicar permisos a la nueva tabla
            });
        }

        function mostrarTabla(mesIndex) {
            document.querySelectorAll('.tabla-mes').forEach(tabla => {
                tabla.style.display = 'none';
            });
            const tablaActiva = document.querySelector(`.tabla-mes[data-mes="${mesIndex}"]`);
            if (tablaActiva) {
                tablaActiva.style.display = 'block';
            }

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            const botonActivo = document.querySelector(`.tab-button[data-mes="${mesIndex}"]`);
            if (botonActivo) {
                botonActivo.classList.add('active');
            }
            
            // Actualizar cabecera de impresi칩n
            printMonthHeader.textContent = `${meses[mesIndex]} ${a침oActual}`;
        }

        selectYear.addEventListener('change', () => { // ELIMINADO ASYNC
            const nuevoA침o = parseInt(selectYear.value);
            if (nuevoA침o === a침oActual) return;

            // Guardar datos del mes actual antes de cambiar de a침o
            let savePromise = Promise.resolve();
            if (auth.currentUser && userId !== "anonimo") {
                const currentMonthData = obtenerDatosTabla(mesActual);
                const currentMonthRecordatorio = recordatorioTextarea.value;
                savePromise = guardarDatosEnFirebase(a침oActual, mesActual, currentMonthData, currentMonthRecordatorio); // ELIMINADO AWAIT
            }

            savePromise.then(() => { // A칌ADIDO .THEN
                a침oActual = nuevoA침o;
                crearTablasParaA침o(a침oActual); // Recrear las tablas para el nuevo a침o (d칤as bisiestos)
                mostrarTabla(mesActual); // Mostrar el mes que estaba activo
                
                // Cargar datos del nuevo a침o/mes
                return cargarDatosDelMes(a침oActual, mesActual); // Devolver promesa
            })
            .then(() => { // A칌ADIDO .THEN
                agregarEventosDeEdicion();
                applyRolePermissions(currentUserRole); // Re-aplicar permisos
            });
        });

        // --- L칩gica de Carga de Datos (Firebase) ---
        function cargarDatosDelMes(a침o, mes) { // ELIMINADO ASYNC
            if (!auth.currentUser) return Promise.resolve(); // No cargar nada si no hay usuario

            const rutaDatosMes = `artifacts/${appId}/public_data/FAH-945/${a침o}/${mes}`;
            const rutaRecordatorio = `artifacts/${appId}/public_data/FAH-945/${a침o}/${mes}/recordatorio`;
            const rutaVienen = `artifacts/${appId}/public_data/FAH-945/${a침o}/${mes === 0 ? 11 : mes - 1}`;
            const a침oVienen = mes === 0 ? a침o - 1 : a침o;
            const rutaTotalesGenerales = `artifacts/${appId}/public_data/totales_generales/FAH-945-Overall`;
            const rutaMecanicos = `artifacts/${appId}/public_data/FAH-945/${a침o}/${mes}/mecanicos`; // <<< NUEVA RUTA

            const tablaActiva = document.querySelector(`.tabla-mes[data-mes="${mes}"] .tabla-vuelo tbody`);
            if (!tablaActiva) return Promise.resolve();

            // Reescrito con Promise.all para cargar todo en paralelo sin awaits
            return new Promise((resolve, reject) => {
                const p1_datosVienen = get(ref(database, rutaVienen.replace(a침o, a침oVienen)));
                const p2_datosActuales = get(ref(database, rutaDatosMes));
                const p3_recordatorio = get(ref(database, rutaRecordatorio));
                const p4_totalesGenerales = get(ref(database, rutaTotalesGenerales));
                const p5_mecanicos = get(ref(database, rutaMecanicos)); // <<< NUEVA PROMESA

                Promise.all([p1_datosVienen, p2_datosActuales, p3_recordatorio, p4_totalesGenerales, p5_mecanicos])
                    .then(([snapshotVienen, snapshotActual, snapshotRecordatorio, snapshotGeneral, snapshotMecanicos]) => {
                        
                        const datosVienen = snapshotVienen.val() || {};
                        const datosActuales = snapshotActual.val() || {};
                        recordatorioTextarea.value = snapshotRecordatorio.val() || '';
                        const totalesGenerales = snapshotGeneral.val() || {};
                        const mecanicos = snapshotMecanicos.val() || {}; // <<< NUEVOS DATOS

                        // 4. Poblar la tabla
                        tablaActiva.querySelectorAll('tr[data-nomenclatura]').forEach(fila => {
                            const nom = fila.dataset.nomenclatura;
                            const datosFila = datosActuales[nom] || {};
                            const datosFilaVienen = datosVienen[nom] || {};

                            // Calcular "Vienen" (Total General del mes anterior)
                            let vienen = 0;
                            /* --- INICIO DE LA MODIFICACI칍N (L칍GICA "VIENEN" INTELIGENTE) --- */
                            const vienen_calculado = parseFloat(datosFilaVienen.general) || 0;
                            const vienen_guardado = parseFloat(datosFila.vienen); // Leer el valor guardado este mes

                            if (mesActual === 0) { // Es Enero
                                // En Enero, priorizar el valor guardado. Si no existe, usar el calculado (de Dic. a침o anterior).
                                vienen = !isNaN(vienen_guardado) ? vienen_guardado : vienen_calculado;
                            } else { // Es Feb - Dic
                                // En otros meses, SIEMPRE usar el calculado para mantener la cadena.
                                vienen = vienen_calculado;
                            }
                            /* --- FIN DE LA MODIFICACI칍N --- */
                            
                            // Casos especiales para AC HRS, ATERRIZAJES, RINS (se acumulan)
                            /* --- INICIO DEL BLOQUE A ELIMINAR ---
                            if (nom === "AC HRS" || nom === "ATERRIZAJES" || nom === "RINS") {
                                // El "Vienen" de este mes es el Total General menos lo de este mes
                                const totalMesActual = Object.values(datosFila.dias || {}).reduce((acc, val) => acc + (parseFloat(val) || 0), 0);
                                vienen = (totalesGenerales[nom] || 0) - totalMesActual;
                            }
                            --- FIN DEL BLOQUE A ELIMINAR --- */

                            fila.querySelector('.fila-vienen').textContent = formatNumber(vienen.toFixed(nom === "AC HRS" ? 1 : 0));

                            // Poblar d칤as
                            fila.querySelectorAll('td.editable-cell').forEach(celda => {
                                const dia = celda.dataset.dia;
                                celda.textContent = formatNumber(datosFila.dias?.[dia] || '');
                            });
                        });

                        // 5. Calcular totales
                        actualizarTotales();

                        // 6. Aplicar tooltips de mec치nicos (NUEVO)
                        const headerRow = tablaActiva.closest('table').querySelector('thead tr');
                        if (headerRow) {
                            // Limpiar tooltips antiguos (d칤as 1-31, que son th:nth-child(3) en adelante)
                            headerRow.querySelectorAll('th:nth-child(n+3)').forEach(th => {
                                th.innerHTML = th.textContent.trim(); // Restaura solo el n칰mero (quita el icono)
                                th.title = '';
                                th.style.cursor = '';
                                // th.style.textDecoration = ''; // Ya no se usa
                            });

                            // Aplicar nuevos tooltips
                            for (const dia in mecanicos) {
                                const data = mecanicos[dia]; // Puede ser string (antiguo) o array (nuevo)
                                let nombres = '';

                                // --- INICIO: L칩gica para m칰ltiples mec치nicos ---
                                if (Array.isArray(data)) {
                                    nombres = data.join(', '); // Unir lista
                                } else if (typeof data === 'string') {
                                    nombres = data; // Compatibilidad con datos antiguos
                                }
                                // --- FIN: L칩gica para m칰ltiples mec치nicos ---

                                const diaIndex = parseInt(dia) + 2; // +2 porque 1=Nomenclatura, 2=Vienen, 3=Dia 1
                                const th = headerRow.querySelector(`th:nth-child(${diaIndex})`);
                                if (th && nombres) { // Asegurarse de que 'nombres' no est칠 vac칤o
                                    th.title = `Reporte(s) por: ${nombres}`;
                                    th.style.cursor = 'help';
                                    // --- INICIO: A침adir icono ---
                                    const diaNum = th.textContent.trim(); // Guardar el n칰mero del d칤a
                                    th.innerHTML = `${diaNum} ${iconoMecanicoHTML}`; // A침adir el icono
                                    // th.style.textDecoration = 'underline dotted'; // Quitar subrayado
                                    // --- FIN: A침adir icono ---
                                }
                            }
                        }

                        resolve(); // Resolver la promesa principal

                    })
                    .catch(error => {
                        showCustomAlert(`Error al cargar datos: ${error.message}`);
                        reject(error);
                    });
            });
        }
        
        // --- L칩gica de Guardado de Datos (Firebase) ---

        /**
         * Recoge todos los datos de la tabla activa.
         * @param {number} mesIndex - El 칤ndice del mes (0-11).
         * @returns {object} - Un objeto con los datos de la tabla.
         */
        function obtenerDatosTabla(mesIndex) {
            const tablaActiva = document.querySelector(`.tabla-mes[data-mes="${mesIndex}"] .tabla-vuelo tbody`);
            if (!tablaActiva) return {};

            const datos = {};
            tablaActiva.querySelectorAll('tr[data-nomenclatura]').forEach(fila => {
                const nom = fila.dataset.nomenclatura;
                datos[nom] = {
                    /* --- INICIO DE LA MODIFICACI칍N (VIENEN INTOCABLE) --- */
                    // La propiedad 'vienen' se elimina de aqu칤.
                    // Ya no leemos 'vienen' de la tabla para guardarlo.
                    // 'vienen' ahora es un valor 100% calculado en 'cargarDatosDelMes'.
                    vienen: parseFloat(fila.querySelector('.fila-vienen').textContent) || 0, // <-- L칈NEA RESTAURADA
                    /* --- FIN DE LA MODIFICACI칍N --- */
                    dias: {},
                    total: parseFloat(fila.querySelector('.fila-total').textContent) || 0,
                    general: parseFloat(fila.querySelector('.fila-general').textContent) || 0,
                };

                fila.querySelectorAll('td.editable-cell').forEach(celda => {
                    const dia = celda.dataset.dia;
                    const valor = celda.textContent.trim();
                    if (valor !== '') {
                        datos[nom].dias[dia] = parseFloat(valor) || 0;
                    }
                });
            });
            return datos;
        }

        /**
         * Guarda los datos del mes y el recordatorio en Firebase.
         * @param {number} a침o - A침o actual
         * @param {number} mes - Mes actual (0-11)
         * @param {object} datos - Datos de la tabla del mes
         * @param {string} recordatorio - Texto del recordatorio
         */
        function guardarDatosEnFirebase(a침o, mes, datos, recordatorio) { // ELIMINADO ASYNC
            if (!auth.currentUser || userId === "anonimo") return Promise.resolve(); // Devolver promesa resuelta

            const rutaDatosMes = `artifacts/${appId}/public_data/FAH-945/${a침o}/${mes}`;
            const rutaRecordatorio = `${rutaDatosMes}/recordatorio`;
            const rutaTotalesGenerales = `artifacts/${appId}/public_data/totales_generales/FAH-945-Overall`;

            try {
                // Guardar datos del mes (excluyendo el recordatorio)
                const datosParaGuardar = { ...datos };
                delete datosParaGuardar.recordatorio; // Asegurarse de que no est칠 anidado
                const p1 = set(ref(database, rutaDatosMes), datosParaGuardar); // ELIMINADO AWAIT
                
                // Guardar recordatorio por separado
                const p2 = set(ref(database, rutaRecordatorio), recordatorio); // ELIMINADO AWAIT

                // Actualizar los totales generales globales
                const totalesGenerales = {
                    "AC HRS": datos["AC HRS"]?.general || 0,
                    "ATERRIZAJES": datos["ATERRIZAJES"]?.general || 0,
                    "RINS": datos["RINS"]?.general || 0,
                };
                const p3 = set(ref(database, rutaTotalesGenerales), totalesGenerales); // ELIMINADO AWAIT
                
                // Devolver una promesa que se resuelve cuando todas las escrituras terminan
                return Promise.all([p1, p2, p3])
                    .then(() => {
                        // console.log("Datos guardados exitosamente.");
                    })
                    .catch((error) => {
                        showCustomAlert(`Error al guardar datos: ${error.message}`);
                        throw error; // Relanzar el error para que las cadenas .then() fallen
                    });

            } catch (error) {
                showCustomAlert(`Error al guardar datos: ${error.message}`);
                return Promise.reject(error); // Devolver promesa rechazada
            }
        }
        
        // --- L칩gica de C치lculo de Totales ---
        function actualizarTotales() {
            const tablaActiva = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!tablaActiva) return;

            tablaActiva.querySelectorAll('tr[data-nomenclatura]').forEach(fila => {
                const nom = fila.dataset.nomenclatura;
                let totalMes = 0;
                
                fila.querySelectorAll('td.editable-cell').forEach(celda => {
                    totalMes += parseFloat(celda.textContent) || 0;
                });

                const vienen = parseFloat(fila.querySelector('.fila-vienen').textContent) || 0;
                const totalGeneral = vienen + totalMes;
                
                // Formatear AC HRS con 1 decimal, el resto como enteros
                if (nom.includes("AC HRS") || nom.includes("ENGINE HRS")) {
                    fila.querySelector('.fila-total').textContent = formatNumber(totalMes.toFixed(1));
                    fila.querySelector('.fila-general').textContent = formatNumber(totalGeneral.toFixed(1));
                } else {
                    fila.querySelector('.fila-total').textContent = formatNumber(totalMes);
                    fila.querySelector('.fila-general').textContent = formatNumber(totalGeneral);
                }
            });
        }
        
        // --- L칩gica de Edici칩n en Celdas ---

        // Funci칩n Debounce para no guardar en cada pulsaci칩n de tecla
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        const guardarDebounced = debounce(() => { // ELIMINADO ASYNC
            if (auth.currentUser && userId !== "anonimo") {
                const currentMonthData = obtenerDatosTabla(mesActual);
                const currentMonthRecordatorio = recordatorioTextarea.value;
                guardarDatosEnFirebase(a침oActual, mesActual, currentMonthData, currentMonthRecordatorio); // ELIMINADO AWAIT
                // No se necesita .then o .catch aqu칤, es "disparar y olvidar"
            }
        }, 1500); // Guardar 1.5 segundos despu칠s de la 칰ltima edici칩n

        function agregarEventosDeEdicion() {
            const tablaActiva = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo`);
            if (!tablaActiva) return;

            // Evento para celdas editables
            tablaActiva.querySelectorAll('.editable-cell').forEach(celda => {
                celda.addEventListener('input', (e) => {
                    // Solo permitir n칰meros y un punto decimal
                    let valor = e.target.textContent;
                    valor = valor.replace(/[^0-9.]/g, '');
                    // Asegurar que solo haya un punto decimal
                    if (valor.indexOf('.') !== valor.lastIndexOf('.')) {
                        valor = valor.substring(0, valor.lastIndexOf('.'));
                    }
                    
                    if (e.target.textContent !== valor) {
                         e.target.textContent = valor;
                         // (Manejar la posici칩n del cursor ser칤a complejo, se omite por simplicidad)
                    }

                    actualizarTotales();
                    guardarDebounced();
                    
                    // Efecto LED
                    celda.classList.remove('celda-modificada'); // Reiniciar animaci칩n
                    void celda.offsetWidth; // Truco para reiniciar la animaci칩n
                    celda.classList.add('celda-modificada');
                });
            });

            // Evento para el recordatorio
            recordatorioTextarea.addEventListener('input', () => {
                guardarDebounced();
            });
        }

        // ================================================================
        // ==== FIN: L칍GICA DE APLICACI칍N PRINCIPAL (FUNCIONES FALTANTES) ====
        // ================================================================
        
        // ======================================================
        // ==== INICIO: NUEVAS FUNCIONES PARA MODO QR ====
        // ======================================================

        /**
         * Revisa si la URL contiene el par치metro 'action=addFlightData'.
         * Si es as칤, inicia el flujo de ingreso r치pido.
         */
        function checkURLParamsForQR() { // ELIMINADO ASYNC
            // const urlParams = new URLSearchParams(window.location.search); // <-- ELIMINADO
            // if (urlParams.get('action') === 'addFlightData') { // <-- ELIMINADO

            // === INICIO: NUEVA L칍GICA DE QR ===
            // 1. Limpiar la URL para que no se re-active en un F5
            // Lo hacemos aqu칤 para asegurar que solo se limpie si el flujo QR se inicia
            window.history.replaceState({}, document.title, window.location.pathname);
            // === FIN: NUEVA L칍GICA DE QR ===
                
            // 1. Obtener fecha actual
            const today = new Date();
                const targetYear = today.getFullYear();
                const targetMonth = today.getMonth(); // 0-11
                const targetDay = today.getDate(); // 1-31

                // 2. Comprobar si el a침o est치 en la lista
                if (!a침os.includes(targetYear)) {
                    showCustomAlert(`El a침o ${targetYear} no est치 configurado en la aplicaci칩n.`);
                    return Promise.resolve(); // Devolver promesa resuelta
                }

                // 3. Forzar el cambio al mes y a침o actuales
                
                let savePromise = Promise.resolve(); // Empezar con promesa resuelta
                if (a침oActual !== targetYear || mesActual !== targetMonth) {
                    if (auth.currentUser && userId !== "anonimo") {
                        const currentMonthData = obtenerDatosTabla(mesActual);
                        const currentMonthRecordatorio = recordatorioTextarea.value;
                        // Asignar la promesa de guardado
                        savePromise = guardarDatosEnFirebase(a침oActual, mesActual, currentMonthData, currentMonthRecordatorio); // ELIMINADO AWAIT
                    }
                }

                // Encadenar toda la l칩gica a la promesa de guardado
                return savePromise.then(() => { // A칌ADIDO .THEN
                    a침oActual = targetYear;
                    mesActual = targetMonth;

                    // Actualizar el UI (selector de a침o y pesta침as de mes)
                    selectYear.value = a침oActual;
                    crearTablasParaA침o(a침oActual); // Recrear tablas para el a침o correcto
                    mostrarTabla(mesActual); // Activar la pesta침a del mes correcto

                    // 4. Cargar los datos del mes actual
                    return cargarDatosDelMes(a침oActual, mesActual); // Devolver promesa
                })
                .then(() => { // A칌ADIDO .THEN
                    agregarEventosDeEdicion();
                    applyRolePermissions(currentUserRole);

                    // 5. Mostrar el modal de ingreso
                    flightModalDate.textContent = `${targetDay} de ${meses[targetMonth]} de ${targetYear}`;
                    flightDataModal.style.display = 'flex';

                    // Limpiar historial de URL para que no se active de nuevo al recargar
                    // window.history.replaceState({}, document.title, window.location.pathname); // <-- ELIMINADO (se movi칩 al inicio de la funci칩n)
                });
        } // <-- Esta es la llave de cierre correcta para checkURLParamsForQR (L칤nea 1736)

        // --- INICIO DE LA CORRECCI칍N ---
        // Las siguientes 2 l칤neas eran un error de una edici칩n anterior y causaban el 'SyntaxError'.
        // Han sido eliminadas.
        // return Promise.resolve(); 
        // } 
        // --- FIN DE LA CORRECCI칍N ---

        /**
         * Maneja el guardado de datos del modal de ingreso r치pido (QR).
         * Ahora detecta conflictos antes de guardar.
         */
        function handleFlightDataSave() { // MODIFICADO
            const acHrs = modalAcHrs.value;
            const aterrizajes = modalAterrizajes.value;
            const rins = modalRins.value;
            // === INICIO: NUEVOS VALORES QR ===
            const engineHrs1 = modalEngineHrs1.value; // <-- A칌ADIDO
            const engineStarts1 = modalEngineStarts1.value;
            const flights1 = modalFlights1.value;
            // === FIN: NUEVOS VALORES QR ===

            // Guardar datos temporalmente
            pendingFlightData = { acHrs, aterrizajes, rins, engineHrs1, engineStarts1, flights1 }; // <-- MODIFICADO

            const today = new Date();
            const targetDay = today.getDate(); // 1-31
            const cellIndex = targetDay + 1; // 0: Nomenclatura, 1: Vienen, 2: D칤a 1 ...

            // Encuentra la tabla activa
            const activeTable = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!activeTable) {
                showCustomAlert("Error: No se encontr칩 la tabla activa.");
                return;
            }

            const dataToCheck = [
                { nomenclatura: "AC HRS", value: acHrs },
                { nomenclatura: "ATERRIZAJES", value: aterrizajes },
                { nomenclatura: "RINS", value: rins },
                // === INICIO: NUEVOS CHEQUEOS QR ===
                { nomenclatura: "ENGINE HRS", value: engineHrs1 }, // <-- A칌ADIDO
                { nomenclatura: "ENGINE STARTS", value: engineStarts1 },
                { nomenclatura: "FLIGHTS", value: flights1 }
                // === FIN: NUEVOS CHEQUEOS QR ===
            ];

            let hasConflict = false;
            
            dataToCheck.forEach(item => {
                const newValue = parseFloat(item.value.trim()) || 0;
                if (newValue === 0) return; // Si el nuevo valor es 0, no hay conflicto

                const row = activeTable.querySelector(`tr[data-nomenclatura="${item.nomenclatura}"]`);
                const cell = row ? row.querySelectorAll('td')[cellIndex] : null;
                const existingValue = parseFloat(cell?.textContent.trim()) || 0;

                if (existingValue > 0) {
                    hasConflict = true;
                }
            });

            if (hasConflict) {
                // Conflicto detectado: mostrar el modal de elecci칩n
                document.getElementById('dataConflictModal').style.display = 'flex';
                // Ocultar el modal de ingreso
                flightDataModal.style.display = 'none';
            } else {
                // Sin conflicto: aplicar los datos directamente (modo 'overwrite')
                applyFlightData('overwrite');
            }
        }

        /**
         * Aplica los datos de vuelo (guardados en pendingFlightData) a la tabla
         * seg칰n el modo (sumar o reemplazar).
         * @param {string} mode - 'sum' (sumar) o 'overwrite' (reemplazar)
         */
        function applyFlightData(mode = 'overwrite') {
            if (!pendingFlightData) return; // No hay nada que aplicar

            const { acHrs, aterrizajes, rins, engineHrs1, engineStarts1, flights1 } = pendingFlightData; // <-- MODIFICADO

            const today = new Date();
            const targetDay = today.getDate();
            const cellIndex = targetDay + 1;

            const activeTable = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!activeTable) { showCustomAlert("Error: Tabla no activa."); return; }

            const dataToUpdate = [
                { nomenclatura: "AC HRS", value: acHrs },
                { nomenclatura: "ATERRIZAJES", value: aterrizajes },
                { nomenclatura: "RINS", value: rins },
                // === INICIO: NUEVOS DATOS A ACTUALIZAR ===
                { nomenclatura: "ENGINE HRS", value: engineHrs1 }, // <-- A칌ADIDO
                { nomenclatura: "ENGINE STARTS", value: engineStarts1 },
                { nomenclatura: "FLIGHTS", value: flights1 }
                // === FIN: NUEVOS DATOS A ACTUALIZAR ===
            ];

            // 1. Actualizar las celdas en la tabla HTML
            dataToUpdate.forEach(item => {
                const nom = item.nomenclatura;
                const newValue = parseFloat(item.value.trim()) || 0;

                // No hacer nada si el nuevo valor es 0 y el modo es 'sumar'
                if (newValue === 0 && mode === 'sum') return;

                const row = activeTable.querySelector(`tr[data-nomenclatura="${nom}"]`);
                const cell = row ? row.querySelectorAll('td')[cellIndex] : null;
                
                if (cell) {
                    const existingValue = parseFloat(cell.textContent.trim()) || 0;
                    let finalValue = 0;

                    if (mode === 'sum') {
                        finalValue = existingValue + newValue;
                    } else { // 'overwrite'
                        finalValue = newValue;
                    }

                    // Formatear y establecer el valor final
                    let formattedValue;
                    // --- MODIFICADO: Formateo decimal solo para AC HRS y ENGINE HRS ---
                    if (nom === "AC HRS" || nom === "ENGINE HRS") {
                        formattedValue = finalValue > 0 ? finalValue.toFixed(1) : '';
                    } else {
                        formattedValue = finalValue > 0 ? finalValue.toFixed(0) : '';
                    }
                    cell.textContent = formatNumber(formattedValue); // formatNumber se encarga de formatear
                    
                    if (finalValue > 0) {
                        cell.classList.add("led-persistente"); // A침adir efecto
                    } else {
                        cell.classList.remove("led-persistente");
                    }
                }
            });

            // 2. Recalcular y guardar en Firebase
            actualizarTotales();
            // --- INICIO DE LA MODIFICACI칍N (Arreglar bug de 0.0) ---
            // Guardamos los datos pendientes en una variable local ANTES de que se borren
            const dataParaConfirmar = pendingFlightData; 
            
            guardarDatosEnFirebase(a침oActual, mesActual, obtenerDatosTabla(mesActual), recordatorioTextarea.value)
                .then(() => {
                    // 3. Ocultar modal de ingreso (si sigue abierto) y el de conflicto
                    flightDataModal.style.display = 'none';
                    document.getElementById('dataConflictModal').style.display = 'none';
                    modalAcHrs.value = '';
                    modalAterrizajes.value = '';
                    modalRins.value = '';
                    // === INICIO: LIMPIAR NUEVOS CAMPOS ===
                    modalEngineHrs1.value = ''; // <-- A칌ADIDO
                    modalEngineStarts1.value = '';
                    modalFlights1.value = '';
                    // === FIN: LIMPIAR NUEVOS CAMPOS ===

                    // 4. Mostrar modal de confirmaci칩n con los datos actualizados
                    showConfirmationModal(activeTable, dataParaConfirmar); // <-- Pasamos los datos como argumento
                });
            
            // 5. Limpiar los datos pendientes
            pendingFlightData = null;
        }


        /**
         * Muestra el modal de confirmaci칩n con los totales generales actualizados.
         */ // <-- A칌AD칈 ESTE CIERRE DE COMENTARIO
        // =CAMBIADO: Ahora abre el modal de mec치nico
        function showConfirmationModal(activeTable, qrData) { // <-- Se a침ade argumento 'qrData'
            // Obtener los datos del formulario QR que est치n pendientes
            // const qrData = pendingFlightData || { acHrs: 0, aterrizajes: 0, rins: 0 }; // <-- L칈NEA ELIMINADA
            
            // Si qrData no se pas칩 (un caso raro), usar un objeto vac칤o
            const datosDelReporte = qrData || {}; // <-- Objeto vac칤o por defecto
            
            // === INICIO: L칍GICA RECONSTRUIDA PARA 9 CAMPOS ===
            
            // Definir todos los campos que queremos mostrar
            const itemsAMostrar = [
                { nom: "AC HRS", suma: parseFloat(datosDelReporte.acHrs) || 0, decimales: 1 },
                { nom: "ATERRIZAJES", suma: parseFloat(datosDelReporte.aterrizajes) || 0, decimales: 0 },
                { nom: "RINS", suma: parseFloat(datosDelReporte.rins) || 0, decimales: 0 },
                { nom: "ENGINE HRS", suma: parseFloat(datosDelReporte.engineHrs1) || 0, decimales: 1 },
                { nom: "ENGINE STARTS", suma: parseFloat(datosDelReporte.engineStarts1) || 0, decimales: 0 },
                { nom: "FLIGHTS", suma: parseFloat(datosDelReporte.flights1) || 0, decimales: 0 }
            ];

            const listContainer = document.getElementById('confirmationListContainer');
            listContainer.innerHTML = ''; // Limpiar el contenedor

            // Recorrer cada item y construir su HTML
            itemsAMostrar.forEach(item => {
                const fila = activeTable.querySelector(`tr[data-nomenclatura="${item.nom}"]`);
                if (!fila) return; // Si no se encuentra la fila, saltar

                // Leemos el "GENERAL" (que ya fue actualizado en applyFlightData)
                const generalStr = fila.querySelector('.fila-general')?.textContent.trim() || '0';
                const generalNum = parseFloat(generalStr) || 0;
                
                // Calculamos el "VIENEN" restando la suma de hoy del total general
                const vienenNum = generalNum - item.suma;
                
                // Formatear los strings
                const vienenStr = vienenNum.toFixed(item.decimales);
                const sumaStr = `+${item.suma.toFixed(item.decimales)}`;
                const generalFinalStr = generalNum.toFixed(item.decimales);
                
                // Crear el HTML para este 칤tem
                const itemHTML = `
                    <div class="space-y-1${item.suma === 0 ? ' opacity-60' : ''}"> <!-- Atenuar si no se report칩 nada -->
                        <h4 class="font-bold text-lg text-blue-700">${item.nom}</h4>
                        <div>
                            <span class="font-medium text-gray-700">Total Anterior (Vienen):</span>
                            <strong class="text-lg float-right text-gray-800">${formatNumber(vienenStr)}</strong>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Reporte de Hoy:</span>
                            <strong class="text-lg float-right text-gray-800">${formatNumber(sumaStr)}</strong>
                        </div>
                        <hr class="my-1">
                        <div>
                            <span class="font-bold text-gray-900">NUEVO TOTAL GENERAL:</span>
                            <strong class="text-2xl float-right text-blue-700">${formatNumber(generalFinalStr)}</strong>
                        </div>
                    </div>
                `;
                listContainer.innerHTML += itemHTML;
            });
            
            // === FIN: L칍GICA RECONSTRUIDA PARA 9 CAMPOS ===

            confirmationModal.style.display = 'flex';

            /* --- INICIO DE LA MODIFICACI칍N (FORZAR MODAL DE NOMBRE) --- */
            // Re-asignamos el listener aqu칤 para asegurar que siempre est칠 activo
            // y apunte al modal de mec치nico.
            closeConfirmationBtn.onclick = () => { // Usamos .onclick para sobreescribir cualquier listener anterior
                confirmationModal.style.display = 'none';
                mechanicNameModal.style.display = 'flex'; // Abre el siguiente modal
                modalMechanicName.focus(); // Pone el cursor en el campo de nombre
            };
            /* --- FIN DE LA MODIFICACI칍N --- */
        }

        // === INICIO: NUEVA FUNCI칍N PARA GUARDAR MEC츼NICO Y SALIR ===
        /**
         * Maneja el guardado del nombre del mec치nico y cierra la sesi칩n de QR.
         */
        function handleSaveMechanicName() {
            const mechanicName = modalMechanicName.value.trim();
            if (!mechanicName) {
                showCustomAlert("Por favor, ingresa un nombre.");
                return;
            }

            const today = new Date();
            const targetDay = today.getDate();

            // Ruta para guardar el nombre del mec치nico
            const mechanicPath = `artifacts/${appId}/public_data/FAH-906/${a침oActual}/${mesActual}/mecanicos/${targetDay}`;

            // --- INICIO: L칩gica para m칰ltiples mec치nicos ---
            // 1. Leer los nombres existentes primero
            get(ref(database, mechanicPath)).then(snapshot => {
                const existingData = snapshot.val();
                const nameSet = new Set();

                if (Array.isArray(existingData)) {
                    existingData.forEach(name => nameSet.add(name));
                } else if (typeof existingData === 'string' && existingData) {
                    nameSet.add(existingData); // Compatibilidad con datos antiguos
                }
                
                nameSet.add(mechanicName); // A침adir el nuevo nombre

                const updatedNameList = Array.from(nameSet); // Lista de nombres 칰nicos

                // 2. Guardar la nueva lista (array)
                set(ref(database, mechanicPath), updatedNameList)
                    .then(() => {
                        // 3. Ocultar modal de mec치nico
                        mechanicNameModal.style.display = 'none';
                        modalMechanicName.value = ''; // Limpiar el campo

                        // 4. Mostrar modal de despedida
                        goodbyeMessage.textContent = `춰Gracias, ${mechanicName}! Tu reporte ha sido guardado.`;
                        goodbyeModal.style.display = 'flex';

                        // 5. Redirigir/Cerrar la p치gina despu칠s de 3 segundos
                        setTimeout(() => {
                            window.location.href = 'about:blank';
                        }, 3000);
                    })
                    .catch((error) => {
                        showCustomAlert(`Error al guardar la lista de mec치nicos: ${error.message}`);
                    });

            }).catch(error => {
                showCustomAlert(`Error al leer los mec치nicos existentes: ${error.message}`);
            });
            // --- FIN: L칩gica para m칰ltiples mec치nicos ---
        }
        // === FIN: NUEVA FUNCI칍N PARA GUARDAR MEC츼NICO Y SALIR ===


        // ====================================================
        // ==== FIN: NUEVAS FUNCIONES PARA MODO QR ====
        // ====================================================

        // =========================================================
        // ==== INICIO: NUEVAS FUNCIONES PARA REPORTE DETALLADO ====
        // =========================================================

        /**
         * Genera un reporte detallado (Totales de Mes y General) para el mes activo
         * y lo muestra en un modal.
         */
        function generarReporteDetallado() {
            const activeTable = document.querySelector(`.tabla-mes[style*="display: block"] .tabla-vuelo tbody`);
            if (!activeTable) {
                showCustomAlert("No se encontr칩 la tabla activa para generar el reporte.");
                return;
            }

            const mesNombre = meses[mesActual];
            const a침o = a침oActual;

            // 1. Obtener los elementos del modal de reporte
            const reportModal = document.getElementById('reportModal');
            const reportContentEl = document.getElementById('reportModalContent');
            const reportTitleEl = document.getElementById('reportModalTitle');
            
            if (!reportModal || !reportContentEl || !reportTitleEl) {
                showCustomAlert("Error: No se encontraron los elementos del modal de reporte.");
                return;
            }

            // 2. Establecer el t칤tulo del reporte
            reportTitleEl.textContent = `Reporte Detallado de Totales - ${mesNombre} ${a침o}`;

            // 3. Construir el HTML del reporte
            let reportHTML = `<table class="w-full text-sm border-collapse border border-gray-400">`;
            reportHTML += `<thead class="bg-gray-100">
                            <tr class="bg-gray-200">
                                <th class="border border-gray-400 p-2 text-left">Nomenclatura</th>
                                <th class="border border-gray-400 p-2 text-right">Total Mes</th>
                                <th class="border border-gray-400 p-2 text-right">Total General</th>
                            </tr>
                           </thead>
                           <tbody>`;

            // 4. Iterar a trav칠s de la lista de filas ordenadas
            nombresFilasOrdenadas.forEach(nom => {
                const fila = activeTable.querySelector(`tr[data-nomenclatura="${nom}"]`);
                
                // A침adir cabeceras de motor para separaci칩n visual
                if (nom === "CONTINGENCY EXCURSIONS") {
                    reportHTML += `<tr><td colspan="3" class="font-bold bg-gray-100 p-2 border border-gray-400">MOTOR</td></tr>`;
                }

                if (fila) {
                    const totalMes = fila.querySelector('.fila-total')?.textContent.trim() || '0';
                    const totalGeneral = fila.querySelector('.fila-general')?.textContent.trim() || '0';

                    reportHTML += `<tr>
                                    <td class="border border-gray-400 p-2 text-left">${nom}</td>
                                    <td class="border border-gray-400 p-2 text-right">${totalMes}</td>
                                    <td class="border border-gray-400 p-2 text-right">${totalGeneral}</td>
                                  </tr>`;
                }
            });

            reportHTML += `</tbody></table>`;

            // 5. Inyectar el HTML en el modal
            reportContentEl.innerHTML = reportHTML;

            // 6. Mostrar el modal
            reportModal.style.display = 'flex';
        }

        /**
         * Activa la impresi칩n del sistema, usando estilos CSS para imprimir solo el modal de reporte.
         */
        function imprimirReporte() {
            // A침ade una clase al body para activar los estilos de impresi칩n correctos
            document.body.classList.add('imprimiendo-reporte');
            
            window.print();
            
            // Elimina la clase despu칠s de que se abra el di치logo de impresi칩n
            // (se ejecutar치 despu칠s de que `print()` bloquee el hilo)
            setTimeout(() => {
                 document.body.classList.remove('imprimiendo-reporte');
            }, 100); // Un peque침o retardo
        }

        // =======================================================
        // ==== FIN: NUEVAS FUNCIONES PARA REPORTE DETALLADO ====
        // =======================================================


        // --- Funci칩n de inicializaci칩n de la aplicaci칩n ---
        function iniciar() { // ELIMINADO ASYNC
            cargarA침os();
            crearTablasParaA침o(a침oActual);
            crearBotonesMeses();

            // === INICIO: NUEVOS EVENT LISTENERS PARA MODALES QR ===
            saveFlightDataBtn.addEventListener('click', handleFlightDataSave);
            cancelFlightDataBtn.addEventListener('click', () => {
                flightDataModal.style.display = 'none';
                pendingFlightData = null; // Limpiar datos pendientes si cancela
                window.location.href = 'about:blank'; // <-- A칌ADIDO: Cierra la p치gina
            });
            // --- MODIFICADO: El bot칩n "Confirmado" ahora abre el modal de mec치nico ---
            /* --- INICIO DE LA MODIFICACI칍N (FORZAR MODAL DE NOMBRE) --- */
            // El listener de 'closeConfirmationBtn' se elimina de 'iniciar()'
            // y se mueve a 'showConfirmationModal()' para asegurar que funcione.
            /*
            closeConfirmationBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                mechanicNameModal.style.display = 'flex'; // Abre el siguiente modal
                modalMechanicName.focus(); // Pone el cursor en el campo de nombre
            });
            */
            /* --- FIN DE LA MODIFICACI칍N --- */
            // === FIN: NUEVOS EVENT LISTENERS PARA MODALES QR ===

            // === INICIO: EVENT LISTENERS PARA MODAL DE CONFLICTO (NUEVO) ===
            document.getElementById('overwriteDataBtn').addEventListener('click', () => applyFlightData('overwrite'));
            document.getElementById('sumDataBtn').addEventListener('click', () => applyFlightData('sum'));
            document.getElementById('cancelConflictBtn').addEventListener('click', () => {
                document.getElementById('dataConflictModal').style.display = 'none';
                pendingFlightData = null; // Limpiar datos pendientes
            });
            // === FIN: EVENT LISTENERS PARA MODAL DE CONFLICTO ===

            // === INICIO: EVENT LISTENER PARA MODAL DE MEC츼NICO (NUEVO) ===
            saveMechanicNameBtn.addEventListener('click', handleSaveMechanicName);
            // === FIN: EVENT LISTENER PARA MODAL DE MEC츼NICO ===

            // === INICIO: LISTENER PARA ALERTA PERSONALIZADA ===
            customAlertCloseBtn.addEventListener('click', () => {
                customAlertModal.style.display = 'none';
            });
            // === FIN: LISTENER PARA ALERTA PERSONALIZADA ===

            // === INICIO: NUEVOS LISTENERS PARA EL MODAL DE REPORTE ===
            btnImprimir.addEventListener('click', generarReporteDetallado);
            
            const printReportBtn = document.getElementById('printReportBtn');
            if(printReportBtn) {
                printReportBtn.addEventListener('click', imprimirReporte);
            }
            
            const closeReportBtn = document.getElementById('closeReportBtn');
            if(closeReportBtn) {
                closeReportBtn.addEventListener('click', () => {
                    document.getElementById('reportModal').style.display = 'none';
                });
            }
            // === FIN: NUEVOS LISTENERS PARA EL MODAL DE REPORTE ===


            // Event listener para el bot칩n "Estado de Componentes" (reescrito sin async/await)
            btnComponentStatus.addEventListener('click', () => { // <--- QUIT칄 EL ASYNC
                if (!auth.currentUser) {
                    showCustomAlert('Debes iniciar sesi칩n para ver el estado de los componentes.');
                    return;
                }

                // Obtener los totales generales directamente de Firebase Realtime Database
                const rutaTotalesGenerales = `artifacts/${appId}/public_data/totales_generales/FAH-945-Overall`;
                
                // --- Reescrito con .then() y .catch() ---
                get(ref(database, rutaTotalesGenerales)).then((snapshot) => {
                    let generalTotals = { 'AC HRS': 0, 'ATERRIZAJES': 0, 'RINS': 0 };
                    if (snapshot.exists()) {
                        generalTotals = snapshot.val();
                    }

                    const componentsData = [
                        { name: "AC HRS", current: generalTotals['AC HRS'] || 0, type: "general_total" },
                        { name: "ATERRIZAJES", current: generalTotals['ATERRIZAJES'] || 0, type: "general_total" },
                        { name: "RINS", current: generalTotals['RINS'] || 0, type: "general_total" }
                    ];
                    
                    // Guardar los datos en localStorage (para compatibilidad si COMPONENTES906.HTML lo usa)
                    localStorage.setItem('componentStatusData', JSON.stringify(componentsData));
                    
                    window.location.href = 'COMPONENTES906.HTML'; // Redirige a la nueva p치gina
                }).catch((error) => {
                    showCustomAlert(`Error al cargar datos para la p치gina de componentes: ${error.message}`);
                });
                // --- Fin de la reescritura ---
            });

            // Event listener para el nuevo bot칩n "Inspecciones"
            const btnInspecciones = document.getElementById('btnInspecciones');
            btnInspecciones.addEventListener('click', () => {
                // Redirigir a la nueva p치gina de inspecciones
                window.location.href = 'inspecciones945.html';
            });

        } // <-- Cierre de la funci칩n iniciar()

        // --- LLAMADA DE INICIALIZACI칍N ---
        // Esto ejecuta toda la configuraci칩n, incluyendo los listeners de login.
        iniciar();

    </script>

</body>
</html>
